name: TDD Monitor (Unified)

# Unified monitoring workflow that consolidates:
# - Circuit breaker (health monitoring)
# - Stuck spec recovery (timeout detection)
# - PR monitoring (auto-merge, stuck PRs)
# - Conflict resolution (merge conflicts)
# - Retry monitoring (stuck retries)

on:
  # Event-driven triggers (immediate response)
  workflow_run:
    workflows: ['Claude Code TDD']
    types: [completed]
  push:
    branches:
      - main

  # Scheduled backup (every 30 min)
  schedule:
    - cron: '*/30 * * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      force_recovery:
        description: 'Force recovery of all stuck specs'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

env:
  STUCK_TIMEOUT_MINUTES: 90 # Specs stuck >90 min are recovered
  PR_STUCK_TIMEOUT_MINUTES: 120 # PRs stuck >120 min are force-closed
  RETRY_STUCK_TIMEOUT_MINUTES: 30 # Retries stuck >30 min are recovered

jobs:
  # Job 1: Health Check & Circuit Breaker
  # Monitors overall pipeline health and disables queue on high failure rate
  health-check:
    name: üè• Health Check & Circuit Breaker
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      failure_rate: ${{ steps.analyze.outputs.failure_rate }}
      should_open_circuit: ${{ steps.analyze.outputs.should_open_circuit }}
      is_circuit_open: ${{ steps.circuit_status.outputs.is_open }}

    steps:
      - name: Analyze pipeline health
        id: analyze
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üìä Analyzing TDD pipeline health..."

          # Get last 10 workflow runs from claude-tdd.yml
          RECENT_RUNS=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow="claude-tdd.yml" \
            --limit 10 \
            --json conclusion,createdAt,displayTitle)

          TOTAL=$(echo "$RECENT_RUNS" | jq 'length')
          FAILURES=$(echo "$RECENT_RUNS" | jq '[.[] | select(.conclusion == "failure" or .conclusion == "cancelled")] | length')

          # Count specs in retry state
          RETRY_1=$(gh issue list --repo ${{ github.repository }} --label "infrastructure-retry:1" --json number --jq 'length')
          RETRY_2=$(gh issue list --repo ${{ github.repository }} --label "infrastructure-retry:2" --json number --jq 'length')
          RETRY_3=$(gh issue list --repo ${{ github.repository }} --label "infrastructure-retry:3" --json number --jq 'length')
          RETRY_ISSUES=$((RETRY_1 + RETRY_2 + RETRY_3))

          # Calculate failure rate
          if [ "$TOTAL" -eq 0 ]; then
            FAILURE_RATE=0
          else
            FAILURE_RATE=$((FAILURES * 100 / TOTAL))
          fi

          echo "üìà Health metrics:"
          echo "   Recent runs: $TOTAL"
          echo "   Failures: $FAILURES"
          echo "   Failure rate: ${FAILURE_RATE}%"
          echo "   Issues in retry: $RETRY_ISSUES"

          # Output results
          echo "failure_rate=$FAILURE_RATE" >> $GITHUB_OUTPUT
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "retry_issues=$RETRY_ISSUES" >> $GITHUB_OUTPUT

          # Determine if circuit should open
          # Open if: >50% failure rate OR >5 issues in retry state
          if [ "$TOTAL" -ge 5 ] && [ "$FAILURE_RATE" -gt 50 ]; then
            echo "should_open_circuit=true" >> $GITHUB_OUTPUT
            echo "üö® THRESHOLD EXCEEDED: ${FAILURE_RATE}% failure rate"
          elif [ "$RETRY_ISSUES" -gt 5 ]; then
            echo "should_open_circuit=true" >> $GITHUB_OUTPUT
            echo "üö® THRESHOLD EXCEEDED: $RETRY_ISSUES issues in retry"
          else
            echo "should_open_circuit=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Health is acceptable"
          fi

      - name: Check circuit breaker status
        id: circuit_status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if queue processor is disabled
          STATUS=$(gh workflow list \
            --repo ${{ github.repository }} \
            --all \
            --json name,state \
            --jq '.[] | select(.name == "TDD Queue - Processor") | .state')

          if [ "$STATUS" = "disabled_manually" ]; then
            echo "is_open=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Circuit breaker is OPEN (queue disabled)"
          else
            echo "is_open=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Circuit breaker is CLOSED (queue active)"
          fi

      - name: Open circuit breaker
        if: steps.analyze.outputs.should_open_circuit == 'true' && steps.circuit_status.outputs.is_open != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üö® Opening circuit breaker - disabling queue..."

          gh workflow disable "tdd-queue-processor.yml" --repo ${{ github.repository }}

          # Create incident issue
          gh issue create \
            --repo ${{ github.repository }} \
            --title "üö® TDD Circuit Breaker: High Failure Rate" \
            --body "## üö® Circuit Breaker Activated

          **Failure Rate**: ${{ steps.analyze.outputs.failure_rate }}%
          **Recent Runs**: ${{ steps.analyze.outputs.failures }}/${{ steps.analyze.outputs.total }} failed
          **Issues in Retry**: ${{ steps.analyze.outputs.retry_issues }}
          **Action**: Queue processor disabled

          ### Investigation
          1. Check recent runs: [claude-tdd.yml](https://github.com/${{ github.repository }}/actions/workflows/claude-tdd.yml)
          2. Check retry issues: \`gh issue list --label infrastructure-retry:1\`
          3. Look for error patterns

          ### Recovery
          Once resolved:
          1. Re-enable queue: \`gh workflow enable tdd-queue-processor.yml\`
          2. Close this issue

          ---
          *ü§ñ TDD Monitor (Unified)*" \
            --label "tdd-automation,incident,priority:high"

      - name: Close circuit breaker
        if: steps.analyze.outputs.should_open_circuit == 'false' && steps.circuit_status.outputs.is_open == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "‚úÖ Health recovered - closing circuit breaker..."

          gh workflow enable "tdd-queue-processor.yml" --repo ${{ github.repository }}

          # Close incident issues
          gh issue list \
            --repo ${{ github.repository }} \
            --label "incident" \
            --state open \
            --json number,title \
            --jq '.[] | select(.title | contains("TDD Circuit Breaker")) | .number' \
            | while read -r ISSUE; do
              gh issue comment "$ISSUE" --repo ${{ github.repository }} \
                --body "‚úÖ **Circuit Breaker Recovered**

          **Current Failure Rate**: ${{ steps.analyze.outputs.failure_rate }}%
          **Action**: Queue processor re-enabled

          Pipeline operating normally.

          ---
          *ü§ñ TDD Monitor (Unified)*"

              gh issue close "$ISSUE" --repo ${{ github.repository }}
            done

  # Job 2: Stuck Spec Recovery
  # Finds specs stuck in-progress >90 min and re-queues or fails them
  stuck-spec-recovery:
    name: üîÑ Stuck Spec Recovery
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Find and recover stuck specs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
          TIMEOUT_MINUTES: ${{ env.STUCK_TIMEOUT_MINUTES }}
          FORCE_RECOVERY: ${{ github.event.inputs.force_recovery || 'false' }}
        run: |
          echo "üîç Looking for specs stuck >$TIMEOUT_MINUTES min..."

          ISSUES=$(gh issue list \
            --repo ${{ github.repository }} \
            --label "tdd-spec:in-progress" \
            --json number,title,updatedAt,labels \
            --limit 100)

          NOW=$(date +%s)
          TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
          STUCK_COUNT=0

          echo "$ISSUES" | jq -r '.[] | @json' | while read -r issue; do
            ISSUE_NUMBER=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            UPDATED_AT=$(echo "$issue" | jq -r '.updatedAt')
            LABELS=$(echo "$issue" | jq -r '.labels[].name' | tr '\n' ' ')

            UPDATED_EPOCH=$(date -d "$UPDATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$UPDATED_AT" +%s 2>/dev/null || echo "0")
            AGE=$((NOW - UPDATED_EPOCH))
            AGE_MIN=$((AGE / 60))

            # Skip if not stuck (or force recovery is enabled)
            if [ "$FORCE_RECOVERY" != "true" ] && [ "$AGE" -le "$TIMEOUT_SECONDS" ]; then
              continue
            fi

            echo ""
            echo "‚è±Ô∏è  STUCK: Issue #$ISSUE_NUMBER (${AGE_MIN} min old)"
            STUCK_COUNT=$((STUCK_COUNT + 1))

            # Check for retry label
            RETRY_LABEL=$(echo "$LABELS" | grep -o 'infrastructure-retry:[0-9]' || echo "")

            if [ -n "$RETRY_LABEL" ]; then
              RETRY_NUM=$(echo "$RETRY_LABEL" | sed 's/infrastructure-retry://')
              echo "   Stuck retry attempt #$RETRY_NUM"

              if [ "$RETRY_NUM" -ge 3 ]; then
                echo "   ‚ùå Max retries reached - marking as failed"
                gh issue edit "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                  --remove-label "tdd-spec:in-progress" \
                  --remove-label "$RETRY_LABEL" \
                  --add-label "tdd-spec:failed"

                gh issue comment "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                  --body "‚ùå **Max Retries Exhausted**

                Stuck in retry #$RETRY_NUM for $AGE_MIN minutes. Manual intervention required.

                ---
                *ü§ñ TDD Monitor (Unified)*"
              else
                NEXT_RETRY=$((RETRY_NUM + 1))
                echo "   üîÑ Triggering retry #$NEXT_RETRY"

                gh issue edit "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                  --remove-label "$RETRY_LABEL" \
                  --add-label "infrastructure-retry:$NEXT_RETRY"

                gh issue comment "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                  --body "üîÑ **Stuck Retry Recovery**

                Retry #$RETRY_NUM stuck for $AGE_MIN min. Triggering retry #$NEXT_RETRY.

                @claude retry implementation

                ---
                *ü§ñ TDD Monitor (Unified)*"
              fi
            else
              echo "   üìã Re-queueing stuck spec"
              gh issue edit "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                --remove-label "tdd-spec:in-progress" \
                --add-label "tdd-spec:queued"

              gh issue comment "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                --body "‚è±Ô∏è  **Timeout Recovery**

              Stuck for $AGE_MIN min. Re-queued for retry.

              ---
              *ü§ñ TDD Monitor (Unified)*"
            fi
          done

          if [ "$STUCK_COUNT" -gt 0 ]; then
            echo ""
            echo "‚úÖ Recovered $STUCK_COUNT stuck spec(s)"
          else
            echo "‚úÖ No stuck specs found"
          fi

  # Job 3: PR Monitoring
  # Monitors PRs for missing auto-merge and stuck validation
  pr-monitoring:
    name: üìã PR Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Monitor PRs for auto-merge
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "üîç Checking PRs for missing auto-merge..."

          PRS=$(gh pr list \
            --repo ${{ github.repository }} \
            --label "tdd-automation" \
            --state open \
            --json number,title,autoMergeRequest,createdAt,mergeable \
            --limit 50)

          NOW=$(date +%s)
          FIXED_COUNT=0

          echo "$PRS" | jq -r '.[] | @json' | while read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            TITLE=$(echo "$pr" | jq -r '.title')
            AUTO_MERGE=$(echo "$pr" | jq -r '.autoMergeRequest')
            CREATED_AT=$(echo "$pr" | jq -r '.createdAt')
            MERGEABLE=$(echo "$pr" | jq -r '.mergeable')

            if [ "$AUTO_MERGE" = "null" ] || [ -z "$AUTO_MERGE" ]; then
              CREATED_EPOCH=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED_AT" +%s 2>/dev/null || echo "$NOW")
              AGE_MIN=$(( (NOW - CREATED_EPOCH) / 60 ))

              # Only enable auto-merge if PR is >5 min old (give CI time to start)
              if [ "$AGE_MIN" -ge 5 ]; then
                echo ""
                echo "‚ö†Ô∏è  PR #$PR_NUMBER missing auto-merge (${AGE_MIN}m old)"
                echo "   Enabling auto-merge..."

                # Try to enable auto-merge
                if gh pr merge "$PR_NUMBER" --repo ${{ github.repository }} --auto --squash 2>/dev/null; then
                  # Verify it was enabled
                  sleep 2
                  VERIFY=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json autoMergeRequest --jq '.autoMergeRequest')

                  if [ "$VERIFY" != "null" ]; then
                    echo "   ‚úÖ Auto-merge enabled"
                    FIXED_COUNT=$((FIXED_COUNT + 1))

                    gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} \
                      --body "üîß **Auto-merge enabled**

                    Detected missing auto-merge after $AGE_MIN minutes.

                    PR will merge automatically when CI passes.

                    ---
                    *ü§ñ TDD Monitor (Unified)*"
                  else
                    echo "   ‚ö†Ô∏è  Auto-merge command succeeded but not enabled (may not be mergeable)"
                  fi
                else
                  echo "   ‚ö†Ô∏è  Could not enable auto-merge (PR may not be mergeable)"
                fi
              fi
            fi
          done

          if [ "$FIXED_COUNT" -gt 0 ]; then
            echo ""
            echo "‚úÖ Enabled auto-merge on $FIXED_COUNT PR(s)"
          else
            echo "‚úÖ All PRs have auto-merge enabled"
          fi

      - name: Detect stuck PRs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
          STUCK_TIMEOUT: ${{ env.PR_STUCK_TIMEOUT_MINUTES }}
        run: |
          echo "üîç Checking for PRs stuck in validation..."

          PRS=$(gh pr list \
            --repo ${{ github.repository }} \
            --label "tdd-automation" \
            --state open \
            --json number,title,createdAt,statusCheckRollup \
            --limit 50)

          NOW=$(date +%s)
          STUCK_COUNT=0

          echo "$PRS" | jq -r '.[] | @json' | while read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            CREATED_AT=$(echo "$pr" | jq -r '.createdAt')

            CREATED_EPOCH=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED_AT" +%s 2>/dev/null || echo "$NOW")
            AGE_MIN=$(( (NOW - CREATED_EPOCH) / 60 ))

            # Check if stuck (>120 min old)
            if [ "$AGE_MIN" -ge "$STUCK_TIMEOUT" ]; then
              echo ""
              echo "‚ö†Ô∏è  PR #$PR_NUMBER stuck for ${AGE_MIN}m"

              # Check if perpetually failing
              CHECKS=$(echo "$pr" | jq -r '.statusCheckRollup')
              FAILURES=$(echo "$CHECKS" | jq '[.[] | select(.conclusion == "FAILURE")] | length' 2>/dev/null || echo "0")

              if [ "$FAILURES" -gt 3 ]; then
                echo "   ‚ùå Perpetual failures detected - force closing"
                STUCK_COUNT=$((STUCK_COUNT + 1))

                # Get linked issue
                ISSUE_NUMBER=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json body --jq '.body' | grep -oP 'Closes #\K\d+' | head -1)

                gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} \
                  --body "‚ùå **PR Force-Closed: Perpetual Failures**

                PR stuck for ${AGE_MIN} minutes with multiple CI failures.

                Marking spec as failed. Manual intervention required.

                ---
                *ü§ñ TDD Monitor (Unified)*"

                gh pr close "$PR_NUMBER" --repo ${{ github.repository }}

                if [ -n "$ISSUE_NUMBER" ]; then
                  gh issue edit "$ISSUE_NUMBER" --repo ${{ github.repository }} \
                    --remove-label "tdd-spec:in-progress" \
                    --add-label "tdd-spec:failed"
                fi
              else
                echo "   ‚ö†Ô∏è  PR stuck but checks still running - monitoring"
              fi
            fi
          done

          if [ "$STUCK_COUNT" -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  Force-closed $STUCK_COUNT stuck PR(s)"
          fi

  # Job 4: Conflict Resolution
  # Detects and resolves merge conflicts automatically
  conflict-resolution:
    name: üîÄ Conflict Resolution
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Find and resolve conflicts
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "üîç Scanning for conflicted PRs..."

          CONFLICTED=$(gh pr list \
            --repo ${{ github.repository }} \
            --label "tdd-automation" \
            --state open \
            --json number,mergeable,mergeStateStatus,headRefName,labels \
            --jq '.[] | select(.mergeable == "CONFLICTING" or .mergeStateStatus == "DIRTY")')

          if [ -z "$CONFLICTED" ]; then
            echo "‚úÖ No conflicted PRs found"
            exit 0
          fi

          echo "$CONFLICTED" | jq -r '.number' | while read -r PR_NUMBER; do
            echo ""
            echo "‚ö†Ô∏è  PR #$PR_NUMBER has conflicts"

            # Check if already attempted resolution
            HAS_RETRY=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | grep "conflict-resolution:attempted" || echo "")

            if [ -n "$HAS_RETRY" ]; then
              echo "   Already attempted - marking for manual review"

              gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} \
                --add-label "needs-manual-resolution"

              gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} \
                --body "ü§ñ **Manual Resolution Required**

              Automatic conflict resolution failed. Please resolve manually:

              1. \`git fetch origin main:main\`
              2. \`git checkout [branch] && git rebase origin/main\`
              3. Resolve conflicts
              4. \`git push --force-with-lease\`

              ---
              *ü§ñ TDD Monitor (Unified)*"
            else
              echo "   Triggering automatic resolution"

              gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} \
                --add-label "conflict-resolution:attempted"

              HEAD_REF=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json headRefName --jq '.headRefName')

              gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} \
                --body "@claude resolve conflicts

              This PR has merge conflicts. Please resolve automatically:

              1. \`git fetch origin main:main\`
              2. \`git checkout $HEAD_REF && git rebase origin/main\`
              3. Resolve conflicts (prioritize main, keep both in tests)
              4. \`bun run lint && typecheck && test:unit\`
              5. \`git push --force-with-lease\`
              6. Re-enable auto-merge: \`gh pr merge $PR_NUMBER --auto --squash\`

              ---
              *ü§ñ TDD Monitor (Unified)*"
            fi
          done

  # Job 5: Summary Report
  # Generates summary of monitoring actions
  summary:
    name: üìä Summary
    runs-on: ubuntu-latest
    needs: [health-check, stuck-spec-recovery, pr-monitoring, conflict-resolution]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Generate summary
        run: |
          echo "üìä TDD Monitor Summary"
          echo "===================="
          echo ""
          echo "üè• Health Check:"
          echo "   Failure rate: ${{ needs.health-check.outputs.failure_rate }}%"
          echo "   Circuit: ${{ needs.health-check.outputs.is_circuit_open == 'true' && 'OPEN (queue disabled)' || 'CLOSED (queue active)' }}"
          echo ""
          echo "‚úÖ All monitoring jobs completed"
