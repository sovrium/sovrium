name: TDD Retry Monitor [DEPRECATED]

# ‚ö†Ô∏è DEPRECATED: This workflow has been consolidated into tdd-monitor-unified.yml
# Kept for reference only. Will be removed after successful migration.

# This workflow monitors for retry attempts that fail to start properly
# It detects when workflow_dispatch retries silently fail and recovers them

on:
  # Run every 20 minutes to check for stuck retries
  schedule:
    - cron: '*/30 * * * *' # Optimized from 20 min to reduce GitHub Actions usage

  # Manual trigger for testing
  workflow_dispatch:

permissions:
  issues: write
  actions: read
  contents: read

jobs:
  check-stuck-retries:
    name: üîç Monitor Stuck Retries
    runs-on: ubuntu-latest
    if: false # DISABLED - consolidated into tdd-monitor-unified.yml
    timeout-minutes: 5

    steps:
      - name: Find and recover stuck retry attempts
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "üîç Checking for stuck retry attempts..."

          # Find issues with infrastructure retry labels that are still in-progress
          RETRY_ISSUES=$(gh issue list \
            --repo ${{ github.repository }} \
            --label "tdd-spec:in-progress" \
            --json number,labels,updatedAt,title \
            --jq '.[] | select(.labels[].name | contains("infrastructure-retry:"))')

          if [ -z "$RETRY_ISSUES" ]; then
            echo "‚úÖ No issues with retry labels found"
            exit 0
          fi

          NOW=$(date +%s)
          STUCK_COUNT=0
          RECOVERED_COUNT=0

          echo "$RETRY_ISSUES" | jq -c '.' | while IFS= read -r issue; do
            NUMBER=$(echo "$issue" | jq -r '.number')
            TITLE=$(echo "$issue" | jq -r '.title')
            UPDATED=$(echo "$issue" | jq -r '.updatedAt')
            LABELS=$(echo "$issue" | jq -r '.labels[].name' | tr '\n' ' ')

            # Convert update time to epoch
            UPDATED_EPOCH=$(date -d "$UPDATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$UPDATED" +%s 2>/dev/null || echo "$NOW")
            AGE_MINUTES=$(( (NOW - UPDATED_EPOCH) / 60 ))

            echo ""
            echo "üìã Checking issue #$NUMBER: $TITLE"
            echo "   Last updated: $AGE_MINUTES minutes ago"
            echo "   Labels: $LABELS"

            # Check if there's a recent workflow run for this issue
            RECENT_RUN=$(gh run list \
              --workflow claude-tdd.yml \
              --repo ${{ github.repository }} \
              --limit 20 \
              --json displayTitle,createdAt,status \
              --jq ".[] | select(.displayTitle | contains(\"#$NUMBER\") or contains(\"$TITLE\"))" | head -1)

            if [ -n "$RECENT_RUN" ]; then
              RUN_CREATED=$(echo "$RECENT_RUN" | jq -r '.createdAt')
              RUN_STATUS=$(echo "$RECENT_RUN" | jq -r '.status')
              RUN_EPOCH=$(date -d "$RUN_CREATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$RUN_CREATED" +%s 2>/dev/null || echo 0)
              RUN_AGE_MINUTES=$(( (NOW - RUN_EPOCH) / 60 ))

              echo "   Found run: status=$RUN_STATUS, age=${RUN_AGE_MINUTES}m"

              # If run is recent and active, skip
              if [ "$RUN_AGE_MINUTES" -lt 30 ]; then
                echo "   ‚úÖ Recent run found, skipping"
                continue
              fi
            fi

            # If retry attempt is older than 30 minutes with no recent run, it's stuck
            if [ "$AGE_MINUTES" -gt 30 ]; then
              STUCK_COUNT=$((STUCK_COUNT + 1))
              echo "   ‚ö†Ô∏è STUCK RETRY DETECTED (${AGE_MINUTES}m old with no recent run)"

              # Extract retry number from labels
              RETRY_NUM=$(echo "$LABELS" | grep -o 'infrastructure-retry:[0-9]' | cut -d: -f2 | head -1)
              NEXT_RETRY=$((RETRY_NUM + 1))

              if [ "$NEXT_RETRY" -le 3 ]; then
                echo "   üîÑ Triggering recovery (retry $NEXT_RETRY of 3)..."

                # Trigger retry via issue comment (more reliable than workflow_dispatch)
                gh issue comment "$NUMBER" --repo ${{ github.repository }} \
                  --body "üîÑ **Stuck Retry Recovery**

                Detected stuck retry attempt #$RETRY_NUM that failed to start properly.

                **Details:**
                - Last activity: ${AGE_MINUTES} minutes ago
                - No active workflow runs found
                - Triggering retry attempt $NEXT_RETRY of 3

                @claude retry implementation (stuck retry recovery)

                ---
                *ü§ñ Automated Retry Monitor*"

                RECOVERED_COUNT=$((RECOVERED_COUNT + 1))
                echo "   ‚úÖ Recovery triggered for issue #$NUMBER"
              else
                echo "   ‚ùå Max retries reached, marking as failed..."

                # Remove retry labels and mark as failed
                gh issue edit "$NUMBER" --repo ${{ github.repository }} \
                  --remove-label "tdd-spec:in-progress" \
                  --remove-label "infrastructure-retry:$RETRY_NUM" \
                  --add-label "tdd-spec:failed"

                gh issue comment "$NUMBER" --repo ${{ github.repository }} \
                  --body "‚ùå **Retry Attempts Exhausted**

                All 3 retry attempts have failed or gotten stuck.

                **Manual intervention required:**
                1. Check the workflow logs for errors
                2. Verify Claude Code service is operational
                3. Consider manually implementing the spec

                The queue processor will continue with other specs.

                ---
                *ü§ñ Automated Retry Monitor*"
              fi
            else
              echo "   ‚è≥ Retry is ${AGE_MINUTES}m old, monitoring..."
            fi
          done

          echo ""
          echo "üìä Summary:"
          echo "   Stuck retries found: $STUCK_COUNT"
          echo "   Retries recovered: $RECOVERED_COUNT"

          if [ "$STUCK_COUNT" -gt 0 ]; then
            echo "::warning::Found $STUCK_COUNT stuck retries, recovered $RECOVERED_COUNT"
          else
            echo "‚úÖ All retries are progressing normally"
          fi

      - name: Check for systematic retry failures
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "üîç Checking for systematic retry failures..."

          # Count issues with multiple retry attempts
          MULTI_RETRY_COUNT=$(gh issue list \
            --repo ${{ github.repository }} \
            --search "label:infrastructure-retry:2 OR label:infrastructure-retry:3" \
            --json number --jq 'length')

          if [ "$MULTI_RETRY_COUNT" -gt 3 ]; then
            echo "‚ö†Ô∏è Multiple issues requiring retries detected: $MULTI_RETRY_COUNT"
            echo "This may indicate systematic infrastructure issues"

            # Check if alert already exists
            EXISTING_ALERT=$(gh issue list \
              --repo ${{ github.repository }} \
              --label "infrastructure,incident" \
              --state open \
              --search "Workflow Dispatch Failures" \
              --json number --jq '.[0].number')

            if [ -z "$EXISTING_ALERT" ]; then
              echo "Creating infrastructure alert..."

              gh issue create \
                --repo ${{ github.repository }} \
                --title "‚ö†Ô∏è Systematic Workflow Dispatch Failures Detected" \
                --body "## Infrastructure Issue Alert

              Multiple retry attempts are failing to start properly via workflow_dispatch.

              **Current Status:**
              - Issues with multiple retries: $MULTI_RETRY_COUNT
              - Possible causes:
                - GitHub Actions API issues
                - Rate limiting on workflow dispatches
                - Claude Code service issues

              **Recommended Actions:**
              1. Check GitHub Actions status page
              2. Review recent workflow logs for patterns
              3. Consider using issue comments instead of workflow_dispatch for retries
              4. Monitor circuit breaker status

              **Affected Issues:**
              $(gh issue list --repo ${{ github.repository }} --search "label:infrastructure-retry:2 OR label:infrastructure-retry:3" --json number,title --jq '.[] | "- #\(.number): \(.title)"')

              ---
              *ü§ñ Automated Retry Monitor*" \
                --label "infrastructure,incident,tdd-automation"

              echo "‚úÖ Alert issue created"
            else
              echo "‚ÑπÔ∏è Alert already exists: #$EXISTING_ALERT"
            fi
          else
            echo "‚úÖ Retry failure rate is normal ($MULTI_RETRY_COUNT issues with multiple retries)"
          fi
