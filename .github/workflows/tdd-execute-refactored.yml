# TDD - Execute (Claude Code) - Refactored Version
#
# This workflow handles all Claude Code execution with infrastructure-level retry logic.
# It handles both automated queue processing and manual @claude mentions.
#
# REFACTORED: Uses TypeScript CLI commands instead of inline bash
# See: scripts/tdd-automation/cli/tdd-execute.ts

name: TDD - Execute (Claude Code) v2

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      retry_attempt:
        description: 'Current retry attempt (1-3)'
        required: false
        type: number
        default: 1

  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

concurrency:
  group: claude-issue-${{ github.event.issue.number || github.event.pull_request.number || github.event.inputs.issue_number || 'default' }}
  cancel-in-progress: false

env:
  MAX_INFRASTRUCTURE_RETRIES: 3
  CLAUDE_TIMEOUT_MINUTES: 60

jobs:
  # Pre-check job: Validate context using TypeScript CLI
  validate-context:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      issues: read
    outputs:
      has_context: ${{ steps.pre-check.outputs.has_context }}
      issue_number: ${{ steps.pre-check.outputs.issue_number }}
      skip_reason: ${{ steps.pre-check.outputs.skip_reason }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run pre-check validation
        id: pre-check
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number || github.event.inputs.issue_number }}
          EVENT_COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          COOLDOWN_MINUTES: '30'
        run: bun run scripts/tdd-automation/cli/tdd-execute.ts pre-check

  # Execute Claude Code (must remain in YAML for GitHub OAuth)
  execute-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 65
    needs: [validate-context]
    if: |
      needs.validate-context.outputs.has_context == 'true' &&
      github.event.sender.login != 'claude[bot]'
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    outputs:
      claude_success: ${{ steps.analyze.outputs.claude_success }}
      error_type: ${{ steps.analyze.outputs.error_type }}
      is_retryable: ${{ steps.analyze.outputs.is_retryable }}
      has_branch: ${{ steps.verify.outputs.has_branch }}
      branch_name: ${{ steps.verify.outputs.branch_name }}
      spec_id: ${{ steps.context.outputs.spec_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Extract context
        id: context
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
        run: bun run scripts/tdd-automation/cli/tdd-execute.ts extract-context

      - name: Check usage limits
        id: usage
        run: bun run scripts/tdd-automation/check-claude-code-usage.ts --check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TDD_DAILY_COST_LIMIT: ${{ secrets.TDD_DAILY_COST_LIMIT }}
          TDD_WEEKLY_COST_LIMIT: ${{ secrets.TDD_WEEKLY_COST_LIMIT }}
        continue-on-error: true

      - name: Skip if usage limits exceeded
        if: steps.usage.outcome == 'failure'
        run: |
          echo "Usage limits exceeded - skipping Claude Code execution"
          exit 0

      # Claude Code Action (MUST remain in YAML - requires GitHub OAuth context)
      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 60
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_PAT_WORKFLOW }}
          additional_permissions: |
            actions: read
          claude_args: >-
            --model claude-sonnet-4-5-20250929
            --max-budget-usd 50.00
            --allowedTools Edit,Read,Write,Bash,Glob,Grep,Task,TodoWrite,Skill,LSP
            --disallowedTools WebFetch,WebSearch,AskUserQuestion,NotebookEdit,SlashCommand

      - name: Save workflow logs
        if: always()
        run: |
          timeout 30 gh run view ${{ github.run_id }} --log > /tmp/workflow_log.txt 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Analyze result
        id: analyze
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          CLAUDE_OUTCOME: ${{ steps.claude.outcome }}
          WORKFLOW_LOG_FILE: /tmp/workflow_log.txt
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
        run: bun run scripts/tdd-automation/cli/tdd-execute.ts analyze-result

      - name: Verify branch
        id: verify
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
          CLAUDE_OUTCOME: ${{ steps.claude.outcome }}
        run: bun run scripts/tdd-automation/cli/tdd-execute.ts verify-branch

      - name: Detect SDK crash
        id: sdk-crash
        if: steps.claude.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
          CLAUDE_OUTCOME: ${{ steps.claude.outcome }}
          WORKFLOW_LOG_FILE: /tmp/workflow_log.txt
        run: bun run scripts/tdd-automation/cli/tdd-execute.ts detect-sdk-crash

      - name: Update issue on failure
        if: |
          steps.claude.outcome != 'success' &&
          steps.verify.outputs.has_branch != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
          ERROR_TYPE: ${{ steps.analyze.outputs.error_type }}
          RETRY_ATTEMPT: ${{ github.event.inputs.retry_attempt || 1 }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "**Claude Code Execution Failed (Attempt $RETRY_ATTEMPT)**

          **Error Type**: \`$ERROR_TYPE\`
          **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          The automation system will analyze this error and retry if appropriate.

          ---
          *Infrastructure Error Handler*"

  # Handle infrastructure retries
  handle-retry:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-context, execute-claude]
    if: |
      always() &&
      needs.execute-claude.outputs.is_retryable == 'true' &&
      needs.execute-claude.outputs.has_branch != 'true'
    permissions:
      actions: write
      issues: write
    steps:
      - name: Trigger retry
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
          CURRENT_ATTEMPT: ${{ github.event.inputs.retry_attempt || 1 }}
        run: |
          NEXT_ATTEMPT=$((CURRENT_ATTEMPT + 1))

          if [ "$NEXT_ATTEMPT" -le "${{ env.MAX_INFRASTRUCTURE_RETRIES }}" ]; then
            echo "Triggering retry attempt $NEXT_ATTEMPT..."
            gh workflow run tdd-execute-refactored.yml \
              --field issue_number="$ISSUE_NUMBER" \
              --field retry_attempt="$NEXT_ATTEMPT"
          else
            echo "Max retries reached (${{ env.MAX_INFRASTRUCTURE_RETRIES }})"
            gh issue comment "$ISSUE_NUMBER" --body "**Max Retries Reached**

            Failed after ${{ env.MAX_INFRASTRUCTURE_RETRIES }} attempts. Manual intervention required.

            ---
            *TDD Automation*"
          fi

  # Create PR on success
  create-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate-context, execute-claude]
    if: |
      always() &&
      needs.execute-claude.outputs.has_branch == 'true'
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT_WORKFLOW }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
          BRANCH_NAME: ${{ needs.execute-claude.outputs.branch_name }}
          ISSUE_NUMBER: ${{ needs.validate-context.outputs.issue_number }}
          SPEC_ID: ${{ needs.execute-claude.outputs.spec_id }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH_NAME"
            exit 0
          fi

          # Create PR
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "fix: implement $SPEC_ID" \
            --body "## Summary

          Implements spec \`$SPEC_ID\` as specified in issue #$ISSUE_NUMBER.

          Closes #$ISSUE_NUMBER

          ---
          *Generated by TDD Automation*" \
            --label "tdd-automation"

          # Update issue labels
          gh issue edit "$ISSUE_NUMBER" \
            --remove-label "tdd-spec:in-progress" \
            --add-label "tdd-spec:completed" 2>/dev/null || true
