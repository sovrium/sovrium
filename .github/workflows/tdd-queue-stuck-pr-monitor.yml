name: TDD Queue - PR Monitor & Auto-Retry [DEPRECATED]


# âš ï¸ DEPRECATED: This workflow has been consolidated into tdd-monitor-unified.yml
# Kept for reference only. Will be removed after successful migration.

# This workflow monitors TDD automation PRs for three issues:
# 1. PRs stuck in open state despite passing checks (missing auto-merge)
# 2. PRs with failed tests that need automatic retry
# 3. PRs that succeeded and need retry label cleanup
#
# It automatically:
# - Enables auto-merge for stuck PRs
# - Triggers @claude retry for test failures (up to 3 times with exponential backoff)
# - Tracks retry attempts to prevent infinite loops
# - Cleans up retry labels on successful PRs
# - Provides detailed failure diagnostics

on:
  schedule:
    # Run every 30 minutes (optimized from 10 min to reduce GitHub Actions usage)
    - cron: '*/30 * * * *'
  workflow_dispatch: # Allow manual triggering for testing

concurrency:
  group: tdd-stuck-pr-monitor
  cancel-in-progress: false

env:
  MAX_CODE_RETRIES: 3 # Max retries for code/test failures
  MAX_DAILY_RETRIES: 10 # Max retries per day across all PRs

jobs:
  monitor-stuck-prs:
    name: Monitor and Fix PRs
    runs-on: ubuntu-latest
    if: false # DISABLED - consolidated into tdd-monitor-unified.yml
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Find and fix stuck PRs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ðŸ” Scanning for stuck PRs..."

          # Get all open tdd-automation PRs
          OPEN_PRS=$(gh pr list \
            --repo sovrium/sovrium \
            --label tdd-automation \
            --state open \
            --json number,autoMergeRequest,mergeable,statusCheckRollup,createdAt,headRefName,mergeStateStatus \
            --jq '.[]')

          if [ -z "$OPEN_PRS" ]; then
            echo "âœ… No open tdd-automation PRs found"
            exit 0
          fi

          # Process each PR
          echo "$OPEN_PRS" | jq -c '.' | while IFS= read -r PR; do
            PR_NUMBER=$(echo "$PR" | jq -r '.number')
            AUTO_MERGE=$(echo "$PR" | jq -r '.autoMergeRequest')
            MERGEABLE=$(echo "$PR" | jq -r '.mergeable')
            CREATED_AT=$(echo "$PR" | jq -r '.createdAt')
            HEAD_REF=$(echo "$PR" | jq -r '.headRefName')
            MERGE_STATE=$(echo "$PR" | jq -r '.mergeStateStatus')

            echo ""
            echo "ðŸ“‹ Checking PR #$PR_NUMBER (branch: $HEAD_REF)"
            echo "   Created: $CREATED_AT"
            echo "   Mergeable: $MERGEABLE"
            echo "   Merge State: $MERGE_STATE"
            echo "   Auto-merge: $([ "$AUTO_MERGE" = "null" ] && echo "âŒ NOT ENABLED" || echo "âœ… Enabled")"

            # Skip if auto-merge is already enabled
            if [ "$AUTO_MERGE" != "null" ]; then
              echo "   âœ… Auto-merge already enabled, skipping"
              continue
            fi

            # Track if we updated the branch
            BRANCH_UPDATED="false"

            # Check if branch needs updating (behind main)
            if [ "$MERGE_STATE" = "BEHIND" ] || [ "$MERGEABLE" = "CONFLICTING" ]; then
              echo "   ðŸ”„ Branch is behind main or has conflicts, attempting to update..."

              # Try to update the branch with main using GitHub API
              UPDATE_RESULT=$(gh api \
                --method PUT \
                "/repos/sovrium/sovrium/pulls/$PR_NUMBER/update-branch" \
                2>&1 || echo "FAILED")

              if [ "$UPDATE_RESULT" != "FAILED" ]; then
                echo "   âœ… Branch update initiated successfully"
                BRANCH_UPDATED="true"

                # Wait for GitHub to complete the update
                sleep 10

                # Re-fetch PR status after update
                UPDATED_PR=$(gh pr view "$PR_NUMBER" --repo sovrium/sovrium --json mergeable,mergeStateStatus)
                MERGEABLE=$(echo "$UPDATED_PR" | jq -r '.mergeable')
                MERGE_STATE=$(echo "$UPDATED_PR" | jq -r '.mergeStateStatus')

                echo "   ðŸ“Š New status after update: Mergeable=$MERGEABLE, MergeState=$MERGE_STATE"
              else
                echo "   âš ï¸  Failed to update branch (may require manual intervention for conflicts)"
                echo "   Error: $UPDATE_RESULT"
              fi
            fi

            # Skip if still not mergeable after update attempt
            if [ "$MERGEABLE" != "MERGEABLE" ]; then
              echo "   âš ï¸  Not mergeable (status: $MERGEABLE), skipping"
              continue
            fi

            # Check if all required checks are passing
            CHECKS=$(echo "$PR" | jq -r '.statusCheckRollup[]? | select(.name == "Test" or .name == "CodeQL") | select(.conclusion == "SUCCESS" or .conclusion == "SKIPPED") | .name' | wc -l | xargs)

            if [ "$CHECKS" -lt 1 ]; then
              echo "   â³ CI checks not complete yet, skipping"
              continue
            fi

            # Calculate PR age in minutes
            NOW=$(date +%s)
            CREATED_TIMESTAMP=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED_AT" +%s 2>/dev/null || echo $NOW)
            AGE_MINUTES=$(( ($NOW - $CREATED_TIMESTAMP) / 60 ))

            # Only enable auto-merge if PR is older than 5 minutes
            # This gives Claude Code time to enable it manually
            if [ $AGE_MINUTES -lt 5 ]; then
              echo "   â³ PR is only $AGE_MINUTES minutes old, waiting for Claude Code to enable auto-merge"
              continue
            fi

            # Enable auto-merge for stuck PR
            echo "   ðŸ”§ STUCK PR DETECTED! Enabling auto-merge..."
            if gh pr merge "$PR_NUMBER" --auto --squash --repo sovrium/sovrium; then
              echo "   âœ… Auto-merge enabled successfully for PR #$PR_NUMBER"

              # Add a comment explaining what happened
              COMMENT_BODY="ðŸ¤– **Stuck PR Monitor**

              This PR was stuck in an open state despite having all checks passing and being mergeable. Auto-merge has been automatically enabled.

              **Actions taken:**
              - $([ "$BRANCH_UPDATED" = "true" ] && echo "âœ… Updated branch with latest main" || echo "Branch was already up to date")
              - âœ… Enabled auto-merge

              **Details:**
              - PR age: $AGE_MINUTES minutes
              - Mergeable status: $MERGEABLE
              - Merge state: $MERGE_STATE
              - CI checks: Passing

              The PR will now merge automatically when all requirements are met."

              gh pr comment "$PR_NUMBER" --repo sovrium/sovrium --body "$COMMENT_BODY"
            else
              echo "   âŒ Failed to enable auto-merge for PR #$PR_NUMBER"
            fi
          done

          echo ""
          echo "âœ… Stuck PR monitoring complete"

      - name: Clean up retry labels on successful PRs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ðŸ§¹ Cleaning up retry labels from successful PRs..."

          # Get all open tdd-automation PRs with retry labels
          SUCCESSFUL_PRS=$(gh pr list \
            --repo sovrium/sovrium \
            --label tdd-automation \
            --state open \
            --json number,labels,statusCheckRollup \
            --jq '[.[] | select(.labels[]?.name | startswith("code-retry:"))]')

          if [ -z "$SUCCESSFUL_PRS" ] || [ "$SUCCESSFUL_PRS" = "[]" ]; then
            echo "âœ… No PRs with retry labels found"
          else
            echo "$SUCCESSFUL_PRS" | jq -c '.[]' | while IFS= read -r PR; do
              PR_NUMBER=$(echo "$PR" | jq -r '.number')

              # Check if all tests are passing
              TEST_STATUS=$(echo "$PR" | jq -r '.statusCheckRollup[]? | select(.name == "Test") | .conclusion' || echo "")

              if [ "$TEST_STATUS" = "SUCCESS" ]; then
                echo "âœ… PR #$PR_NUMBER has passing tests, cleaning up retry labels..."

                # Get all retry labels
                RETRY_LABELS=$(echo "$PR" | jq -r '.labels[]?.name | select(startswith("code-retry:"))' || echo "")

                if [ -n "$RETRY_LABELS" ]; then
                  for label in $RETRY_LABELS; do
                    gh pr edit "$PR_NUMBER" \
                      --repo sovrium/sovrium \
                      --remove-label "$label" || true
                    echo "   Removed label: $label"
                  done

                  # Also clean up from the related issue
                  HEAD_REF=$(gh pr view "$PR_NUMBER" --repo sovrium/sovrium --json headRefName -q '.headRefName')
                  ISSUE_NUMBER=$(echo "$HEAD_REF" | grep -oE 'issue-[0-9]+' | cut -d- -f2 || echo "")

                  if [ -n "$ISSUE_NUMBER" ]; then
                    for label in $RETRY_LABELS; do
                      gh issue edit "$ISSUE_NUMBER" \
                        --repo sovrium/sovrium \
                        --remove-label "$label" || true
                    done
                    echo "   Also cleaned labels from issue #$ISSUE_NUMBER"
                  fi
                fi
              fi
            done
          fi

          echo "âœ… Retry label cleanup complete"

      - name: Auto-retry failed tests
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ðŸ”„ Checking for PRs with failed tests..."

          # Get all open tdd-automation PRs with their status
          OPEN_PRS=$(gh pr list \
            --repo sovrium/sovrium \
            --label tdd-automation \
            --state open \
            --json number,labels,statusCheckRollup,headRefName,updatedAt,title \
            --jq '.[]')

          if [ -z "$OPEN_PRS" ]; then
            echo "âœ… No open tdd-automation PRs found"
            exit 0
          fi

          RETRY_TRIGGERED_COUNT=0
          FAILED_COUNT=0

          # Check today's retry count across all PRs
          TODAY=$(date +%Y-%m-%d)
          DAILY_RETRIES=$(gh issue list \
            --repo sovrium/sovrium \
            --label tdd-automation \
            --state all \
            --search "created:$TODAY" \
            --json comments \
            --jq '[.[] | .comments[] | select(.body | contains("Automated Test Failure Handler") and contains("$TODAY"))] | length' || echo "0")

          echo "ðŸ“Š Daily retry count: $DAILY_RETRIES / $MAX_DAILY_RETRIES"

          if [ "$DAILY_RETRIES" -ge "$MAX_DAILY_RETRIES" ]; then
            echo "âš ï¸  Daily retry limit reached ($MAX_DAILY_RETRIES). Pausing automatic retries until tomorrow."
            exit 0
          fi

          # Process each PR for test failures
          echo "$OPEN_PRS" | jq -c '.' | while IFS= read -r PR; do
            PR_NUMBER=$(echo "$PR" | jq -r '.number')
            TITLE=$(echo "$PR" | jq -r '.title')
            HEAD_REF=$(echo "$PR" | jq -r '.headRefName')
            UPDATED=$(echo "$PR" | jq -r '.updatedAt')

            # Check if Test workflow failed
            TEST_STATUS=$(echo "$PR" | jq -r '.statusCheckRollup[]? | select(.name == "Test") | .conclusion' || echo "")

            if [ "$TEST_STATUS" != "FAILURE" ]; then
              # Not a test failure, skip
              continue
            fi

            echo ""
            echo "âŒ PR #$PR_NUMBER has failed tests: $TITLE"
            FAILED_COUNT=$((FAILED_COUNT + 1))

            # Extract issue number from branch name
            ISSUE_NUMBER=$(echo "$HEAD_REF" | grep -oE 'issue-[0-9]+' | cut -d- -f2 || echo "")

            if [ -z "$ISSUE_NUMBER" ]; then
              echo "   âš ï¸  Could not extract issue number from branch: $HEAD_REF"
              continue
            fi

            echo "   ðŸ“ Related issue: #$ISSUE_NUMBER"

            # Check for existing code retry labels
            CURRENT_RETRY=0
            CODE_RETRY_LABELS=$(echo "$PR" | jq -r '.labels[]?.name | select(startswith("code-retry:"))' || echo "")

            if [ -n "$CODE_RETRY_LABELS" ]; then
              # Extract highest retry number
              for label in $CODE_RETRY_LABELS; do
                NUM=$(echo "$label" | cut -d: -f2)
                if [ "$NUM" -gt "$CURRENT_RETRY" ]; then
                  CURRENT_RETRY=$NUM
                fi
              done
            fi

            echo "   ðŸ“Š Current code retry count: $CURRENT_RETRY"

            # Check if max retries reached
            if [ "$CURRENT_RETRY" -ge "$MAX_CODE_RETRIES" ]; then
              echo "   âŒ Max retries reached ($MAX_CODE_RETRIES), marking as failed"

              # Mark issue as failed
              gh issue edit "$ISSUE_NUMBER" \
                --repo sovrium/sovrium \
                --remove-label "tdd-spec:in-progress" \
                --add-label "tdd-spec:failed" \
                --add-label "max-retries-exhausted" || true

              # Add comment explaining failure
              printf '%s\n' \
                "âŒ **Automatic Retries Exhausted**" \
                "" \
                "Test failures persisted after $MAX_CODE_RETRIES automatic retry attempts." \
                "" \
                "**PR**: #$PR_NUMBER" \
                "**Final Status**: Tests continue to fail" \
                "**Action Required**: Manual intervention needed" \
                "" \
                "The spec has been marked as \`tdd-spec:failed\`. The queue processor will continue with the next spec." \
                "" \
                "---" \
                "*ðŸ¤– Automated Test Failure Handler*" > /tmp/comment_body.md

              gh issue comment "$ISSUE_NUMBER" \
                --repo sovrium/sovrium \
                --body-file /tmp/comment_body.md || true

              continue
            fi

            # Calculate exponential backoff based on retry count
            # 1st retry: 5 minutes, 2nd: 15 minutes, 3rd: 45 minutes
            # Using pow function for better shell compatibility
            if [ "$CURRENT_RETRY" -eq 0 ]; then
              BACKOFF_MINUTES=5
            elif [ "$CURRENT_RETRY" -eq 1 ]; then
              BACKOFF_MINUTES=15
            else
              BACKOFF_MINUTES=45
            fi

            # Check when last updated to avoid retrying too quickly
            NOW=$(date +%s)
            UPDATED_EPOCH=$(date -d "$UPDATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$UPDATED" +%s 2>/dev/null || echo "$NOW")
            AGE_MINUTES=$(( (NOW - UPDATED_EPOCH) / 60 ))

            echo "   â±ï¸  Test failed ${AGE_MINUTES} minutes ago"
            echo "   â° Required wait time: ${BACKOFF_MINUTES} minutes (exponential backoff)"

            # Skip if not enough time has passed based on exponential backoff
            if [ "$AGE_MINUTES" -lt "$BACKOFF_MINUTES" ]; then
              echo "   â³ Waiting for backoff period (${BACKOFF_MINUTES} minutes)"
              continue
            fi

            # Check for recent retry comments (within last 30 minutes)
            RECENT_RETRY=$(gh issue view "$ISSUE_NUMBER" \
              --repo sovrium/sovrium \
              --comments \
              --json comments \
              --jq '[.comments[] | select(.createdAt > (now - 1800 | todate) and .body | contains("@claude retry"))] | length' || echo "0")

            if [ "$RECENT_RETRY" -gt 0 ]; then
              echo "   â³ Recent retry already in progress (within last 30 minutes), skipping"
              continue
            fi

            # Trigger retry
            NEXT_RETRY=$((CURRENT_RETRY + 1))
            echo "   ðŸ”„ Triggering automatic retry (attempt $NEXT_RETRY of $MAX_CODE_RETRIES)..."

            # Add retry label to PR
            gh pr edit "$PR_NUMBER" \
              --repo sovrium/sovrium \
              --add-label "code-retry:$NEXT_RETRY" || true

            # Add retry label to issue
            gh issue edit "$ISSUE_NUMBER" \
              --repo sovrium/sovrium \
              --add-label "code-retry:$NEXT_RETRY" || true

            # Get more detailed failure information
            FAILURE_DETAILS=$(gh pr checks "$PR_NUMBER" \
              --repo sovrium/sovrium \
              --json name,conclusion,detailsUrl \
              --jq '[.[] | select(.conclusion == "FAILURE" or .conclusion == "CANCELLED")] | map("\(.name): \(.conclusion)") | join(", ")' || echo "Unable to fetch details")

            # Get test failure summary from workflow run
            LATEST_RUN=$(gh run list \
              --repo sovrium/sovrium \
              --branch "$HEAD_REF" \
              --workflow "test.yml" \
              --limit 1 \
              --json conclusion,url,databaseId \
              --jq '.[0]' || echo "{}")

            RUN_URL=$(echo "$LATEST_RUN" | jq -r '.url' || echo "")
            RUN_ID=$(echo "$LATEST_RUN" | jq -r '.databaseId' || echo "")

            # Post retry comment on issue with enhanced diagnostics
            # Create the comment body with proper variable expansion
            if [ -n "$RUN_URL" ]; then
              FAILURE_LOG_LINK="- [View full test logs]($RUN_URL)"
            else
              FAILURE_LOG_LINK=""
            fi

            printf '%s\n' \
              "ðŸ”„ **Automatic Test Retry**" \
              "" \
              "**Reason**: Test workflow failed on PR #$PR_NUMBER" \
              "**Retry Attempt**: $NEXT_RETRY of $MAX_CODE_RETRIES" \
              "**Backoff Period**: Waited ${AGE_MINUTES} minutes (required: ${BACKOFF_MINUTES} minutes)" \
              "**Failed Checks**: $FAILURE_DETAILS" \
              "" \
              "@claude retry implementation - Please fix the failing tests and ensure all checks pass." \
              "" \
              "**ðŸ“‹ Failure Analysis:**" \
              "$FAILURE_LOG_LINK" \
              "- PR: #$PR_NUMBER" \
              "- Spec ID: Extract from title: $TITLE" \
              "- Previous retry attempts: $CURRENT_RETRY" \
              "" \
              "**ðŸ” Debugging Checklist:**" \
              "1. Check the [test logs in PR #$PR_NUMBER](https://github.com/sovrium/sovrium/pull/$PR_NUMBER/checks)" \
              "2. Look for specific test failures in the logs" \
              "3. Check if it's a flaky test or genuine implementation issue" \
              "4. Verify all dependencies are installed" \
              "5. Check for race conditions or timing issues" \
              "6. Review recent changes that might have affected this spec" \
              "" \
              "**âš¡ Quick Actions:**" \
              "- If tests are passing locally but failing in CI, check environment differences" \
              "- If it's a snapshot mismatch, run \`bun test:e2e:update-snapshots\`" \
              "- If it's a timeout, consider increasing test timeouts or optimizing the code" \
              "" \
              "---" \
              "*ðŸ¤– Automated Test Failure Handler - Retry $NEXT_RETRY/$MAX_CODE_RETRIES*" > /tmp/retry_comment.md

            gh issue comment "$ISSUE_NUMBER" \
              --repo sovrium/sovrium \
              --body-file /tmp/retry_comment.md || true

            echo "   âœ… Retry triggered for issue #$ISSUE_NUMBER"
            RETRY_TRIGGERED_COUNT=$((RETRY_TRIGGERED_COUNT + 1))
          done

          echo ""
          echo "ðŸ“Š Test Failure Summary:"
          echo "   Failed PRs found: $FAILED_COUNT"
          echo "   Retries triggered: $RETRY_TRIGGERED_COUNT"
          echo "   Daily retry total: $((DAILY_RETRIES + RETRY_TRIGGERED_COUNT)) / $MAX_DAILY_RETRIES"
          echo "   Retry strategy: Exponential backoff (5 â†’ 15 â†’ 45 minutes)"
          echo "âœ… Test failure monitoring complete"
