name: Test
permissions:
  contents: read
  actions: write
  issues: write
  pull-requests: write

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]

env:
  # Infrastructure retry configuration
  MAX_E2E_RETRIES: 2
  E2E_RETRY_DELAY_SECONDS: 30
  # Sharding configuration (4 shards √ó 2 workers = 8 effective workers)
  E2E_SHARD_TOTAL: 4

jobs:
  # ============================================================================
  # PARALLEL STATIC ANALYSIS JOBS
  # These run simultaneously to reduce wall-clock time
  # ============================================================================

  lint:
    name: Lint
    if: github.event_name == 'push' || github.event.action != 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Cache ESLint results
        uses: actions/cache@v4
        with:
          path: .eslintcache
          key: ${{ runner.os }}-eslint-${{ hashFiles('**/bun.lockb') }}-${{ hashFiles('eslint.config.ts') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-eslint-${{ hashFiles('**/bun.lockb') }}-${{ hashFiles('eslint.config.ts') }}-
            ${{ runner.os }}-eslint-${{ hashFiles('**/bun.lockb') }}-

      - name: Lint code
        run: bun run lint

  typecheck:
    name: TypeCheck
    if: github.event_name == 'push' || github.event.action != 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run typecheck

  unit-tests:
    name: Unit Tests
    if: github.event_name == 'push' || github.event.action != 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun test:unit

      - name: Validate spec counts
        run: bun run validate:spec-counts

  # ============================================================================
  # E2E TESTS WITH SHARDING
  # 4 shards running in parallel, each with 2 workers = 8 effective workers
  # ============================================================================

  e2e:
    name: E2E Shard ${{ matrix.shard }}/${{ matrix.total }}
    if: github.event_name == 'push' || github.event.action != 'closed'
    needs: [lint, typecheck, unit-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
        total: [4]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(bun pm ls @playwright/test | grep '@playwright/test' | awk '{print $2}' | head -n 1)" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps chromium

      - name: Pre-pull Docker images
        run: |
          echo "üê≥ Pre-pulling Docker images..."
          docker pull axllent/mailpit:latest &
          docker pull postgres:16-alpine &
          wait
          echo "‚úÖ Docker images ready"

      - name: Verify Docker ready
        run: |
          docker info > /dev/null 2>&1 || { echo "‚ùå Docker not running"; exit 1; }
          echo "‚úÖ Docker daemon ready"

      - name: Run E2E tests (shard ${{ matrix.shard }}/${{ matrix.total }})
        id: e2e
        run: |
          echo "üß™ Running E2E shard ${{ matrix.shard }} of ${{ matrix.total }}..."
          bunx playwright test --grep "@regression" --shard=${{ matrix.shard }}/${{ matrix.total }}
        continue-on-error: true
        env:
          # Use 2 workers per shard (4 shards √ó 2 workers = 8 effective workers)
          CI_WORKERS: 2

      - name: Retry E2E tests on failure
        id: e2e-retry
        if: steps.e2e.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è E2E shard ${{ matrix.shard }} failed, retrying..."
          sleep ${{ env.E2E_RETRY_DELAY_SECONDS }}

          # Cleanup stale containers
          docker ps -aq --filter "name=sovrium-" | xargs -r docker rm -f 2>/dev/null || true
          docker ps -aq --filter "name=mailpit" | xargs -r docker rm -f 2>/dev/null || true

          echo "üîÑ Retrying shard ${{ matrix.shard }}..."
          bunx playwright test --grep "@regression" --shard=${{ matrix.shard }}/${{ matrix.total }}
        env:
          CI_WORKERS: 2

      - name: E2E shard final status
        if: always()
        run: |
          if [ "${{ steps.e2e.outcome }}" = "success" ]; then
            echo "‚úÖ Shard ${{ matrix.shard }} passed on first attempt"
          elif [ "${{ steps.e2e-retry.outcome }}" = "success" ]; then
            echo "‚úÖ Shard ${{ matrix.shard }} passed on retry"
          else
            echo "‚ùå Shard ${{ matrix.shard }} failed"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # E2E RESULTS AGGREGATION
  # Merges results from all shards and handles regression classification
  # ============================================================================

  e2e-results:
    name: E2E Results
    if: always() && (github.event_name == 'push' || github.event.action != 'closed')
    needs: [e2e]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      e2e_failed: ${{ steps.check.outputs.e2e_failed }}
      has_regressions: ${{ steps.classify-failures.outputs.has_regressions }}
      regression_specs: ${{ steps.classify-failures.outputs.regression_specs }}
      target_spec: ${{ steps.classify-failures.outputs.target_spec }}
      failure_type: ${{ steps.classify-failures.outputs.failure_type }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-shard-*
          path: all-test-results/
          merge-multiple: false

      - name: Check E2E results
        id: check
        run: |
          echo "üìä Checking E2E shard results..."

          # Check if any shard failed
          FAILED="false"
          if [ "${{ needs.e2e.result }}" = "failure" ]; then
            FAILED="true"
            echo "‚ùå One or more E2E shards failed"
          else
            echo "‚úÖ All E2E shards passed"
          fi

          echo "e2e_failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Classify test failures
        id: classify-failures
        if: |
          needs.e2e.result == 'failure' &&
          contains(github.event.pull_request.labels.*.name, 'tdd-automation')
        env:
          GH_TOKEN: ${{ github.token }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "üîç Classifying test failures for TDD automation PR..."

          # Extract target spec from PR body
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oP 'Closes #\K[0-9]+' | head -1 || echo "")
          TARGET_SPEC=""

          if [ -n "$ISSUE_NUMBER" ]; then
            echo "üìã Found linked issue: #$ISSUE_NUMBER"
            ISSUE_BODY=$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body' 2>/dev/null || echo "")
            TARGET_SPEC=$(echo "$ISSUE_BODY" | grep -oP '\*\*File\*\*:\s*`\K[^`]+' | head -1 || echo "")

            if [ -z "$TARGET_SPEC" ]; then
              TARGET_SPEC=$(echo "$ISSUE_BODY" | grep -oP 'specs/[^\s:]+\.spec\.ts' | head -1 || echo "")
            fi
            echo "üéØ Target spec: $TARGET_SPEC"
          fi

          # Parse failed tests from merged test results
          FAILED_SPECS=""
          if [ -d "all-test-results" ]; then
            FAILED_SPECS=$(find all-test-results -type d -name "*.spec.ts*" 2>/dev/null | \
              sed 's|.*/test-results-shard-[0-9]*/||' | \
              sed 's|-chromium.*||' | \
              sed 's|--.*||' | \
              tr '-' '/' | \
              sed 's|^|specs/|' | \
              sed 's|$|.spec.ts|' | \
              sort -u | tr '\n' ',' | sed 's/,$//')
          fi

          if [ -z "$FAILED_SPECS" ]; then
            FAILED_SPECS="unknown"
          fi

          echo "‚ùå Failed specs: $FAILED_SPECS"

          # Classify failures
          HAS_REGRESSIONS="false"
          REGRESSION_SPECS=""
          FAILURE_TYPE="unknown"

          if [ -n "$TARGET_SPEC" ] && [ "$FAILED_SPECS" != "unknown" ]; then
            IFS=',' read -ra SPECS_ARRAY <<< "$FAILED_SPECS"
            for spec in "${SPECS_ARRAY[@]}"; do
              spec=$(echo "$spec" | xargs)
              if [ -n "$spec" ] && [ "$spec" != "$TARGET_SPEC" ]; then
                HAS_REGRESSIONS="true"
                if [ -z "$REGRESSION_SPECS" ]; then
                  REGRESSION_SPECS="$spec"
                else
                  REGRESSION_SPECS="$REGRESSION_SPECS,$spec"
                fi
              fi
            done

            if [ "$HAS_REGRESSIONS" = "true" ]; then
              if echo "$FAILED_SPECS" | grep -q "$TARGET_SPEC"; then
                FAILURE_TYPE="mixed"
              else
                FAILURE_TYPE="regression_only"
              fi
            else
              FAILURE_TYPE="target_only"
            fi
          fi

          echo ""
          echo "üìä Classification Results:"
          echo "  Target spec: $TARGET_SPEC"
          echo "  Failed specs: $FAILED_SPECS"
          echo "  Has regressions: $HAS_REGRESSIONS"
          echo "  Regression specs: $REGRESSION_SPECS"
          echo "  Failure type: $FAILURE_TYPE"

          echo "has_regressions=$HAS_REGRESSIONS" >> $GITHUB_OUTPUT
          echo "regression_specs=$REGRESSION_SPECS" >> $GITHUB_OUTPUT
          echo "target_spec=$TARGET_SPEC" >> $GITHUB_OUTPUT
          echo "failure_type=$FAILURE_TYPE" >> $GITHUB_OUTPUT

      - name: Fail if E2E tests failed
        if: needs.e2e.result == 'failure'
        run: |
          echo "‚ùå E2E tests failed - see individual shard results for details"
          exit 1

  # ============================================================================
  # TDD AUTOMATION JOBS
  # ============================================================================

  close-tdd-issue:
    name: Close TDD Issue on PR Merge
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'tdd-automation')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Extract issue number from PR body
        id: issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -o 'Closes #[0-9]*' | head -1 | grep -o '[0-9]*' || echo "")

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ö†Ô∏è No issue number found in PR body"
            echo "has_issue=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found issue #$ISSUE_NUMBER"
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Close issue
        if: steps.issue.outputs.has_issue == 'true'
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.issue_number }}"

          gh issue close "$ISSUE_NUMBER" --reason completed
          gh issue edit "$ISSUE_NUMBER" --add-label "tdd-spec:completed"
          gh issue edit "$ISSUE_NUMBER" --remove-label "tdd-spec:in-progress"

          echo "‚úÖ Closed issue #$ISSUE_NUMBER"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

  verify-issue-closed:
    name: Verify TDD Issue Closed After Merge
    needs: close-tdd-issue
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'tdd-automation')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Extract issue number from PR body
        id: issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -o 'Closes #[0-9]*' | head -1 | grep -o '[0-9]*' || echo "")

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ö†Ô∏è No issue number found in PR body - skipping verification"
            echo "has_issue=false" >> $GITHUB_OUTPUT
          else
            echo "üîç Found issue #$ISSUE_NUMBER - verifying closure"
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Verify issue is closed
        if: steps.issue.outputs.has_issue == 'true'
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.issue_number }}"

          echo "üîç Checking if issue #$ISSUE_NUMBER is closed..."

          ISSUE_DATA=$(gh issue view "$ISSUE_NUMBER" --json state,labels --jq '{state: .state, labels: [.labels[].name]}')
          STATE=$(echo "$ISSUE_DATA" | jq -r '.state')
          LABELS=$(echo "$ISSUE_DATA" | jq -r '.labels | join(", ")')

          echo "  Current state: $STATE"
          echo "  Current labels: $LABELS"

          if [ "$STATE" = "CLOSED" ]; then
            HAS_COMPLETED=$(echo "$LABELS" | grep -c "tdd-spec:completed" || echo "0")
            HAS_IN_PROGRESS=$(echo "$LABELS" | grep -c "tdd-spec:in-progress" || echo "0")

            if [ "$HAS_COMPLETED" -eq 1 ] && [ "$HAS_IN_PROGRESS" -eq 0 ]; then
              echo "‚úÖ Issue #$ISSUE_NUMBER is properly closed with correct labels"
            else
              echo "‚ö†Ô∏è Issue #$ISSUE_NUMBER is closed but has incorrect labels - fixing..."
              gh issue edit "$ISSUE_NUMBER" --add-label "tdd-spec:completed" || true
              gh issue edit "$ISSUE_NUMBER" --remove-label "tdd-spec:in-progress" || true
              echo "‚úÖ Fixed labels on issue #$ISSUE_NUMBER"
            fi
          else
            echo "‚ùå CRITICAL: Issue #$ISSUE_NUMBER failed to close - forcing closure"

            gh issue close "$ISSUE_NUMBER" --reason completed || {
              echo "‚ùå Failed to close issue - retrying with gh api..."
              gh api --method PATCH "/repos/${{ github.repository }}/issues/$ISSUE_NUMBER" \
                -f state='closed' \
                -f state_reason='completed'
            }

            gh issue edit "$ISSUE_NUMBER" --add-label "tdd-spec:completed" || true
            gh issue edit "$ISSUE_NUMBER" --remove-label "tdd-spec:in-progress" || true

            NEW_STATE=$(gh issue view "$ISSUE_NUMBER" --json state --jq '.state')
            if [ "$NEW_STATE" = "CLOSED" ]; then
              echo "‚úÖ Successfully force-closed issue #$ISSUE_NUMBER"
              echo "üîì Queue unblocked - processor can continue with next spec"
            else
              echo "‚ùå FAILED to close issue #$ISSUE_NUMBER - manual intervention required"
              echo "::error::Failed to close issue #$ISSUE_NUMBER after PR merge - queue may be blocked"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

  delete-tdd-branch:
    name: Delete TDD Branch on PR Close
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == false &&
      (startsWith(github.event.pull_request.head.ref, 'tdd/') ||
       startsWith(github.event.pull_request.head.ref, 'claude/'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete branch
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "üóëÔ∏è  Deleting unmerged branch: $BRANCH"

          gh api \
            --method DELETE \
            /repos/${{ github.repository }}/git/refs/heads/$BRANCH \
            && echo "‚úÖ Branch deleted successfully" \
            || echo "‚ö†Ô∏è  Branch may already be deleted"
        env:
          GH_TOKEN: ${{ github.token }}

  handle-regressions:
    name: Handle TDD Regressions
    needs: e2e-results
    if: |
      failure() &&
      needs.e2e-results.outputs.has_regressions == 'true' &&
      contains(github.event.pull_request.labels.*.name, 'tdd-automation')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Add regression label to PR
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "üè∑Ô∏è  Adding failure:regression label to PR #$PR_NUMBER"
          gh pr edit "$PR_NUMBER" --add-label "failure:regression" || true

      - name: Extract issue and failure details
        id: details
        env:
          GH_TOKEN: ${{ github.token }}
          PR_BODY: ${{ github.event.pull_request.body }}
          REGRESSION_SPECS: ${{ needs.e2e-results.outputs.regression_specs }}
          TARGET_SPEC: ${{ needs.e2e-results.outputs.target_spec }}
          FAILURE_TYPE: ${{ needs.e2e-results.outputs.failure_type }}
        run: |
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oP 'Closes #\K[0-9]+' | head -1 || echo "")
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          SPEC_ID=""
          if [ -n "$ISSUE_NUMBER" ]; then
            ISSUE_TITLE=$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title' 2>/dev/null || echo "")
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oP '[A-Z]+-[A-Z]+-[0-9]+' | head -1 || echo "unknown")
          fi
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT

          echo ""
          echo "üìã Regression Details:"
          echo "  Issue: #$ISSUE_NUMBER"
          echo "  Spec ID: $SPEC_ID"
          echo "  Target spec: $TARGET_SPEC"
          echo "  Regression specs: $REGRESSION_SPECS"
          echo "  Failure type: $FAILURE_TYPE"

      - name: Post regression fix instructions to PR
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ISSUE_NUMBER: ${{ steps.details.outputs.issue_number }}
          SPEC_ID: ${{ steps.details.outputs.spec_id }}
          REGRESSION_SPECS: ${{ needs.e2e-results.outputs.regression_specs }}
          TARGET_SPEC: ${{ needs.e2e-results.outputs.target_spec }}
          FAILURE_TYPE: ${{ needs.e2e-results.outputs.failure_type }}
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          cat << 'EOF' > /tmp/comment.md
          ## üîß Regression Detected - Auto-Fix Required

          @claude This PR has **regressions** - tests failing in files OTHER than the target spec.

          ### üìä Failure Analysis
          - **Target Spec**: `$TARGET_SPEC`
          - **Regression Specs**: `$REGRESSION_SPECS`
          - **Failure Type**: `$FAILURE_TYPE`
          - **Spec ID**: `$SPEC_ID`
          - **Issue**: #$ISSUE_NUMBER

          ### ü§ñ Auto-Fix Instructions

          **CRITICAL**: Your changes broke tests in other files. This is a **regression** that must be fixed.

          1. **Analyze the regression cause**:
             - Run `bun test:e2e -- $REGRESSION_SPECS` to see the failing tests
             - Check what code you changed that could affect these tests
             - Look for **catch-all patterns** that are too greedy

          2. **Fix the regression** without modifying the failing tests

          3. **Verify the fix**:
             ```bash
             bun run quality
             bun test:e2e:regression
             ```

          4. **Push the fix**:
             ```bash
             bun run license
             git add -A
             git commit -m "fix: resolve regression in $SPEC_ID"
             git push
             ```

          ---
          *ü§ñ Regression Handler - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF

          envsubst < /tmp/comment.md > /tmp/comment_final.md
          gh pr comment "$PR_NUMBER" --body-file /tmp/comment_final.md
          echo "‚úÖ Posted regression fix instructions to PR #$PR_NUMBER"

      - name: Update issue with regression status
        if: steps.details.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.details.outputs.issue_number }}
          REGRESSION_SPECS: ${{ needs.e2e-results.outputs.regression_specs }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "‚ö†Ô∏è **Regression Detected**

          The PR for this spec has introduced regressions in other test files:
          - **Regression specs**: \`$REGRESSION_SPECS\`

          Claude Code will attempt to auto-fix the regression.

          ---
          *ü§ñ Regression Handler*"

          gh issue edit "$ISSUE_NUMBER" --add-label "failure:regression" || true
