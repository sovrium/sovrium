# TDD - Dispatch (Queue Processing) - Refactored Version
#
# This workflow processes the TDD spec queue by:
# 1. Checking if queue is paused (credit exhaustion)
# 2. Validating the next queued spec
# 3. Triggering Claude Code execution via @claude comment
#
# REFACTORED: Uses TypeScript CLI commands instead of inline bash
# See: scripts/tdd-automation/cli/tdd-dispatch.ts

name: TDD - Dispatch (Queue Processing) v2

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to process (optional)'
        required: false
        type: number

concurrency:
  group: tdd-dispatch
  cancel-in-progress: false

env:
  COOLDOWN_MINUTES: 30

jobs:
  # Job 1: Check if queue is paused
  check-paused:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      issues: read
    outputs:
      paused: ${{ steps.check.outputs.paused }}
      pause_issue: ${{ steps.check.outputs.pause_issue }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check if queue is paused
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: bun run scripts/tdd-automation/cli/tdd-dispatch.ts check-paused

  # Job 2: Get next spec from queue
  get-next-spec:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-paused]
    if: needs.check-paused.outputs.paused != 'true'
    permissions:
      issues: read
    outputs:
      issue_number: ${{ steps.get-spec.outputs.issue_number }}
      spec_id: ${{ steps.get-spec.outputs.spec_id }}
      has_spec: ${{ steps.get-spec.outputs.has_spec }}
    steps:
      - name: Get next queued spec
        id: get-spec
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_ISSUE: ${{ github.event.inputs.issue_number }}
        run: |
          # If specific issue provided, use that
          if [ -n "$INPUT_ISSUE" ] && [ "$INPUT_ISSUE" != "0" ]; then
            echo "Using specified issue: $INPUT_ISSUE"
            echo "issue_number=$INPUT_ISSUE" >> $GITHUB_OUTPUT
            echo "has_spec=true" >> $GITHUB_OUTPUT

            # Get spec ID from issue title
            SPEC_ID=$(gh issue view "$INPUT_ISSUE" --json title --jq '.title | split(" ")[1] | gsub(":"; "")')
            echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get oldest queued spec
          ISSUE=$(gh issue list \
            --label "tdd-spec:queued" \
            --state open \
            --json number,title,updatedAt \
            --jq 'sort_by(.updatedAt) | .[0]')

          if [ -z "$ISSUE" ] || [ "$ISSUE" = "null" ]; then
            echo "No queued specs found"
            echo "has_spec=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          ISSUE_NUMBER=$(echo "$ISSUE" | jq -r '.number')
          TITLE=$(echo "$ISSUE" | jq -r '.title')
          SPEC_ID=$(echo "$TITLE" | sed 's/ðŸ¤– \([A-Z-]*-[0-9]*\):.*/\1/')

          echo "Found queued spec: #$ISSUE_NUMBER - $SPEC_ID"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "has_spec=true" >> $GITHUB_OUTPUT

  # Job 3: Validate the spec
  validate-spec:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-paused, get-next-spec]
    if: |
      needs.check-paused.outputs.paused != 'true' &&
      needs.get-next-spec.outputs.has_spec == 'true'
    permissions:
      issues: read
      pull-requests: read
    outputs:
      should_process: ${{ steps.validate.outputs.should_process }}
      reason: ${{ steps.validate.outputs.reason }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate issue state
        id: validate-issue
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ needs.get-next-spec.outputs.issue_number }}
        run: bun run scripts/tdd-automation/cli/tdd-dispatch.ts validate-issue

      - name: Check if superseded
        id: check-superseded
        if: steps.validate-issue.outputs.should_process == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          SPEC_ID: ${{ needs.get-next-spec.outputs.spec_id }}
        run: bun run scripts/tdd-automation/cli/tdd-dispatch.ts check-superseded

      - name: Check cooldown
        id: check-cooldown
        if: |
          steps.validate-issue.outputs.should_process == 'true' &&
          steps.check-superseded.outputs.is_superseded != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ needs.get-next-spec.outputs.issue_number }}
          COOLDOWN_MINUTES: ${{ env.COOLDOWN_MINUTES }}
        run: bun run scripts/tdd-automation/cli/tdd-dispatch.ts check-cooldown

      - name: Determine final validation result
        id: validate
        run: |
          # Check issue validation
          if [ "${{ steps.validate-issue.outputs.should_process }}" != "true" ]; then
            echo "should_process=false" >> $GITHUB_OUTPUT
            echo "reason=${{ steps.validate-issue.outputs.reason }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if superseded
          if [ "${{ steps.check-superseded.outputs.is_superseded }}" = "true" ]; then
            echo "should_process=false" >> $GITHUB_OUTPUT
            echo "reason=superseded" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check cooldown
          if [ "${{ steps.check-cooldown.outputs.in_cooldown }}" = "true" ]; then
            echo "should_process=false" >> $GITHUB_OUTPUT
            echo "reason=in_cooldown" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_process=true" >> $GITHUB_OUTPUT
          echo "reason=valid" >> $GITHUB_OUTPUT

  # Job 4: Trigger Claude Code execution
  trigger-execution:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-paused, get-next-spec, validate-spec]
    if: |
      needs.check-paused.outputs.paused != 'true' &&
      needs.get-next-spec.outputs.has_spec == 'true' &&
      needs.validate-spec.outputs.should_process == 'true'
    permissions:
      issues: write
    steps:
      - name: Mark spec as in-progress
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ needs.get-next-spec.outputs.issue_number }}
        run: |
          echo "Marking issue #$ISSUE_NUMBER as in-progress"
          gh issue edit "$ISSUE_NUMBER" \
            --remove-label "tdd-spec:queued" \
            --add-label "tdd-spec:in-progress" 2>/dev/null || true

      - name: Trigger Claude Code via comment
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
          ISSUE_NUMBER: ${{ needs.get-next-spec.outputs.issue_number }}
          SPEC_ID: ${{ needs.get-next-spec.outputs.spec_id }}
        run: |
          echo "Triggering Claude Code for issue #$ISSUE_NUMBER"

          gh issue comment "$ISSUE_NUMBER" --body "@claude Please implement the spec \`$SPEC_ID\` as described in this issue.

          **Instructions:**
          1. Create a branch: \`claude/issue-${ISSUE_NUMBER}-$(date +%s)\`
          2. Remove the \`.fixme()\` marker from the test
          3. Implement the minimal code to make the test pass
          4. Run \`bun run quality\` and \`bun run license\`
          5. Commit and push the changes
          6. Create a PR that closes this issue

          ---
          *TDD Dispatch v2*"

  # Job 5: Handle skipped specs
  handle-skipped:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-paused, get-next-spec, validate-spec]
    if: |
      needs.get-next-spec.outputs.has_spec == 'true' &&
      needs.validate-spec.outputs.should_process != 'true'
    permissions:
      issues: write
    steps:
      - name: Handle superseded spec
        if: needs.validate-spec.outputs.reason == 'superseded'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ needs.get-next-spec.outputs.issue_number }}
        run: |
          echo "Marking issue #$ISSUE_NUMBER as superseded"
          gh issue edit "$ISSUE_NUMBER" \
            --remove-label "tdd-spec:queued" \
            --add-label "tdd-spec:completed" 2>/dev/null || true

          gh issue comment "$ISSUE_NUMBER" --body "**Spec Already Implemented**

          This spec no longer has \`.fixme()\` marker - it has been implemented elsewhere.

          Closing as completed.

          ---
          *TDD Dispatch v2*"

          gh issue close "$ISSUE_NUMBER"

      - name: Log cooldown skip
        if: needs.validate-spec.outputs.reason == 'in_cooldown'
        env:
          ISSUE_NUMBER: ${{ needs.get-next-spec.outputs.issue_number }}
        run: |
          echo "Issue #$ISSUE_NUMBER is in cooldown period, skipping"

      - name: Log validation failure
        if: |
          needs.validate-spec.outputs.reason != 'superseded' &&
          needs.validate-spec.outputs.reason != 'in_cooldown'
        env:
          ISSUE_NUMBER: ${{ needs.get-next-spec.outputs.issue_number }}
          REASON: ${{ needs.validate-spec.outputs.reason }}
        run: |
          echo "Issue #$ISSUE_NUMBER validation failed: $REASON"

  # Job 6: Summary
  summary:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [check-paused, get-next-spec, validate-spec, trigger-execution, handle-skipped]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“‹ TDD Dispatch Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-paused.outputs.paused }}" = "true" ]; then
            echo "â¸ï¸ **Queue is paused** (issue #${{ needs.check-paused.outputs.pause_issue }})" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          if [ "${{ needs.get-next-spec.outputs.has_spec }}" != "true" ]; then
            echo "âœ… **No queued specs** - queue is empty" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "### Spec Processing" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Issue | #${{ needs.get-next-spec.outputs.issue_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Spec ID | ${{ needs.get-next-spec.outputs.spec_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Valid | ${{ needs.validate-spec.outputs.should_process }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-spec.outputs.should_process }}" = "true" ]; then
            echo "| Status | ðŸš€ Triggered |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | â­ï¸ Skipped (${{ needs.validate-spec.outputs.reason }}) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by TDD Dispatch v2*" >> $GITHUB_STEP_SUMMARY
