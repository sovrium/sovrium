name: TDD Queue - Daily Refactor

# Purpose: Automated daily codebase refactoring
# - Waits for TDD queue to become clean (no in-progress specs, no open PRs)
# - Runs codebase-refactor-auditor agent
# - Creates PR with auto-merge enabled
# - Monday-Saturday: Incremental (last 24h changes)
# - Sunday: Full codebase audit

on:
  # Scheduled runs - Daily at 1:30 AM UTC (runs AFTER populate at 1:00 AM)
  # Rationale: Populate adds specs first, then refactor waits for clean queue
  schedule:
    - cron: '30 1 * * *'

  # Manual trigger for testing
  workflow_dispatch:

# Security: Define minimal required permissions
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  # Phase 1: Wait for clean state (NO queue lock - allows queue to continue)
  wait-for-clean:
    name: ‚è≥ Wait for Clean State
    runs-on: ubuntu-latest
    timeout-minutes: 150 # 2.5 hours max wait
    outputs:
      should_proceed: ${{ steps.wait.outputs.clean }}
      scope: ${{ steps.scope.outputs.type }}
      branch_name: ${{ steps.scope.outputs.branch }}
      scope_description: ${{ steps.scope.outputs.description }}

    steps:
      - name: Wait for TDD queue to become clean
        id: wait
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "‚è≥ Waiting for TDD queue to become clean..."
          echo "   Checking for in-progress specs and open TDD PRs..."

          MAX_WAIT_SECONDS=7200  # 2 hours max wait
          POLL_INTERVAL=300       # 5 minutes between checks
          WAITED=0

          while [ $WAITED -lt $MAX_WAIT_SECONDS ]; do
            # Check in-progress specs
            IN_PROGRESS=$(gh issue list --label "tdd-spec:in-progress" --json number --jq 'length' 2>/dev/null || echo "0")

            # Check open TDD PRs
            OPEN_PRS=$(gh pr list --label "tdd-automation" --state open --json number --jq 'length' 2>/dev/null || echo "0")

            if [ "$IN_PROGRESS" -eq 0 ] && [ "$OPEN_PRS" -eq 0 ]; then
              echo "‚úÖ Queue is clean - ready to proceed with refactor"
              echo "clean=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "‚è∏Ô∏è  Queue active: $IN_PROGRESS specs in-progress, $OPEN_PRS PRs open"
            echo "   Next check in 5 minutes... (${WAITED}s / ${MAX_WAIT_SECONDS}s elapsed)"

            sleep $POLL_INTERVAL
            WAITED=$((WAITED + POLL_INTERVAL))
          done

          # Timed out waiting for clean state
          echo "‚è±Ô∏è  Timeout: Queue did not become clean after 2 hours"
          echo "   Skipping refactor, will try again tomorrow at 2 AM UTC"
          echo "clean=false" >> $GITHUB_OUTPUT

      - name: Determine refactor scope
        id: scope
        if: steps.wait.outputs.clean == 'true'
        run: |
          DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday
          TIMESTAMP=$(date +%Y%m%d)

          if [ "$DAY_OF_WEEK" -eq 7 ]; then
            # Sunday: Full codebase audit
            echo "type=weekly" >> $GITHUB_OUTPUT
            echo "branch=refactor/weekly-$TIMESTAMP" >> $GITHUB_OUTPUT
            echo "description=Full codebase audit (weekly comprehensive review)" >> $GITHUB_OUTPUT
            echo "üìÖ Sunday - Scheduling full codebase audit"
          else
            # Monday-Saturday: Incremental refactor
            echo "type=daily" >> $GITHUB_OUTPUT
            echo "branch=refactor/daily-$TIMESTAMP" >> $GITHUB_OUTPUT
            echo "description=Incremental refactor (files changed in last 24 hours)" >> $GITHUB_OUTPUT
            echo "üìÖ Weekday - Scheduling incremental refactor"
          fi

  # Phase 2: Run refactor (ACQUIRES queue lock - blocks queue processor)
  refactor:
    name: üîÑ Automated Refactor
    needs: wait-for-clean
    if: needs.wait-for-clean.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 2 hours max for refactor execution

    # IMPORTANT: Acquire TDD queue lock to block queue processor during refactor
    concurrency:
      group: tdd-queue
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git operations

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "‚úÖ Git configured for automated commits"

      - name: Create refactor branch
        id: branch
        env:
          BRANCH_NAME: ${{ needs.wait-for-clean.outputs.branch_name }}
        run: |
          echo "üåø Creating branch: $BRANCH_NAME"

          # Ensure we're on main and up-to-date
          git checkout main
          git pull origin main

          # Delete branch if it exists (cleanup from previous failed run)
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

          # Create new branch
          git checkout -b "$BRANCH_NAME"

          echo "‚úÖ Branch created: $BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run Claude Code with codebase-refactor-auditor
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Additional permissions for Claude to read CI results
          additional_permissions: |
            actions: read

          # Automated refactoring prompt - using | for proper multiline formatting
          prompt: |
            # Automated Refactoring Workflow - ${{ needs.wait-for-clean.outputs.scope }}

            ## üìã Context
            - **Scope**: ${{ needs.wait-for-clean.outputs.scope_description }}
            - **Branch**: ${{ needs.wait-for-clean.outputs.branch_name }}
            - **Mode**: FULLY AUTOMATED (pipeline mode)

            ## ü§ñ Automation Mode
            **You are in pipeline/automation mode**:
            - ‚úÖ Make autonomous decisions - no human approval needed
            - ‚úÖ Apply safe refactors that maintain test coverage
            - ‚ùå DO NOT ask questions - proceed with best judgment
            - ‚ùå DO NOT apply Phase 1.2 recommendations (require manual approval)

            ## ‚úÖ Critical Steps (ALL REQUIRED)

            1. **Run codebase-refactor-auditor agent** - Use `Task` tool with `subagent_type='codebase-refactor-auditor'` in automated/pipeline mode
            2. **Apply Phase 1.1 refactors only** - Safe, automated changes that maintain test coverage
            3. **Verify layer architecture** - Ensure NO cross-layer import violations (domain must be pure)
            4. **Run quality checks** - Execute `bun run quality` and confirm ALL checks pass (ESLint, TypeScript, unit tests, E2E regression)
            5. **Commit changes** - Run `bun run license`, then commit with message: "refactor: automated ${{ needs.wait-for-clean.outputs.scope }} maintenance"
            6. **Create PR** - `gh pr create --base main --label "automated-refactor" --title "refactor: automated ${{ needs.wait-for-clean.outputs.scope }} maintenance"`
            7. **Enable auto-merge** - `gh pr merge $PR_NUMBER --auto --squash`
            8. **Verify auto-merge** - Run `gh pr view $PR_NUMBER --json autoMergeRequest` and confirm autoMergeRequest is NOT null

            ## ‚ö†Ô∏è Error Handling

            - **If `bun run quality` fails**: Do NOT create PR - fix the issues first or skip the refactoring
            - **If layer architecture violations found**: Fix them before proceeding - this is critical
            - **If no changes needed**: Report "No refactoring needed - codebase is clean" and exit successfully (no PR)
            - **If PR creation fails**: Retry once, then exit with error

            ## üö´ DO NOT

            - Do NOT apply Phase 1.2 recommendations (they require manual approval)
            - Do NOT create PR with failing tests
            - Do NOT skip the quality verification step
            - Do NOT modify files outside src/ directory

            **Reference**: @docs/development/tdd-automation-pipeline.md

          # Agent auto-discovery from .claude/agents/ directory
          claude_args: '--dangerously-skip-permissions'

      - name: Verify refactor completed
        id: verify
        if: always()
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîç Verifying refactor status..."

          # Check if PR was created
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "‚ö†Ô∏è  No PR created - refactor may have found no issues to fix"
            echo "   This is normal if codebase is already clean"
            echo "pr_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ PR #$PR_NUMBER created successfully"
          echo "pr_created=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Check PR status
          PR_STATUS=$(gh pr view "$PR_NUMBER" --json state --jq '.state')
          echo "   PR State: $PR_STATUS"

      - name: Handle validation failure
        if: failure() && steps.verify.outputs.pr_created == 'true'
        env:
          PR_NUMBER: ${{ steps.verify.outputs.pr_number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "‚ùå Refactor validation failed - converting PR to draft"

          # Convert to draft
          gh pr ready "$PR_NUMBER" --undo 2>/dev/null || true

          # Add needs-review label
          gh pr edit "$PR_NUMBER" --add-label "refactor:needs-review"

          # Add comment explaining failure
          gh pr comment "$PR_NUMBER" --body "‚ö†Ô∏è **Automated refactor failed validation**

          This PR was created by the daily automated refactoring workflow but failed quality checks.

          **Next Steps**:
          1. Review the failed checks in the PR
          2. Fix issues manually if needed
          3. Push fixes to this branch
          4. Remove draft status and re-enable auto-merge when ready

          The TDD queue will resume normal operation regardless of this failure.

          ---
          ü§ñ Automated Refactor Workflow"

          echo "‚úÖ PR marked for manual review"

      - name: Summary
        if: always()
        run: |
          echo "üìä Daily Refactor Summary"
          echo "========================"
          echo "Scope: ${{ needs.wait-for-clean.outputs.scope }}"
          echo "Branch: ${{ needs.wait-for-clean.outputs.branch_name }}"
          echo "PR Created: ${{ steps.verify.outputs.pr_created }}"
          if [ "${{ steps.verify.outputs.pr_created }}" = "true" ]; then
            echo "PR Number: #${{ steps.verify.outputs.pr_number }}"
          fi
          echo ""
          echo "TDD queue will resume normal processing"
