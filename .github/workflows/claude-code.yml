name: Claude Code

on:
  issue_comment:
    types: [created]

# Required permissions for Claude Code Action
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write  # Required for OIDC authentication

jobs:
  # ============================================================================
  # JOB 1: VALIDATE TRIGGER
  #
  # Pre-conditions:
  # 1. Comment author is thomas-jeanneau (TDD bot account)
  # 2. PR has tdd-automation label
  # 3. Credit limits not exceeded
  # ============================================================================
  validate:
    name: Validate Trigger
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '@claude') &&
      github.event.comment.user.login == 'thomas-jeanneau'
    runs-on: ubuntu-latest
    outputs:
      is-valid: ${{ steps.validate.outputs.is-valid }}
      pr-number: ${{ github.event.issue.number }}
      pr-branch: ${{ steps.pr-info.outputs.branch }}
      agent-type: ${{ steps.parse.outputs.agent-type }}
      spec-file: ${{ steps.parse.outputs.spec-file }}
      spec-id: ${{ steps.parse.outputs.spec-id }}
      timeout: ${{ steps.config.outputs.timeout }}
    steps:
      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          PR_DATA=$(gh pr view "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --json headRefName,labels)
          BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          HAS_LABEL=$(echo "$PR_DATA" | jq -r '.labels[].name' | grep -c "tdd-automation" || echo "0")
          IS_TDD_BRANCH=$(echo "$BRANCH" | grep -c "^tdd/" || echo "0")

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          if [ "$HAS_LABEL" -gt 0 ] || [ "$IS_TDD_BRANCH" -gt 0 ]; then
            echo "is-tdd=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-tdd=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ Not a TDD PR - skipping"
          fi

      - name: Parse @claude comment
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Extract agent type from comment
          if echo "$COMMENT_BODY" | grep -q "e2e-test-fixer"; then
            echo "agent-type=e2e-test-fixer" >> "$GITHUB_OUTPUT"
          elif echo "$COMMENT_BODY" | grep -q "codebase-refactor-auditor"; then
            echo "agent-type=codebase-refactor-auditor" >> "$GITHUB_OUTPUT"
          else
            echo "agent-type=e2e-test-fixer" >> "$GITHUB_OUTPUT"  # Default
          fi

          # Extract spec file if mentioned (format: `specs/...`)
          # shellcheck disable=SC2016
          SPEC_FILE=$(echo "$COMMENT_BODY" | grep -oP 'File: `\K[^`]+' | head -1 || echo "")
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(echo "$COMMENT_BODY" | grep -oP '`specs/[^`]+`' | tr -d '`' | head -1 || echo "")
          fi
          echo "spec-file=$SPEC_FILE" >> "$GITHUB_OUTPUT"

          # Extract spec ID (format: Spec: `SPEC-ID`)
          SPEC_ID=$(echo "$COMMENT_BODY" | grep -oP 'Spec: `\K[^`]+' | head -1 || echo "")
          echo "spec-id=$SPEC_ID" >> "$GITHUB_OUTPUT"

          echo "ðŸ“‹ Parsed: agent=${{ steps.parse.outputs.agent-type || 'e2e-test-fixer' }}, spec-file=$SPEC_FILE, spec-id=$SPEC_ID"

      - name: Check credit limits
        id: credits
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          # Secondary credit check (defense in depth with pr-creator.yml)
          # Query successful claude-code.yml runs from past 24 hours
          DAILY_RUNS=$(gh run list --repo "${{ github.repository }}" --workflow="claude-code.yml" \
            --created ">$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)" \
            --json databaseId,conclusion --jq '[.[] | select(.conclusion == "success")] | length' 2>/dev/null || echo "0")

          # Estimate cost ($15 fallback per run - conservative)
          ESTIMATED_DAILY=$((DAILY_RUNS * 15))

          echo "ðŸ“Š Estimated daily spend: ~\$$ESTIMATED_DAILY (based on $DAILY_RUNS successful runs)"

          if [ "$ESTIMATED_DAILY" -ge 100 ]; then
            echo "credits-ok=false" >> "$GITHUB_OUTPUT"
            echo "â›” Daily credit limit (~\$100) reached"
          else
            echo "credits-ok=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate all conditions
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          IS_TDD="${{ steps.pr-info.outputs.is-tdd }}"
          CREDITS_OK="${{ steps.credits.outputs.credits-ok }}"

          if [ "$IS_TDD" != "true" ]; then
            echo "is-valid=false" >> "$GITHUB_OUTPUT"
            echo "âŒ Validation failed: Not a TDD PR"
            exit 0
          fi

          if [ "$CREDITS_OK" != "true" ]; then
            echo "is-valid=false" >> "$GITHUB_OUTPUT"
            gh pr comment "${{ github.event.issue.number }}" --repo "${{ github.repository }}" \
              --body "â¸ï¸ Daily credit limit reached. TDD automation paused until tomorrow."
            exit 0
          fi

          echo "is-valid=true" >> "$GITHUB_OUTPUT"
          echo "âœ… All validation checks passed"

      - uses: actions/checkout@v4
        if: steps.validate.outputs.is-valid == 'true'
        with:
          ref: ${{ steps.pr-info.outputs.branch }}

      - name: Extract per-spec timeout
        id: config
        if: steps.validate.outputs.is-valid == 'true'
        run: |
          SPEC_FILE="${{ steps.parse.outputs.spec-file }}"
          DEFAULT_TIMEOUT=45

          if [ -n "$SPEC_FILE" ] && [ -f "$SPEC_FILE" ]; then
            # Extract @tdd-timeout annotation if present
            TIMEOUT=$(grep -oP '@tdd-timeout \K[0-9]+' "$SPEC_FILE" 2>/dev/null || echo "$DEFAULT_TIMEOUT")
          else
            TIMEOUT=$DEFAULT_TIMEOUT
          fi

          echo "timeout=$TIMEOUT" >> "$GITHUB_OUTPUT"
          echo "â±ï¸ Timeout: ${TIMEOUT} minutes"

  # ============================================================================
  # JOB 2: EXECUTE CLAUDE CODE
  #
  # Steps:
  # 1. Checkout PR branch
  # 2. Sync with main (detect conflicts)
  # 3. Configure agent based on failure type
  # 4. Run anthropics/claude-code-action@v1
  # 5. Push changes (handled by action)
  # ============================================================================
  execute:
    name: Execute Claude Code
    needs: validate
    if: needs.validate.outputs.is-valid == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(needs.validate.outputs.timeout) || 45 }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.pr-branch }}
          token: ${{ secrets.GH_PAT_WORKFLOW }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Sync with main branch
        id: sync
        run: |
          git fetch origin main

          BEHIND=$(git rev-list --count HEAD..origin/main)
          echo "behind=$BEHIND" >> "$GITHUB_OUTPUT"

          if [ "$BEHIND" -gt 0 ]; then
            echo "ðŸ“¥ Main branch has $BEHIND new commits, merging..."

            if ! git merge origin/main --no-edit 2>/dev/null; then
              echo "has-conflict=true" >> "$GITHUB_OUTPUT"
              git diff --name-only --diff-filter=U > /tmp/conflicted_files.txt
              CONFLICT_FILES=$(cat /tmp/conflicted_files.txt | tr '\n' ', ' | sed 's/,$//')
              echo "conflict-files=$CONFLICT_FILES" >> "$GITHUB_OUTPUT"
              # Only abort if merge is actually in progress
              if [ -f .git/MERGE_HEAD ]; then
                git merge --abort
              fi
              echo "âš ï¸ Merge conflict detected in: $CONFLICT_FILES"
            else
              echo "has-conflict=false" >> "$GITHUB_OUTPUT"
              git push origin HEAD
              echo "âœ… Successfully merged and pushed"
            fi
          else
            echo "has-conflict=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Already up to date with main"
          fi

      - name: Add conflict label if needed
        if: steps.sync.outputs.has-conflict == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          gh pr edit "${{ needs.validate.outputs.pr-number }}" \
            --repo "${{ github.repository }}" \
            --add-label "tdd-automation:had-conflict"

          # Disable auto-merge until human reviews conflict resolution
          gh pr merge "${{ needs.validate.outputs.pr-number }}" \
            --repo "${{ github.repository }}" --disable-auto || true

      - name: Configure agent
        id: agent-config
        env:
          AGENT_TYPE: ${{ needs.validate.outputs.agent-type }}
          HAS_CONFLICT: ${{ steps.sync.outputs.has-conflict }}
          CONFLICT_FILES: ${{ steps.sync.outputs.conflict-files }}
          SPEC_ID: ${{ needs.validate.outputs.spec-id }}
          SPEC_FILE: ${{ needs.validate.outputs.spec-file }}
          ORIGINAL_COMMENT: ${{ github.event.comment.body }}
        run: |
          # Configure claude_args based on agent type
          # See: docs/development/tdd-automation-pipeline.md#agent-configurations

          if [ "$AGENT_TYPE" = "codebase-refactor-auditor" ]; then
            ALLOWED_TOOLS="Bash,Read,Write,Edit,Glob,Grep,Task,TodoWrite,LSP"
            DISALLOWED_TOOLS="WebFetch,WebSearch,Skill,AskUserQuestion,NotebookEdit"
            MAX_TURNS=40
          else
            # Default: e2e-test-fixer
            ALLOWED_TOOLS="Bash,Read,Write,Edit,Glob,Grep,Task,TodoWrite,LSP,Skill"
            DISALLOWED_TOOLS="WebFetch,WebSearch,AskUserQuestion,NotebookEdit"
            MAX_TURNS=50
          fi

          # Build claude_args for the action
          CLAUDE_ARGS="--max-turns $MAX_TURNS --allowedTools \"$ALLOWED_TOOLS\" --disallowedTools \"$DISALLOWED_TOOLS\""
          echo "claude-args=$CLAUDE_ARGS" >> "$GITHUB_OUTPUT"

          # Build prompt based on context
          if [ "$HAS_CONFLICT" = "true" ]; then
            {
              echo "âš ï¸ **MERGE CONFLICT DETECTED**"
              echo ""
              echo "Conflicted files: \`$CONFLICT_FILES\`"
              echo ""
              echo "**Resolve conflicts first:**"
              echo "1. Run: \`git fetch origin main && git merge origin/main\`"
              echo "2. Carefully resolve each conflict:"
              echo "   - For DOMAIN MODEL conflicts: prefer main (newer schema)"
              echo "   - For TEST FILE conflicts: merge both test cases"
              echo "   - For CONFIG conflicts: prefer main"
              echo "3. After resolving, run full quality + regression tests"
              echo "4. If unsure about ANY conflict, add comment: \`// TODO human review needed\`"
              echo "5. Commit the resolved merge"
              echo ""
              echo "**Then proceed with the original task:**"
              echo ""
              echo "$ORIGINAL_COMMENT"
            } > /tmp/claude_prompt.txt
          else
            # Use original comment as prompt (already contains full instructions from test.yml)
            echo "$ORIGINAL_COMMENT" > /tmp/claude_prompt.txt
          fi

          # Store prompt for action
          PROMPT=$(cat /tmp/claude_prompt.txt)
          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PROMPT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        timeout-minutes: ${{ fromJSON(needs.validate.outputs.timeout) || 45 }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.agent-config.outputs.prompt }}
          claude_args: ${{ steps.agent-config.outputs.claude-args }}
          track_progress: true
          use_sticky_comment: true

      - name: Handle conflict resolution notice
        if: steps.sync.outputs.has-conflict == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          PR_NUMBER="${{ needs.validate.outputs.pr-number }}"

          # Post conflict review notice
          {
            echo "âš ï¸ **Merge Conflict Resolution Notice**"
            echo ""
            echo "This PR had merge conflicts that were auto-resolved by Claude Code."
            echo ""
            echo "**Human review required before merge.**"
            echo ""
            echo "Please verify:"
            echo "- [ ] Conflict resolution is correct"
            echo "- [ ] Tests pass"
            echo "- [ ] Code logic makes sense"
            echo ""
            echo "After review, re-enable auto-merge or merge manually."
          } > /tmp/conflict_comment.txt

          gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body-file /tmp/conflict_comment.txt
