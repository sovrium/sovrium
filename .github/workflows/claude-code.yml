name: Claude Code

on:
  issue_comment:
    types: [created]

# Required permissions for Claude Code Action
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write  # Required for OIDC authentication

jobs:
  # ============================================================================
  # JOB 1: VALIDATE TRIGGER
  #
  # Pre-conditions:
  # 1. Comment author is thomas-jeanneau (TDD bot account)
  # 2. PR has tdd-automation label
  # 3. Credit limits not exceeded
  # ============================================================================
  validate:
    name: Validate Trigger
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '@claude') &&
      github.event.comment.user.login == 'thomas-jeanneau'
    runs-on: ubuntu-latest
    outputs:
      is-valid: ${{ steps.validate.outputs.is-valid }}
      pr-number: ${{ github.event.issue.number }}
      pr-branch: ${{ steps.pr-info.outputs.branch }}
      agent-type: ${{ steps.parse.outputs.agent-type }}
      spec-file: ${{ steps.parse.outputs.spec-file }}
      spec-id: ${{ steps.parse.outputs.spec-id }}
      timeout: ${{ steps.config.outputs.timeout }}
    steps:
      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          PR_DATA=$(gh pr view "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --json headRefName,labels)
          BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          HAS_LABEL=$(echo "$PR_DATA" | jq -r '.labels[].name' | grep -c "tdd-automation" || echo "0")
          IS_TDD_BRANCH=$(echo "$BRANCH" | grep -c "^tdd/" || echo "0")

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          if [ "$HAS_LABEL" -gt 0 ] || [ "$IS_TDD_BRANCH" -gt 0 ]; then
            echo "is-tdd=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-tdd=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ Not a TDD PR - skipping"
          fi

      - name: Parse @claude comment
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Extract agent type from comment
          if echo "$COMMENT_BODY" | grep -q "e2e-test-fixer"; then
            echo "agent-type=e2e-test-fixer" >> "$GITHUB_OUTPUT"
          elif echo "$COMMENT_BODY" | grep -q "codebase-refactor-auditor"; then
            echo "agent-type=codebase-refactor-auditor" >> "$GITHUB_OUTPUT"
          else
            echo "agent-type=e2e-test-fixer" >> "$GITHUB_OUTPUT"  # Default
          fi

          # Extract spec file if mentioned (format: `specs/...`)
          # shellcheck disable=SC2016
          SPEC_FILE=$(echo "$COMMENT_BODY" | grep -oP 'File: `\K[^`]+' | head -1 || echo "")
          if [ -z "$SPEC_FILE" ]; then
            SPEC_FILE=$(echo "$COMMENT_BODY" | grep -oP '`specs/[^`]+`' | tr -d '`' | head -1 || echo "")
          fi
          echo "spec-file=$SPEC_FILE" >> "$GITHUB_OUTPUT"

          # Extract spec ID (format: Spec: `SPEC-ID`)
          SPEC_ID=$(echo "$COMMENT_BODY" | grep -oP 'Spec: `\K[^`]+' | head -1 || echo "")
          echo "spec-id=$SPEC_ID" >> "$GITHUB_OUTPUT"

          echo "ðŸ“‹ Parsed: agent=${{ steps.parse.outputs.agent-type || 'e2e-test-fixer' }}, spec-file=$SPEC_FILE, spec-id=$SPEC_ID"

      - name: Check credit limits
        id: credits
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          # Secondary credit check (defense in depth with pr-creator.yml)
          # Cost limits: $100/day, $500/week (see docs/development/tdd-automation-pipeline.md)

          # Query successful claude-code.yml runs with full details from past 7 days
          gh run list --repo "${{ github.repository }}" --workflow="claude-code.yml" \
            --created ">$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)" \
            --json databaseId,conclusion,createdAt,displayTitle,status --limit 100 > /tmp/all_runs.json

          # Filter successful runs
          jq '[.[] | select(.conclusion == "success")]' /tmp/all_runs.json > /tmp/successful_runs.json

          # Calculate daily runs (past 24 hours)
          DAILY_CUTOFF=$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)
          DAILY_RUNS=$(jq "[.[] | select(.createdAt > \"$DAILY_CUTOFF\")] | length" /tmp/successful_runs.json)
          WEEKLY_RUNS=$(jq 'length' /tmp/successful_runs.json)

          # Estimate cost ($15 per run - conservative)
          ESTIMATED_DAILY=$((DAILY_RUNS * 15))
          ESTIMATED_WEEKLY=$((WEEKLY_RUNS * 15))

          # Calculate limits
          DAILY_LIMIT=100
          WEEKLY_LIMIT=500
          DAILY_WARNING=80
          WEEKLY_WARNING=400

          # Calculate remaining budget
          DAILY_REMAINING=$((DAILY_LIMIT - ESTIMATED_DAILY))
          WEEKLY_REMAINING=$((WEEKLY_LIMIT - ESTIMATED_WEEKLY))

          # Calculate usage percentages
          DAILY_PERCENT=$((ESTIMATED_DAILY * 100 / DAILY_LIMIT))
          WEEKLY_PERCENT=$((ESTIMATED_WEEKLY * 100 / WEEKLY_LIMIT))

          # Time until reset
          HOURS_UNTIL_DAILY_RESET=$(( 24 - $(date -u +%H) ))
          DAYS_UNTIL_WEEKLY_RESET=$(( 7 - $(date -u +%u) ))

          # Store all metrics for comment
          echo "daily-runs=$DAILY_RUNS" >> "$GITHUB_OUTPUT"
          echo "weekly-runs=$WEEKLY_RUNS" >> "$GITHUB_OUTPUT"
          echo "estimated-daily=$ESTIMATED_DAILY" >> "$GITHUB_OUTPUT"
          echo "estimated-weekly=$ESTIMATED_WEEKLY" >> "$GITHUB_OUTPUT"
          echo "daily-limit=$DAILY_LIMIT" >> "$GITHUB_OUTPUT"
          echo "weekly-limit=$WEEKLY_LIMIT" >> "$GITHUB_OUTPUT"
          echo "daily-remaining=$DAILY_REMAINING" >> "$GITHUB_OUTPUT"
          echo "weekly-remaining=$WEEKLY_REMAINING" >> "$GITHUB_OUTPUT"
          echo "daily-percent=$DAILY_PERCENT" >> "$GITHUB_OUTPUT"
          echo "weekly-percent=$WEEKLY_PERCENT" >> "$GITHUB_OUTPUT"
          echo "hours-until-daily-reset=$HOURS_UNTIL_DAILY_RESET" >> "$GITHUB_OUTPUT"
          echo "days-until-weekly-reset=$DAYS_UNTIL_WEEKLY_RESET" >> "$GITHUB_OUTPUT"

          echo "ðŸ“Š Credit Usage Metrics:"
          echo "  Daily:  $ESTIMATED_DAILY/$DAILY_LIMIT USD ($DAILY_PERCENT%) - $DAILY_RUNS runs - Reset in ${HOURS_UNTIL_DAILY_RESET}h"
          echo "  Weekly: $ESTIMATED_WEEKLY/$WEEKLY_LIMIT USD ($WEEKLY_PERCENT%) - $WEEKLY_RUNS runs - Reset in ${DAYS_UNTIL_WEEKLY_RESET}d"

          # Check if limits exceeded
          if [ "$ESTIMATED_DAILY" -ge "$DAILY_LIMIT" ] || [ "$ESTIMATED_WEEKLY" -ge "$WEEKLY_LIMIT" ]; then
            echo "credits-ok=false" >> "$GITHUB_OUTPUT"
            if [ "$ESTIMATED_DAILY" -ge "$DAILY_LIMIT" ]; then
              echo "limit-type=daily" >> "$GITHUB_OUTPUT"
              echo "â›” Daily credit limit (\$$DAILY_LIMIT) reached"
            else
              echo "limit-type=weekly" >> "$GITHUB_OUTPUT"
              echo "â›” Weekly credit limit (\$$WEEKLY_LIMIT) reached"
            fi
          else
            echo "credits-ok=true" >> "$GITHUB_OUTPUT"
            echo "limit-type=none" >> "$GITHUB_OUTPUT"
            echo "âœ… Credits OK"
          fi

      - name: Validate all conditions
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          IS_TDD="${{ steps.pr-info.outputs.is-tdd }}"
          CREDITS_OK="${{ steps.credits.outputs.credits-ok }}"

          if [ "$IS_TDD" != "true" ]; then
            echo "is-valid=false" >> "$GITHUB_OUTPUT"
            echo "âŒ Validation failed: Not a TDD PR"
            exit 0
          fi

          if [ "$CREDITS_OK" != "true" ]; then
            echo "is-valid=false" >> "$GITHUB_OUTPUT"

            # Build simplified credit limit comment with run details
            LIMIT_TYPE="${{ steps.credits.outputs.limit-type }}"
            DAILY_RUNS="${{ steps.credits.outputs.daily-runs }}"
            WEEKLY_RUNS="${{ steps.credits.outputs.weekly-runs }}"
            EST_DAILY="${{ steps.credits.outputs.estimated-daily }}"
            EST_WEEKLY="${{ steps.credits.outputs.estimated-weekly }}"
            DAILY_LIMIT="${{ steps.credits.outputs.daily-limit }}"
            WEEKLY_LIMIT="${{ steps.credits.outputs.weekly-limit }}"
            DAILY_REMAINING="${{ steps.credits.outputs.daily-remaining }}"
            WEEKLY_REMAINING="${{ steps.credits.outputs.weekly-remaining }}"
            DAILY_PERCENT="${{ steps.credits.outputs.daily-percent }}"
            WEEKLY_PERCENT="${{ steps.credits.outputs.weekly-percent }}"
            HOURS_RESET="${{ steps.credits.outputs.hours-until-daily-reset }}"
            DAYS_RESET="${{ steps.credits.outputs.days-until-weekly-reset }}"

            {
              if [ "$LIMIT_TYPE" = "daily" ]; then
                echo "## â¸ï¸ Daily Credit Limit Reached"
                echo ""
                echo "TDD automation paused until daily limit resets in **${HOURS_RESET} hours**."
              else
                echo "## â¸ï¸ Weekly Credit Limit Reached"
                echo ""
                echo "TDD automation paused until weekly limit resets in **${DAYS_RESET} days**."
              fi
              echo ""
              echo "### ðŸ“Š Current Usage"
              echo ""
              echo "| Period | Usage | Limit | Remaining | % Used | Runs | Reset In |"
              echo "|--------|-------|-------|-----------|--------|------|----------|"
              echo "| **Daily** | \$$EST_DAILY | \$$DAILY_LIMIT | \$$DAILY_REMAINING | $DAILY_PERCENT% | $DAILY_RUNS | ${HOURS_RESET}h |"
              echo "| **Weekly** | \$$EST_WEEKLY | \$$WEEKLY_LIMIT | \$$WEEKLY_REMAINING | $WEEKLY_PERCENT% | $WEEKLY_RUNS | ${DAYS_RESET}d |"
              echo ""
              echo "### ðŸ“‹ Recent Runs (Last 10)"
              echo ""
              echo "| Run | Date | Spec ID | Cost |"
              echo "|-----|------|---------|------|"

              # Generate run details table from successful runs
              jq -r '.[] | "\(.databaseId)|\(.createdAt)|\(.displayTitle)"' /tmp/successful_runs.json | head -10 | while IFS='|' read -r run_id created_at title; do
                # Format date
                run_date=$(date -u -d "$created_at" '+%Y-%m-%d %H:%M' 2>/dev/null || echo "$created_at")

                # Extract spec ID from title (format: "Implement SPEC-ID")
                spec_id=$(echo "$title" | grep -oP 'Implement \K[A-Z]+-[A-Z]+-[A-Z]+-[0-9]+' || echo "N/A")

                # Cost per run
                cost="\$15"

                echo "| [#$run_id](https://github.com/${{ github.repository }}/actions/runs/$run_id) | $run_date | \`$spec_id\` | $cost |"
              done

              echo ""
              echo "---"
              echo "*ðŸ’° Cost estimate: ~\$15 per successful run (conservative)*"
              echo ""
              echo "*ðŸ“… Last updated: $(date -u '+%Y-%m-%d %H:%M UTC')*"
            } > /tmp/credit_limit.md

            gh pr comment "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --body-file /tmp/credit_limit.md
            exit 0
          fi

          echo "is-valid=true" >> "$GITHUB_OUTPUT"
          echo "âœ… All validation checks passed"

      - uses: actions/checkout@v4
        if: steps.validate.outputs.is-valid == 'true'
        with:
          ref: ${{ steps.pr-info.outputs.branch }}

      - name: Extract per-spec timeout
        id: config
        if: steps.validate.outputs.is-valid == 'true'
        run: |
          SPEC_FILE="${{ steps.parse.outputs.spec-file }}"
          DEFAULT_TIMEOUT=45

          if [ -n "$SPEC_FILE" ] && [ -f "$SPEC_FILE" ]; then
            # Extract @tdd-timeout annotation if present
            TIMEOUT=$(grep -oP '@tdd-timeout \K[0-9]+' "$SPEC_FILE" 2>/dev/null || echo "$DEFAULT_TIMEOUT")
          else
            TIMEOUT=$DEFAULT_TIMEOUT
          fi

          echo "timeout=$TIMEOUT" >> "$GITHUB_OUTPUT"
          echo "â±ï¸ Timeout: ${TIMEOUT} minutes"

  # ============================================================================
  # JOB 2: EXECUTE CLAUDE CODE
  #
  # Steps:
  # 1. Checkout PR branch
  # 2. Sync with main (detect conflicts)
  # 3. Configure agent based on failure type
  # 4. Run anthropics/claude-code-action@v1
  # 5. Push changes (handled by action)
  # ============================================================================
  execute:
    name: Execute Claude Code
    needs: validate
    if: needs.validate.outputs.is-valid == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(needs.validate.outputs.timeout) || 45 }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.pr-branch }}
          token: ${{ secrets.GH_PAT_WORKFLOW }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Sync with main branch
        id: sync
        run: |
          git fetch origin main

          BEHIND=$(git rev-list --count HEAD..origin/main)
          echo "behind=$BEHIND" >> "$GITHUB_OUTPUT"

          if [ "$BEHIND" -gt 0 ]; then
            echo "ðŸ“¥ Main branch has $BEHIND new commits, merging..."

            if ! git merge origin/main --no-edit 2>/dev/null; then
              echo "has-conflict=true" >> "$GITHUB_OUTPUT"
              git diff --name-only --diff-filter=U > /tmp/conflicted_files.txt
              CONFLICT_FILES=$(cat /tmp/conflicted_files.txt | tr '\n' ', ' | sed 's/,$//')
              echo "conflict-files=$CONFLICT_FILES" >> "$GITHUB_OUTPUT"
              # Only abort if merge is actually in progress
              if [ -f .git/MERGE_HEAD ]; then
                git merge --abort
              fi
              echo "âš ï¸ Merge conflict detected in: $CONFLICT_FILES"
            else
              echo "has-conflict=false" >> "$GITHUB_OUTPUT"
              git push origin HEAD
              echo "âœ… Successfully merged and pushed"
            fi
          else
            echo "has-conflict=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Already up to date with main"
          fi

      - name: Add conflict label if needed
        if: steps.sync.outputs.has-conflict == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          gh pr edit "${{ needs.validate.outputs.pr-number }}" \
            --repo "${{ github.repository }}" \
            --add-label "tdd-automation:had-conflict"

          # Disable auto-merge until human reviews conflict resolution
          gh pr merge "${{ needs.validate.outputs.pr-number }}" \
            --repo "${{ github.repository }}" --disable-auto || true

      - name: Configure agent
        id: agent-config
        env:
          AGENT_TYPE: ${{ needs.validate.outputs.agent-type }}
          HAS_CONFLICT: ${{ steps.sync.outputs.has-conflict }}
          CONFLICT_FILES: ${{ steps.sync.outputs.conflict-files }}
          SPEC_ID: ${{ needs.validate.outputs.spec-id }}
          SPEC_FILE: ${{ needs.validate.outputs.spec-file }}
          ORIGINAL_COMMENT: ${{ github.event.comment.body }}
        run: |
          # Configure claude_args based on agent type
          # See: docs/development/tdd-automation-pipeline.md#agent-configurations

          if [ "$AGENT_TYPE" = "codebase-refactor-auditor" ]; then
            ALLOWED_TOOLS="Bash,Read,Write,Edit,Glob,Grep,Task,TodoWrite,LSP"
            DISALLOWED_TOOLS="WebFetch,WebSearch,Skill,AskUserQuestion,NotebookEdit"
            MAX_TURNS=40
          else
            # Default: e2e-test-fixer
            ALLOWED_TOOLS="Bash,Read,Write,Edit,Glob,Grep,Task,TodoWrite,LSP,Skill"
            DISALLOWED_TOOLS="WebFetch,WebSearch,AskUserQuestion,NotebookEdit"
            MAX_TURNS=50
          fi

          # Build claude_args for the action
          CLAUDE_ARGS="--max-turns $MAX_TURNS --allowedTools \"$ALLOWED_TOOLS\" --disallowedTools \"$DISALLOWED_TOOLS\""
          echo "claude-args=$CLAUDE_ARGS" >> "$GITHUB_OUTPUT"

          # Build prompt based on context
          if [ "$HAS_CONFLICT" = "true" ]; then
            {
              echo "âš ï¸ **MERGE CONFLICT DETECTED**"
              echo ""
              echo "Conflicted files: \`$CONFLICT_FILES\`"
              echo ""
              echo "**Resolve conflicts first:**"
              echo "1. Run: \`git fetch origin main && git merge origin/main\`"
              echo "2. Carefully resolve each conflict:"
              echo "   - For DOMAIN MODEL conflicts: prefer main (newer schema)"
              echo "   - For TEST FILE conflicts: merge both test cases"
              echo "   - For CONFIG conflicts: prefer main"
              echo "3. After resolving, run full quality + regression tests"
              echo "4. If unsure about ANY conflict, add comment: \`// TODO human review needed\`"
              echo "5. Commit the resolved merge"
              echo ""
              echo "**Then proceed with the original task:**"
              echo ""
              echo "$ORIGINAL_COMMENT"
            } > /tmp/claude_prompt.txt
          else
            # Use original comment as prompt (already contains full instructions from test.yml)
            echo "$ORIGINAL_COMMENT" > /tmp/claude_prompt.txt
          fi

          # Store prompt for action
          PROMPT=$(cat /tmp/claude_prompt.txt)
          echo "prompt<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PROMPT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        timeout-minutes: ${{ fromJSON(needs.validate.outputs.timeout) || 45 }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.agent-config.outputs.prompt }}
          claude_args: ${{ steps.agent-config.outputs.claude-args }}
          track_progress: true
          use_sticky_comment: true

      - name: Handle conflict resolution notice
        if: steps.sync.outputs.has-conflict == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          PR_NUMBER="${{ needs.validate.outputs.pr-number }}"

          # Post conflict review notice
          {
            echo "âš ï¸ **Merge Conflict Resolution Notice**"
            echo ""
            echo "This PR had merge conflicts that were auto-resolved by Claude Code."
            echo ""
            echo "**Human review required before merge.**"
            echo ""
            echo "Please verify:"
            echo "- [ ] Conflict resolution is correct"
            echo "- [ ] Tests pass"
            echo "- [ ] Code logic makes sense"
            echo ""
            echo "After review, re-enable auto-merge or merge manually."
          } > /tmp/conflict_comment.txt

          gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body-file /tmp/conflict_comment.txt
