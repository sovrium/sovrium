name: PR Creator

on:
  schedule:
    - cron: '0 * * * *' # Hourly backup
  workflow_run:
    workflows: ['Test']
    types: [completed]
    branches: [main]
  workflow_dispatch:

# Required permissions for Claude Code Action (credit check probe)
permissions:
  contents: write         # Required to push branches
  pull-requests: write    # Required to create/manage PRs
  issues: write          # Required to add labels to PRs
  actions: read          # Required to read workflow runs
  id-token: write        # Required for OIDC authentication (Claude Code Action)

jobs:
  check-active-pr:
    runs-on: ubuntu-latest
    outputs:
      has-active: ${{ steps.check.outputs.has-active }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for active TDD PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/check-active-pr.ts 2>&1)
          HAS_ACTIVE=$(echo "$RESULT" | tail -1 | jq -r '.hasActivePR')
          echo "has-active=$HAS_ACTIVE" >> "$GITHUB_OUTPUT"

      - name: Add workflow summary
        if: steps.check.outputs.has-active == 'true'
        run: |
          echo "## â¸ï¸ Active TDD PR Exists" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Serial processing constraint: another TDD PR is currently in progress." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Skipping credit check** to save API costs (~\$0.01 per probe)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow will retry after current PR completes." >> $GITHUB_STEP_SUMMARY

  check-credits:
    needs: check-active-pr
    if: needs.check-active-pr.outputs.has-active == 'false'
    runs-on: ubuntu-latest
    outputs:
      can-proceed: ${{ steps.check.outputs.can-proceed }}
      exhausted: ${{ steps.check.outputs.exhausted }}
      daily-spend: ${{ steps.check.outputs.daily-spend }}
      weekly-spend: ${{ steps.check.outputs.weekly-spend }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Probe Claude Code API for credit availability
        id: probe-credits
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 2
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: "hi"
          claude_args: "--max-turns 1 --max-budget-usd 0.01"
          track_progress: false
          use_sticky_comment: false

      - name: Parse probe result
        id: parse-probe
        if: always()
        run: |
          EXECUTION_FILE="${{ steps.probe-credits.outputs.execution_file }}"

          if [ -z "$EXECUTION_FILE" ] || [ ! -f "$EXECUTION_FILE" ]; then
            echo "probe-failed=true" >> "$GITHUB_OUTPUT"
            echo "exhausted=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸  Probe failed (no execution file), assuming credits available"
            exit 0
          fi

          # Parse result from execution file
          RESULT_JSON=$(jq -r '.[] | select(.type == "result")' "$EXECUTION_FILE" 2>/dev/null)

          if [ -z "$RESULT_JSON" ]; then
            echo "probe-failed=true" >> "$GITHUB_OUTPUT"
            echo "exhausted=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸  Probe failed (no result), assuming credits available"
            exit 0
          fi

          IS_ERROR=$(echo "$RESULT_JSON" | jq -r '.is_error // false')
          COST=$(echo "$RESULT_JSON" | jq -r '.total_cost_usd // 0')
          ERROR_MSG=$(echo "$RESULT_JSON" | jq -r '.errors // [] | join(", ")')

          echo "probe-failed=false" >> "$GITHUB_OUTPUT"
          echo "is-error=$IS_ERROR" >> "$GITHUB_OUTPUT"
          echo "cost=$COST" >> "$GITHUB_OUTPUT"

          # Detect exhaustion: is_error=true AND total_cost_usd=0
          if [ "$IS_ERROR" = "true" ] && { [ "$COST" = "0" ] || [ "$COST" = "0.0" ]; }; then
            echo "exhausted=true" >> "$GITHUB_OUTPUT"
            echo "ðŸš« Credits exhausted detected (is_error=$IS_ERROR, cost=$COST)"
            echo "   Error: $ERROR_MSG"
          else
            echo "exhausted=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Credits available (is_error=$IS_ERROR, cost=$COST)"
          fi

      - name: Check credit limits
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
          PROBE_EXHAUSTED: ${{ steps.parse-probe.outputs.exhausted }}
          PROBE_FAILED: ${{ steps.parse-probe.outputs.probe-failed }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/check-credits.ts 2>&1)
          echo "can-proceed=$(echo "$RESULT" | tail -1 | jq -r '.canProceed')" >> "$GITHUB_OUTPUT"
          echo "exhausted=$(echo "$RESULT" | tail -1 | jq -r '.exhausted // false')" >> "$GITHUB_OUTPUT"
          echo "daily-spend=$(echo "$RESULT" | tail -1 | jq -r '.dailySpend')" >> "$GITHUB_OUTPUT"
          echo "weekly-spend=$(echo "$RESULT" | tail -1 | jq -r '.weeklySpend')" >> "$GITHUB_OUTPUT"

      - name: Add workflow summary
        if: always()
        run: |
          CAN_PROCEED="${{ steps.check.outputs.can-proceed }}"
          EXHAUSTED="${{ steps.check.outputs.exhausted }}"
          DAILY_SPEND="${{ steps.check.outputs.daily-spend }}"
          WEEKLY_SPEND="${{ steps.check.outputs.weekly-spend }}"

          if [ "$EXHAUSTED" = "true" ]; then
            echo "## ðŸš« Claude Code API Credits Exhausted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "API probe confirmed credits are exhausted." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Daily spend: \$${DAILY_SPEND}" >> $GITHUB_STEP_SUMMARY
            echo "- Weekly spend: \$${WEEKLY_SPEND}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required**: Contact Anthropic support or wait for credit reset." >> $GITHUB_STEP_SUMMARY
          elif [ "$CAN_PROCEED" = "false" ]; then
            echo "## â¸ï¸ Credit Limit Exceeded" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Budget limits reached:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Daily spend: \$${DAILY_SPEND} / \$200" >> $GITHUB_STEP_SUMMARY
            echo "- Weekly spend: \$${WEEKLY_SPEND} / \$1000" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Credits Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "TDD automation proceeding:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Daily spend: \$${DAILY_SPEND} / \$200" >> $GITHUB_STEP_SUMMARY
            echo "- Weekly spend: \$${WEEKLY_SPEND} / \$1000" >> $GITHUB_STEP_SUMMARY
          fi

  create-pr:
    needs: [check-active-pr, check-credits]
    if: needs.check-credits.outputs.can-proceed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT_WORKFLOW }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Find excluded specs (in manual-intervention PRs)
        id: excluded
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/find-excluded-specs.ts 2>&1)
          EXCLUDED=$(echo "$RESULT" | tail -1 | jq -r '.excludedList')
          echo "specs=$EXCLUDED" >> "$GITHUB_OUTPUT"

      - name: Find next spec
        id: next-spec
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/core/find-ready-spec.ts) || true
          SPEC_JSON=$(echo "$RESULT" | tail -1)

          # Check if we got valid JSON output
          if echo "$SPEC_JSON" | jq -e '.specId' > /dev/null 2>&1; then
            SPEC_ID=$(echo "$SPEC_JSON" | jq -r '.specId')
            SPEC_FILE=$(echo "$SPEC_JSON" | jq -r '.file')
            SPEC_LINE=$(echo "$SPEC_JSON" | jq -r '.line')
            PRIORITY=$(echo "$SPEC_JSON" | jq -r '.priority')

            echo "Found spec: $SPEC_ID (priority: $PRIORITY) at line $SPEC_LINE"
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "spec-id=$SPEC_ID" >> "$GITHUB_OUTPUT"
            echo "spec-file=$SPEC_FILE" >> "$GITHUB_OUTPUT"
            echo "spec-line=$SPEC_LINE" >> "$GITHUB_OUTPUT"
            echo "priority=$PRIORITY" >> "$GITHUB_OUTPUT"
          else
            echo "No pending specs found"
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract per-spec configuration
        if: steps.next-spec.outputs.found == 'true'
        id: spec-config
        env:
          SPEC_FILE: ${{ steps.next-spec.outputs.spec-file }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/extract-spec-config.ts 2>&1)
          MAX_ATTEMPTS=$(echo "$RESULT" | tail -1 | jq -r '.maxAttempts')
          TIMEOUT=$(echo "$RESULT" | tail -1 | jq -r '.timeout')
          echo "max-attempts=$MAX_ATTEMPTS" >> "$GITHUB_OUTPUT"
          echo "timeout=$TIMEOUT" >> "$GITHUB_OUTPUT"

      - name: Create branch and remove .fixme()
        if: steps.next-spec.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          SPEC_ID="${{ steps.next-spec.outputs.spec-id }}"
          SPEC_FILE="${{ steps.next-spec.outputs.spec-file }}"
          SPEC_LINE="${{ steps.next-spec.outputs.spec-line }}"
          BRANCH="tdd/${SPEC_ID,,}"  # Lowercase

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if remote branch exists
          if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
            echo "âš ï¸ Remote branch $BRANCH already exists. Checking for open PRs..."

            # Safety check: Verify no open PR exists for this branch
            OPEN_PRS=$(gh pr list --head "$BRANCH" --state open --json number --jq '. | length')

            if [ "$OPEN_PRS" -gt 0 ]; then
              echo "âŒ ERROR: Open PR(s) exist for branch $BRANCH. Cannot delete."
              echo "This is a safety check to prevent overwriting active TDD branches."
              echo "Manual intervention required: Close or merge the existing PR first."
              exit 1
            fi

            echo "âœ… No open PRs found for $BRANCH. Deleting stale remote branch..."
            git push origin --delete "$BRANCH" || echo "âš ï¸ Branch deletion failed (may not exist on remote)"
          fi

          # Create new branch from latest main
          git checkout -b "$BRANCH"

          # Remove .fixme() from the specific test line only
          sed -i "${SPEC_LINE}s/\.fixme(/(/g" "$SPEC_FILE"

          git add "$SPEC_FILE"
          git commit -m "test(tdd): activate $SPEC_ID spec"
          git push origin "$BRANCH"

      - name: Create PR with attempt tracking in title
        if: steps.next-spec.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          SPEC_ID="${{ steps.next-spec.outputs.spec-id }}"
          SPEC_FILE="${{ steps.next-spec.outputs.spec-file }}"
          PRIORITY="${{ steps.next-spec.outputs.priority }}"
          MAX_ATTEMPTS="${{ steps.spec-config.outputs.max-attempts }}"
          BRANCH="tdd/${SPEC_ID,,}"  # Lowercase

          # PR title includes attempt tracking (immutable counter)
          TITLE="[TDD] Implement $SPEC_ID | Attempt 1/$MAX_ATTEMPTS"

          # Write body to temp file to avoid YAML parsing issues
          {
            echo "## TDD Automation PR"
            echo ""
            echo "This PR was automatically created by the TDD automation pipeline."
            echo "Tests will run automatically. If they fail, Claude Code will attempt to fix them."
            echo ""
            echo "Do not manually edit the attempt count in the title."
          } > /tmp/pr_body.md
          # Append dynamic content
          echo "" >> /tmp/pr_body.md
          echo "Spec ID: \`$SPEC_ID\`" >> /tmp/pr_body.md
          echo "File: \`$SPEC_FILE\`" >> /tmp/pr_body.md
          echo "Priority: $PRIORITY" >> /tmp/pr_body.md
          echo "Max Attempts: $MAX_ATTEMPTS" >> /tmp/pr_body.md

          gh pr create \
            --title "$TITLE" \
            --body-file /tmp/pr_body.md \
            --label "tdd-automation" \
            --base main \
            --head "$BRANCH"

          # Enable auto-merge
          PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')
          gh pr merge "$PR_NUMBER" --squash --auto || true
