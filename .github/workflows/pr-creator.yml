name: PR Creator

on:
  schedule:
    - cron: '0 * * * *' # Hourly backup
  workflow_run:
    workflows: ['Test']
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  check-credits:
    runs-on: ubuntu-latest
    outputs:
      can-proceed: ${{ steps.check.outputs.can-proceed }}
      daily-spend: ${{ steps.check.outputs.daily-spend }}
      weekly-spend: ${{ steps.check.outputs.weekly-spend }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check credit limits
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/check-credits.ts 2>&1)
          echo "can-proceed=$(echo "$RESULT" | tail -1 | jq -r '.canProceed')" >> "$GITHUB_OUTPUT"
          echo "daily-spend=$(echo "$RESULT" | tail -1 | jq -r '.dailySpend')" >> "$GITHUB_OUTPUT"
          echo "weekly-spend=$(echo "$RESULT" | tail -1 | jq -r '.weeklySpend')" >> "$GITHUB_OUTPUT"

  check-active-pr:
    needs: check-credits
    if: needs.check-credits.outputs.can-proceed == 'true'
    runs-on: ubuntu-latest
    outputs:
      has-active: ${{ steps.check.outputs.has-active }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for active TDD PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/check-active-pr.ts 2>&1)
          HAS_ACTIVE=$(echo "$RESULT" | tail -1 | jq -r '.hasActivePR')
          echo "has-active=$HAS_ACTIVE" >> "$GITHUB_OUTPUT"

  create-pr:
    needs: [check-credits, check-active-pr]
    if: needs.check-active-pr.outputs.has-active == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT_WORKFLOW }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Find excluded specs (in manual-intervention PRs)
        id: excluded
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/find-excluded-specs.ts 2>&1)
          EXCLUDED=$(echo "$RESULT" | tail -1 | jq -r '.excludedList')
          echo "specs=$EXCLUDED" >> "$GITHUB_OUTPUT"

      - name: Find next spec
        id: next-spec
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/core/find-ready-spec.ts) || true
          SPEC_JSON=$(echo "$RESULT" | tail -1)

          # Check if we got valid JSON output
          if echo "$SPEC_JSON" | jq -e '.specId' > /dev/null 2>&1; then
            SPEC_ID=$(echo "$SPEC_JSON" | jq -r '.specId')
            SPEC_FILE=$(echo "$SPEC_JSON" | jq -r '.file')
            SPEC_LINE=$(echo "$SPEC_JSON" | jq -r '.line')
            PRIORITY=$(echo "$SPEC_JSON" | jq -r '.priority')

            echo "Found spec: $SPEC_ID (priority: $PRIORITY) at line $SPEC_LINE"
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "spec-id=$SPEC_ID" >> "$GITHUB_OUTPUT"
            echo "spec-file=$SPEC_FILE" >> "$GITHUB_OUTPUT"
            echo "spec-line=$SPEC_LINE" >> "$GITHUB_OUTPUT"
            echo "priority=$PRIORITY" >> "$GITHUB_OUTPUT"
          else
            echo "No pending specs found"
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract per-spec configuration
        if: steps.next-spec.outputs.found == 'true'
        id: spec-config
        env:
          SPEC_FILE: ${{ steps.next-spec.outputs.spec-file }}
        run: |
          RESULT=$(bun run scripts/tdd-automation/workflows/pr-creator/extract-spec-config.ts 2>&1)
          MAX_ATTEMPTS=$(echo "$RESULT" | tail -1 | jq -r '.maxAttempts')
          TIMEOUT=$(echo "$RESULT" | tail -1 | jq -r '.timeout')
          echo "max-attempts=$MAX_ATTEMPTS" >> "$GITHUB_OUTPUT"
          echo "timeout=$TIMEOUT" >> "$GITHUB_OUTPUT"

      - name: Create branch and remove .fixme()
        if: steps.next-spec.outputs.found == 'true'
        run: |
          SPEC_ID="${{ steps.next-spec.outputs.spec-id }}"
          SPEC_FILE="${{ steps.next-spec.outputs.spec-file }}"
          SPEC_LINE="${{ steps.next-spec.outputs.spec-line }}"
          BRANCH="tdd/${SPEC_ID,,}"  # Lowercase

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"

          # Remove .fixme() from the specific test line only
          sed -i "${SPEC_LINE}s/\.fixme(/(/g" "$SPEC_FILE"

          git add "$SPEC_FILE"
          git commit -m "test(tdd): activate $SPEC_ID spec"
          git push origin "$BRANCH"

      - name: Create PR with attempt tracking in title
        if: steps.next-spec.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          SPEC_ID="${{ steps.next-spec.outputs.spec-id }}"
          SPEC_FILE="${{ steps.next-spec.outputs.spec-file }}"
          PRIORITY="${{ steps.next-spec.outputs.priority }}"
          MAX_ATTEMPTS="${{ steps.spec-config.outputs.max-attempts }}"
          BRANCH="tdd/${SPEC_ID,,}"  # Lowercase

          # PR title includes attempt tracking (immutable counter)
          TITLE="[TDD] Implement $SPEC_ID | Attempt 1/$MAX_ATTEMPTS"

          # Write body to temp file to avoid YAML parsing issues
          {
            echo "## TDD Automation PR"
            echo ""
            echo "This PR was automatically created by the TDD automation pipeline."
            echo "Tests will run automatically. If they fail, Claude Code will attempt to fix them."
            echo ""
            echo "Do not manually edit the attempt count in the title."
          } > /tmp/pr_body.md
          # Append dynamic content
          echo "" >> /tmp/pr_body.md
          echo "Spec ID: \`$SPEC_ID\`" >> /tmp/pr_body.md
          echo "File: \`$SPEC_FILE\`" >> /tmp/pr_body.md
          echo "Priority: $PRIORITY" >> /tmp/pr_body.md
          echo "Max Attempts: $MAX_ATTEMPTS" >> /tmp/pr_body.md

          gh pr create \
            --title "$TITLE" \
            --body-file /tmp/pr_body.md \
            --label "tdd-automation" \
            --base main \
            --head "$BRANCH"

          # Enable auto-merge
          PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')
          gh pr merge "$PR_NUMBER" --squash --auto || true
