name: TDD Worker V2

on:
  workflow_dispatch:
    inputs:
      spec_file:
        description: 'Path to spec file (e.g., specs/api/tables/create.spec.ts)'
        required: true
        type: string
      priority:
        description: 'Priority score (0-100)'
        required: true
        type: number
      retry_count:
        description: 'Current attempt number (0-2, after 3rd failure â†’ manual intervention)'
        required: true
        type: number
      previous_errors:
        description: 'JSON array of previous error objects'
        required: false
        type: string
        default: '[]'
      test_count:
        description: 'Number of tests in file (from .fixme() count)'
        required: true
        type: number

jobs:
  process-spec:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Create PR branch
        id: branch
        run: |
          # Extract spec name without path and extension
          SPEC_NAME=$(basename "${{ inputs.spec_file }}" .spec.ts)
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="tdd-v2/${SPEC_NAME}-${TIMESTAMP}"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Lock file in state
        run: |
          bun run scripts/tdd-automation-v2/core/lock-file.ts \
            --file "${{ inputs.spec_file }}"

      - name: Run pre-validation (validate-specs)
        id: prevalidate
        continue-on-error: true
        run: |
          bun run scripts/tdd-automation-v2/core/pre-validate.ts \
            --file "${{ inputs.spec_file }}" \
            --output prevalidation-result.json

      - name: Parse pre-validation results
        id: parse_prevalidation
        run: |
          if [ -f prevalidation-result.json ]; then
            RESULT=$(cat prevalidation-result.json)
            PASSED=$(echo "$RESULT" | jq -r '.passed')
            FAILED=$(echo "$RESULT" | jq -r '.failed')

            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT

            if [ "$FAILED" -eq "0" ]; then
              echo "all_passed=true" >> $GITHUB_OUTPUT
            else
              echo "all_passed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=${{ inputs.test_count }}" >> $GITHUB_OUTPUT
          fi

      - name: Fast path - All tests pass
        if: steps.parse_prevalidation.outputs.all_passed == 'true'
        run: |
          echo "ğŸ‰ All tests pass without implementation! Fast path activated."

          git add .
          git commit -m "test: remove .fixme() from ${{ inputs.spec_file }} (${{ inputs.test_count }} tests pass)"
          git push origin ${{ steps.branch.outputs.branch }}

          # Create PR
          bun run scripts/tdd-automation-v2/services/pr-manager.ts create \
            --file "${{ inputs.spec_file }}" \
            --branch "${{ steps.branch.outputs.branch }}" \
            --test-count "${{ inputs.test_count }}" \
            --fast-path

          # Unlock file and exit
          bun run scripts/tdd-automation-v2/core/unlock-file.ts \
            --file "${{ inputs.spec_file }}"

          exit 0

      - name: Invoke Claude - e2e-test-fixer
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– Invoking Claude Code e2e-test-fixer agent..."

          bun run scripts/tdd-automation-v2/services/claude-invoker.ts \
            --agent e2e-test-fixer \
            --file "${{ inputs.spec_file }}" \
            --context '${{ inputs.previous_errors }}' \
            --retry-count "${{ inputs.retry_count }}"

      - name: Check if src/ modified
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        id: src_check
        run: |
          if git diff --name-only | grep '^src/'; then
            echo "modified=true" >> $GITHUB_OUTPUT
          else
            echo "modified=false" >> $GITHUB_OUTPUT
          fi

      - name: Invoke Claude - codebase-refactor-auditor
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.src_check.outputs.modified == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ” Invoking Claude Code codebase-refactor-auditor agent..."

          bun run scripts/tdd-automation-v2/services/claude-invoker.ts \
            --agent codebase-refactor-auditor

      - name: Run quality checks
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        run: |
          echo "âœ… Running quality checks..."
          bun run quality --skip-e2e

      - name: Add license headers
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        run: |
          echo "ğŸ“ Adding license headers..."
          bun run license

      - name: Commit and push changes
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        run: |
          git add .

          SPEC_ID=$(basename "${{ inputs.spec_file }}" .spec.ts)
          git commit -m "feat: implement ${SPEC_ID}

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

          git push origin ${{ steps.branch.outputs.branch }}

      - name: Create Pull Request
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SPEC_ID=$(basename "${{ inputs.spec_file }}" .spec.ts)

          PR_NUMBER=$(bun run scripts/tdd-automation-v2/services/pr-manager.ts create \
            --file "${{ inputs.spec_file }}" \
            --branch "${{ steps.branch.outputs.branch }}" \
            --spec-id "$SPEC_ID" \
            --retry-count "${{ inputs.retry_count }}")

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Wait for CI checks
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        id: ci
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â³ Waiting for CI checks..."

          RESULT=$(bun run scripts/tdd-automation-v2/services/ci-waiter.ts \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --timeout 600)

          echo "result=$RESULT" >> $GITHUB_OUTPUT

      - name: Auto-merge on success
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.ci.outputs.result == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "âœ… CI passed! Auto-merging PR..."

          bun run scripts/tdd-automation-v2/services/pr-manager.ts merge \
            --pr ${{ steps.pr.outputs.pr_number }}

      - name: Analyze failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.ci.outputs.result == 'failure'
        id: analyze
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "âŒ CI failed. Analyzing failure type..."

          FAILURE_TYPE=$(bun run scripts/tdd-automation-v2/services/failure-analyzer.ts \
            --pr ${{ steps.pr.outputs.pr_number }})

          echo "type=$FAILURE_TYPE" >> $GITHUB_OUTPUT

      - name: Handle regression failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.analyze.outputs.type == 'regression'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ”„ Regression detected. Closing PR and re-queuing..."

          bun run scripts/tdd-automation-v2/services/failure-handler.ts \
            --file "${{ inputs.spec_file }}" \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --type regression \
            --retry-count "${{ inputs.retry_count }}"

      - name: Handle spec failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.analyze.outputs.type == 'spec-failure'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "âŒ Spec failure. Recording and re-queuing..."

          bun run scripts/tdd-automation-v2/services/failure-handler.ts \
            --file "${{ inputs.spec_file }}" \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --type spec-failure \
            --retry-count "${{ inputs.retry_count }}"

      - name: Handle infrastructure failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.analyze.outputs.type == 'infrastructure'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "âš™ï¸ Infrastructure failure. Recording and re-queuing..."

          bun run scripts/tdd-automation-v2/services/failure-handler.ts \
            --file "${{ inputs.spec_file }}" \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --type infrastructure \
            --retry-count "${{ inputs.retry_count }}"

      - name: Cleanup - Release file lock
        if: always()
        run: |
          echo "ğŸ”“ Releasing file lock..."

          bun run scripts/tdd-automation-v2/core/unlock-file.ts \
            --file "${{ inputs.spec_file }}" || true
