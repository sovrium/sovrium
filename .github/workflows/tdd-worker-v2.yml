name: TDD Worker V2

on:
  workflow_dispatch:
    inputs:
      spec_id:
        description: 'Spec ID (e.g., API-TABLES-001)'
        required: true
        type: string
      file_path:
        description: 'Path to spec file (e.g., specs/api/tables/create.spec.ts)'
        required: true
        type: string
      test_name:
        description: 'Full test description for grep matching (e.g., "API-TABLES-001: should create table")'
        required: true
        type: string
      priority:
        description: 'Priority score (0-100)'
        required: true
        type: number
      retry_count:
        description: 'Current attempt number (0-2, after 3rd failure â†’ manual intervention)'
        required: true
        type: number
      previous_errors:
        description: 'JSON array of previous error objects'
        required: false
        type: string
        default: '[]'

jobs:
  process-spec:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install

      - name: Create PR branch
        id: branch
        run: |
          # Use spec ID for branch name
          SPEC_ID="${{ inputs.spec_id }}"
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="tdd-v2/${SPEC_ID}-${TIMESTAMP}"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Lock file in state
        run: |
          bun run scripts/tdd-automation-v2/core/lock-file.ts \
            --file "${{ inputs.file_path }}"

      - name: Run pre-validation (validate-specs)
        id: prevalidate
        continue-on-error: true
        run: |
          bun run scripts/tdd-automation-v2/core/pre-validate.ts \
            --file "${{ inputs.file_path }}" \
            --spec-id "${{ inputs.spec_id }}" \
            --test-name "${{ inputs.test_name }}" \
            --output prevalidation-result.json

      - name: Parse pre-validation results
        id: parse_prevalidation
        run: |
          if [ -f prevalidation-result.json ]; then
            RESULT=$(cat prevalidation-result.json)
            PASSED=$(echo "$RESULT" | jq -r '.passed')
            FAILED=$(echo "$RESULT" | jq -r '.failed')

            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT

            if [ "$FAILED" -eq "0" ]; then
              echo "all_passed=true" >> $GITHUB_OUTPUT
            else
              echo "all_passed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=1" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push pre-validation changes
        run: |
          echo "ğŸ“ Committing .fixme() removal..."

          git add .

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit (pre-validation may have failed)"
          else
            SPEC_ID="${{ inputs.spec_id }}"
            git commit -m "test: remove .fixme() from ${SPEC_ID}" -m "Pre-validation: ${{ steps.parse_prevalidation.outputs.passed }} passed, ${{ steps.parse_prevalidation.outputs.failed }} failed"
            git push origin ${{ steps.branch.outputs.branch }}
            echo "âœ… Changes committed and pushed"
          fi

      - name: Create Pull Request
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ğŸ”€ Creating PR for transparency..."

          SPEC_ID="${{ inputs.spec_id }}"

          PR_NUMBER=$(bun run scripts/tdd-automation-v2/services/pr-manager.ts create \
            --file "${{ inputs.file_path }}" \
            --branch "${{ steps.branch.outputs.branch }}" \
            --spec-id "$SPEC_ID" \
            --retry-count "${{ inputs.retry_count }}")

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PR #${PR_NUMBER} created - Claude's work will be visible here"

      - name: Fast path - All tests pass
        if: steps.parse_prevalidation.outputs.all_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ğŸ‰ All tests pass without implementation! Fast path activated."

          # Update PR with fast-path label
          gh pr edit ${{ steps.pr.outputs.pr_number }} --add-label "tdd:fast-path"

          # Auto-merge immediately (no need for Claude)
          bun run scripts/tdd-automation-v2/services/pr-manager.ts merge \
            --pr ${{ steps.pr.outputs.pr_number }}

          # Unlock file and exit
          bun run scripts/tdd-automation-v2/core/unlock-file.ts \
            --file "${{ inputs.file_path }}"

          exit 0

      - name: Run Claude Code (e2e-test-fixer)
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        id: claude_fixer
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 60
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_PAT_WORKFLOW }}
          allowed_bots: '*'
          additional_permissions: |
            actions: read
          prompt: |
            You are working on the TDD Workflow V2 automation. Your task is to implement code to make a failing E2E test pass.

            **Spec ID**: ${{ inputs.spec_id }}
            **Test Name**: ${{ inputs.test_name }}
            **Spec File**: ${{ inputs.file_path }}
            **Retry Count**: ${{ inputs.retry_count }}/3 (0 = first attempt)
            ${{ inputs.retry_count != '0' && format('**Previous Errors**: {0}', inputs.previous_errors) || '' }}

            **Instructions**:
            1. Use the e2e-test-fixer agent to implement the code needed to pass this specific test
            2. The .fixme() has already been removed from the test: ${{ inputs.test_name }}
            3. Implement minimal code to make this test pass (follow TDD best practices)
            4. Run bun test:e2e:regression to verify your implementation
            5. Do NOT run quality checks or add license headers (automated in next steps)

            **Critical Requirements**:
            - Use Effect.ts for business logic in application layer
            - Follow Sovrium layer-based architecture patterns
            - Keep implementation minimal (just enough to pass this specific test)
            - Focus only on ${{ inputs.spec_id }} - do not modify other tests

            **Important Notes**:
            - If src/ files are modified, the codebase-refactor-auditor will run next
            - Quality checks and license headers are added automatically
            - Focus only on making this specific test pass with minimal implementation
          claude_args: >-
            --model claude-sonnet-4-5-20250929
            --max-budget-usd 50.00
            --allowedTools Edit,Read,Write,Bash,Glob,Grep,Task,TodoWrite,Skill,LSP
            --disallowedTools WebFetch,WebSearch,AskUserQuestion,NotebookEdit,SlashCommand

      - name: Check if src/ modified
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        id: src_check
        run: |
          if git diff --name-only | grep '^src/'; then
            echo "modified=true" >> $GITHUB_OUTPUT
          else
            echo "modified=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code (codebase-refactor-auditor)
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.src_check.outputs.modified == 'true'
        id: claude_refactor
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 30
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_PAT_WORKFLOW }}
          allowed_bots: '*'
          additional_permissions: |
            actions: read
          prompt: |
            You are working on the TDD Workflow V2 automation. The e2e-test-fixer agent has implemented code to pass E2E test ${{ inputs.spec_id }} in ${{ inputs.file_path }}.

            **Your Task**: Audit the implementation and refactor for code quality while maintaining test behavior.

            **Instructions**:
            1. Use the codebase-refactor-auditor agent to review recent changes in src/
            2. Eliminate code duplication using DRY principles
            3. Ensure proper layer-based architecture (domain, application, infrastructure, presentation)
            4. Verify Effect.ts patterns are followed correctly
            5. Optimize for readability and maintainability

            **Critical Requirements**:
            - Do NOT change test behavior (all tests must still pass after refactoring)
            - Focus on code quality improvements only
            - Maintain functional programming patterns
            - Keep changes minimal and focused
            - Ensure bun run quality --skip-e2e passes after your changes

            **Important Notes**:
            - Tests are already passing - your job is to improve code quality
            - Quality checks and license headers will be added automatically next
            - Run bun test:e2e:regression to verify tests still pass after refactoring
          claude_args: >-
            --model claude-sonnet-4-5-20250929
            --max-budget-usd 25.00
            --allowedTools Edit,Read,Write,Bash,Glob,Grep,Task,TodoWrite,Skill,LSP
            --disallowedTools WebFetch,WebSearch,AskUserQuestion,NotebookEdit,SlashCommand

      - name: Run quality checks
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        run: |
          echo "âœ… Running quality checks..."
          bun run quality --skip-e2e

      - name: Add license headers
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        run: |
          echo "ğŸ“ Adding license headers..."
          bun run license

      - name: Commit and push changes
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        run: |
          echo "ğŸ“¦ Committing Claude's implementation..."

          git add .

          SPEC_ID="${{ inputs.spec_id }}"
          git commit -m "feat: implement ${SPEC_ID}" -m "Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

          git push origin ${{ steps.branch.outputs.branch }}

          echo "âœ… Changes pushed to PR #${{ steps.pr.outputs.pr_number }}"

      - name: Wait for CI checks
        if: steps.parse_prevalidation.outputs.all_passed == 'false'
        id: ci
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "â³ Waiting for CI checks..."

          RESULT=$(bun run scripts/tdd-automation-v2/services/ci-waiter.ts \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --timeout 600)

          echo "result=$RESULT" >> $GITHUB_OUTPUT

      - name: Auto-merge on success
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.ci.outputs.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "âœ… CI passed! Auto-merging PR..."

          bun run scripts/tdd-automation-v2/services/pr-manager.ts merge \
            --pr ${{ steps.pr.outputs.pr_number }}

      - name: Analyze failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.ci.outputs.result == 'failure'
        id: analyze
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "âŒ CI failed. Analyzing failure type..."

          FAILURE_TYPE=$(bun run scripts/tdd-automation-v2/services/failure-analyzer.ts \
            --pr ${{ steps.pr.outputs.pr_number }})

          echo "type=$FAILURE_TYPE" >> $GITHUB_OUTPUT

      - name: Handle regression failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.analyze.outputs.type == 'regression'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ğŸ”„ Regression detected. Closing PR and re-queuing..."

          bun run scripts/tdd-automation-v2/services/failure-handler.ts \
            --file "${{ inputs.file_path }}" \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --type regression \
            --retry-count "${{ inputs.retry_count }}"

      - name: Handle spec failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.analyze.outputs.type == 'spec-failure'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "âŒ Spec failure. Recording and re-queuing..."

          bun run scripts/tdd-automation-v2/services/failure-handler.ts \
            --file "${{ inputs.file_path }}" \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --type spec-failure \
            --retry-count "${{ inputs.retry_count }}"

      - name: Handle infrastructure failure
        if: steps.parse_prevalidation.outputs.all_passed == 'false' && steps.analyze.outputs.type == 'infrastructure'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "âš™ï¸ Infrastructure failure. Recording and re-queuing..."

          bun run scripts/tdd-automation-v2/services/failure-handler.ts \
            --file "${{ inputs.file_path }}" \
            --pr ${{ steps.pr.outputs.pr_number }} \
            --type infrastructure \
            --retry-count "${{ inputs.retry_count }}"

      - name: Cleanup - Release file lock
        if: always()
        run: |
          echo "ğŸ”“ Releasing file lock..."

          bun run scripts/tdd-automation-v2/core/unlock-file.ts \
            --file "${{ inputs.file_path }}" || true
