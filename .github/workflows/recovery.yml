name: Recovery Actions

# Manual recovery actions for TDD automation pipeline
# Provides workflow_dispatch triggers for common recovery scenarios

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Recovery action to perform'
        required: true
        type: choice
        options:
          - retry-claude-code
          - reset-attempt-counter
          - mark-for-spec-review
          - close-and-reset-spec
      pr_number:
        description: 'PR number to act on'
        required: true
        type: number
      spec_file:
        description: 'Spec file path (required for close-and-reset-spec action)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  execute-recovery:
    name: Execute Recovery Action
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [ "${{ inputs.action }}" = "close-and-reset-spec" ] && [ -z "${{ inputs.spec_file }}" ]; then
            echo "âŒ Error: spec_file is required for close-and-reset-spec action"
            exit 1
          fi
          echo "âœ… Inputs validated"

      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          PR_DATA=$(gh pr view "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --json title,headRefName)
          TITLE=$(echo "$PR_DATA" | jq -r '.title')
          BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          # Extract spec ID from title (format: [TDD] Implement <spec-id> | Attempt X/5)
          SPEC_ID=$(echo "$TITLE" | grep -oP 'Implement \K[^ ]+' || echo "")
          echo "spec-id=$SPEC_ID" >> "$GITHUB_OUTPUT"

          echo "ðŸ“‹ PR #${{ inputs.pr_number }}: $TITLE"
          echo "ðŸŒ¿ Branch: $BRANCH"
          echo "ðŸ”– Spec ID: $SPEC_ID"

      # ============================================================================
      # ACTION: retry-claude-code
      # Posts @claude comment to trigger Claude Code execution
      # ============================================================================
      - name: Action - Retry Claude Code
        if: inputs.action == 'retry-claude-code'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ðŸ”„ Posting @claude comment to trigger retry..."

          # Post @claude comment with spec context
          {
            echo "@claude"
            echo ""
            echo "Spec: \`${{ steps.pr-info.outputs.spec-id }}\`"
            echo "File: \`${{ inputs.spec_file }}\`"
            echo ""
            echo "_Manual retry triggered by TDD recovery workflow_"
          } > /tmp/retry_comment.md

          gh pr comment "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --body-file /tmp/retry_comment.md

          echo "âœ… @claude comment posted - Claude Code workflow will trigger shortly"

      # ============================================================================
      # ACTION: reset-attempt-counter
      # Updates PR title to reset attempt counter to 1/5
      # ============================================================================
      - name: Action - Reset Attempt Counter
        if: inputs.action == 'reset-attempt-counter'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ðŸ”„ Resetting attempt counter to 1/5..."

          # Extract spec ID from current title
          CURRENT_TITLE="${{ steps.pr-info.outputs.title }}"
          SPEC_ID="${{ steps.pr-info.outputs.spec-id }}"

          if [ -z "$SPEC_ID" ]; then
            echo "âŒ Error: Could not extract spec ID from PR title"
            exit 1
          fi

          # Generate new title with attempt 1/5
          NEW_TITLE="[TDD] Implement $SPEC_ID | Attempt 1/5"

          # Update PR title
          gh pr edit "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --title "$NEW_TITLE"

          echo "âœ… PR title updated: $NEW_TITLE"

          # Post comment explaining the reset
          {
            echo "ðŸ”„ **Attempt Counter Reset**"
            echo ""
            echo "The attempt counter has been manually reset to **1/5**."
            echo ""
            echo "**Previous Title**: $CURRENT_TITLE"
            echo "**New Title**: $NEW_TITLE"
            echo ""
            echo "This allows the TDD automation to retry up to 5 more times."
            echo ""
            echo "---"
            echo "_Manual reset via TDD recovery workflow_"
          } > /tmp/reset_comment.md

          gh pr comment "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --body-file /tmp/reset_comment.md

          echo "âœ… Comment posted"

      # ============================================================================
      # ACTION: mark-for-spec-review
      # Closes PR and adds spec-review-needed label
      # ============================================================================
      - name: Action - Mark for Spec Review
        if: inputs.action == 'mark-for-spec-review'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ðŸ“ Marking PR for spec review..."

          # Add label
          gh pr edit "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --add-label "tdd-automation:spec-review-needed"

          # Post comment
          {
            echo "ðŸ“ **Spec Review Needed**"
            echo ""
            echo "This spec requires manual review. Possible reasons:"
            echo "- Spec is too complex or ambiguous"
            echo "- Requirements are unclear or conflicting"
            echo "- Implementation requires architectural decisions"
            echo ""
            echo "**Next Steps**:"
            echo "1. Review the spec in \`${{ inputs.spec_file }}\`"
            echo "2. Simplify or clarify the requirements"
            echo "3. Consider breaking into smaller specs"
            echo "4. Remove \`.fixme()\` annotation when ready"
            echo ""
            echo "---"
            echo "_Manual review requested via TDD recovery workflow_"
          } > /tmp/review_comment.md

          gh pr comment "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --body-file /tmp/review_comment.md

          # Close PR
          gh pr close "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --comment "Closed for spec review"

          echo "âœ… PR closed with spec-review-needed label"

      # ============================================================================
      # ACTION: close-and-reset-spec
      # Closes PR and creates new PR to add .fixme() back to spec
      # ============================================================================
      - name: Action - Close and Reset Spec
        if: inputs.action == 'close-and-reset-spec'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_WORKFLOW }}
        run: |
          echo "ðŸ”„ Closing PR and resetting spec..."

          # Close current PR
          gh pr close "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --comment "Closed - resetting spec to .fixme() state"

          # Add label to closed PR
          gh pr edit "${{ inputs.pr_number }}" --repo "${{ github.repository }}" --add-label "tdd-automation:reset-spec"

          echo "âœ… PR closed"
          echo "âš ï¸ Next: Create a new PR to add .fixme() back to the spec file"
          echo "ðŸ“ Spec file: ${{ inputs.spec_file }}"
          echo ""
          echo "**Manual Steps Required**:"
          echo "1. Checkout main branch"
          echo "2. Add .fixme() annotation back to test in ${{ inputs.spec_file }}"
          echo "3. Commit and push"
          echo "4. PR creator will detect the spec again"

      # ============================================================================
      # POST-ACTION SUMMARY
      # ============================================================================
      - name: Post Summary
        if: always()
        run: |
          echo "## TDD Recovery Action Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number**: #${{ inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Spec ID**: ${{ steps.pr-info.outputs.spec-id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ steps.pr-info.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "${{ inputs.action }}" in
            retry-claude-code)
              echo "âœ… Posted @claude comment to trigger retry" >> $GITHUB_STEP_SUMMARY
              ;;
            reset-attempt-counter)
              echo "âœ… Reset attempt counter to 1/5" >> $GITHUB_STEP_SUMMARY
              ;;
            mark-for-spec-review)
              echo "âœ… Closed PR with spec-review-needed label" >> $GITHUB_STEP_SUMMARY
              ;;
            close-and-reset-spec)
              echo "âœ… Closed PR - manual reset of spec required" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
