{
  "summary": "List records in table",
  "description": "Returns paginated list of records from the specified table with advanced filtering, sorting, field selection, grouping, and aggregation capabilities.",
  "operationId": "listRecords",
  "tags": ["records"],
  "parameters": [
    {
      "name": "tableId",
      "in": "path",
      "required": true,
      "schema": {
        "type": "integer",
        "minimum": 1
      },
      "description": "Unique identifier of the table"
    },
    {
      "name": "view",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "Apply predefined view ID (applies view's filters, sorts, and field visibility)",
      "example": "active_projects"
    },
    {
      "name": "filter",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "JSON filter expression with AND/OR logic. Example: {\"operator\":\"AND\",\"conditions\":[{\"field\":\"status\",\"operator\":\"equals\",\"value\":\"active\"},{\"field\":\"priority\",\"operator\":\"greaterThanOrEqual\",\"value\":3}]}",
      "example": "{\"operator\":\"AND\",\"conditions\":[{\"field\":\"status\",\"operator\":\"equals\",\"value\":\"active\"}]}"
    },
    {
      "name": "filterByFormula",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "Airtable-style formula filtering. Example: AND({status}='active', {priority}>=3)",
      "example": "AND({status}='active', {priority}>=3)"
    },
    {
      "name": "sort",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "Comma-separated field:direction pairs. Direction can be 'asc' or 'desc'. Example: priority:desc,created_at:desc",
      "example": "priority:desc,created_at:desc"
    },
    {
      "name": "fields",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "Comma-separated field names to include in response (projection). Only specified fields will be returned.",
      "example": "id,name,status,created_at"
    },
    {
      "name": "limit",
      "in": "query",
      "required": false,
      "schema": {
        "type": "integer",
        "minimum": 1,
        "maximum": 1000,
        "default": 100
      },
      "description": "Maximum number of records to return per request (offset-based pagination)"
    },
    {
      "name": "offset",
      "in": "query",
      "required": false,
      "schema": {
        "type": "integer",
        "minimum": 0,
        "default": 0
      },
      "description": "Number of records to skip (offset-based pagination)"
    },
    {
      "name": "pageSize",
      "in": "query",
      "required": false,
      "schema": {
        "type": "integer",
        "minimum": 1,
        "maximum": 1000
      },
      "description": "Records per page (token-based pagination). Use with pageToken for cursor-based navigation."
    },
    {
      "name": "pageToken",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "Continuation token for next page (token-based pagination). Obtained from previous response."
    },
    {
      "name": "groupBy",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "Field name to group records by. Returns records grouped by distinct values of this field.",
      "example": "status"
    },
    {
      "name": "aggregate",
      "in": "query",
      "required": false,
      "schema": {
        "type": "string"
      },
      "description": "JSON object specifying aggregation functions. Supported: count, sum, avg, min, max. Example: {\"count\":true,\"sum\":[\"budget\"],\"avg\":[\"priority\"]}",
      "example": "{\"count\":true,\"sum\":[\"budget\",\"amount\"],\"avg\":[\"priority\",\"rating\"]}"
    }
  ],
  "responses": {
    "200": {
      "description": "List of records with pagination and optional aggregations",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "records": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                },
                "description": "Array of record objects matching the query"
              },
              "pagination": {
                "type": "object",
                "properties": {
                  "total": {
                    "type": "integer",
                    "description": "Total number of records matching the query"
                  },
                  "limit": {
                    "type": "integer",
                    "description": "Current limit (max records per page)"
                  },
                  "offset": {
                    "type": "integer",
                    "description": "Current offset (records skipped)"
                  },
                  "nextPageToken": {
                    "type": "string",
                    "description": "Token for fetching next page (token-based pagination)"
                  }
                },
                "required": ["total"]
              },
              "aggregations": {
                "type": "object",
                "description": "Aggregation results (only included if aggregate parameter provided)",
                "properties": {
                  "count": {
                    "type": "integer",
                    "description": "Total count of records"
                  },
                  "sum": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "number"
                    },
                    "description": "Sum aggregations by field"
                  },
                  "avg": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "number"
                    },
                    "description": "Average aggregations by field"
                  },
                  "min": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "number"
                    },
                    "description": "Minimum values by field"
                  },
                  "max": {
                    "type": "object",
                    "additionalProperties": {
                      "type": "number"
                    },
                    "description": "Maximum values by field"
                  }
                }
              }
            },
            "required": ["records", "pagination"]
          },
          "examples": {
            "basicList": {
              "summary": "Basic list without filters",
              "value": {
                "records": [
                  {
                    "id": 1,
                    "name": "Project Alpha",
                    "status": "active",
                    "priority": 5,
                    "created_at": "2025-01-15T10:30:00Z"
                  },
                  {
                    "id": 2,
                    "name": "Project Beta",
                    "status": "completed",
                    "priority": 3,
                    "created_at": "2025-01-20T14:00:00Z"
                  }
                ],
                "pagination": {
                  "total": 150,
                  "limit": 100,
                  "offset": 0
                }
              }
            },
            "filteredAndSorted": {
              "summary": "Filtered and sorted records",
              "value": {
                "records": [
                  {
                    "id": 5,
                    "name": "High Priority Task",
                    "status": "active",
                    "priority": 5,
                    "created_at": "2025-01-22T09:00:00Z"
                  },
                  {
                    "id": 3,
                    "name": "Important Project",
                    "status": "active",
                    "priority": 4,
                    "created_at": "2025-01-18T11:30:00Z"
                  }
                ],
                "pagination": {
                  "total": 45,
                  "limit": 100,
                  "offset": 0
                }
              }
            },
            "withAggregations": {
              "summary": "Records with aggregation results",
              "value": {
                "records": [
                  {
                    "id": 1,
                    "name": "Project Alpha",
                    "budget": 50000,
                    "priority": 5
                  }
                ],
                "pagination": {
                  "total": 150,
                  "limit": 100,
                  "offset": 0
                },
                "aggregations": {
                  "count": 150,
                  "sum": {
                    "budget": 1500000
                  },
                  "avg": {
                    "priority": 4.2
                  },
                  "min": {
                    "budget": 1000
                  },
                  "max": {
                    "budget": 100000
                  }
                }
              }
            },
            "fieldProjection": {
              "summary": "Records with selected fields only",
              "value": {
                "records": [
                  {
                    "id": 1,
                    "name": "Project Alpha",
                    "status": "active"
                  },
                  {
                    "id": 2,
                    "name": "Project Beta",
                    "status": "completed"
                  }
                ],
                "pagination": {
                  "total": 150,
                  "limit": 100,
                  "offset": 0
                }
              }
            }
          }
        }
      }
    },
    "400": {
      "description": "Invalid query parameters",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "error": {
                "type": "string"
              },
              "message": {
                "type": "string"
              }
            }
          },
          "examples": {
            "invalidFilter": {
              "summary": "Invalid filter JSON",
              "value": {
                "error": "ValidationError",
                "message": "Invalid filter parameter: malformed JSON"
              }
            },
            "invalidSort": {
              "summary": "Invalid sort format",
              "value": {
                "error": "ValidationError",
                "message": "Invalid sort parameter: expected format 'field:direction'"
              }
            }
          }
        }
      }
    },
    "404": {
      "$ref": "../../../../components/responses/TableNotFound.json"
    }
  },
  "x-specs": [
    {
      "id": "API-TABLES-RECORDS-LIST-001",
      "given": "Table 'projects' with 3 records",
      "when": "User requests all records",
      "then": "Returns 200 with array of 3 records and pagination metadata",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, status VARCHAR(50) DEFAULT 'active', priority INTEGER DEFAULT 1, created_at TIMESTAMP DEFAULT NOW())",
            "INSERT INTO projects (name, status, priority) VALUES ('Project Alpha', 'active', 5), ('Project Beta', 'completed', 3), ('Project Gamma', 'active', 4)"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 200 with all records and pagination",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "minItems": 3,
                  "maxItems": 3
                },
                "pagination": {
                  "type": "object",
                  "properties": {
                    "total": { "type": "integer" },
                    "limit": { "type": "integer" },
                    "offset": { "type": "integer" }
                  },
                  "required": ["total"]
                }
              },
              "required": ["records", "pagination"]
            },
            "validateResponseData": {
              "pagination.total": 3,
              "records.length": 3
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-002",
      "given": "A running server with no table ID 9999",
      "when": "User requests records from non-existent table",
      "then": "Returns 404 Not Found",
      "validation": {
        "setup": {
          "executeQuery": [],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/9999/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 9999 }
          }
        },
        "assertions": [
          {
            "description": "Returns 404 when table does not exist",
            "expectedStatus": 404,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Table not found"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-003",
      "given": "Table with 5 records (2 active, 3 completed)",
      "when": "User requests records with filter for status=active",
      "then": "Returns 200 with only 2 active records",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, status VARCHAR(50) NOT NULL)",
            "INSERT INTO tasks (name, status) VALUES ('Task 1', 'active'), ('Task 2', 'active'), ('Task 3', 'completed'), ('Task 4', 'completed'), ('Task 5', 'completed')"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "filter": "{\"operator\":\"AND\",\"conditions\":[{\"field\":\"status\",\"operator\":\"equals\",\"value\":\"active\"}]}"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns only records matching filter criteria",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": { "type": "array" },
                "pagination": {
                  "type": "object",
                  "properties": {
                    "total": { "type": "integer" }
                  }
                }
              }
            },
            "validateResponseData": {
              "pagination.total": 2,
              "records.length": 2
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-004",
      "given": "Table with 3 records having different priorities",
      "when": "User requests records sorted by priority descending",
      "then": "Returns 200 with records in descending priority order",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), priority INTEGER)",
            "INSERT INTO projects (name, priority) VALUES ('Low Priority', 1), ('High Priority', 5), ('Medium Priority', 3)"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "sort": "priority:desc"
            }
          }
        },
        "assertions": [
          {
            "description": "Records sorted by priority descending",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "minItems": 3
                }
              }
            },
            "validateResponseData": {
              "records[0].priority": 5,
              "records[1].priority": 3,
              "records[2].priority": 1
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-005",
      "given": "Table with records containing 5 fields each",
      "when": "User requests only id and name fields",
      "then": "Returns 200 with records containing only specified fields",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), phone VARCHAR(50), address TEXT, created_at TIMESTAMP)",
            "INSERT INTO users (name, email, phone, address, created_at) VALUES ('John Doe', 'john@example.com', '555-0100', '123 Main St', NOW())"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "fields": "id,name"
            }
          }
        },
        "assertions": [
          {
            "description": "Response includes only requested fields",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": { "type": "integer" },
                      "name": { "type": "string" }
                    },
                    "required": ["id", "name"]
                  }
                }
              }
            },
            "validateResponseData": {
              "records[0].name": "John Doe"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-006",
      "given": "Table with 150 records",
      "when": "User requests records with limit=20 and offset=40",
      "then": "Returns 200 with records 41-60 and correct pagination metadata",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE items (id SERIAL PRIMARY KEY, name VARCHAR(255))",
            "INSERT INTO items (name) SELECT 'Item ' || generate_series(1, 150)"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "limit": 20,
              "offset": 40
            }
          }
        },
        "assertions": [
          {
            "description": "Returns paginated subset with correct metadata",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": { "type": "array" },
                "pagination": {
                  "type": "object",
                  "properties": {
                    "total": { "type": "integer" },
                    "limit": { "type": "integer" },
                    "offset": { "type": "integer" }
                  }
                }
              }
            },
            "validateResponseData": {
              "pagination.total": 150,
              "pagination.limit": 20,
              "pagination.offset": 40,
              "records.length": 20
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-007",
      "given": "Table with predefined view filtering active status",
      "when": "User requests records with view parameter",
      "then": "Returns 200 with records filtered by view configuration",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, name VARCHAR(255), status VARCHAR(50))",
            "INSERT INTO tasks (name, status) VALUES ('Task 1', 'active'), ('Task 2', 'inactive'), ('Task 3', 'active')"
          ],
          "tableConfig": {
            "views": [
              {
                "id": "active_view",
                "filters": [{ "field": "status", "operator": "equals", "value": "active" }]
              }
            ]
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "view": "active_view"
            }
          }
        },
        "assertions": [
          {
            "description": "View filters applied to results",
            "expectedStatus": 200,
            "validateResponseData": {
              "pagination.total": 2,
              "records.length": 2
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-008",
      "given": "Table with records of different statuses",
      "when": "User requests records grouped by status field",
      "then": "Returns 200 with records grouped by distinct status values",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), status VARCHAR(50))",
            "INSERT INTO projects (name, status) VALUES ('P1', 'active'), ('P2', 'active'), ('P3', 'completed'), ('P4', 'pending')"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "groupBy": "status"
            }
          }
        },
        "assertions": [
          {
            "description": "Records grouped by status field",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": { "type": "array" },
                "groups": {
                  "type": "object",
                  "additionalProperties": {
                    "type": "array"
                  }
                }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-009",
      "given": "Table with numeric budget and priority fields",
      "when": "User requests aggregations (count, sum, avg)",
      "then": "Returns 200 with aggregation results in response",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), budget INTEGER, priority INTEGER)",
            "INSERT INTO projects (name, budget, priority) VALUES ('P1', 10000, 5), ('P2', 20000, 3), ('P3', 15000, 4)"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "aggregate": "{\"count\":true,\"sum\":[\"budget\"],\"avg\":[\"priority\"]}"
            }
          }
        },
        "assertions": [
          {
            "description": "Aggregation results included in response",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": { "type": "array" },
                "aggregations": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "sum": { "type": "object" },
                    "avg": { "type": "object" }
                  }
                }
              }
            },
            "validateResponseData": {
              "aggregations.count": 3,
              "aggregations.sum.budget": 45000,
              "aggregations.avg.priority": 4
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-010",
      "given": "Table with status and priority fields",
      "when": "User filters records using Airtable-style formula",
      "then": "Returns 200 with records matching formula criteria",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, name VARCHAR(255), status VARCHAR(50), priority INTEGER)",
            "INSERT INTO tasks (name, status, priority) VALUES ('T1', 'active', 5), ('T2', 'active', 2), ('T3', 'completed', 5)"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "filterByFormula": "AND({status}='active', {priority}>=3)"
            }
          }
        },
        "assertions": [
          {
            "description": "Formula filter applied correctly",
            "expectedStatus": 200,
            "validateResponseData": {
              "pagination.total": 1,
              "records.length": 1,
              "records[0].name": "T1"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-011",
      "given": "Table with status and created_at fields",
      "when": "User sorts by status ascending, then created_at descending",
      "then": "Returns 200 with records sorted by primary then secondary field",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, name VARCHAR(255), status VARCHAR(50), created_at TIMESTAMP)",
            "INSERT INTO tasks (name, status, created_at) VALUES ('T1', 'active', '2025-01-01'), ('T2', 'active', '2025-01-15'), ('T3', 'completed', '2025-01-10')"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "sort": "status:asc,created_at:desc"
            }
          }
        },
        "assertions": [
          {
            "description": "Multi-field sort applied correctly",
            "expectedStatus": 200,
            "validateResponseData": {
              "records[0].status": "active",
              "records[0].name": "T2",
              "records[1].status": "active",
              "records[1].name": "T1",
              "records[2].status": "completed"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-012",
      "given": "Table with view filtering status=active and explicit priority filter",
      "when": "User combines view parameter with filter parameter",
      "then": "Returns 200 with both view and explicit filters applied (AND logic)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, name VARCHAR(255), status VARCHAR(50), priority INTEGER)",
            "INSERT INTO tasks (name, status, priority) VALUES ('T1', 'active', 5), ('T2', 'active', 2), ('T3', 'completed', 5)"
          ],
          "tableConfig": {
            "views": [
              {
                "id": "active_view",
                "filters": [{ "field": "status", "operator": "equals", "value": "active" }]
              }
            ]
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": {
              "Authorization": "Bearer test_token"
            },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "view": "active_view",
              "filter": "{\"operator\":\"AND\",\"conditions\":[{\"field\":\"priority\",\"operator\":\"greaterThan\",\"value\":3}]}"
            }
          }
        },
        "assertions": [
          {
            "description": "View and explicit filters combined with AND logic",
            "expectedStatus": 200,
            "validateResponseData": {
              "pagination.total": 1,
              "records.length": 1,
              "records[0].name": "T1",
              "records[0].status": "active",
              "records[0].priority": 5
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-UNAUTHORIZED-001",
      "given": "An unauthenticated user (no Bearer token)",
      "when": "User attempts to list records from a table",
      "then": "Returns 401 Unauthorized error",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, salary) VALUES ('John Doe', 75000)"
          ],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 401 when no auth token provided",
            "expectedStatus": 401,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "message": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Unauthorized"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-FORBIDDEN-VIEWER-001",
      "given": "A viewer user without read permission for the table",
      "when": "User attempts to list records",
      "then": "Returns 403 Forbidden error",
      "validation": {
        "setup": {
          "executeQuery": ["CREATE TABLE confidential_data (id SERIAL PRIMARY KEY, data TEXT)"],
          "authUser": {
            "id": 3,
            "organizationId": "org_123",
            "role": "viewer"
          },
          "tableConfig": {
            "id": 1,
            "name": "confidential_data",
            "permissions": {
              "viewer": {
                "table": { "read": false, "create": false, "update": false, "delete": false }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer viewer_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 403 when user lacks read permission",
            "expectedStatus": 403,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "message": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Forbidden"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-ORG-ISOLATION-001",
      "given": "A user from organization A attempting to access table from organization B",
      "when": "User attempts to list records from different organization's table",
      "then": "Returns 404 Not Found (don't leak existence of other org's data)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), organization_id VARCHAR(255))",
            "INSERT INTO projects (name, organization_id) VALUES ('Project A', 'org_456')"
          ],
          "authUser": {
            "id": 1,
            "organizationId": "org_123",
            "role": "admin"
          },
          "tableConfig": {
            "id": 1,
            "name": "projects",
            "organizationId": "org_456"
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer admin_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 404 to prevent leaking existence of other organization's data",
            "expectedStatus": 404,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Table not found"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-ORG-FILTER-001",
      "given": "Multiple organizations with records in the same table",
      "when": "User lists records",
      "then": "Returns only records belonging to user's organization",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), organization_id VARCHAR(255))",
            "INSERT INTO employees (name, organization_id) VALUES ('Alice', 'org_123'), ('Bob', 'org_123'), ('Charlie', 'org_456')"
          ],
          "authUser": {
            "id": 1,
            "organizationId": "org_123",
            "role": "admin"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123"
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer admin_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns only records from user's organization",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": { "type": "array" },
                "pagination": { "type": "object" }
              },
              "required": ["records", "pagination"]
            },
            "validateResponseData": {
              "pagination.total": 2,
              "records.length": 2
            }
          },
          {
            "description": "All returned records belong to user's organization",
            "executeAssertion": "expect(response.records.every(r => r.organization_id === 'org_123')).toBe(true)"
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-FIELD-FILTER-ADMIN-001",
      "given": "An admin user listing records with sensitive fields",
      "when": "Admin lists records from employees table",
      "then": "Returns all fields including sensitive fields (salary)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, email, salary) VALUES ('John Doe', 'john@example.com', 75000), ('Jane Smith', 'jane@example.com', 85000)"
          ],
          "authUser": {
            "id": 1,
            "organizationId": "org_123",
            "role": "admin"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "admin": {
                "table": { "read": true, "create": true, "update": true, "delete": true },
                "fields": {
                  "salary": { "read": true, "write": true }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer admin_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns records with all fields including salary",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": { "type": "integer" },
                      "name": { "type": "string" },
                      "email": { "type": "string" },
                      "salary": { "type": "number" }
                    },
                    "required": ["id", "name", "email", "salary"]
                  }
                }
              }
            },
            "validateResponseData": {
              "records.length": 2,
              "records[0].salary": 75000,
              "records[1].salary": 85000
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-FIELD-FILTER-MEMBER-001",
      "given": "A member user with field-level restrictions (salary field hidden)",
      "when": "Member lists records from employees table",
      "then": "Returns records with salary field excluded from response",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, email, salary) VALUES ('John Doe', 'john@example.com', 75000), ('Jane Smith', 'jane@example.com', 85000)"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns records with salary field filtered out",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": { "type": "integer" },
                      "name": { "type": "string" },
                      "email": { "type": "string" }
                    },
                    "required": ["id", "name", "email"]
                  }
                }
              }
            },
            "validateResponseData": {
              "records.length": 2
            }
          },
          {
            "description": "Salary field does not exist in response",
            "executeAssertion": "expect(response.records[0]).not.toHaveProperty('salary')"
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-FIELD-FILTER-VIEWER-001",
      "given": "A viewer user with field-level restrictions (salary and email hidden)",
      "when": "Viewer lists records from employees table",
      "then": "Returns records with sensitive fields excluded",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, email, salary) VALUES ('John Doe', 'john@example.com', 75000)"
          ],
          "authUser": {
            "id": 3,
            "organizationId": "org_123",
            "role": "viewer"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "viewer": {
                "table": { "read": true, "create": false, "update": false, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false },
                  "email": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer viewer_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns records with only permitted fields",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": { "type": "integer" },
                      "name": { "type": "string" }
                    },
                    "required": ["id", "name"]
                  }
                }
              }
            }
          },
          {
            "description": "Sensitive fields do not exist in response",
            "executeAssertion": "expect(response.records[0]).not.toHaveProperty('salary') && expect(response.records[0]).not.toHaveProperty('email')"
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-FIELD-FILTER-MULTIPLE-001",
      "given": "Multiple sensitive fields with different permission levels per role",
      "when": "User lists records",
      "then": "Returns records with appropriate field filtering based on role",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), phone VARCHAR(50), salary DECIMAL(10,2), ssn VARCHAR(11))",
            "INSERT INTO employees (name, email, phone, salary, ssn) VALUES ('John Doe', 'john@example.com', '555-0100', 75000, '123-45-6789')"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "email": { "read": true, "write": true },
                  "phone": { "read": true, "write": false },
                  "salary": { "read": false, "write": false },
                  "ssn": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns records with granular field filtering applied",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": { "type": "integer" },
                      "name": { "type": "string" },
                      "email": { "type": "string" },
                      "phone": { "type": "string" }
                    },
                    "required": ["id", "name", "email", "phone"]
                  }
                }
              }
            }
          },
          {
            "description": "Highly sensitive fields excluded",
            "executeAssertion": "expect(response.records[0]).not.toHaveProperty('salary') && expect(response.records[0]).not.toHaveProperty('ssn')"
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-FIELD-PROJECTION-001",
      "given": "User requests specific fields using 'fields' query parameter",
      "when": "Field projection combined with permission filtering",
      "then": "Returns only fields that are both requested AND permitted",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, email, salary) VALUES ('John Doe', 'john@example.com', 75000)"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "fields": "id,name,email,salary"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns only permitted fields even if salary was requested",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "id": { "type": "integer" },
                      "name": { "type": "string" },
                      "email": { "type": "string" }
                    },
                    "required": ["id", "name", "email"]
                  }
                }
              }
            }
          },
          {
            "description": "Salary field excluded despite being requested",
            "executeAssertion": "expect(response.records[0]).not.toHaveProperty('salary')"
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-COMBINED-001",
      "given": "Organization isolation and field-level filtering both apply",
      "when": "User lists records",
      "then": "Returns only own organization's records with field filtering applied",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), salary DECIMAL(10,2), organization_id VARCHAR(255))",
            "INSERT INTO employees (name, salary, organization_id) VALUES ('Alice', 75000, 'org_123'), ('Bob', 85000, 'org_123'), ('Charlie', 95000, 'org_456')"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns only own org records with salary filtered",
            "expectedStatus": 200,
            "validateResponseData": {
              "pagination.total": 2,
              "records.length": 2
            }
          },
          {
            "description": "All records from user's org and salary field hidden",
            "executeAssertion": "expect(response.records.every(r => r.organization_id === 'org_123' && !r.hasOwnProperty('salary'))).toBe(true)"
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-EMPTY-RESULTS-001",
      "given": "User has permission to read table but no records exist in their organization",
      "when": "User lists records",
      "then": "Returns 200 with empty records array and total: 0",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), organization_id VARCHAR(255))",
            "INSERT INTO projects (name, organization_id) VALUES ('Project X', 'org_456')"
          ],
          "authUser": {
            "id": 1,
            "organizationId": "org_123",
            "role": "admin"
          },
          "tableConfig": {
            "id": 1,
            "name": "projects",
            "organizationId": "org_123",
            "permissions": {
              "admin": {
                "table": { "read": true, "create": true, "update": true, "delete": true }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer admin_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 200 with empty results when no records in user's org",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": { "type": "array" },
                "pagination": {
                  "type": "object",
                  "properties": {
                    "total": { "type": "integer" }
                  }
                }
              }
            },
            "validateResponseData": {
              "pagination.total": 0,
              "records.length": 0
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-PAGINATION-001",
      "given": "Large dataset with field-level permissions and pagination",
      "when": "User paginates through records",
      "then": "All paginated results respect field-level permissions",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, salary) SELECT 'Employee ' || generate_series(1, 50), generate_series(50000, 99000, 1000)"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "limit": 20,
              "offset": 10
            }
          }
        },
        "assertions": [
          {
            "description": "Pagination works correctly with field filtering",
            "expectedStatus": 200,
            "validateResponseData": {
              "pagination.total": 50,
              "pagination.limit": 20,
              "pagination.offset": 10,
              "records.length": 20
            }
          },
          {
            "description": "All paginated records have salary field filtered",
            "executeAssertion": "expect(response.records.every(r => !r.hasOwnProperty('salary'))).toBe(true)"
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-SORTING-001",
      "given": "User attempts to sort by a field they cannot read",
      "when": "Sort parameter includes hidden field (salary)",
      "then": "Returns 403 Forbidden (cannot sort by inaccessible field)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, salary) VALUES ('Alice', 75000), ('Bob', 85000)"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "sort": "salary:desc"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 403 when attempting to sort by inaccessible field",
            "expectedStatus": 403,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "message": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Forbidden",
              "message": "Cannot sort by field 'salary': insufficient permissions"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-FILTERING-001",
      "given": "User attempts to filter by a field they cannot read",
      "when": "Filter parameter includes hidden field (salary)",
      "then": "Returns 403 Forbidden (cannot filter by inaccessible field)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, salary) VALUES ('Alice', 75000), ('Bob', 85000)"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "filter": "{\"operator\":\"AND\",\"conditions\":[{\"field\":\"salary\",\"operator\":\"greaterThan\",\"value\":70000}]}"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 403 when attempting to filter by inaccessible field",
            "expectedStatus": 403,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "message": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Forbidden",
              "message": "Cannot filter by field 'salary': insufficient permissions"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-AGGREGATE-001",
      "given": "User attempts to aggregate field they cannot read",
      "when": "Aggregate parameter includes hidden field (salary)",
      "then": "Returns 403 Forbidden (cannot aggregate inaccessible field)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), salary DECIMAL(10,2))",
            "INSERT INTO employees (name, salary) VALUES ('Alice', 75000), ('Bob', 85000)"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "aggregate": "{\"avg\":[\"salary\"]}"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 403 when attempting to aggregate inaccessible field",
            "expectedStatus": 403,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "message": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Forbidden",
              "message": "Cannot aggregate field 'salary': insufficient permissions"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-RECORDS-LIST-PERMISSIONS-AGGREGATE-ALLOWED-001",
      "given": "User aggregates only accessible fields",
      "when": "Aggregate parameter includes only permitted fields",
      "then": "Returns aggregation results for accessible fields",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), priority INTEGER, budget DECIMAL(10,2))",
            "INSERT INTO projects (name, priority, budget) VALUES ('P1', 5, 10000), ('P2', 3, 20000), ('P3', 4, 15000)"
          ],
          "authUser": {
            "id": 2,
            "organizationId": "org_123",
            "role": "member"
          },
          "tableConfig": {
            "id": 1,
            "name": "projects",
            "organizationId": "org_123",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "priority": { "read": true, "write": true },
                  "budget": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/records",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 },
            "queryParams": {
              "aggregate": "{\"count\":true,\"avg\":[\"priority\"]}"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns aggregation results for accessible fields only",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "records": { "type": "array" },
                "aggregations": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "avg": {
                      "type": "object",
                      "properties": {
                        "priority": { "type": "number" }
                      }
                    }
                  }
                }
              }
            },
            "validateResponseData": {
              "aggregations.count": 3,
              "aggregations.avg.priority": 4
            }
          },
          {
            "description": "Budget field not included in aggregations",
            "executeAssertion": "expect(response.aggregations.avg).not.toHaveProperty('budget')"
          }
        ]
      }
    }
  ]
}
