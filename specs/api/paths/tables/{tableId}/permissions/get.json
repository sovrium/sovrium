{
  "summary": "Check table permissions",
  "description": "Returns the current authenticated user's effective permissions for the specified table. Includes table-level operations (read, create, update, delete) and field-level permissions (read/write for each field). Requires authentication.",
  "operationId": "checkTablePermissions",
  "tags": ["permissions"],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "parameters": [
    {
      "name": "tableId",
      "in": "path",
      "required": true,
      "description": "The ID of the table",
      "schema": {
        "type": "integer",
        "minimum": 1
      }
    }
  ],
  "responses": {
    "200": {
      "description": "User's permissions for the table",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "properties": {
              "table": {
                "type": "object",
                "description": "Table-level permissions",
                "properties": {
                  "read": {
                    "type": "boolean",
                    "description": "Can list/read records from table"
                  },
                  "create": {
                    "type": "boolean",
                    "description": "Can create new records in table"
                  },
                  "update": {
                    "type": "boolean",
                    "description": "Can update records in table"
                  },
                  "delete": {
                    "type": "boolean",
                    "description": "Can delete records from table"
                  }
                },
                "required": ["read", "create", "update", "delete"]
              },
              "fields": {
                "type": "object",
                "description": "Field-level permissions (per field name)",
                "additionalProperties": {
                  "type": "object",
                  "properties": {
                    "read": {
                      "type": "boolean",
                      "description": "Can view this field's value"
                    },
                    "write": {
                      "type": "boolean",
                      "description": "Can modify this field's value"
                    }
                  },
                  "required": ["read", "write"]
                }
              }
            },
            "required": ["table", "fields"]
          },
          "examples": {
            "adminPermissions": {
              "summary": "Admin user with full permissions",
              "value": {
                "table": {
                  "read": true,
                  "create": true,
                  "update": true,
                  "delete": true
                },
                "fields": {
                  "id": {
                    "read": true,
                    "write": false
                  },
                  "name": {
                    "read": true,
                    "write": true
                  },
                  "email": {
                    "read": true,
                    "write": true
                  },
                  "salary": {
                    "read": true,
                    "write": true
                  },
                  "created_at": {
                    "read": true,
                    "write": false
                  },
                  "updated_at": {
                    "read": true,
                    "write": false
                  }
                }
              }
            },
            "memberPermissions": {
              "summary": "Member user with limited permissions",
              "value": {
                "table": {
                  "read": true,
                  "create": false,
                  "update": true,
                  "delete": false
                },
                "fields": {
                  "id": {
                    "read": true,
                    "write": false
                  },
                  "name": {
                    "read": true,
                    "write": true
                  },
                  "email": {
                    "read": true,
                    "write": true
                  },
                  "salary": {
                    "read": false,
                    "write": false
                  },
                  "created_at": {
                    "read": true,
                    "write": false
                  },
                  "updated_at": {
                    "read": true,
                    "write": false
                  }
                }
              }
            },
            "viewerPermissions": {
              "summary": "Viewer with read-only access",
              "value": {
                "table": {
                  "read": true,
                  "create": false,
                  "update": false,
                  "delete": false
                },
                "fields": {
                  "id": {
                    "read": true,
                    "write": false
                  },
                  "name": {
                    "read": true,
                    "write": false
                  },
                  "email": {
                    "read": true,
                    "write": false
                  },
                  "salary": {
                    "read": false,
                    "write": false
                  },
                  "created_at": {
                    "read": true,
                    "write": false
                  },
                  "updated_at": {
                    "read": true,
                    "write": false
                  }
                }
              }
            }
          }
        }
      }
    },
    "401": {
      "$ref": "../../../../components/responses/Unauthorized.json"
    },
    "404": {
      "$ref": "../../../../components/responses/TableNotFound.json"
    }
  },
  "x-specs": [
    {
      "id": "API-TABLES-PERMISSIONS-CHECK-001",
      "given": "An authenticated admin user",
      "when": "User checks permissions for a table",
      "then": "All table and field permissions should be returned as true",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), salary DECIMAL(10,2), created_at TIMESTAMP, updated_at TIMESTAMP)"
          ],
          "authUser": {
            "id": 1,
            "role": "admin",
            "permissions": ["tables:read", "tables:create", "tables:update", "tables:delete"]
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/permissions",
            "headers": { "Authorization": "Bearer admin_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 200 with full table permissions for admin",
            "expectedStatus": 200,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "table": {
                  "type": "object",
                  "properties": {
                    "read": { "type": "boolean" },
                    "create": { "type": "boolean" },
                    "update": { "type": "boolean" },
                    "delete": { "type": "boolean" }
                  },
                  "required": ["read", "create", "update", "delete"]
                },
                "fields": { "type": "object" }
              },
              "required": ["table", "fields"]
            },
            "validateResponseData": {
              "table.read": true,
              "table.create": true,
              "table.update": true,
              "table.delete": true
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-PERMISSIONS-CHECK-002",
      "given": "An authenticated member user with limited permissions",
      "when": "User checks permissions for a table",
      "then": "Permissions should reflect user's role restrictions",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), salary DECIMAL(10,2))"
          ],
          "authUser": {
            "id": 2,
            "role": "member",
            "permissions": ["tables:read", "tables:update"]
          },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "permissions": {
              "member": {
                "table": { "read": true, "create": false, "update": true, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/permissions",
            "headers": { "Authorization": "Bearer member_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 200 with restricted permissions for member",
            "expectedStatus": 200,
            "validateResponseData": {
              "table.read": true,
              "table.create": false,
              "table.update": true,
              "table.delete": false,
              "fields.salary.read": false,
              "fields.salary.write": false
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-PERMISSIONS-CHECK-003",
      "given": "An unauthenticated user",
      "when": "User attempts to check permissions",
      "then": "401 Unauthorized error should be returned",
      "validation": {
        "setup": {
          "executeQuery": ["CREATE TABLE employees (id SERIAL PRIMARY KEY)"],
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/permissions",
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns 401 when no auth token provided",
            "expectedStatus": 401,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "message": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-PERMISSIONS-CHECK-004",
      "given": "An authenticated user checking a non-existent table",
      "when": "User checks permissions for invalid table ID",
      "then": "404 Not Found error should be returned",
      "validation": {
        "setup": {
          "executeQuery": [],
          "authUser": { "id": 1, "role": "admin" },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/9999/permissions",
            "headers": { "Authorization": "Bearer admin_token" },
            "pathParams": { "tableId": 9999 }
          }
        },
        "assertions": [
          {
            "description": "Returns 404 when table does not exist",
            "expectedStatus": 404,
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" }
              },
              "required": ["error"]
            },
            "validateResponseData": {
              "error": "Table not found"
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-PERMISSIONS-CHECK-005",
      "given": "A table with field-level permission restrictions",
      "when": "User checks permissions",
      "then": "Sensitive fields should show read: false and write: false",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255), salary DECIMAL(10,2))"
          ],
          "authUser": { "id": 3, "role": "viewer" },
          "tableConfig": {
            "id": 1,
            "name": "employees",
            "permissions": {
              "viewer": {
                "table": { "read": true, "create": false, "update": false, "delete": false },
                "fields": {
                  "salary": { "read": false, "write": false },
                  "email": { "read": true, "write": false },
                  "name": { "read": true, "write": false }
                }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/permissions",
            "headers": { "Authorization": "Bearer viewer_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns permissions with sensitive fields blocked",
            "expectedStatus": 200,
            "validateResponseData": {
              "fields.salary.read": false,
              "fields.salary.write": false,
              "fields.email.read": true,
              "fields.email.write": false,
              "fields.name.read": true,
              "fields.name.write": false
            }
          }
        ]
      }
    },
    {
      "id": "API-TABLES-PERMISSIONS-CHECK-006",
      "given": "A viewer user with read-only access",
      "when": "User checks permissions",
      "then": "All write operations should be false (create, update, delete)",
      "validation": {
        "setup": {
          "executeQuery": ["CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), status VARCHAR(50))"],
          "authUser": { "id": 4, "role": "viewer" },
          "tableConfig": {
            "id": 1,
            "name": "projects",
            "permissions": {
              "viewer": {
                "table": { "read": true, "create": false, "update": false, "delete": false }
              }
            }
          },
          "apiRequest": {
            "method": "GET",
            "endpoint": "/api/tables/1/permissions",
            "headers": { "Authorization": "Bearer viewer_token" },
            "pathParams": { "tableId": 1 }
          }
        },
        "assertions": [
          {
            "description": "Returns read-only permissions (all writes false)",
            "expectedStatus": 200,
            "validateResponseData": {
              "table.read": true,
              "table.create": false,
              "table.update": false,
              "table.delete": false
            }
          }
        ]
      }
    }
  ]
}
