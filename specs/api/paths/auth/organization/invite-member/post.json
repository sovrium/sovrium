{
  "summary": "Invite member to organization",
  "description": "Sends an invitation to a user to join the organization. Only organization owners and admins can send invitations. If user doesn't exist, they can be invited by email and will need to sign up first.",
  "operationId": "inviteMember",
  "tags": ["organization"],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "requestBody": {
    "required": true,
    "content": {
      "application/json": {
        "schema": {
          "type": "object",
          "required": ["organizationId", "email"],
          "properties": {
            "organizationId": {
              "type": "string",
              "description": "The ID of the organization",
              "example": "org_123abc"
            },
            "email": {
              "type": "string",
              "format": "email",
              "description": "Email address of the user to invite",
              "example": "newuser@example.com"
            },
            "role": {
              "type": "string",
              "enum": ["admin", "member", "viewer"],
              "default": "member",
              "description": "Role to assign when invitation is accepted",
              "example": "member"
            }
          }
        }
      }
    }
  },
  "responses": {
    "201": {
      "description": "Success - Invitation sent",
      "content": {
        "application/json": {
          "schema": {
            "type": "object",
            "required": ["invitation"],
            "properties": {
              "invitation": {
                "type": "object",
                "required": ["id", "email", "role", "status", "expiresAt"],
                "properties": {
                  "id": {
                    "type": "string"
                  },
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "role": {
                    "type": "string"
                  },
                  "status": {
                    "type": "string",
                    "enum": ["pending"]
                  },
                  "expiresAt": {
                    "type": "string",
                    "format": "date-time"
                  }
                }
              }
            }
          },
          "examples": {
            "invitationSent": {
              "summary": "Invitation sent successfully",
              "value": {
                "invitation": {
                  "id": "inv_789ghi",
                  "email": "newuser@example.com",
                  "role": "member",
                  "status": "pending",
                  "expiresAt": "2025-02-15T12:00:00Z"
                }
              }
            }
          }
        }
      }
    },
    "400": {
      "$ref": "../../../../components/responses/ValidationError.json"
    },
    "401": {
      "description": "Unauthorized - User not authenticated",
      "content": {
        "application/json": {
          "schema": {
            "$ref": "../../../../components/schemas/Error.json"
          }
        }
      }
    },
    "403": {
      "description": "Forbidden - User does not have permission to invite members",
      "content": {
        "application/json": {
          "schema": {
            "$ref": "../../../../components/schemas/Error.json"
          }
        }
      }
    },
    "404": {
      "description": "Not Found - Organization not found or user is not a member",
      "content": {
        "application/json": {
          "schema": {
            "$ref": "../../../../components/schemas/Error.json"
          }
        }
      }
    },
    "409": {
      "$ref": "../../../../components/responses/ConflictError.json"
    }
  },
  "x-specs": [
    {
      "id": "API-ORG-INVITE-MEMBER-SUCCESS-001",
      "given": "An authenticated organization owner",
      "when": "Owner invites new user by email",
      "then": "Returns 201 Created with invitation token and sends invitation email",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'owner@example.com', '$2a$10$YourHashedPasswordHere', 'Owner User', true, NOW(), NOW())",
            "INSERT INTO organizations (id, name, slug, created_at, updated_at) VALUES (1, 'Test Org', 'test-org', NOW(), NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (1, 1, 1, 'owner', NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'owner_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1,
            "organizationId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer owner_token",
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "1",
              "email": "newuser@example.com",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 201 Created",
            "expectedStatus": 201
          },
          {
            "description": "Response contains invitation details",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "invitation": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string" },
                    "email": { "type": "string" },
                    "role": { "type": "string" },
                    "status": { "type": "string" },
                    "expiresAt": { "type": "string" }
                  },
                  "required": ["id", "email", "role", "status", "expiresAt"]
                }
              },
              "required": ["invitation"]
            }
          },
          {
            "description": "Invitation is created in database with pending status",
            "validateDatabaseState": {
              "query": "SELECT email, role, status FROM organization_invitations WHERE organization_id = 1 AND email = 'newuser@example.com'",
              "expectedRows": 1,
              "rowValidation": {
                "email": {
                  "equals": "newuser@example.com"
                },
                "role": {
                  "equals": "member"
                },
                "status": {
                  "equals": "pending"
                }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-VALIDATION-REQUIRED-FIELDS-001",
      "given": "An authenticated organization owner",
      "when": "Owner submits request without required fields",
      "then": "Returns 400 Bad Request with validation errors",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'owner@example.com', '$2a$10$YourHashedPasswordHere', 'Owner User', true, NOW(), NOW())",
            "INSERT INTO organizations (id, name, slug, created_at, updated_at) VALUES (1, 'Test Org', 'test-org', NOW(), NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (1, 1, 1, 'owner', NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'owner_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1,
            "organizationId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer owner_token",
              "Content-Type": "application/json"
            },
            "body": {}
          }
        },
        "assertions": [
          {
            "description": "Returns 400 Bad Request",
            "expectedStatus": 400
          },
          {
            "description": "Response contains validation error for required fields",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-VALIDATION-INVALID-EMAIL-001",
      "given": "An authenticated organization owner",
      "when": "Owner submits invitation with invalid email format",
      "then": "Returns 400 Bad Request with validation error",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'owner@example.com', '$2a$10$YourHashedPasswordHere', 'Owner User', true, NOW(), NOW())",
            "INSERT INTO organizations (id, name, slug, created_at, updated_at) VALUES (1, 'Test Org', 'test-org', NOW(), NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (1, 1, 1, 'owner', NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'owner_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1,
            "organizationId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer owner_token",
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "1",
              "email": "invalid-email",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 400 Bad Request",
            "expectedStatus": 400
          },
          {
            "description": "Response contains validation error for email format",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-PERMISSIONS-UNAUTHORIZED-NO-TOKEN-001",
      "given": "A running server",
      "when": "Unauthenticated user attempts to invite member",
      "then": "Returns 401 Unauthorized",
      "validation": {
        "setup": {
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "1",
              "email": "newuser@example.com",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 401 Unauthorized",
            "expectedStatus": 401
          },
          {
            "description": "Response contains error about missing authentication",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-PERMISSIONS-FORBIDDEN-REGULAR-MEMBER-001",
      "given": "An authenticated regular member (not owner/admin)",
      "when": "Member attempts to invite another user",
      "then": "Returns 403 Forbidden",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'member@example.com', '$2a$10$YourHashedPasswordHere', 'Member User', true, NOW(), NOW())",
            "INSERT INTO organizations (id, name, slug, created_at, updated_at) VALUES (1, 'Test Org', 'test-org', NOW(), NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (1, 1, 1, 'member', NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'member_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1,
            "organizationId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer member_token",
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "1",
              "email": "newuser@example.com",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 403 Forbidden",
            "expectedStatus": 403
          },
          {
            "description": "Response contains error about insufficient permissions",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-NOT-FOUND-001",
      "given": "An authenticated user",
      "when": "User attempts to invite to non-existent organization",
      "then": "Returns 404 Not Found",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'user@example.com', '$2a$10$YourHashedPasswordHere', 'Test User', true, NOW(), NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'user_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer user_token",
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "999",
              "email": "newuser@example.com",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 404 Not Found",
            "expectedStatus": 404
          },
          {
            "description": "Response contains error about organization not found",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-CONFLICT-ALREADY-MEMBER-001",
      "given": "An authenticated organization owner and a user who is already a member",
      "when": "Owner attempts to invite existing member",
      "then": "Returns 409 Conflict error",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'owner@example.com', '$2a$10$YourHashedPasswordHere', 'Owner User', true, NOW(), NOW())",
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (2, 'existing@example.com', '$2a$10$YourHashedPasswordHere', 'Existing Member', true, NOW(), NOW())",
            "INSERT INTO organizations (id, name, slug, created_at, updated_at) VALUES (1, 'Test Org', 'test-org', NOW(), NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (1, 1, 1, 'owner', NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (2, 1, 2, 'member', NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'owner_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1,
            "organizationId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer owner_token",
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "1",
              "email": "existing@example.com",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 409 Conflict",
            "expectedStatus": 409
          },
          {
            "description": "Response contains error about user already being member",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-CONFLICT-PENDING-INVITATION-001",
      "given": "An authenticated organization owner and an existing pending invitation",
      "when": "Owner attempts to invite user with pending invitation",
      "then": "Returns 409 Conflict error",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'owner@example.com', '$2a$10$YourHashedPasswordHere', 'Owner User', true, NOW(), NOW())",
            "INSERT INTO organizations (id, name, slug, created_at, updated_at) VALUES (1, 'Test Org', 'test-org', NOW(), NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (1, 1, 1, 'owner', NOW())",
            "INSERT INTO organization_invitations (id, organization_id, email, role, token, status, expires_at, created_at) VALUES (1, 1, 'pending@example.com', 'member', 'invite_token_123', 'pending', NOW() + INTERVAL '7 days', NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'owner_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1,
            "organizationId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer owner_token",
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "1",
              "email": "pending@example.com",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 409 Conflict",
            "expectedStatus": 409
          },
          {
            "description": "Response contains error about pending invitation",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    },
    {
      "id": "API-ORG-INVITE-MEMBER-EDGE-CASE-CASE-INSENSITIVE-EMAIL-001",
      "given": "An authenticated organization owner",
      "when": "Owner invites user with email in different case than existing member",
      "then": "Returns 409 Conflict (case-insensitive email matching)",
      "validation": {
        "setup": {
          "executeQuery": [
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (1, 'owner@example.com', '$2a$10$YourHashedPasswordHere', 'Owner User', true, NOW(), NOW())",
            "INSERT INTO users (id, email, password_hash, name, email_verified, created_at, updated_at) VALUES (2, 'existing@example.com', '$2a$10$YourHashedPasswordHere', 'Existing Member', true, NOW(), NOW())",
            "INSERT INTO organizations (id, name, slug, created_at, updated_at) VALUES (1, 'Test Org', 'test-org', NOW(), NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (1, 1, 1, 'owner', NOW())",
            "INSERT INTO organization_members (id, organization_id, user_id, role, created_at) VALUES (2, 1, 2, 'member', NOW())",
            "INSERT INTO sessions (id, user_id, token, expires_at, created_at) VALUES (1, 1, 'owner_token', NOW() + INTERVAL '7 days', NOW())"
          ],
          "authUser": {
            "id": 1,
            "sessionId": 1,
            "organizationId": 1
          },
          "apiRequest": {
            "method": "POST",
            "endpoint": "/api/auth/organization/invite-member",
            "headers": {
              "Authorization": "Bearer owner_token",
              "Content-Type": "application/json"
            },
            "body": {
              "organizationId": "1",
              "email": "EXISTING@EXAMPLE.COM",
              "role": "member"
            }
          }
        },
        "assertions": [
          {
            "description": "Returns 409 Conflict (case-insensitive)",
            "expectedStatus": 409
          },
          {
            "description": "Response contains error about user already being member",
            "expectedSchema": {
              "type": "object",
              "properties": {
                "error": { "type": "string" },
                "code": { "type": "string" }
              }
            }
          }
        ]
      }
    }
  ]
}
