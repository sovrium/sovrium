{
  "$id": "max.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Maximum value",
  "description": "Maximum value",
  "type": "number",
  "x-specs": [
    {
      "id": "APP-FIELD-DECIMAL-MAX-001",
      "given": "decimal field with max: 100.0",
      "when": "field migration creates CHECK constraint",
      "then": "PostgreSQL rejects decimal values above maximum",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE exam_scores (id SERIAL PRIMARY KEY, score DECIMAL(5,2) CHECK (score <= 100.0))",
            "INSERT INTO exam_scores (score) VALUES (85.5), (100.0), (92.75)"
          ],
          "fieldConfig": {
            "name": "score",
            "type": "decimal",
            "max": 100.0
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint exists for max value",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.check_constraints WHERE constraint_name LIKE '%score%' AND check_clause LIKE '%<= 100.0%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Value at maximum (100.0) accepted",
            "executeQuery": "SELECT score FROM exam_scores WHERE score = 100.0",
            "expected": {
              "score": 100.0
            }
          },
          {
            "description": "Value above maximum rejected",
            "executeQuery": "INSERT INTO exam_scores (score) VALUES (100.01)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Decimal value below maximum accepted",
            "executeQuery": "INSERT INTO exam_scores (score) VALUES (67.25) RETURNING score",
            "expected": {
              "score": 67.25
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-DECIMAL-MAX-002",
      "given": "decimal field with max: 999.99 (price limit)",
      "when": "INSERT with value above max",
      "then": "PostgreSQL CHECK constraint rejects value",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, price DECIMAL(10,2) CHECK (price <= 999.99))",
            "INSERT INTO products (price) VALUES (49.99), (999.99)"
          ],
          "fieldConfig": {
            "name": "price",
            "type": "decimal",
            "max": 999.99
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint enforces max 999.99",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%price%'",
            "expected": {
              "check_clause": "(price <= 999.99)"
            }
          },
          {
            "description": "Exact maximum (999.99) accepted",
            "executeQuery": "SELECT price FROM products WHERE price = 999.99",
            "expected": {
              "price": 999.99
            }
          },
          {
            "description": "Above maximum rejected",
            "executeQuery": "INSERT INTO products (price) VALUES (1000.00)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Below maximum accepted",
            "executeQuery": "INSERT INTO products (price) VALUES (149.50) RETURNING price",
            "expected": {
              "price": 149.5
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-DECIMAL-MAX-003",
      "given": "decimal field with both min and max (range constraint)",
      "when": "CHECK constraint combines both",
      "then": "PostgreSQL enforces decimal value within range",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE discounts (id SERIAL PRIMARY KEY, rate DECIMAL(5,2) CHECK (rate >= 0.0 AND rate <= 100.0))",
            "INSERT INTO discounts (rate) VALUES (0.0), (50.5), (100.0)"
          ],
          "fieldConfig": {
            "name": "rate",
            "type": "decimal",
            "min": 0.0,
            "max": 100.0
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint enforces range 0.0-100.0",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%rate%'",
            "expected": {
              "check_clause": "((rate >= 0.0) AND (rate <= 100.0))"
            }
          },
          {
            "description": "Value at min (0.0) accepted",
            "executeQuery": "SELECT rate FROM discounts WHERE rate = 0.0",
            "expected": {
              "rate": 0.0
            }
          },
          {
            "description": "Value at max (100.0) accepted",
            "executeQuery": "SELECT rate FROM discounts WHERE rate = 100.0",
            "expected": {
              "rate": 100.0
            }
          },
          {
            "description": "Value below min rejected",
            "executeQuery": "INSERT INTO discounts (rate) VALUES (-0.01)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Value above max rejected",
            "executeQuery": "INSERT INTO discounts (rate) VALUES (100.01)",
            "expectError": "violates check constraint"
          }
        ]
      }
    }
  ]
}
