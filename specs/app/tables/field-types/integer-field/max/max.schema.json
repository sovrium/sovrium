{
  "$id": "max.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Maximum value",
  "description": "Maximum value",
  "type": "number",
  "x-specs": [
    {
      "id": "APP-FIELD-INTEGER-MAX-001",
      "given": "integer field with max: 100",
      "when": "field migration creates CHECK constraint",
      "then": "PostgreSQL rejects values above maximum",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE quiz_scores (id SERIAL PRIMARY KEY, student_name VARCHAR(255), score INTEGER CHECK (score <= 100))",
            "INSERT INTO quiz_scores (student_name, score) VALUES ('Alice', 85), ('Bob', 100)"
          ],
          "fieldConfig": {
            "name": "score",
            "type": "integer",
            "max": 100
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint exists for max value",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.check_constraints WHERE constraint_name LIKE '%score%' AND check_clause LIKE '%<= 100%'",
            "expected": { "count": 1 }
          },
          {
            "description": "Value at maximum (100) accepted",
            "executeQuery": "SELECT score FROM quiz_scores WHERE score = 100",
            "expected": { "score": 100 }
          },
          {
            "description": "Value above maximum rejected",
            "executeQuery": "INSERT INTO quiz_scores (student_name, score) VALUES ('Charlie', 101)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Value below maximum accepted",
            "executeQuery": "INSERT INTO quiz_scores (student_name, score) VALUES ('Diana', 75) RETURNING score",
            "expected": { "score": 75 }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-INTEGER-MAX-002",
      "given": "integer field with max: 5 (rating)",
      "when": "INSERT with value above max",
      "then": "PostgreSQL CHECK constraint rejects value",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE reviews (id SERIAL PRIMARY KEY, product_name VARCHAR(255), rating INTEGER CHECK (rating <= 5))",
            "INSERT INTO reviews (product_name, rating) VALUES ('Product A', 4)"
          ],
          "fieldConfig": {
            "name": "rating",
            "type": "integer",
            "max": 5
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint enforces max rating 5",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%rating%'",
            "expected": { "check_clause": "(rating <= 5)" }
          },
          {
            "description": "Rating 5 (exact maximum) accepted",
            "executeQuery": "INSERT INTO reviews (product_name, rating) VALUES ('Product B', 5) RETURNING rating",
            "expected": { "rating": 5 }
          },
          {
            "description": "Rating 6 (above maximum) rejected",
            "executeQuery": "INSERT INTO reviews (product_name, rating) VALUES ('Product C', 6)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Rating 1 (below maximum) accepted",
            "executeQuery": "INSERT INTO reviews (product_name, rating) VALUES ('Product D', 1) RETURNING rating",
            "expected": { "rating": 1 }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-INTEGER-MAX-003",
      "given": "integer field with both min and max (range constraint)",
      "when": "CHECK constraint combines both",
      "then": "PostgreSQL enforces value within range",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE settings (id SERIAL PRIMARY KEY, volume INTEGER CHECK (volume >= 0 AND volume <= 100))",
            "INSERT INTO settings (volume) VALUES (0), (50), (100)"
          ],
          "fieldConfig": {
            "name": "volume",
            "type": "integer",
            "min": 0,
            "max": 100
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint enforces range 0-100",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%volume%'",
            "expected": { "check_clause": "((volume >= 0) AND (volume <= 100))" }
          },
          {
            "description": "Value at min (0) accepted",
            "executeQuery": "SELECT volume FROM settings WHERE volume = 0",
            "expected": { "volume": 0 }
          },
          {
            "description": "Value at max (100) accepted",
            "executeQuery": "SELECT volume FROM settings WHERE volume = 100",
            "expected": { "volume": 100 }
          },
          {
            "description": "Value below min rejected",
            "executeQuery": "INSERT INTO settings (volume) VALUES (-1)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Value above max rejected",
            "executeQuery": "INSERT INTO settings (volume) VALUES (101)",
            "expectError": "violates check constraint"
          }
        ]
      }
    }
  ]
}
