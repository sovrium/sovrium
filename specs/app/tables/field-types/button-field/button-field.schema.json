{
  "$id": "button-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Button Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "type": {
      "type": "string",
      "const": "button"
    },
    "label": {
      "$ref": "./label/label.schema.json"
    },
    "action": {
      "$ref": "./action/action.schema.json"
    },
    "url": {
      "$ref": "./url/url.schema.json"
    },
    "automation": {
      "$ref": "./automation/automation.schema.json"
    }
  },
  "description": "Trigger actions or open URLs",
  "required": ["id", "name", "type", "label", "action"],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-BUTTON-FIELD-001",
      "given": "table configuration with button field 'approve_action'",
      "when": "field migration processes button field",
      "then": "PostgreSQL does not create data column (button is UI-only configuration)",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE approvals (id SERIAL PRIMARY KEY, status VARCHAR(50) DEFAULT 'pending')",
          "fieldConfig": {
            "id": 1,
            "name": "approve_action",
            "type": "button",
            "label": "Approve",
            "action": "update_field"
          }
        },
        "assertions": [
          {
            "description": "No column created for button field",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='approvals' AND column_name='approve_action'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Only id and status columns exist",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='approvals' ORDER BY ordinal_position",
            "expected": [
              {
                "column_name": "id"
              },
              {
                "column_name": "status"
              }
            ]
          },
          {
            "description": "Note: Button configuration stored in application layer, not database schema",
            "executeQuery": "SELECT 'Button field is UI-only, no database column' as note",
            "expected": {
              "note": "Button field is UI-only, no database column"
            }
          }
        ]
      }
    },
    {
      "id": "APP-BUTTON-FIELD-002",
      "given": "table 'tasks' with button field triggering UPDATE action",
      "when": "button action updates another field",
      "then": "PostgreSQL UPDATE statement modifies target field value",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, title VARCHAR(255), status VARCHAR(50) DEFAULT 'open')",
            "INSERT INTO tasks (title, status) VALUES ('Task 1', 'open'), ('Task 2', 'in_progress')"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "complete_button",
            "type": "button",
            "label": "Mark Complete",
            "action": "update_field",
            "targetField": "status",
            "targetValue": "completed"
          }
        },
        "assertions": [
          {
            "description": "Initial task status",
            "executeQuery": "SELECT id, status FROM tasks WHERE id = 1",
            "expected": {
              "id": 1,
              "status": "open"
            }
          },
          {
            "description": "Simulate button click: update status",
            "executeQuery": "UPDATE tasks SET status = 'completed' WHERE id = 1 RETURNING id, status",
            "expected": {
              "id": 1,
              "status": "completed"
            }
          },
          {
            "description": "Verify status updated",
            "executeQuery": "SELECT status FROM tasks WHERE id = 1",
            "expected": {
              "status": "completed"
            }
          }
        ]
      }
    },
    {
      "id": "APP-BUTTON-FIELD-003",
      "given": "table 'orders' with button field logging click events",
      "when": "button click tracking is enabled",
      "then": "PostgreSQL audit table records button click events",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_number VARCHAR(50))",
            "CREATE TABLE button_clicks (id SERIAL PRIMARY KEY, table_name VARCHAR(100), record_id INTEGER, button_name VARCHAR(100), clicked_at TIMESTAMPTZ DEFAULT NOW())",
            "INSERT INTO orders (order_number) VALUES ('ORD-001')"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "send_email_button",
            "type": "button",
            "label": "Send Email",
            "action": "trigger_automation",
            "trackClicks": true
          }
        },
        "assertions": [
          {
            "description": "Simulate button click: log event",
            "executeQuery": "INSERT INTO button_clicks (table_name, record_id, button_name) VALUES ('orders', 1, 'send_email_button') RETURNING table_name, record_id, button_name",
            "expected": {
              "table_name": "orders",
              "record_id": 1,
              "button_name": "send_email_button"
            }
          },
          {
            "description": "Count button clicks for record",
            "executeQuery": "SELECT COUNT(*) as click_count FROM button_clicks WHERE table_name = 'orders' AND record_id = 1",
            "expected": {
              "click_count": 1
            }
          },
          {
            "description": "Multiple clicks tracked",
            "executeQuery": "INSERT INTO button_clicks (table_name, record_id, button_name) VALUES ('orders', 1, 'send_email_button'), ('orders', 1, 'send_email_button') RETURNING COUNT(*) OVER() as total",
            "expected": {
              "total": 2
            }
          }
        ]
      }
    },
    {
      "id": "APP-BUTTON-FIELD-004",
      "given": "table 'invoices' with button field for URL navigation",
      "when": "button opens external URL",
      "then": "PostgreSQL stores URL in related column for button target",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE invoices (id SERIAL PRIMARY KEY, invoice_number VARCHAR(50), pdf_url VARCHAR(500))",
            "INSERT INTO invoices (invoice_number, pdf_url) VALUES ('INV-001', 'https://example.com/invoices/inv-001.pdf')"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "view_pdf_button",
            "type": "button",
            "label": "View PDF",
            "action": "open_url",
            "url": "{pdf_url}"
          }
        },
        "assertions": [
          {
            "description": "URL column exists for button target",
            "executeQuery": "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='invoices' AND column_name='pdf_url'",
            "expected": {
              "column_name": "pdf_url",
              "data_type": "character varying"
            }
          },
          {
            "description": "Button references URL from field",
            "executeQuery": "SELECT pdf_url FROM invoices WHERE id = 1",
            "expected": {
              "pdf_url": "https://example.com/invoices/inv-001.pdf"
            }
          },
          {
            "description": "URL can be updated for button target",
            "executeQuery": "UPDATE invoices SET pdf_url = 'https://cdn.example.com/invoices/inv-001.pdf' WHERE id = 1 RETURNING pdf_url",
            "expected": {
              "pdf_url": "https://cdn.example.com/invoices/inv-001.pdf"
            }
          }
        ]
      }
    },
    {
      "id": "APP-BUTTON-FIELD-005",
      "given": "table 'tickets' with button field triggering workflow automation",
      "when": "button action starts workflow",
      "then": "PostgreSQL stores workflow execution state in separate table",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tickets (id SERIAL PRIMARY KEY, subject VARCHAR(255), status VARCHAR(50) DEFAULT 'new')",
            "CREATE TABLE workflow_executions (id SERIAL PRIMARY KEY, trigger_type VARCHAR(50), trigger_source VARCHAR(100), record_id INTEGER, status VARCHAR(50) DEFAULT 'pending', created_at TIMESTAMPTZ DEFAULT NOW())",
            "INSERT INTO tickets (subject) VALUES ('Support Request #123')"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "escalate_button",
            "type": "button",
            "label": "Escalate",
            "action": "trigger_automation",
            "automation": "escalation_workflow"
          }
        },
        "assertions": [
          {
            "description": "Simulate button click: trigger workflow",
            "executeQuery": "INSERT INTO workflow_executions (trigger_type, trigger_source, record_id, status) VALUES ('button_click', 'escalate_button', 1, 'pending') RETURNING trigger_source, record_id",
            "expected": {
              "trigger_source": "escalate_button",
              "record_id": 1
            }
          },
          {
            "description": "Workflow execution logged",
            "executeQuery": "SELECT COUNT(*) as workflow_count FROM workflow_executions WHERE trigger_source = 'escalate_button' AND record_id = 1",
            "expected": {
              "workflow_count": 1
            }
          },
          {
            "description": "Update workflow status after completion",
            "executeQuery": "UPDATE workflow_executions SET status = 'completed' WHERE trigger_source = 'escalate_button' AND record_id = 1 RETURNING status",
            "expected": {
              "status": "completed"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-ACTION-001",
      "given": "user selects action from valid options",
      "when": "validating input",
      "then": "selection should be accepted",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "selection should be accepted",
            "validateConfig": true,
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-ACTION-002",
      "given": "user provides invalid action value",
      "when": "validating input",
      "then": "error should list valid options: url, automation",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "error should list valid options: url, automation",
            "validateConfig": true,
            "expectError": "action must be one of: update_field, open_url, trigger_automation"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-ACTION-003",
      "given": "action is set to any valid enum value",
      "when": "processing entity",
      "then": "appropriate behavior should execute",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "appropriate behavior should execute",
            "validateConfig": true,
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-AUTOMATION-001",
      "given": "user provides automation",
      "when": "validating input",
      "then": "string value should be accepted",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "string value should be accepted",
            "validateConfig": true,
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-AUTOMATION-002",
      "given": "automation is empty string",
      "when": "validating input",
      "then": "behavior should follow optional/required rules",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "behavior should follow optional/required rules",
            "validateConfig": true,
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-LABEL-001",
      "given": "user provides label with at least 1 characters",
      "when": "validating input",
      "then": "value should be accepted",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "value should be accepted",
            "validateConfig": true,
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-LABEL-002",
      "given": "user provides label shorter than 1 chars",
      "when": "validating input",
      "then": "error should require minimum length",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "error should require minimum length",
            "validateConfig": true,
            "expectError": "must be within the allowed range"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-URL-001",
      "given": "user provides url",
      "when": "validating input",
      "then": "string value should be accepted",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "string value should be accepted",
            "validateConfig": true,
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BUTTON-URL-002",
      "given": "url is empty string",
      "when": "validating input",
      "then": "behavior should follow optional/required rules",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "example_field",
            "type": "text"
          }
        },
        "assertions": [
          {
            "description": "behavior should follow optional/required rules",
            "validateConfig": true,
            "expectError": "validation error"
          }
        ]
      }
    }
  ]
}
