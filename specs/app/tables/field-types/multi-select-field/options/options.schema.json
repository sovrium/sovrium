{
  "$id": "options.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Multi Select Field Options",
  "description": "Array of selectable string options for this field (minimum 1 item required)",
  "type": "array",
  "default": [],
  "items": {
    "type": "string"
  },
  "x-specs": [
    {
      "id": "APP-FIELD-MULTI-SELECT-OPTIONS-001",
      "given": "multi-select field with options: ['JavaScript', 'Python', 'Go', 'Rust']",
      "when": "field migration creates TEXT[] column with CHECK constraint",
      "then": "PostgreSQL validates all array elements are from allowed options",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE developers (id SERIAL PRIMARY KEY, name VARCHAR(255), skills TEXT[] CHECK (skills <@ ARRAY['JavaScript', 'Python', 'Go', 'Rust']))",
            "INSERT INTO developers (name, skills) VALUES ('Alice', ARRAY['JavaScript', 'Python']), ('Bob', ARRAY['Go', 'Rust'])"
          ],
          "fieldConfig": {
            "name": "skills",
            "type": "multi-select",
            "options": ["JavaScript", "Python", "Go", "Rust"]
          }
        },
        "assertions": [
          {
            "description": "Column uses TEXT[] array type",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='developers' AND column_name='skills'",
            "expected": {
              "data_type": "ARRAY"
            }
          },
          {
            "description": "Valid array of options accepted",
            "executeQuery": "SELECT skills FROM developers WHERE name = 'Alice'",
            "expected": {
              "skills": ["JavaScript", "Python"]
            }
          },
          {
            "description": "Single option stored as array",
            "executeQuery": "INSERT INTO developers (name, skills) VALUES ('Charlie', ARRAY['Python']) RETURNING skills",
            "expected": {
              "skills": ["Python"]
            }
          },
          {
            "description": "Invalid option in array rejected",
            "executeQuery": "INSERT INTO developers (name, skills) VALUES ('Dave', ARRAY['Java', 'Python'])",
            "expectError": "violates check constraint"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-MULTI-SELECT-OPTIONS-002",
      "given": "multi-select field with options: ['Red', 'Green', 'Blue']",
      "when": "empty array or NULL inserted",
      "then": "PostgreSQL accepts empty array (if nullable) or NULL",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255), tags TEXT[] CHECK (tags <@ ARRAY['Red', 'Green', 'Blue'] OR tags IS NULL))",
            "INSERT INTO products (name, tags) VALUES ('Product A', ARRAY['Red', 'Blue']), ('Product B', ARRAY[]::TEXT[]), ('Product C', NULL)"
          ],
          "fieldConfig": {
            "name": "tags",
            "type": "multi-select",
            "options": ["Red", "Green", "Blue"],
            "required": false
          }
        },
        "assertions": [
          {
            "description": "Empty array accepted",
            "executeQuery": "SELECT tags FROM products WHERE name = 'Product B'",
            "expected": {
              "tags": []
            }
          },
          {
            "description": "NULL accepted when field is nullable",
            "executeQuery": "SELECT tags FROM products WHERE name = 'Product C'",
            "expected": {
              "tags": null
            }
          },
          {
            "description": "Non-empty valid array accepted",
            "executeQuery": "SELECT tags FROM products WHERE name = 'Product A'",
            "expected": {
              "tags": ["Red", "Blue"]
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-MULTI-SELECT-OPTIONS-003",
      "given": "multi-select field with empty options array",
      "when": "field configuration validation runs",
      "then": "error should enforce minimum 1 option required",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "categories",
            "type": "multi-select",
            "options": []
          }
        },
        "assertions": [
          {
            "description": "Configuration with empty options array rejected",
            "validateConfig": true,
            "expectError": "options array must have at least 1 item"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-MULTI-SELECT-OPTIONS-004",
      "given": "multi-select field with options: ['Feature', 'Bug', 'Enhancement']",
      "when": "all options selected",
      "then": "PostgreSQL stores complete array of values",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE issues (id SERIAL PRIMARY KEY, title VARCHAR(255), labels TEXT[] CHECK (labels <@ ARRAY['Feature', 'Bug', 'Enhancement']))",
            "INSERT INTO issues (title, labels) VALUES ('Issue 1', ARRAY['Feature', 'Bug', 'Enhancement'])"
          ],
          "fieldConfig": {
            "name": "labels",
            "type": "multi-select",
            "options": ["Feature", "Bug", "Enhancement"]
          }
        },
        "assertions": [
          {
            "description": "All options can be selected simultaneously",
            "executeQuery": "SELECT labels FROM issues WHERE title = 'Issue 1'",
            "expected": {
              "labels": ["Feature", "Bug", "Enhancement"]
            }
          },
          {
            "description": "Array order preserved",
            "executeQuery": "INSERT INTO issues (title, labels) VALUES ('Issue 2', ARRAY['Enhancement', 'Feature']) RETURNING labels",
            "expected": {
              "labels": ["Enhancement", "Feature"]
            }
          },
          {
            "description": "Duplicate values in array rejected by application logic",
            "executeQuery": "INSERT INTO issues (title, labels) VALUES ('Issue 3', ARRAY['Bug', 'Bug'])",
            "expectError": "duplicate values not allowed"
          }
        ]
      }
    }
  ]
}
