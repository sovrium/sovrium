{
  "$id": "barcode-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Barcode Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "required": {
      "$ref": "../common/required/required.schema.json"
    },
    "type": {
      "type": "string",
      "const": "barcode"
    },
    "format": {
      "$ref": "./format/format.schema.json"
    }
  },
  "description": "Display and scan barcodes",
  "required": [
    "id",
    "name",
    "type"
  ],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-BARCODE-FIELD-001",
      "given": "table configuration with barcode field 'product_code'",
      "when": "field migration creates VARCHAR column for barcode",
      "then": "PostgreSQL VARCHAR column stores barcode string values",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE products (id SERIAL PRIMARY KEY, product_code VARCHAR(100))",
          "fieldConfig": {
            "id": 1,
            "name": "product_code",
            "type": "barcode"
          }
        },
        "assertions": [
          {
            "description": "Column created as VARCHAR",
            "executeQuery": "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='products' AND column_name='product_code'",
            "expected": {
              "column_name": "product_code",
              "data_type": "character varying"
            }
          },
          {
            "description": "Barcode value can be stored",
            "executeQuery": "INSERT INTO products (product_code) VALUES ('123456789012') RETURNING product_code",
            "expected": {
              "product_code": "123456789012"
            }
          },
          {
            "description": "Null barcode allowed (optional field)",
            "executeQuery": "INSERT INTO products (product_code) VALUES (NULL) RETURNING product_code",
            "expected": {
              "product_code": null
            }
          }
        ]
      }
    },
    {
      "id": "APP-BARCODE-FIELD-002",
      "given": "table 'inventory' with barcode field (EAN-13 format) and validation",
      "when": "CHECK constraint enforces barcode format",
      "then": "PostgreSQL validates barcode length and numeric characters",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE inventory (id SERIAL PRIMARY KEY, ean_code VARCHAR(13) CHECK (ean_code ~ '^[0-9]{13}$'))",
          "fieldConfig": {
            "id": 1,
            "name": "ean_code",
            "type": "barcode",
            "format": "EAN-13"
          }
        },
        "assertions": [
          {
            "description": "Valid EAN-13 barcode succeeds",
            "executeQuery": "INSERT INTO inventory (ean_code) VALUES ('5901234123457') RETURNING ean_code",
            "expected": {
              "ean_code": "5901234123457"
            }
          },
          {
            "description": "Invalid barcode (too short) rejected",
            "executeQuery": "INSERT INTO inventory (ean_code) VALUES ('12345')",
            "expectError": "violates check constraint"
          },
          {
            "description": "Invalid barcode (non-numeric) rejected",
            "executeQuery": "INSERT INTO inventory (ean_code) VALUES ('123456789012A')",
            "expectError": "violates check constraint"
          }
        ]
      }
    },
    {
      "id": "APP-BARCODE-FIELD-003",
      "given": "table 'assets' with barcode field (UNIQUE constraint)",
      "when": "barcode uniqueness is enforced",
      "then": "PostgreSQL UNIQUE constraint prevents duplicate barcodes",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE assets (id SERIAL PRIMARY KEY, asset_tag VARCHAR(50) UNIQUE NOT NULL)",
            "INSERT INTO assets (asset_tag) VALUES ('ASSET-001')"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "asset_tag",
            "type": "barcode",
            "required": true,
            "unique": true
          }
        },
        "assertions": [
          {
            "description": "UNIQUE constraint exists",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='assets' AND constraint_type='UNIQUE' AND constraint_name LIKE '%asset_tag%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Duplicate barcode rejected",
            "executeQuery": "INSERT INTO assets (asset_tag) VALUES ('ASSET-001')",
            "expectError": "duplicate key value violates unique constraint"
          },
          {
            "description": "New unique barcode succeeds",
            "executeQuery": "INSERT INTO assets (asset_tag) VALUES ('ASSET-002') RETURNING asset_tag",
            "expected": {
              "asset_tag": "ASSET-002"
            }
          }
        ]
      }
    },
    {
      "id": "APP-BARCODE-FIELD-004",
      "given": "table 'shipments' with barcode field and index for lookups",
      "when": "btree index is created on barcode column",
      "then": "PostgreSQL index optimizes barcode scan lookups",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE shipments (id SERIAL PRIMARY KEY, tracking_code VARCHAR(50))",
            "CREATE INDEX idx_shipments_tracking_code ON shipments(tracking_code)",
            "INSERT INTO shipments (tracking_code) VALUES ('TRACK-001'), ('TRACK-002'), ('TRACK-003')"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "tracking_code",
            "type": "barcode",
            "indexed": true
          }
        },
        "assertions": [
          {
            "description": "Index exists for efficient lookups",
            "executeQuery": "SELECT indexname, tablename FROM pg_indexes WHERE indexname = 'idx_shipments_tracking_code'",
            "expected": {
              "indexname": "idx_shipments_tracking_code",
              "tablename": "shipments"
            }
          },
          {
            "description": "Barcode lookup by exact match",
            "executeQuery": "SELECT id, tracking_code FROM shipments WHERE tracking_code = 'TRACK-002'",
            "expected": {
              "id": 2,
              "tracking_code": "TRACK-002"
            }
          },
          {
            "description": "Barcode prefix search",
            "executeQuery": "SELECT COUNT(*) as count FROM shipments WHERE tracking_code LIKE 'TRACK-%'",
            "expected": {
              "count": 3
            }
          }
        ]
      }
    },
    {
      "id": "APP-BARCODE-FIELD-005",
      "given": "table 'tickets' with barcode field (QR code format) for URLs",
      "when": "barcode stores longer QR code data",
      "then": "PostgreSQL VARCHAR supports variable-length barcode data",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tickets (id SERIAL PRIMARY KEY, qr_data VARCHAR(500))",
            "INSERT INTO tickets (qr_data) VALUES ('https://event.example.com/tickets/abc123?seat=A15&gate=3')"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "qr_data",
            "type": "barcode",
            "format": "QR"
          }
        },
        "assertions": [
          {
            "description": "Long QR code data can be stored",
            "executeQuery": "SELECT LENGTH(qr_data) as length FROM tickets WHERE id = 1",
            "expected": {
              "length": 61
            }
          },
          {
            "description": "QR code data retrieved",
            "executeQuery": "SELECT qr_data FROM tickets WHERE id = 1",
            "expected": {
              "qr_data": "https://event.example.com/tickets/abc123?seat=A15&gate=3"
            }
          },
          {
            "description": "Extract URL components from QR code",
            "executeQuery": "SELECT SPLIT_PART(qr_data, '?', 1) as base_url FROM tickets WHERE id = 1",
            "expected": {
              "base_url": "https://event.example.com/tickets/abc123"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BARCODE-FORMAT-001",
      "given": "barcode field with format: 'qr' (QR Code)",
      "when": "field migration creates TEXT column",
      "then": "PostgreSQL stores barcode data as text, application encodes as QR Code",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255), product_code TEXT)",
            "INSERT INTO products (name, product_code) VALUES ('Widget A', 'https://example.com/product/12345'), ('Widget B', 'PROD-9876')"
          ],
          "fieldConfig": {
            "name": "product_code",
            "type": "barcode",
            "format": "qr"
          }
        },
        "assertions": [
          {
            "description": "Column uses TEXT type for barcode data",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='products' AND column_name='product_code'",
            "expected": {
              "data_type": "text"
            }
          },
          {
            "description": "Barcode data stored as text",
            "executeQuery": "SELECT product_code FROM products WHERE name = 'Widget A'",
            "expected": {
              "product_code": "https://example.com/product/12345"
            }
          },
          {
            "description": "Application encodes as QR Code (2D matrix)",
            "barcodeFormat": "qr",
            "executeQuery": "SELECT product_code FROM products WHERE name = 'Widget A'",
            "expectedEncoding": "qr",
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BARCODE-FORMAT-002",
      "given": "barcode field with format: 'ean13' (13-digit EAN)",
      "when": "EAN-13 barcode '5901234123457' stored",
      "then": "application validates 13-digit format and encodes as EAN-13",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE inventory (id SERIAL PRIMARY KEY, item_name VARCHAR(255), ean TEXT CHECK (ean ~ '^[0-9]{13}$'))",
            "INSERT INTO inventory (item_name, ean) VALUES ('Book', '5901234123457'), ('Magazine', '9780123456789')"
          ],
          "fieldConfig": {
            "name": "ean",
            "type": "barcode",
            "format": "ean13"
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint validates 13-digit format",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%ean%'",
            "expected": {
              "check_clause": "(ean ~ '^[0-9]{13}$')"
            }
          },
          {
            "description": "Valid EAN-13 accepted",
            "executeQuery": "SELECT ean FROM inventory WHERE item_name = 'Book'",
            "expected": {
              "ean": "5901234123457"
            }
          },
          {
            "description": "Invalid EAN-13 (wrong length) rejected",
            "executeQuery": "INSERT INTO inventory (item_name, ean) VALUES ('Invalid', '123456')",
            "expectError": "violates check constraint"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BARCODE-FORMAT-003",
      "given": "barcode field with invalid format value",
      "when": "field configuration validation runs",
      "then": "error lists valid options: qr, ean13, code128, code39",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "tracking_code",
            "type": "barcode",
            "format": "INVALID-FORMAT"
          }
        },
        "assertions": [
          {
            "description": "Invalid format rejected with enum error",
            "validateConfig": true,
            "expectError": "format must be one of: qr, ean13, code128, code39"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BARCODE-FORMAT-004",
      "given": "barcode field with format: 'code128' (high-density linear)",
      "when": "alphanumeric code 'SHIP-2024-001' stored",
      "then": "application encodes as Code 128 barcode",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE shipments (id SERIAL PRIMARY KEY, destination VARCHAR(255), tracking_number TEXT)",
            "INSERT INTO shipments (destination, tracking_number) VALUES ('New York', 'SHIP-2024-001'), ('Los Angeles', 'SHIP-2024-002')"
          ],
          "fieldConfig": {
            "name": "tracking_number",
            "type": "barcode",
            "format": "code128"
          }
        },
        "assertions": [
          {
            "description": "Alphanumeric tracking number stored",
            "executeQuery": "SELECT tracking_number FROM shipments WHERE destination = 'New York'",
            "expected": {
              "tracking_number": "SHIP-2024-001"
            }
          },
          {
            "description": "Application encodes as Code 128",
            "barcodeFormat": "code128",
            "executeQuery": "SELECT tracking_number FROM shipments WHERE destination = 'New York'",
            "expectedEncoding": "code128",
            "expectError": "validation error"
          }
        ]
      }
    }
  ]
}
