{
  "$id": "format.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Barcode Format",
  "description": "Barcode encoding format. Storage uses TEXT for barcode data. Format controls encoding type: qr (QR Code 2D matrix), ean13 (13-digit European Article Number), code128 (high-density linear barcode), code39 (alphanumeric barcode).",
  "type": "string",
  "default": "qr",
  "enum": ["qr", "ean13", "code128", "code39"],
  "x-specs": [
    {
      "id": "APP-FIELD-BARCODE-FORMAT-001",
      "given": "barcode field with format: 'qr' (QR Code)",
      "when": "field migration creates TEXT column",
      "then": "PostgreSQL stores barcode data as text, application encodes as QR Code",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255), product_code TEXT)",
            "INSERT INTO products (name, product_code) VALUES ('Widget A', 'https://example.com/product/12345'), ('Widget B', 'PROD-9876')"
          ],
          "fieldConfig": {
            "name": "product_code",
            "type": "barcode",
            "format": "qr"
          }
        },
        "assertions": [
          {
            "description": "Column uses TEXT type for barcode data",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='products' AND column_name='product_code'",
            "expected": { "data_type": "text" }
          },
          {
            "description": "Barcode data stored as text",
            "executeQuery": "SELECT product_code FROM products WHERE name = 'Widget A'",
            "expected": { "product_code": "https://example.com/product/12345" }
          },
          {
            "description": "Application encodes as QR Code (2D matrix)",
            "barcodeFormat": "qr",
            "executeQuery": "SELECT product_code FROM products WHERE name = 'Widget A'",
            "expectedEncoding": "qr"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BARCODE-FORMAT-002",
      "given": "barcode field with format: 'ean13' (13-digit EAN)",
      "when": "EAN-13 barcode '5901234123457' stored",
      "then": "application validates 13-digit format and encodes as EAN-13",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE inventory (id SERIAL PRIMARY KEY, item_name VARCHAR(255), ean TEXT CHECK (ean ~ '^[0-9]{13}$'))",
            "INSERT INTO inventory (item_name, ean) VALUES ('Book', '5901234123457'), ('Magazine', '9780123456789')"
          ],
          "fieldConfig": {
            "name": "ean",
            "type": "barcode",
            "format": "ean13"
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint validates 13-digit format",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%ean%'",
            "expected": { "check_clause": "(ean ~ '^[0-9]{13}$')" }
          },
          {
            "description": "Valid EAN-13 accepted",
            "executeQuery": "SELECT ean FROM inventory WHERE item_name = 'Book'",
            "expected": { "ean": "5901234123457" }
          },
          {
            "description": "Invalid EAN-13 (wrong length) rejected",
            "executeQuery": "INSERT INTO inventory (item_name, ean) VALUES ('Invalid', '123456')",
            "expectError": "violates check constraint"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BARCODE-FORMAT-003",
      "given": "barcode field with invalid format value",
      "when": "field configuration validation runs",
      "then": "error lists valid options: qr, ean13, code128, code39",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "tracking_code",
            "type": "barcode",
            "format": "INVALID-FORMAT"
          }
        },
        "assertions": [
          {
            "description": "Invalid format rejected with enum error",
            "validateConfig": true,
            "expectError": "format must be one of: qr, ean13, code128, code39"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-BARCODE-FORMAT-004",
      "given": "barcode field with format: 'code128' (high-density linear)",
      "when": "alphanumeric code 'SHIP-2024-001' stored",
      "then": "application encodes as Code 128 barcode",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE shipments (id SERIAL PRIMARY KEY, destination VARCHAR(255), tracking_number TEXT)",
            "INSERT INTO shipments (destination, tracking_number) VALUES ('New York', 'SHIP-2024-001'), ('Los Angeles', 'SHIP-2024-002')"
          ],
          "fieldConfig": {
            "name": "tracking_number",
            "type": "barcode",
            "format": "code128"
          }
        },
        "assertions": [
          {
            "description": "Alphanumeric tracking number stored",
            "executeQuery": "SELECT tracking_number FROM shipments WHERE destination = 'New York'",
            "expected": { "tracking_number": "SHIP-2024-001" }
          },
          {
            "description": "Application encodes as Code 128",
            "barcodeFormat": "code128",
            "executeQuery": "SELECT tracking_number FROM shipments WHERE destination = 'New York'",
            "expectedEncoding": "code128"
          }
        ]
      }
    }
  ]
}
