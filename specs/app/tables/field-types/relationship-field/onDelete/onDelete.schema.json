{
  "$id": "onDelete.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Action to take when the related record is deleted",
  "description": "PostgreSQL referential action for ON DELETE: cascade (delete child records), set-null (set foreign key to NULL), restrict (prevent deletion if children exist), no-action (similar to restrict with deferred check).",
  "type": "string",
  "default": "restrict",
  "enum": [
    "cascade",
    "set-null",
    "restrict",
    "no-action"
  ],
  "x-specs": [
    {
      "id": "APP-FIELD-RELATIONSHIP-ONDELETE-001",
      "given": "relationship field with onDelete: 'cascade'",
      "when": "parent record deleted",
      "then": "PostgreSQL automatically deletes all child records (CASCADE)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE customers (id SERIAL PRIMARY KEY, name VARCHAR(255), email VARCHAR(255))",
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_number VARCHAR(50), customer_id INTEGER REFERENCES customers(id) ON DELETE CASCADE)",
            "INSERT INTO customers (name, email) VALUES ('Alice', 'alice@example.com'), ('Bob', 'bob@example.com')",
            "INSERT INTO orders (order_number, customer_id) VALUES ('ORD-001', 1), ('ORD-002', 1), ('ORD-003', 2)"
          ],
          "fieldConfig": {
            "name": "customer_id",
            "type": "relationship",
            "relatedTable": "customers",
            "onDelete": "cascade"
          }
        },
        "assertions": [
          {
            "description": "Foreign key has ON DELETE CASCADE",
            "executeQuery": "SELECT rc.delete_rule FROM information_schema.referential_constraints rc JOIN information_schema.table_constraints tc ON rc.constraint_name = tc.constraint_name WHERE tc.table_name = 'orders' AND tc.constraint_type = 'FOREIGN KEY'",
            "expected": {
              "delete_rule": "CASCADE"
            }
          },
          {
            "description": "Before deletion: customer 1 has 2 orders",
            "executeQuery": "SELECT COUNT(*) as count FROM orders WHERE customer_id = 1",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Delete parent customer",
            "executeQuery": "DELETE FROM customers WHERE id = 1 RETURNING name",
            "expected": {
              "name": "Alice"
            }
          },
          {
            "description": "After deletion: child orders automatically deleted (CASCADE)",
            "executeQuery": "SELECT COUNT(*) as count FROM orders WHERE customer_id = 1",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Other customer's orders unaffected",
            "executeQuery": "SELECT COUNT(*) as count FROM orders WHERE customer_id = 2",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-RELATIONSHIP-ONDELETE-002",
      "given": "relationship field with onDelete: 'set-null'",
      "when": "parent record deleted",
      "then": "PostgreSQL sets child foreign key columns to NULL (SET NULL)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE departments (id SERIAL PRIMARY KEY, name VARCHAR(255))",
            "CREATE TABLE employees (id SERIAL PRIMARY KEY, name VARCHAR(255), department_id INTEGER REFERENCES departments(id) ON DELETE SET NULL)",
            "INSERT INTO departments (name) VALUES ('Engineering'), ('Sales')",
            "INSERT INTO employees (name, department_id) VALUES ('Alice', 1), ('Bob', 1), ('Charlie', 2)"
          ],
          "fieldConfig": {
            "name": "department_id",
            "type": "relationship",
            "relatedTable": "departments",
            "onDelete": "set-null"
          }
        },
        "assertions": [
          {
            "description": "Foreign key has ON DELETE SET NULL",
            "executeQuery": "SELECT rc.delete_rule FROM information_schema.referential_constraints rc JOIN information_schema.table_constraints tc ON rc.constraint_name = tc.constraint_name WHERE tc.table_name = 'employees' AND tc.constraint_type = 'FOREIGN KEY'",
            "expected": {
              "delete_rule": "SET NULL"
            }
          },
          {
            "description": "Before deletion: employees have department_id",
            "executeQuery": "SELECT name FROM employees WHERE department_id = 1 ORDER BY name",
            "expected": [
              {
                "name": "Alice"
              },
              {
                "name": "Bob"
              }
            ]
          },
          {
            "description": "Delete parent department",
            "executeQuery": "DELETE FROM departments WHERE id = 1 RETURNING name",
            "expected": {
              "name": "Engineering"
            }
          },
          {
            "description": "After deletion: employees' department_id set to NULL",
            "executeQuery": "SELECT name FROM employees WHERE department_id IS NULL ORDER BY name",
            "expected": [
              {
                "name": "Alice"
              },
              {
                "name": "Bob"
              }
            ]
          },
          {
            "description": "Employees still exist (not deleted, just orphaned)",
            "executeQuery": "SELECT COUNT(*) as count FROM employees",
            "expected": {
              "count": 3
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-RELATIONSHIP-ONDELETE-003",
      "given": "relationship field with onDelete: 'restrict'",
      "when": "attempting to delete parent record with children",
      "then": "PostgreSQL prevents deletion and returns error (RESTRICT)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE categories (id SERIAL PRIMARY KEY, name VARCHAR(255))",
            "CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255), category_id INTEGER REFERENCES categories(id) ON DELETE RESTRICT)",
            "INSERT INTO categories (name) VALUES ('Electronics'), ('Clothing')",
            "INSERT INTO products (name, category_id) VALUES ('Laptop', 1), ('Smartphone', 1), ('T-Shirt', 2)"
          ],
          "fieldConfig": {
            "name": "category_id",
            "type": "relationship",
            "relatedTable": "categories",
            "onDelete": "restrict"
          }
        },
        "assertions": [
          {
            "description": "Foreign key has ON DELETE RESTRICT",
            "executeQuery": "SELECT rc.delete_rule FROM information_schema.referential_constraints rc JOIN information_schema.table_constraints tc ON rc.constraint_name = tc.constraint_name WHERE tc.table_name = 'products' AND tc.constraint_type = 'FOREIGN KEY'",
            "expected": {
              "delete_rule": "RESTRICT"
            }
          },
          {
            "description": "Category 1 has 2 products",
            "executeQuery": "SELECT COUNT(*) as count FROM products WHERE category_id = 1",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Cannot delete category with existing products",
            "executeQuery": "DELETE FROM categories WHERE id = 1",
            "expectError": "violates foreign key constraint"
          },
          {
            "description": "After failed deletion: category still exists",
            "executeQuery": "SELECT name FROM categories WHERE id = 1",
            "expected": {
              "name": "Electronics"
            }
          },
          {
            "description": "After failed deletion: products still exist",
            "executeQuery": "SELECT COUNT(*) as count FROM products WHERE category_id = 1",
            "expected": {
              "count": 2
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-RELATIONSHIP-ONDELETE-004",
      "given": "relationship field with onDelete: 'no-action'",
      "when": "attempting to delete parent record with children",
      "then": "PostgreSQL prevents deletion (NO ACTION, deferred check)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255))",
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, title VARCHAR(255), project_id INTEGER REFERENCES projects(id) ON DELETE NO ACTION)",
            "INSERT INTO projects (name) VALUES ('Website Redesign'), ('Mobile App')",
            "INSERT INTO tasks (title, project_id) VALUES ('Design mockups', 1), ('Implement backend', 1)"
          ],
          "fieldConfig": {
            "name": "project_id",
            "type": "relationship",
            "relatedTable": "projects",
            "onDelete": "no-action"
          }
        },
        "assertions": [
          {
            "description": "Foreign key has ON DELETE NO ACTION",
            "executeQuery": "SELECT rc.delete_rule FROM information_schema.referential_constraints rc JOIN information_schema.table_constraints tc ON rc.constraint_name = tc.constraint_name WHERE tc.table_name = 'tasks' AND tc.constraint_type = 'FOREIGN KEY'",
            "expected": {
              "delete_rule": "NO ACTION"
            }
          },
          {
            "description": "Cannot delete project with existing tasks",
            "executeQuery": "DELETE FROM projects WHERE id = 1",
            "expectError": "violates foreign key constraint"
          },
          {
            "description": "After failed deletion: project still exists",
            "executeQuery": "SELECT name FROM projects WHERE id = 1",
            "expected": {
              "name": "Website Redesign"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-RELATIONSHIP-ONDELETE-005",
      "given": "relationship field with invalid onDelete value",
      "when": "field configuration validation runs",
      "then": "error lists valid options: cascade, set-null, restrict, no-action",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "customer_id",
            "type": "relationship",
            "relatedTable": "customers",
            "onDelete": "INVALID-ACTION"
          }
        },
        "assertions": [
          {
            "description": "Invalid onDelete rejected with enum error",
            "validateConfig": true,
            "expectError": "onDelete must be one of: cascade, set-null, restrict, no-action"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-RELATIONSHIP-ONDELETE-006",
      "given": "relationship field without onDelete specified",
      "when": "field configuration uses default",
      "then": "PostgreSQL uses RESTRICT as default action",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE authors (id SERIAL PRIMARY KEY, name VARCHAR(255))",
            "CREATE TABLE books (id SERIAL PRIMARY KEY, title VARCHAR(255), author_id INTEGER REFERENCES authors(id))",
            "INSERT INTO authors (name) VALUES ('Jane Austen')",
            "INSERT INTO books (title, author_id) VALUES ('Pride and Prejudice', 1)"
          ],
          "fieldConfig": {
            "name": "author_id",
            "type": "relationship",
            "relatedTable": "authors"
          }
        },
        "assertions": [
          {
            "description": "Default onDelete is RESTRICT (or NO ACTION depending on PostgreSQL version)",
            "executeQuery": "SELECT rc.delete_rule FROM information_schema.referential_constraints rc JOIN information_schema.table_constraints tc ON rc.constraint_name = tc.constraint_name WHERE tc.table_name = 'books' AND tc.constraint_type = 'FOREIGN KEY'",
            "expected": {
              "delete_rule": "NO ACTION"
            }
          },
          {
            "description": "Cannot delete author with existing books (default behavior)",
            "executeQuery": "DELETE FROM authors WHERE id = 1",
            "expectError": "violates foreign key constraint"
          }
        ]
      }
    }
  ]
}
