{
  "$id": "created-at-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Created At Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "type": {
      "type": "string",
      "const": "created-at"
    },
    "indexed": {
      "$ref": "../common/indexed/indexed.schema.json"
    }
  },
  "description": "Automatically set timestamp when record is created. Read-only field that cannot be modified after creation. Always uses current server time in UTC. Automatically indexed for sorting and filtering by creation time. Useful for audit trails, chronological ordering, and tracking when data was first entered. Displays as formatted datetime in UI.",
  "required": [
    "id",
    "name",
    "type"
  ],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-CREATED-AT-FIELD-001",
      "given": "table configuration with created-at field 'created_at'",
      "when": "field migration creates column",
      "then": "PostgreSQL TIMESTAMPTZ column with DEFAULT NOW() is created",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE posts (id SERIAL PRIMARY KEY)",
          "fieldConfig": {
            "id": 1,
            "name": "created_at",
            "type": "created-at"
          }
        },
        "assertions": [
          {
            "description": "Column created as TIMESTAMPTZ with NOT NULL",
            "executeQuery": "SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name='posts' AND column_name='created_at'",
            "expected": {
              "column_name": "created_at",
              "data_type": "timestamp with time zone",
              "is_nullable": "NO"
            }
          },
          {
            "description": "Column has DEFAULT NOW() for automatic timestamp",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='posts' AND column_name='created_at'",
            "expected": {
              "column_default": "now()"
            }
          },
          {
            "description": "INSERT automatically sets created_at to current timestamp",
            "executeQuery": "INSERT INTO posts (id) VALUES (DEFAULT) RETURNING created_at IS NOT NULL as has_timestamp",
            "expected": {
              "has_timestamp": true
            }
          }
        ]
      }
    },
    {
      "id": "APP-CREATED-AT-FIELD-002",
      "given": "table 'users' with created-at field",
      "when": "multiple records are inserted over time",
      "then": "each record has immutable creation timestamp for audit trail",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW())",
            "INSERT INTO users (id) VALUES (DEFAULT)",
            "SELECT pg_sleep(0.1)",
            "INSERT INTO users (id) VALUES (DEFAULT)"
          ]
        },
        "assertions": [
          {
            "description": "Two records have different creation timestamps",
            "executeQuery": "SELECT COUNT(DISTINCT created_at) as unique_timestamps FROM users",
            "expected": {
              "unique_timestamps": 2
            }
          },
          {
            "description": "First record created before second record",
            "executeQuery": "SELECT (SELECT created_at FROM users WHERE id = 1) < (SELECT created_at FROM users WHERE id = 2) as correct_order",
            "expected": {
              "correct_order": true
            }
          },
          {
            "description": "created_at values are immutable (read-only)",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='users' AND column_name='created_at' AND is_updatable='NO'",
            "expected": {
              "count": 0
            }
          }
        ]
      }
    },
    {
      "id": "APP-CREATED-AT-FIELD-003",
      "given": "table configuration with created-at field, indexed=true",
      "when": "index is created on the created_at field",
      "then": "PostgreSQL btree index exists for fast chronological queries",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE documents (id SERIAL PRIMARY KEY, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW())",
            "CREATE INDEX idx_documents_created ON documents(created_at)"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "created_at",
            "type": "created-at",
            "indexed": true
          }
        },
        "assertions": [
          {
            "description": "Index exists in pg_indexes",
            "executeQuery": "SELECT indexname, tablename FROM pg_indexes WHERE indexname = 'idx_documents_created'",
            "expected": {
              "indexname": "idx_documents_created",
              "tablename": "documents"
            }
          },
          {
            "description": "Index uses btree for timestamp sorting",
            "executeQuery": "SELECT indexdef FROM pg_indexes WHERE indexname = 'idx_documents_created'",
            "expected": {
              "indexdef": "CREATE INDEX idx_documents_created ON public.documents USING btree (created_at)"
            }
          }
        ]
      }
    },
    {
      "id": "APP-CREATED-AT-FIELD-004",
      "given": "table 'orders' with created-at field",
      "when": "querying records by creation date range",
      "then": "PostgreSQL supports efficient timestamp range filtering",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW())",
            "INSERT INTO orders (created_at) VALUES ('2024-01-15T10:00:00Z'), ('2024-06-30T14:30:00Z'), ('2024-12-31T23:59:59Z')"
          ]
        },
        "assertions": [
          {
            "description": "Find records created after specific date",
            "executeQuery": "SELECT COUNT(*) as count FROM orders WHERE created_at > '2024-06-01T00:00:00Z'",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Find records created today",
            "executeQuery": "SELECT COUNT(*) as count FROM orders WHERE created_at::DATE = CURRENT_DATE",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Order by creation time descending (newest first)",
            "executeQuery": "SELECT id FROM orders ORDER BY created_at DESC LIMIT 1",
            "expected": {
              "id": 3
            }
          }
        ]
      }
    },
    {
      "id": "APP-CREATED-AT-FIELD-005",
      "given": "table 'audit_log' with created-at field",
      "when": "application layer attempts to manually set created_at",
      "then": "PostgreSQL DEFAULT NOW() ensures automatic timestamp regardless of provided value",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE audit_log (id SERIAL PRIMARY KEY, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW())"
        },
        "assertions": [
          {
            "description": "Attempting to insert with explicit created_at still uses NOW()",
            "executeQuery": "INSERT INTO audit_log (id) VALUES (DEFAULT) RETURNING created_at > '2024-01-01T00:00:00Z' as is_recent",
            "expected": {
              "is_recent": true
            }
          },
          {
            "description": "All records have recent timestamps",
            "executeQuery": "INSERT INTO audit_log (id) VALUES (DEFAULT), (DEFAULT), (DEFAULT) RETURNING (SELECT COUNT(*) FROM audit_log WHERE created_at > NOW() - INTERVAL '1 minute') as recent_count",
            "expected": {
              "recent_count": 4
            }
          }
        ]
      }
    }
  ]
}
