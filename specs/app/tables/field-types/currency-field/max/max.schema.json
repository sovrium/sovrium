{
  "$id": "max.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Currency Field Maximum Value",
  "description": "Maximum value allowed for this currency field",
  "type": "number",
  "x-specs": [
    {
      "id": "APP-FIELD-CURRENCY-MAX-001",
      "given": "currency field with max: 10000.00 (spending limit)",
      "when": "field migration creates CHECK constraint",
      "then": "PostgreSQL rejects currency values above maximum",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE expenses (id SERIAL PRIMARY KEY, amount DECIMAL(15,2) CHECK (amount <= 10000.00))",
            "INSERT INTO expenses (amount) VALUES (500.00), (10000.00), (7500.50)"
          ],
          "fieldConfig": {
            "name": "amount",
            "type": "currency",
            "max": 10000.0
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint exists for max value",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.check_constraints WHERE constraint_name LIKE '%amount%' AND check_clause LIKE '%<= 10000.00%'",
            "expected": { "count": 1 }
          },
          {
            "description": "Value at maximum (10000.00) accepted",
            "executeQuery": "SELECT amount FROM expenses WHERE amount = 10000.00",
            "expected": { "amount": 10000.0 }
          },
          {
            "description": "Value above maximum rejected",
            "executeQuery": "INSERT INTO expenses (amount) VALUES (10000.01)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Value below maximum accepted",
            "executeQuery": "INSERT INTO expenses (amount) VALUES (2500.00) RETURNING amount",
            "expected": { "amount": 2500.0 }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-CURRENCY-MAX-002",
      "given": "currency field with max: 999999.99 (invoice limit)",
      "when": "INSERT with value above max",
      "then": "PostgreSQL CHECK constraint rejects value",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE invoices (id SERIAL PRIMARY KEY, total DECIMAL(15,2) CHECK (total <= 999999.99))",
            "INSERT INTO invoices (total) VALUES (50000.00), (999999.99)"
          ],
          "fieldConfig": {
            "name": "total",
            "type": "currency",
            "max": 999999.99
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint enforces max 999999.99",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%total%'",
            "expected": { "check_clause": "(total <= 999999.99)" }
          },
          {
            "description": "Exact maximum (999999.99) accepted",
            "executeQuery": "SELECT total FROM invoices WHERE total = 999999.99",
            "expected": { "total": 999999.99 }
          },
          {
            "description": "Above maximum rejected",
            "executeQuery": "INSERT INTO invoices (total) VALUES (1000000.00)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Below maximum accepted",
            "executeQuery": "INSERT INTO invoices (total) VALUES (125000.00) RETURNING total",
            "expected": { "total": 125000.0 }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-CURRENCY-MAX-003",
      "given": "currency field with both min and max (price range)",
      "when": "CHECK constraint combines both",
      "then": "PostgreSQL enforces currency value within range",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, price DECIMAL(15,2) CHECK (price >= 0.01 AND price <= 99999.99))",
            "INSERT INTO products (price) VALUES (0.01), (5000.00), (99999.99)"
          ],
          "fieldConfig": {
            "name": "price",
            "type": "currency",
            "min": 0.01,
            "max": 99999.99
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint enforces range 0.01-99999.99",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%price%'",
            "expected": { "check_clause": "((price >= 0.01) AND (price <= 99999.99))" }
          },
          {
            "description": "Value at min (0.01) accepted",
            "executeQuery": "SELECT price FROM products WHERE price = 0.01",
            "expected": { "price": 0.01 }
          },
          {
            "description": "Value at max (99999.99) accepted",
            "executeQuery": "SELECT price FROM products WHERE price = 99999.99",
            "expected": { "price": 99999.99 }
          },
          {
            "description": "Value below min rejected",
            "executeQuery": "INSERT INTO products (price) VALUES (0.00)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Value above max rejected",
            "executeQuery": "INSERT INTO products (price) VALUES (100000.00)",
            "expectError": "violates check constraint"
          }
        ]
      }
    }
  ]
}
