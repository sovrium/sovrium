{
  "$id": "phone-number-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Phone Number Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "required": {
      "$ref": "../common/required/required.schema.json"
    },
    "unique": {
      "$ref": "../common/unique/unique.schema.json"
    },
    "indexed": {
      "$ref": "../common/indexed/indexed.schema.json"
    },
    "type": {
      "const": "phone-number"
    },
    "default": {
      "$ref": "./default/default.schema.json"
    }
  },
  "description": "Text field optimized for phone numbers with automatic formatting based on detected country code. Stores the raw phone number value without validation to support international formats. Display formatting helps readability but doesn't enforce strict patterns. Required flag makes the field mandatory. Unique constraint ensures no duplicate phone numbers.",
  "required": ["id", "name", "type"],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-FIELD-PHONE-NUMBER-001",
      "given": "table 'contacts' with phone number field 'phone'",
      "when": "I enter US phone number '5551234567' (without formatting)",
      "then": "value is stored as '5551234567', displayed as formatted '(555) 123-4567' in UI, and searchable by either format",
      "validation": {
        "setup": {
          "tables": [
            {
              "id": "tbl_001",
              "name": "contacts",
              "fields": [
                {"id": 1, "name": "name", "type": "single-line-text", "required": true},
                {"id": 2, "name": "phone", "type": "phone-number", "required": false}
              ]
            }
          ]
        },
        "assertions": [
          {"field": "phone", "type": "phone-number"}
        ]
      },
      "application": {
        "expectedDOM": [
          "textbox name='phone' type='tel' value='(555) 123-4567'",
          "input shows formatted display value",
          "stored value in database: '5551234567' (raw)"
        ],
        "assertions": [
          "POST /api/tables/tbl_001/records with {\"name\": \"John\", \"phone\": \"5551234567\"} returns 201",
          "response includes {\"id\": \"rec_001\", \"phone\": \"5551234567\"}",
          "UI displays formatted: '(555) 123-4567'",
          "search for '555' or '(555) 123' finds the record"
        ]
      }
    },
    {
      "id": "APP-FIELD-PHONE-NUMBER-002",
      "given": "table 'contacts' with phone number field 'phone' accepting international formats",
      "when": "I enter international numbers from different countries: '+33 1 23 45 67 89' (France), '+44 20 7123 4567' (UK), '+81 3-1234-5678' (Japan)",
      "then": "all international numbers are accepted and stored without validation errors, formatted for display based on detected country code",
      "validation": {
        "setup": {
          "tables": [
            {
              "id": "tbl_001",
              "name": "contacts",
              "fields": [
                {"id": 1, "name": "name", "type": "single-line-text", "required": true},
                {"id": 2, "name": "phone", "type": "phone-number", "required": false}
              ]
            }
          ]
        },
        "assertions": [
          {"field": "phone", "type": "phone-number", "validation": "none"}
        ]
      },
      "application": {
        "expectedDOM": [
          "textbox name='phone' accepts '+33 1 23 45 67 89'",
          "no validation error shown",
          "formatted display: '+33 1 23 45 67 89'"
        ],
        "assertions": [
          "POST with {\"name\": \"Pierre\", \"phone\": \"+33123456789\"} returns 201 (France)",
          "POST with {\"name\": \"James\", \"phone\": \"+442071234567\"} returns 201 (UK)",
          "POST with {\"name\": \"Yuki\", \"phone\": \"+81312345678\"} returns 201 (Japan)",
          "all formats stored as-is, no validation enforced",
          "UI formats based on country code detection"
        ]
      }
    },
    {
      "id": "APP-FIELD-PHONE-NUMBER-003",
      "given": "table 'customers' with phone number field 'phone' having unique constraint, existing record with phone='+1-555-1234'",
      "when": "I attempt to create new record with duplicate phone='+1-555-1234'",
      "then": "API returns 409 Conflict with error 'phone must be unique. Value \"+1-555-1234\" already exists.', no record is created",
      "validation": {
        "setup": {
          "tables": [
            {
              "id": "tbl_001",
              "name": "customers",
              "fields": [
                {"id": 1, "name": "name", "type": "single-line-text", "required": true},
                {"id": 2, "name": "phone", "type": "phone-number", "required": true, "unique": true}
              ]
            }
          ],
          "records": {
            "tbl_001": [
              {"id": "rec_001", "name": "John Doe", "phone": "+1-555-1234"}
            ]
          }
        },
        "assertions": [
          {"field": "phone", "type": "phone-number", "required": true, "unique": true, "constraint": "unique"}
        ]
      },
      "application": {
        "expectedDOM": [
          "textbox name='phone' value='+1-555-1234' aria-invalid=true",
          "alert role=alert text='phone must be unique. Value \"+1-555-1234\" already exists.'"
        ],
        "assertions": [
          "POST /api/tables/tbl_001/records with {\"name\": \"Jane\", \"phone\": \"+1-555-1234\"} returns 409 Conflict",
          "response: {\"error\": \"UniqueConstraintViolation\", \"field\": \"phone\"}",
          "database still contains only 1 record"
        ]
      }
    },
    {
      "id": "APP-PHONE-NUMBER-FIELD-004",
      "given": "JSON schema definition for phone number field with type property",
      "when": "validating field configuration against JSON Schema",
      "then": "type property must have const value 'phone-number', any other value fails validation",
      "validation": {
        "setup": {
          "schema": {
            "type": "object",
            "properties": {
              "type": {"const": "phone-number"}
            },
            "required": ["type"]
          }
        },
        "assertions": [
          {"property": "type", "const": "phone-number"}
        ]
      },
      "application": {
        "assertions": [
          "valid: {\"type\": \"phone-number\"} passes validation",
          "invalid: {\"type\": \"phone\"} fails with 'type must be phone-number'",
          "invalid: {\"type\": \"telephone\"} fails with 'type must be phone-number'",
          "invalid: missing type fails with 'type is required'"
        ]
      }
    },
    {
      "id": "APP-PHONE-NUMBER-FIELD-005",
      "given": "field configuration with type='phone-number' in table schema",
      "when": "application processes field to render form input or display record data",
      "then": "field is rendered as HTML input[type=tel] with automatic formatting on blur, tel: protocol link in read-only view, and no strict validation",
      "validation": {
        "setup": {
          "tables": [
            {
              "id": "tbl_001",
              "name": "contacts",
              "fields": [
                {"id": 1, "name": "phone", "type": "phone-number"},
                {"id": 2, "name": "email", "type": "email"}
              ]
            }
          ]
        },
        "assertions": []
      },
      "application": {
        "expectedDOM": [
          "textbox name='phone' type='tel' (rendered as <input type=\"tel\">)",
          "link href='tel:+15551234567' (in read-only view)"
        ],
        "assertions": [
          "phone field uses <input type=\"tel\"> for mobile keyboard optimization",
          "on blur, applies automatic formatting based on country detection",
          "in read-only view, phone number is clickable tel: link",
          "clicking tel: link opens phone dialer on mobile devices",
          "no strict validation - accepts any text format"
        ]
      }
    }
  ]
}
