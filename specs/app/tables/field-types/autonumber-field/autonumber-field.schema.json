{
  "$id": "autonumber-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Autonumber Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "type": {
      "type": "string",
      "const": "autonumber"
    },
    "prefix": {
      "$ref": "./prefix/prefix.schema.json"
    },
    "startFrom": {
      "$ref": "./startFrom/startFrom.schema.json"
    },
    "digits": {
      "$ref": "./digits/digits.schema.json"
    }
  },
  "description": "Auto-incrementing unique number (read-only)",
  "required": [
    "id",
    "name",
    "type"
  ],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-AUTONUMBER-FIELD-001",
      "given": "table configuration with autonumber field 'record_number'",
      "when": "field migration creates SERIAL column",
      "then": "PostgreSQL SERIAL column with automatic sequence is created",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE invoices (id SERIAL PRIMARY KEY, record_number SERIAL NOT NULL UNIQUE)",
          "fieldConfig": {
            "id": 1,
            "name": "record_number",
            "type": "autonumber"
          }
        },
        "assertions": [
          {
            "description": "Column created as INTEGER",
            "executeQuery": "SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name='invoices' AND column_name='record_number'",
            "expected": {
              "column_name": "record_number",
              "data_type": "integer",
              "is_nullable": "NO"
            }
          },
          {
            "description": "UNIQUE constraint exists",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='invoices' AND constraint_type='UNIQUE' AND constraint_name LIKE '%record_number%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Sequence exists for auto-increment",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_sequences WHERE schemaname='public' AND sequencename LIKE '%record_number%'",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-002",
      "given": "table 'orders' with autonumber field auto-incrementing",
      "when": "multiple records are inserted",
      "then": "PostgreSQL sequence generates sequential unique numbers",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_number SERIAL NOT NULL UNIQUE)",
            "INSERT INTO orders (id) VALUES (DEFAULT)",
            "INSERT INTO orders (id) VALUES (DEFAULT)",
            "INSERT INTO orders (id) VALUES (DEFAULT)"
          ]
        },
        "assertions": [
          {
            "description": "First record gets number 1",
            "executeQuery": "SELECT order_number FROM orders WHERE id = 1",
            "expected": {
              "order_number": 1
            }
          },
          {
            "description": "Second record gets number 2",
            "executeQuery": "SELECT order_number FROM orders WHERE id = 2",
            "expected": {
              "order_number": 2
            }
          },
          {
            "description": "Third record gets number 3",
            "executeQuery": "SELECT order_number FROM orders WHERE id = 3",
            "expected": {
              "order_number": 3
            }
          },
          {
            "description": "All numbers are unique and sequential",
            "executeQuery": "SELECT COUNT(DISTINCT order_number) as unique_count, MAX(order_number) as max_number FROM orders",
            "expected": {
              "unique_count": 3,
              "max_number": 3
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-003",
      "given": "table configuration with autonumber field 'ticket_id' and startFrom=1000",
      "when": "sequence is created with custom start value",
      "then": "PostgreSQL sequence starts from specified number",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE SEQUENCE tickets_ticket_id_seq START WITH 1000 INCREMENT BY 1",
            "CREATE TABLE tickets (id SERIAL PRIMARY KEY, ticket_id INTEGER NOT NULL UNIQUE DEFAULT nextval('tickets_ticket_id_seq'))",
            "INSERT INTO tickets (id) VALUES (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "ticket_id",
            "type": "autonumber",
            "startFrom": 1000
          }
        },
        "assertions": [
          {
            "description": "Sequence starts at 1000",
            "executeQuery": "SELECT start_value FROM pg_sequences WHERE sequencename = 'tickets_ticket_id_seq'",
            "expected": {
              "start_value": 1000
            }
          },
          {
            "description": "First record gets number 1000",
            "executeQuery": "SELECT ticket_id FROM tickets WHERE id = 1",
            "expected": {
              "ticket_id": 1000
            }
          },
          {
            "description": "Second record gets number 1001",
            "executeQuery": "SELECT ticket_id FROM tickets WHERE id = 2",
            "expected": {
              "ticket_id": 1001
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-004",
      "given": "table 'requests' with autonumber field 'request_code' using prefix via generated column",
      "when": "generated column formats number with prefix",
      "then": "PostgreSQL GENERATED ALWAYS AS column creates formatted string",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE requests (id SERIAL PRIMARY KEY, request_number SERIAL NOT NULL, request_code VARCHAR(50) GENERATED ALWAYS AS ('REQ-' || LPAD(request_number::TEXT, 5, '0')) STORED)",
            "INSERT INTO requests (id) VALUES (DEFAULT)",
            "INSERT INTO requests (id) VALUES (DEFAULT)",
            "INSERT INTO requests (id) VALUES (DEFAULT)"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "request_code",
            "type": "autonumber",
            "prefix": "REQ-",
            "digits": 5
          }
        },
        "assertions": [
          {
            "description": "Generated column exists",
            "executeQuery": "SELECT column_name, is_generated FROM information_schema.columns WHERE table_name='requests' AND column_name='request_code'",
            "expected": {
              "column_name": "request_code",
              "is_generated": "ALWAYS"
            }
          },
          {
            "description": "First record formatted with prefix and padding",
            "executeQuery": "SELECT request_code FROM requests WHERE id = 1",
            "expected": {
              "request_code": "REQ-00001"
            }
          },
          {
            "description": "Third record increments correctly",
            "executeQuery": "SELECT request_code FROM requests WHERE id = 3",
            "expected": {
              "request_code": "REQ-00003"
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-005",
      "given": "table 'contracts' with autonumber field preventing duplicate values",
      "when": "attempting to insert duplicate autonumber manually",
      "then": "PostgreSQL UNIQUE constraint prevents duplicates",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE contracts (id SERIAL PRIMARY KEY, contract_number INTEGER NOT NULL UNIQUE DEFAULT nextval('contracts_contract_number_seq'))",
            "CREATE SEQUENCE contracts_contract_number_seq START WITH 1 INCREMENT BY 1",
            "INSERT INTO contracts (id) VALUES (DEFAULT)"
          ]
        },
        "assertions": [
          {
            "description": "First auto-generated number succeeds",
            "executeQuery": "SELECT contract_number FROM contracts WHERE id = 1",
            "expected": {
              "contract_number": 1
            }
          },
          {
            "description": "Manual insert with duplicate number rejected",
            "executeQuery": "INSERT INTO contracts (contract_number) VALUES (1)",
            "expectError": "duplicate key value violates unique constraint"
          },
          {
            "description": "Next auto-generated number succeeds",
            "executeQuery": "INSERT INTO contracts (id) VALUES (DEFAULT) RETURNING contract_number",
            "expected": {
              "contract_number": 2
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-DIGITS-001",
      "given": "autonumber field with digits=5 (zero-padded to 5 digits)",
      "when": "generated column formats number with LPAD",
      "then": "PostgreSQL LPAD pads numbers to 5 digits with leading zeros",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_num SERIAL NOT NULL, order_code VARCHAR(50) GENERATED ALWAYS AS (LPAD(order_num::TEXT, 5, '0')) STORED)",
            "INSERT INTO orders (id) VALUES (DEFAULT), (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "order_code",
            "type": "autonumber",
            "digits": 5
          }
        },
        "assertions": [
          {
            "description": "First number padded to 5 digits",
            "executeQuery": "SELECT order_code FROM orders WHERE id = 1",
            "expected": {
              "order_code": "00001"
            }
          },
          {
            "description": "Second number padded to 5 digits",
            "executeQuery": "SELECT order_code FROM orders WHERE id = 2",
            "expected": {
              "order_code": "00002"
            }
          },
          {
            "description": "Third number padded to 5 digits",
            "executeQuery": "SELECT order_code FROM orders WHERE id = 3",
            "expected": {
              "order_code": "00003"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-DIGITS-002",
      "given": "autonumber field with digits=1 (minimum padding)",
      "when": "generated column formats number with LPAD",
      "then": "PostgreSQL LPAD uses 1 digit (no padding for single-digit numbers)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, task_num SERIAL NOT NULL, task_code VARCHAR(50) GENERATED ALWAYS AS (LPAD(task_num::TEXT, 1, '0')) STORED)",
            "INSERT INTO tasks (id) VALUES (DEFAULT), (DEFAULT), (DEFAULT), (DEFAULT), (DEFAULT), (DEFAULT), (DEFAULT), (DEFAULT), (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "task_code",
            "type": "autonumber",
            "digits": 1
          }
        },
        "assertions": [
          {
            "description": "Single-digit number (5) has no padding",
            "executeQuery": "SELECT task_code FROM tasks WHERE id = 5",
            "expected": {
              "task_code": "5"
            }
          },
          {
            "description": "Double-digit number (10) exceeds padding but still displayed",
            "executeQuery": "SELECT task_code FROM tasks WHERE id = 10",
            "expected": {
              "task_code": "10"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-DIGITS-003",
      "given": "autonumber field with digits=10 (maximum padding)",
      "when": "generated column formats number with LPAD",
      "then": "PostgreSQL LPAD pads numbers to 10 digits with leading zeros",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE invoices (id SERIAL PRIMARY KEY, invoice_num SERIAL NOT NULL, invoice_code VARCHAR(50) GENERATED ALWAYS AS (LPAD(invoice_num::TEXT, 10, '0')) STORED)",
            "INSERT INTO invoices (id) VALUES (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "invoice_code",
            "type": "autonumber",
            "digits": 10
          }
        },
        "assertions": [
          {
            "description": "Number padded to 10 digits (maximum)",
            "executeQuery": "SELECT invoice_code FROM invoices WHERE id = 1",
            "expected": {
              "invoice_code": "0000000001"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-DIGITS-004",
      "given": "autonumber field with default digits=3 (not specified)",
      "when": "generated column formats number with default LPAD",
      "then": "PostgreSQL LPAD defaults to 3 digits with leading zeros",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tickets (id SERIAL PRIMARY KEY, ticket_num SERIAL NOT NULL, ticket_code VARCHAR(50) GENERATED ALWAYS AS (LPAD(ticket_num::TEXT, 3, '0')) STORED)",
            "INSERT INTO tickets (id) VALUES (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "ticket_code",
            "type": "autonumber"
          }
        },
        "assertions": [
          {
            "description": "Default 3-digit padding applied",
            "executeQuery": "SELECT ticket_code FROM tickets WHERE id = 1",
            "expected": {
              "ticket_code": "001"
            }
          },
          {
            "description": "Second number with 3-digit padding",
            "executeQuery": "SELECT ticket_code FROM tickets WHERE id = 2",
            "expected": {
              "ticket_code": "002"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-PREFIX-001",
      "given": "autonumber field with prefix='INV-' and digits=5",
      "when": "generated column concatenates prefix with padded number",
      "then": "PostgreSQL GENERATED ALWAYS AS creates formatted string with prefix",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE invoices (id SERIAL PRIMARY KEY, invoice_num SERIAL NOT NULL, invoice_code VARCHAR(50) GENERATED ALWAYS AS ('INV-' || LPAD(invoice_num::TEXT, 5, '0')) STORED)",
            "INSERT INTO invoices (id) VALUES (DEFAULT), (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "invoice_code",
            "type": "autonumber",
            "prefix": "INV-",
            "digits": 5
          }
        },
        "assertions": [
          {
            "description": "First number formatted with prefix",
            "executeQuery": "SELECT invoice_code FROM invoices WHERE id = 1",
            "expected": {
              "invoice_code": "INV-00001"
            }
          },
          {
            "description": "Second number formatted with prefix",
            "executeQuery": "SELECT invoice_code FROM invoices WHERE id = 2",
            "expected": {
              "invoice_code": "INV-00002"
            }
          },
          {
            "description": "Third number formatted with prefix",
            "executeQuery": "SELECT invoice_code FROM invoices WHERE id = 3",
            "expected": {
              "invoice_code": "INV-00003"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-PREFIX-002",
      "given": "autonumber field with empty prefix (prefix='')",
      "when": "generated column omits prefix concatenation",
      "then": "PostgreSQL GENERATED ALWAYS AS creates number without prefix",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_num SERIAL NOT NULL, order_code VARCHAR(50) GENERATED ALWAYS AS (LPAD(order_num::TEXT, 4, '0')) STORED)",
            "INSERT INTO orders (id) VALUES (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "order_code",
            "type": "autonumber",
            "prefix": "",
            "digits": 4
          }
        },
        "assertions": [
          {
            "description": "Number formatted without prefix",
            "executeQuery": "SELECT order_code FROM orders WHERE id = 1",
            "expected": {
              "order_code": "0001"
            }
          },
          {
            "description": "Second number without prefix",
            "executeQuery": "SELECT order_code FROM orders WHERE id = 2",
            "expected": {
              "order_code": "0002"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-PREFIX-003",
      "given": "autonumber field without prefix specified (optional)",
      "when": "generated column uses only padded number",
      "then": "PostgreSQL GENERATED ALWAYS AS creates number-only format",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tickets (id SERIAL PRIMARY KEY, ticket_num SERIAL NOT NULL, ticket_code VARCHAR(50) GENERATED ALWAYS AS (LPAD(ticket_num::TEXT, 3, '0')) STORED)",
            "INSERT INTO tickets (id) VALUES (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "ticket_code",
            "type": "autonumber",
            "digits": 3
          }
        },
        "assertions": [
          {
            "description": "Number formatted without prefix (optional not specified)",
            "executeQuery": "SELECT ticket_code FROM tickets WHERE id = 1",
            "expected": {
              "ticket_code": "001"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-STARTFROM-001",
      "given": "autonumber field with startFrom=1000",
      "when": "sequence created with START WITH 1000",
      "then": "PostgreSQL sequence generates numbers starting from 1000",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE SEQUENCE orders_order_num_seq START WITH 1000 INCREMENT BY 1",
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_num INTEGER NOT NULL UNIQUE DEFAULT nextval('orders_order_num_seq'))",
            "INSERT INTO orders (id) VALUES (DEFAULT), (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "order_num",
            "type": "autonumber",
            "startFrom": 1000
          }
        },
        "assertions": [
          {
            "description": "Sequence start value is 1000",
            "executeQuery": "SELECT start_value FROM pg_sequences WHERE sequencename = 'orders_order_num_seq'",
            "expected": {
              "start_value": 1000
            }
          },
          {
            "description": "First record gets number 1000",
            "executeQuery": "SELECT order_num FROM orders WHERE id = 1",
            "expected": {
              "order_num": 1000
            }
          },
          {
            "description": "Second record gets number 1001",
            "executeQuery": "SELECT order_num FROM orders WHERE id = 2",
            "expected": {
              "order_num": 1001
            }
          },
          {
            "description": "Third record gets number 1002",
            "executeQuery": "SELECT order_num FROM orders WHERE id = 3",
            "expected": {
              "order_num": 1002
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-STARTFROM-002",
      "given": "autonumber field with default startFrom=1 (not specified)",
      "when": "sequence created with default START WITH 1",
      "then": "PostgreSQL sequence generates numbers starting from 1",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE SEQUENCE invoices_invoice_num_seq START WITH 1 INCREMENT BY 1",
            "CREATE TABLE invoices (id SERIAL PRIMARY KEY, invoice_num INTEGER NOT NULL UNIQUE DEFAULT nextval('invoices_invoice_num_seq'))",
            "INSERT INTO invoices (id) VALUES (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "invoice_num",
            "type": "autonumber"
          }
        },
        "assertions": [
          {
            "description": "Sequence start value defaults to 1",
            "executeQuery": "SELECT start_value FROM pg_sequences WHERE sequencename = 'invoices_invoice_num_seq'",
            "expected": {
              "start_value": 1
            }
          },
          {
            "description": "First record gets number 1",
            "executeQuery": "SELECT invoice_num FROM invoices WHERE id = 1",
            "expected": {
              "invoice_num": 1
            }
          },
          {
            "description": "Second record gets number 2",
            "executeQuery": "SELECT invoice_num FROM invoices WHERE id = 2",
            "expected": {
              "invoice_num": 2
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-AUTONUMBER-STARTFROM-003",
      "given": "autonumber field with startFrom=100",
      "when": "sequence created with START WITH 100",
      "then": "PostgreSQL sequence generates numbers starting from 100",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE SEQUENCE tickets_ticket_num_seq START WITH 100 INCREMENT BY 1",
            "CREATE TABLE tickets (id SERIAL PRIMARY KEY, ticket_num INTEGER NOT NULL UNIQUE DEFAULT nextval('tickets_ticket_num_seq'))",
            "INSERT INTO tickets (id) VALUES (DEFAULT)"
          ],
          "fieldConfig": {
            "name": "ticket_num",
            "type": "autonumber",
            "startFrom": 100
          }
        },
        "assertions": [
          {
            "description": "Sequence start value is 100",
            "executeQuery": "SELECT start_value FROM pg_sequences WHERE sequencename = 'tickets_ticket_num_seq'",
            "expected": {
              "start_value": 100
            }
          },
          {
            "description": "First record gets number 100",
            "executeQuery": "SELECT ticket_num FROM tickets WHERE id = 1",
            "expected": {
              "ticket_num": 100
            }
          }
        ]
      }
    }
  ]
}
