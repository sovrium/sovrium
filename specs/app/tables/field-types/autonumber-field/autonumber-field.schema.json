{
  "$id": "autonumber-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Autonumber Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "type": {
      "type": "string",
      "const": "autonumber"
    },
    "prefix": {
      "$ref": "./prefix/prefix.schema.json"
    },
    "startFrom": {
      "$ref": "./startFrom/startFrom.schema.json"
    },
    "digits": {
      "$ref": "./digits/digits.schema.json"
    }
  },
  "description": "Auto-incrementing unique number (read-only)",
  "required": [
    "id",
    "name",
    "type"
  ],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-AUTONUMBER-FIELD-001",
      "given": "table configuration with autonumber field 'record_number'",
      "when": "field migration creates SERIAL column",
      "then": "PostgreSQL SERIAL column with automatic sequence is created",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE invoices (id SERIAL PRIMARY KEY, record_number SERIAL NOT NULL UNIQUE)",
          "fieldConfig": {
            "id": 1,
            "name": "record_number",
            "type": "autonumber"
          }
        },
        "assertions": [
          {
            "description": "Column created as INTEGER",
            "executeQuery": "SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name='invoices' AND column_name='record_number'",
            "expected": {
              "column_name": "record_number",
              "data_type": "integer",
              "is_nullable": "NO"
            }
          },
          {
            "description": "UNIQUE constraint exists",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='invoices' AND constraint_type='UNIQUE' AND constraint_name LIKE '%record_number%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Sequence exists for auto-increment",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_sequences WHERE schemaname='public' AND sequencename LIKE '%record_number%'",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-002",
      "given": "table 'orders' with autonumber field auto-incrementing",
      "when": "multiple records are inserted",
      "then": "PostgreSQL sequence generates sequential unique numbers",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_number SERIAL NOT NULL UNIQUE)",
            "INSERT INTO orders (id) VALUES (DEFAULT)",
            "INSERT INTO orders (id) VALUES (DEFAULT)",
            "INSERT INTO orders (id) VALUES (DEFAULT)"
          ]
        },
        "assertions": [
          {
            "description": "First record gets number 1",
            "executeQuery": "SELECT order_number FROM orders WHERE id = 1",
            "expected": {
              "order_number": 1
            }
          },
          {
            "description": "Second record gets number 2",
            "executeQuery": "SELECT order_number FROM orders WHERE id = 2",
            "expected": {
              "order_number": 2
            }
          },
          {
            "description": "Third record gets number 3",
            "executeQuery": "SELECT order_number FROM orders WHERE id = 3",
            "expected": {
              "order_number": 3
            }
          },
          {
            "description": "All numbers are unique and sequential",
            "executeQuery": "SELECT COUNT(DISTINCT order_number) as unique_count, MAX(order_number) as max_number FROM orders",
            "expected": {
              "unique_count": 3,
              "max_number": 3
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-003",
      "given": "table configuration with autonumber field 'ticket_id' and startFrom=1000",
      "when": "sequence is created with custom start value",
      "then": "PostgreSQL sequence starts from specified number",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE SEQUENCE tickets_ticket_id_seq START WITH 1000 INCREMENT BY 1",
            "CREATE TABLE tickets (id SERIAL PRIMARY KEY, ticket_id INTEGER NOT NULL UNIQUE DEFAULT nextval('tickets_ticket_id_seq'))",
            "INSERT INTO tickets (id) VALUES (DEFAULT), (DEFAULT)"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "ticket_id",
            "type": "autonumber",
            "startFrom": 1000
          }
        },
        "assertions": [
          {
            "description": "Sequence starts at 1000",
            "executeQuery": "SELECT start_value FROM pg_sequences WHERE sequencename = 'tickets_ticket_id_seq'",
            "expected": {
              "start_value": 1000
            }
          },
          {
            "description": "First record gets number 1000",
            "executeQuery": "SELECT ticket_id FROM tickets WHERE id = 1",
            "expected": {
              "ticket_id": 1000
            }
          },
          {
            "description": "Second record gets number 1001",
            "executeQuery": "SELECT ticket_id FROM tickets WHERE id = 2",
            "expected": {
              "ticket_id": 1001
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-004",
      "given": "table 'requests' with autonumber field 'request_code' using prefix via generated column",
      "when": "generated column formats number with prefix",
      "then": "PostgreSQL GENERATED ALWAYS AS column creates formatted string",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE requests (id SERIAL PRIMARY KEY, request_number SERIAL NOT NULL, request_code VARCHAR(50) GENERATED ALWAYS AS ('REQ-' || LPAD(request_number::TEXT, 5, '0')) STORED)",
            "INSERT INTO requests (id) VALUES (DEFAULT)",
            "INSERT INTO requests (id) VALUES (DEFAULT)",
            "INSERT INTO requests (id) VALUES (DEFAULT)"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "request_code",
            "type": "autonumber",
            "prefix": "REQ-",
            "digits": 5
          }
        },
        "assertions": [
          {
            "description": "Generated column exists",
            "executeQuery": "SELECT column_name, is_generated FROM information_schema.columns WHERE table_name='requests' AND column_name='request_code'",
            "expected": {
              "column_name": "request_code",
              "is_generated": "ALWAYS"
            }
          },
          {
            "description": "First record formatted with prefix and padding",
            "executeQuery": "SELECT request_code FROM requests WHERE id = 1",
            "expected": {
              "request_code": "REQ-00001"
            }
          },
          {
            "description": "Third record increments correctly",
            "executeQuery": "SELECT request_code FROM requests WHERE id = 3",
            "expected": {
              "request_code": "REQ-00003"
            }
          }
        ]
      }
    },
    {
      "id": "APP-AUTONUMBER-FIELD-005",
      "given": "table 'contracts' with autonumber field preventing duplicate values",
      "when": "attempting to insert duplicate autonumber manually",
      "then": "PostgreSQL UNIQUE constraint prevents duplicates",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE contracts (id SERIAL PRIMARY KEY, contract_number INTEGER NOT NULL UNIQUE DEFAULT nextval('contracts_contract_number_seq'))",
            "CREATE SEQUENCE contracts_contract_number_seq START WITH 1 INCREMENT BY 1",
            "INSERT INTO contracts (id) VALUES (DEFAULT)"
          ]
        },
        "assertions": [
          {
            "description": "First auto-generated number succeeds",
            "executeQuery": "SELECT contract_number FROM contracts WHERE id = 1",
            "expected": {
              "contract_number": 1
            }
          },
          {
            "description": "Manual insert with duplicate number rejected",
            "executeQuery": "INSERT INTO contracts (contract_number) VALUES (1)",
            "expectError": "duplicate key value violates unique constraint"
          },
          {
            "description": "Next auto-generated number succeeds",
            "executeQuery": "INSERT INTO contracts (id) VALUES (DEFAULT) RETURNING contract_number",
            "expected": {
              "contract_number": 2
            }
          }
        ]
      }
    }
  ]
}
