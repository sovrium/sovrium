{
  "$id": "resultType.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Formula Result Type",
  "description": "Expected data type of the formula result. Determines PostgreSQL column type for GENERATED column: text→TEXT, number→DECIMAL, boolean→BOOLEAN, date→DATE.",
  "type": "string",
  "default": "text",
  "enum": ["text", "number", "boolean", "date"],
  "x-specs": [
    {
      "id": "APP-FIELD-FORMULA-RESULTTYPE-001",
      "given": "formula field with resultType: 'number'",
      "when": "field migration creates GENERATED column",
      "then": "PostgreSQL creates DECIMAL type column for numeric results",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, price DECIMAL(10,2), quantity INTEGER, total DECIMAL(15,2) GENERATED ALWAYS AS (price * quantity) STORED)",
            "INSERT INTO products (price, quantity) VALUES (29.99, 3)"
          ],
          "fieldConfig": {
            "name": "total",
            "type": "formula",
            "formula": "price * quantity",
            "resultType": "number"
          }
        },
        "assertions": [
          {
            "description": "Column uses DECIMAL type for number resultType",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='products' AND column_name='total'",
            "expected": { "data_type": "numeric" }
          },
          {
            "description": "Numeric result computed correctly",
            "executeQuery": "SELECT total FROM products WHERE id = 1",
            "expected": { "total": 89.97 }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-FORMULA-RESULTTYPE-002",
      "given": "formula field with resultType: 'text'",
      "when": "field migration creates GENERATED column",
      "then": "PostgreSQL creates TEXT type column for string results",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, first_name VARCHAR(255), last_name VARCHAR(255), display_name TEXT GENERATED ALWAYS AS (CONCAT(first_name, ' ', last_name)) STORED)",
            "INSERT INTO users (first_name, last_name) VALUES ('Alice', 'Wonder'), ('Bob', 'Builder')"
          ],
          "fieldConfig": {
            "name": "display_name",
            "type": "formula",
            "formula": "CONCAT(first_name, ' ', last_name)",
            "resultType": "text"
          }
        },
        "assertions": [
          {
            "description": "Column uses TEXT type for text resultType",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='users' AND column_name='display_name'",
            "expected": { "data_type": "text" }
          },
          {
            "description": "Text result computed correctly",
            "executeQuery": "SELECT display_name FROM users WHERE first_name = 'Alice'",
            "expected": { "display_name": "Alice Wonder" }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-FORMULA-RESULTTYPE-003",
      "given": "formula field with resultType: 'boolean'",
      "when": "field migration creates GENERATED column",
      "then": "PostgreSQL creates BOOLEAN type column for conditional results",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE inventory (id SERIAL PRIMARY KEY, stock_level INTEGER, in_stock BOOLEAN GENERATED ALWAYS AS (stock_level > 0) STORED)",
            "INSERT INTO inventory (stock_level) VALUES (0), (10), (50)"
          ],
          "fieldConfig": {
            "name": "in_stock",
            "type": "formula",
            "formula": "stock_level > 0",
            "resultType": "boolean"
          }
        },
        "assertions": [
          {
            "description": "Column uses BOOLEAN type for boolean resultType",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='inventory' AND column_name='in_stock'",
            "expected": { "data_type": "boolean" }
          },
          {
            "description": "Boolean result for zero stock (false)",
            "executeQuery": "SELECT in_stock FROM inventory WHERE stock_level = 0",
            "expected": { "in_stock": false }
          },
          {
            "description": "Boolean result for positive stock (true)",
            "executeQuery": "SELECT in_stock FROM inventory WHERE stock_level = 10",
            "expected": { "in_stock": true }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-FORMULA-RESULTTYPE-004",
      "given": "formula field with resultType: 'date'",
      "when": "field migration creates GENERATED column",
      "then": "PostgreSQL creates DATE type column for date calculations",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE subscriptions (id SERIAL PRIMARY KEY, start_date DATE, duration_days INTEGER, end_date DATE GENERATED ALWAYS AS (start_date + duration_days) STORED)",
            "INSERT INTO subscriptions (start_date, duration_days) VALUES ('2024-01-01', 30), ('2024-06-15', 90)"
          ],
          "fieldConfig": {
            "name": "end_date",
            "type": "formula",
            "formula": "start_date + duration_days",
            "resultType": "date"
          }
        },
        "assertions": [
          {
            "description": "Column uses DATE type for date resultType",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='subscriptions' AND column_name='end_date'",
            "expected": { "data_type": "date" }
          },
          {
            "description": "Date calculation (2024-01-01 + 30 days)",
            "executeQuery": "SELECT end_date FROM subscriptions WHERE start_date = '2024-01-01'",
            "expected": { "end_date": "2024-01-31" }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-FORMULA-RESULTTYPE-005",
      "given": "formula field without resultType specified",
      "when": "field configuration uses default",
      "then": "PostgreSQL creates TEXT type column (default: 'text')",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE calculations (id SERIAL PRIMARY KEY, x INTEGER, y INTEGER, result TEXT GENERATED ALWAYS AS (CONCAT('Sum: ', (x + y)::TEXT)) STORED)",
            "INSERT INTO calculations (x, y) VALUES (5, 10)"
          ],
          "fieldConfig": {
            "name": "result",
            "type": "formula",
            "formula": "CONCAT('Sum: ', (x + y)::TEXT)"
          }
        },
        "assertions": [
          {
            "description": "Default resultType is 'text'",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='calculations' AND column_name='result'",
            "expected": { "data_type": "text" }
          },
          {
            "description": "Result formatted as text",
            "executeQuery": "SELECT result FROM calculations WHERE id = 1",
            "expected": { "result": "Sum: 15" }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-FORMULA-RESULTTYPE-006",
      "given": "formula field with invalid resultType value",
      "when": "field configuration validation runs",
      "then": "error lists valid options: text, number, boolean, date",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "computed",
            "type": "formula",
            "formula": "x + y",
            "resultType": "INVALID-TYPE"
          }
        },
        "assertions": [
          {
            "description": "Invalid resultType rejected with enum error",
            "validateConfig": true,
            "expectError": "resultType must be one of: text, number, boolean, date"
          }
        ]
      }
    }
  ]
}
