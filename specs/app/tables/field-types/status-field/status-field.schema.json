{
  "$id": "status-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Status Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "required": {
      "$ref": "../common/required/required.schema.json"
    },
    "indexed": {
      "$ref": "../common/indexed/indexed.schema.json"
    },
    "type": {
      "type": "string",
      "const": "status"
    },
    "options": {
      "$ref": "./options/options.schema.json"
    },
    "default": {
      "$ref": "./default/default.schema.json"
    }
  },
  "description": "Workflow status with customizable options and colors",
  "required": [
    "id",
    "name",
    "type",
    "options"
  ],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-STATUS-FIELD-001",
      "given": "table configuration with status field 'workflow_status' (options: Draft, In Review, Approved, Published)",
      "when": "field migration creates column",
      "then": "PostgreSQL VARCHAR column with CHECK constraint for status values is created",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE documents (id SERIAL PRIMARY KEY)",
          "fieldConfig": {
            "id": 1,
            "name": "workflow_status",
            "type": "status",
            "options": [
              {
                "value": "Draft",
                "label": "Draft",
                "color": "gray"
              },
              {
                "value": "In Review",
                "label": "In Review",
                "color": "yellow"
              },
              {
                "value": "Approved",
                "label": "Approved",
                "color": "green"
              },
              {
                "value": "Published",
                "label": "Published",
                "color": "blue"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Column created as VARCHAR",
            "executeQuery": "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='documents' AND column_name='workflow_status'",
            "expected": {
              "column_name": "workflow_status",
              "data_type": "character varying"
            }
          },
          {
            "description": "CHECK constraint exists for status values",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.check_constraints WHERE constraint_name LIKE '%workflow_status%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Valid status value can be inserted",
            "executeQuery": "INSERT INTO documents (workflow_status) VALUES ('Draft') RETURNING workflow_status",
            "expected": {
              "workflow_status": "Draft"
            }
          }
        ]
      }
    },
    {
      "id": "APP-STATUS-FIELD-002",
      "given": "table 'projects' with status field 'project_status' (options: Planning, Active, On Hold, Completed, Cancelled)",
      "when": "invalid status value is inserted",
      "then": "PostgreSQL CHECK constraint rejects value not in status options",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE projects (id SERIAL PRIMARY KEY, project_status VARCHAR(50) CHECK (project_status IN ('Planning', 'Active', 'On Hold', 'Completed', 'Cancelled')))"
        },
        "assertions": [
          {
            "description": "Valid status 'Planning' succeeds",
            "executeQuery": "INSERT INTO projects (project_status) VALUES ('Planning') RETURNING project_status",
            "expected": {
              "project_status": "Planning"
            }
          },
          {
            "description": "Valid status 'Active' succeeds",
            "executeQuery": "INSERT INTO projects (project_status) VALUES ('Active') RETURNING project_status",
            "expected": {
              "project_status": "Active"
            }
          },
          {
            "description": "Invalid status value rejected by CHECK constraint",
            "executeQuery": "INSERT INTO projects (project_status) VALUES ('Invalid Status')",
            "expectError": "violates check constraint"
          }
        ]
      }
    },
    {
      "id": "APP-STATUS-FIELD-003",
      "given": "table 'tasks' with status field 'task_status' (required, unique)",
      "when": "constraints are applied",
      "then": "PostgreSQL enforces NOT NULL and UNIQUE constraints",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, task_status VARCHAR(50) UNIQUE NOT NULL CHECK (task_status IN ('Todo', 'In Progress', 'Blocked', 'Done')))",
            "INSERT INTO tasks (task_status) VALUES ('Todo')"
          ]
        },
        "assertions": [
          {
            "description": "NOT NULL constraint enforced",
            "executeQuery": "SELECT is_nullable FROM information_schema.columns WHERE table_name='tasks' AND column_name='task_status'",
            "expected": {
              "is_nullable": "NO"
            }
          },
          {
            "description": "UNIQUE constraint exists",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='tasks' AND constraint_type='UNIQUE' AND constraint_name LIKE '%task_status%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Duplicate status value rejected",
            "executeQuery": "INSERT INTO tasks (task_status) VALUES ('Todo')",
            "expectError": "duplicate key value violates unique constraint"
          },
          {
            "description": "NULL status value rejected",
            "executeQuery": "INSERT INTO tasks (task_status) VALUES (NULL)",
            "expectError": "violates not-null constraint"
          }
        ]
      }
    },
    {
      "id": "APP-STATUS-FIELD-004",
      "given": "table 'orders' with status field 'order_status' and default value 'Pending'",
      "when": "row inserted without providing order_status value",
      "then": "PostgreSQL applies DEFAULT value 'Pending'",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_status VARCHAR(50) DEFAULT 'Pending' CHECK (order_status IN ('Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled')))",
          "fieldConfig": {
            "id": 1,
            "name": "order_status",
            "type": "status",
            "options": [
              {
                "value": "Pending"
              },
              {
                "value": "Processing"
              },
              {
                "value": "Shipped"
              },
              {
                "value": "Delivered"
              },
              {
                "value": "Cancelled"
              }
            ],
            "default": "Pending"
          }
        },
        "assertions": [
          {
            "description": "Column has DEFAULT value",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='orders' AND column_name='order_status'",
            "expected": {
              "column_default": "'Pending'::character varying"
            }
          },
          {
            "description": "INSERT without order_status uses default",
            "executeQuery": "INSERT INTO orders (id) VALUES (DEFAULT) RETURNING order_status",
            "expected": {
              "order_status": "Pending"
            }
          },
          {
            "description": "Explicit value overrides default",
            "executeQuery": "INSERT INTO orders (order_status) VALUES ('Shipped') RETURNING order_status",
            "expected": {
              "order_status": "Shipped"
            }
          }
        ]
      }
    },
    {
      "id": "APP-STATUS-FIELD-005",
      "given": "table configuration with status field 'approval_status', indexed=true",
      "when": "index is created on the status field",
      "then": "PostgreSQL btree index exists for fast status filtering",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE requests (id SERIAL PRIMARY KEY, approval_status VARCHAR(50) NOT NULL CHECK (approval_status IN ('Submitted', 'Under Review', 'Approved', 'Rejected')))",
            "CREATE INDEX idx_requests_status ON requests(approval_status)"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "approval_status",
            "type": "status",
            "indexed": true
          }
        },
        "assertions": [
          {
            "description": "Index exists in pg_indexes",
            "executeQuery": "SELECT indexname, tablename FROM pg_indexes WHERE indexname = 'idx_requests_status'",
            "expected": {
              "indexname": "idx_requests_status",
              "tablename": "requests"
            }
          },
          {
            "description": "Index uses btree for status filtering",
            "executeQuery": "SELECT indexdef FROM pg_indexes WHERE indexname = 'idx_requests_status'",
            "expected": {
              "indexdef": "CREATE INDEX idx_requests_status ON public.requests USING btree (approval_status)"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-STATUS-DEFAULT-001",
      "given": "status field with default: 'todo'",
      "when": "INSERT without value for this field",
      "then": "PostgreSQL DEFAULT constraint provides default status",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, title VARCHAR(255), status VARCHAR(50) DEFAULT 'todo')",
            "INSERT INTO tasks (title) VALUES ('New Task')"
          ],
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": [
              {
                "id": "todo",
                "value": "To Do",
                "color": "#gray"
              },
              {
                "id": "in_progress",
                "value": "In Progress",
                "color": "#blue"
              },
              {
                "id": "done",
                "value": "Done",
                "color": "#green"
              }
            ],
            "default": "todo"
          }
        },
        "assertions": [
          {
            "description": "Column has DEFAULT constraint with status",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='tasks' AND column_name='status'",
            "expected": {
              "column_default": "'todo'::character varying"
            }
          },
          {
            "description": "INSERT without value uses default status",
            "executeQuery": "SELECT status FROM tasks WHERE title = 'New Task'",
            "expected": {
              "status": "todo"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-STATUS-DEFAULT-002",
      "given": "status field without default specified",
      "when": "INSERT without value for this field",
      "then": "PostgreSQL inserts NULL",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, name VARCHAR(255), status VARCHAR(50))",
            "INSERT INTO projects (name) VALUES ('Project A')"
          ],
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": [
              {
                "id": "active",
                "value": "Active",
                "color": "#green"
              },
              {
                "id": "paused",
                "value": "Paused",
                "color": "#yellow"
              },
              {
                "id": "archived",
                "value": "Archived",
                "color": "#gray"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Column has no DEFAULT constraint",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='projects' AND column_name='status'",
            "expected": {
              "column_default": null
            }
          },
          {
            "description": "INSERT without value results in NULL",
            "executeQuery": "SELECT status FROM projects WHERE name = 'Project A'",
            "expected": {
              "status": null
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-STATUS-DEFAULT-003",
      "given": "status field with default and explicit value",
      "when": "INSERT with specific status",
      "then": "PostgreSQL uses explicit value, ignoring default",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, customer VARCHAR(255), status VARCHAR(50) DEFAULT 'pending')",
            "INSERT INTO orders (customer, status) VALUES ('John Doe', 'completed')"
          ],
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": [
              {
                "id": "pending",
                "value": "Pending",
                "color": "#yellow"
              },
              {
                "id": "processing",
                "value": "Processing",
                "color": "#blue"
              },
              {
                "id": "completed",
                "value": "Completed",
                "color": "#green"
              }
            ],
            "default": "pending"
          }
        },
        "assertions": [
          {
            "description": "Explicit value overrides default",
            "executeQuery": "SELECT status FROM orders WHERE customer = 'John Doe'",
            "expected": {
              "status": "completed"
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-STATUS-OPTIONS-001",
      "given": "status field with options: [{value: 'Todo', color: '#FF0000'}, {value: 'Done', color: '#00FF00'}]",
      "when": "field migration creates status column with CHECK constraint and metadata table",
      "then": "PostgreSQL enforces allowed status values and stores color metadata",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE status_options (id SERIAL PRIMARY KEY, field_name VARCHAR(255), value VARCHAR(255), color VARCHAR(7))",
            "INSERT INTO status_options (field_name, value, color) VALUES ('task_status', 'Todo', '#FF0000'), ('task_status', 'Done', '#00FF00')",
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, title VARCHAR(255), status VARCHAR(255) CHECK (status IN ('Todo', 'Done')))",
            "INSERT INTO tasks (title, status) VALUES ('Task 1', 'Todo'), ('Task 2', 'Done')"
          ],
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": [
              {
                "value": "Todo",
                "color": "#FF0000"
              },
              {
                "value": "Done",
                "color": "#00FF00"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Status values enforced by CHECK constraint",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%status%'",
            "expected": {
              "check_clause": "(status IN ('Todo', 'Done'))"
            }
          },
          {
            "description": "Color metadata stored in status_options table",
            "executeQuery": "SELECT value, color FROM status_options WHERE field_name = 'task_status' AND value = 'Todo'",
            "expected": {
              "value": "Todo",
              "color": "#FF0000"
            }
          },
          {
            "description": "Valid status value accepted",
            "executeQuery": "SELECT status FROM tasks WHERE title = 'Task 1'",
            "expected": {
              "status": "Todo"
            }
          },
          {
            "description": "Invalid status value rejected",
            "executeQuery": "INSERT INTO tasks (title, status) VALUES ('Task 3', 'In Progress')",
            "expectError": "violates check constraint"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-STATUS-OPTIONS-002",
      "given": "status field with options missing color property",
      "when": "color is optional (defaults to system color)",
      "then": "PostgreSQL accepts status options without color metadata",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE status_options (id SERIAL PRIMARY KEY, field_name VARCHAR(255), value VARCHAR(255), color VARCHAR(7))",
            "INSERT INTO status_options (field_name, value, color) VALUES ('priority', 'Low', NULL), ('priority', 'High', '#FF0000')",
            "CREATE TABLE issues (id SERIAL PRIMARY KEY, title VARCHAR(255), priority VARCHAR(255) CHECK (priority IN ('Low', 'High')))",
            "INSERT INTO issues (title, priority) VALUES ('Issue 1', 'Low'), ('Issue 2', 'High')"
          ],
          "fieldConfig": {
            "name": "priority",
            "type": "status",
            "options": [
              {
                "value": "Low"
              },
              {
                "value": "High",
                "color": "#FF0000"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Options without color have NULL color metadata",
            "executeQuery": "SELECT value, color FROM status_options WHERE field_name = 'priority' AND value = 'Low'",
            "expected": {
              "value": "Low",
              "color": null
            }
          },
          {
            "description": "Options with color preserve color metadata",
            "executeQuery": "SELECT value, color FROM status_options WHERE field_name = 'priority' AND value = 'High'",
            "expected": {
              "value": "High",
              "color": "#FF0000"
            }
          },
          {
            "description": "Both options accepted in data column",
            "executeQuery": "SELECT COUNT(*) as count FROM issues WHERE priority IN ('Low', 'High')",
            "expected": {
              "count": 2
            }
          }
        ]
      }
    },
    {
      "id": "APP-OPTIONS-003",
      "given": "status option with empty value string",
      "when": "field configuration validation runs",
      "then": "error should require minimum length 1 character",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": [
              {
                "value": "",
                "color": "#FF0000"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Empty value string rejected",
            "validateConfig": true,
            "expectError": "value must have at least 1 character"
          }
        ]
      }
    },
    {
      "id": "APP-OPTIONS-004",
      "given": "status option with valid hex color #1A2B3C",
      "when": "field configuration validation runs",
      "then": "hex color pattern accepted",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": [
              {
                "value": "Active",
                "color": "#1A2B3C"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Valid hex color accepted",
            "validateConfig": true,
            "expected": {
              "valid": true
            }
          }
        ]
      }
    },
    {
      "id": "APP-OPTIONS-005",
      "given": "status option with invalid color 'red' (not hex)",
      "when": "field configuration validation runs",
      "then": "clear error message should explain hex format requirement",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": [
              {
                "value": "Error",
                "color": "red"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Non-hex color rejected with format error",
            "validateConfig": true,
            "expectError": "color must be hex format: #RRGGBB (e.g., #FF0000)"
          }
        ]
      }
    },
    {
      "id": "APP-OPTIONS-006",
      "given": "status field with color #FF00FF stored",
      "when": "status option retrieved from database",
      "then": "original hex color format preserved exactly",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE status_options (id SERIAL PRIMARY KEY, field_name VARCHAR(255), value VARCHAR(255), color VARCHAR(7))",
            "INSERT INTO status_options (field_name, value, color) VALUES ('task_status', 'Review', '#FF00FF')"
          ],
          "fieldConfig": {
            "name": "task_status",
            "type": "status",
            "options": [
              {
                "value": "Review",
                "color": "#FF00FF"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Original hex format preserved (case-sensitive)",
            "executeQuery": "SELECT color FROM status_options WHERE field_name = 'task_status' AND value = 'Review'",
            "expected": {
              "color": "#FF00FF"
            }
          }
        ]
      }
    },
    {
      "id": "APP-OPTIONS-007",
      "given": "status field with empty options array",
      "when": "field configuration validation runs",
      "then": "error should enforce minimum 1 option required",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "status",
            "type": "status",
            "options": []
          }
        },
        "assertions": [
          {
            "description": "Configuration with empty options array rejected",
            "validateConfig": true,
            "expectError": "options array must have at least 1 item"
          }
        ]
      }
    }
  ]
}
