{
  "$id": "duration-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Duration Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "required": {
      "$ref": "../common/required/required.schema.json"
    },
    "type": {
      "type": "string",
      "const": "duration"
    },
    "format": {
      "$ref": "./format/format.schema.json"
    }
  },
  "description": "Time duration in hours, minutes, and seconds",
  "required": ["id", "name", "type"],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-DURATION-FIELD-001",
      "given": "table configuration with duration field 'task_duration'",
      "when": "field migration creates INTERVAL column",
      "then": "PostgreSQL INTERVAL type is created for duration storage",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE tasks (id SERIAL PRIMARY KEY, task_duration INTERVAL)",
          "fieldConfig": {
            "id": 1,
            "name": "task_duration",
            "type": "duration"
          }
        },
        "assertions": [
          {
            "description": "Column created as INTERVAL type",
            "executeQuery": "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='tasks' AND column_name='task_duration'",
            "expected": { "column_name": "task_duration", "data_type": "interval" }
          },
          {
            "description": "Duration in hours can be inserted",
            "executeQuery": "INSERT INTO tasks (task_duration) VALUES (INTERVAL '2 hours') RETURNING task_duration",
            "expected": { "task_duration": "02:00:00" }
          },
          {
            "description": "Duration in minutes can be inserted",
            "executeQuery": "INSERT INTO tasks (task_duration) VALUES (INTERVAL '45 minutes') RETURNING task_duration",
            "expected": { "task_duration": "00:45:00" }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-002",
      "given": "table 'videos' with duration field supporting arithmetic",
      "when": "performing duration calculations",
      "then": "PostgreSQL supports addition, subtraction, and comparison of durations",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE videos (id SERIAL PRIMARY KEY, title VARCHAR(255), length INTERVAL)",
            "INSERT INTO videos (title, length) VALUES ('Video 1', INTERVAL '10 minutes'), ('Video 2', INTERVAL '25 minutes'), ('Video 3', INTERVAL '1 hour')"
          ]
        },
        "assertions": [
          {
            "description": "Find videos longer than 15 minutes",
            "executeQuery": "SELECT COUNT(*) as count FROM videos WHERE length > INTERVAL '15 minutes'",
            "expected": { "count": 2 }
          },
          {
            "description": "Calculate total duration of all videos",
            "executeQuery": "SELECT SUM(length) as total_duration FROM videos",
            "expected": { "total_duration": "01:35:00" }
          },
          {
            "description": "Order videos by duration",
            "executeQuery": "SELECT title FROM videos ORDER BY length DESC LIMIT 1",
            "expected": { "title": "Video 3" }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-003",
      "given": "table 'meetings' with duration field in compound format",
      "when": "storing duration with days, hours, and minutes",
      "then": "PostgreSQL INTERVAL supports complex duration expressions",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE meetings (id SERIAL PRIMARY KEY, estimated_time INTERVAL)",
            "INSERT INTO meetings (estimated_time) VALUES (INTERVAL '2 days 3 hours 30 minutes')"
          ]
        },
        "assertions": [
          {
            "description": "Complex duration stored correctly",
            "executeQuery": "SELECT estimated_time FROM meetings WHERE id = 1",
            "expected": { "estimated_time": "2 days 03:30:00" }
          },
          {
            "description": "Extract hours from interval",
            "executeQuery": "SELECT EXTRACT(HOUR FROM estimated_time) as hours FROM meetings WHERE id = 1",
            "expected": { "hours": 3 }
          },
          {
            "description": "Convert interval to total seconds",
            "executeQuery": "SELECT EXTRACT(EPOCH FROM estimated_time) as total_seconds FROM meetings WHERE id = 1",
            "expected": { "total_seconds": 185400 }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-004",
      "given": "table 'projects' with duration field for date arithmetic",
      "when": "adding duration to timestamp",
      "then": "PostgreSQL supports timestamp + interval operations",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, start_date TIMESTAMPTZ, duration INTERVAL)",
            "INSERT INTO projects (start_date, duration) VALUES ('2024-01-01 09:00:00', INTERVAL '5 days')"
          ]
        },
        "assertions": [
          {
            "description": "Calculate end date by adding duration",
            "executeQuery": "SELECT (start_date + duration)::DATE as end_date FROM projects WHERE id = 1",
            "expected": { "end_date": "2024-01-06" }
          },
          {
            "description": "Calculate remaining time from now",
            "executeQuery": "SELECT (start_date + duration) > NOW() as is_future FROM projects WHERE id = 1",
            "expected": { "is_future": false }
          },
          {
            "description": "Duration arithmetic with multiplication",
            "executeQuery": "SELECT (duration * 2) as doubled_duration FROM projects WHERE id = 1",
            "expected": { "doubled_duration": "10 days" }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-005",
      "given": "table 'shifts' with duration field and CHECK constraint",
      "when": "enforcing maximum duration limit",
      "then": "PostgreSQL CHECK constraint validates duration range",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE shifts (id SERIAL PRIMARY KEY, shift_length INTERVAL CHECK (shift_length <= INTERVAL '12 hours'))",
          "fieldConfig": {
            "id": 1,
            "name": "shift_length",
            "type": "duration"
          }
        },
        "assertions": [
          {
            "description": "Duration within limit succeeds",
            "executeQuery": "INSERT INTO shifts (shift_length) VALUES (INTERVAL '8 hours') RETURNING shift_length",
            "expected": { "shift_length": "08:00:00" }
          },
          {
            "description": "Duration at maximum limit succeeds",
            "executeQuery": "INSERT INTO shifts (shift_length) VALUES (INTERVAL '12 hours') RETURNING shift_length",
            "expected": { "shift_length": "12:00:00" }
          },
          {
            "description": "Duration exceeding limit rejected",
            "executeQuery": "INSERT INTO shifts (shift_length) VALUES (INTERVAL '13 hours')",
            "expectError": "violates check constraint"
          }
        ]
      }
    }
  ]
}
