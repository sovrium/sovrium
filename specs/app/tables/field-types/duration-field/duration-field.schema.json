{
  "$id": "duration-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Duration Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "required": {
      "$ref": "../common/required/required.schema.json"
    },
    "type": {
      "type": "string",
      "const": "duration"
    },
    "format": {
      "$ref": "./format/format.schema.json"
    }
  },
  "description": "Time duration in hours, minutes, and seconds",
  "required": [
    "id",
    "name",
    "type"
  ],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-DURATION-FIELD-001",
      "given": "table configuration with duration field 'task_duration'",
      "when": "field migration creates INTERVAL column",
      "then": "PostgreSQL INTERVAL type is created for duration storage",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE tasks (id SERIAL PRIMARY KEY, task_duration INTERVAL)",
          "fieldConfig": {
            "id": 1,
            "name": "task_duration",
            "type": "duration"
          }
        },
        "assertions": [
          {
            "description": "Column created as INTERVAL type",
            "executeQuery": "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='tasks' AND column_name='task_duration'",
            "expected": {
              "column_name": "task_duration",
              "data_type": "interval"
            }
          },
          {
            "description": "Duration in hours can be inserted",
            "executeQuery": "INSERT INTO tasks (task_duration) VALUES (INTERVAL '2 hours') RETURNING task_duration",
            "expected": {
              "task_duration": "02:00:00"
            }
          },
          {
            "description": "Duration in minutes can be inserted",
            "executeQuery": "INSERT INTO tasks (task_duration) VALUES (INTERVAL '45 minutes') RETURNING task_duration",
            "expected": {
              "task_duration": "00:45:00"
            }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-002",
      "given": "table 'videos' with duration field supporting arithmetic",
      "when": "performing duration calculations",
      "then": "PostgreSQL supports addition, subtraction, and comparison of durations",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE videos (id SERIAL PRIMARY KEY, title VARCHAR(255), length INTERVAL)",
            "INSERT INTO videos (title, length) VALUES ('Video 1', INTERVAL '10 minutes'), ('Video 2', INTERVAL '25 minutes'), ('Video 3', INTERVAL '1 hour')"
          ]
        },
        "assertions": [
          {
            "description": "Find videos longer than 15 minutes",
            "executeQuery": "SELECT COUNT(*) as count FROM videos WHERE length > INTERVAL '15 minutes'",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Calculate total duration of all videos",
            "executeQuery": "SELECT SUM(length) as total_duration FROM videos",
            "expected": {
              "total_duration": "01:35:00"
            }
          },
          {
            "description": "Order videos by duration",
            "executeQuery": "SELECT title FROM videos ORDER BY length DESC LIMIT 1",
            "expected": {
              "title": "Video 3"
            }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-003",
      "given": "table 'meetings' with duration field in compound format",
      "when": "storing duration with days, hours, and minutes",
      "then": "PostgreSQL INTERVAL supports complex duration expressions",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE meetings (id SERIAL PRIMARY KEY, estimated_time INTERVAL)",
            "INSERT INTO meetings (estimated_time) VALUES (INTERVAL '2 days 3 hours 30 minutes')"
          ]
        },
        "assertions": [
          {
            "description": "Complex duration stored correctly",
            "executeQuery": "SELECT estimated_time FROM meetings WHERE id = 1",
            "expected": {
              "estimated_time": "2 days 03:30:00"
            }
          },
          {
            "description": "Extract hours from interval",
            "executeQuery": "SELECT EXTRACT(HOUR FROM estimated_time) as hours FROM meetings WHERE id = 1",
            "expected": {
              "hours": 3
            }
          },
          {
            "description": "Convert interval to total seconds",
            "executeQuery": "SELECT EXTRACT(EPOCH FROM estimated_time) as total_seconds FROM meetings WHERE id = 1",
            "expected": {
              "total_seconds": 185400
            }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-004",
      "given": "table 'projects' with duration field for date arithmetic",
      "when": "adding duration to timestamp",
      "then": "PostgreSQL supports timestamp + interval operations",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE projects (id SERIAL PRIMARY KEY, start_date TIMESTAMPTZ, duration INTERVAL)",
            "INSERT INTO projects (start_date, duration) VALUES ('2024-01-01 09:00:00', INTERVAL '5 days')"
          ]
        },
        "assertions": [
          {
            "description": "Calculate end date by adding duration",
            "executeQuery": "SELECT (start_date + duration)::DATE as end_date FROM projects WHERE id = 1",
            "expected": {
              "end_date": "2024-01-06"
            }
          },
          {
            "description": "Calculate remaining time from now",
            "executeQuery": "SELECT (start_date + duration) > NOW() as is_future FROM projects WHERE id = 1",
            "expected": {
              "is_future": false
            }
          },
          {
            "description": "Duration arithmetic with multiplication",
            "executeQuery": "SELECT (duration * 2) as doubled_duration FROM projects WHERE id = 1",
            "expected": {
              "doubled_duration": "10 days"
            }
          }
        ]
      }
    },
    {
      "id": "APP-DURATION-FIELD-005",
      "given": "table 'shifts' with duration field and CHECK constraint",
      "when": "enforcing maximum duration limit",
      "then": "PostgreSQL CHECK constraint validates duration range",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE shifts (id SERIAL PRIMARY KEY, shift_length INTERVAL CHECK (shift_length <= INTERVAL '12 hours'))",
          "fieldConfig": {
            "id": 1,
            "name": "shift_length",
            "type": "duration"
          }
        },
        "assertions": [
          {
            "description": "Duration within limit succeeds",
            "executeQuery": "INSERT INTO shifts (shift_length) VALUES (INTERVAL '8 hours') RETURNING shift_length",
            "expected": {
              "shift_length": "08:00:00"
            }
          },
          {
            "description": "Duration at maximum limit succeeds",
            "executeQuery": "INSERT INTO shifts (shift_length) VALUES (INTERVAL '12 hours') RETURNING shift_length",
            "expected": {
              "shift_length": "12:00:00"
            }
          },
          {
            "description": "Duration exceeding limit rejected",
            "executeQuery": "INSERT INTO shifts (shift_length) VALUES (INTERVAL '13 hours')",
            "expectError": "violates check constraint"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-DURATION-FORMAT-001",
      "given": "duration field with format: 'h:mm:ss' (hours:minutes:seconds)",
      "when": "field migration creates INTERVAL column",
      "then": "PostgreSQL stores duration, application displays in h:mm:ss format",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, title VARCHAR(255), time_spent INTERVAL)",
            "INSERT INTO tasks (title, time_spent) VALUES ('Coding', INTERVAL '2 hours 30 minutes 45 seconds'), ('Review', INTERVAL '1 hour 15 minutes')"
          ],
          "fieldConfig": {
            "name": "time_spent",
            "type": "duration",
            "format": "h:mm:ss"
          }
        },
        "assertions": [
          {
            "description": "Column uses INTERVAL type",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='tasks' AND column_name='time_spent'",
            "expected": {
              "data_type": "interval"
            }
          },
          {
            "description": "Duration stored as INTERVAL",
            "executeQuery": "SELECT time_spent FROM tasks WHERE title = 'Coding'",
            "expected": {
              "time_spent": "02:30:45"
            }
          },
          {
            "description": "Application displays in h:mm:ss format",
            "displayFormat": "h:mm:ss",
            "executeQuery": "SELECT time_spent FROM tasks WHERE title = 'Coding'",
            "expectedDisplay": "2:30:45",
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-DURATION-FORMAT-002",
      "given": "duration field with format: 'minutes' (total minutes)",
      "when": "duration '1 hour 30 minutes' retrieved",
      "then": "application displays as '90' (total minutes)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE meetings (id SERIAL PRIMARY KEY, title VARCHAR(255), duration INTERVAL)",
            "INSERT INTO meetings (title, duration) VALUES ('Standup', INTERVAL '15 minutes'), ('Planning', INTERVAL '1 hour 30 minutes')"
          ],
          "fieldConfig": {
            "name": "duration",
            "type": "duration",
            "format": "minutes"
          }
        },
        "assertions": [
          {
            "description": "Application displays total minutes",
            "displayFormat": "minutes",
            "executeQuery": "SELECT duration FROM meetings WHERE title = 'Planning'",
            "expectedDisplay": "90",
            "expectError": "validation error"
          },
          {
            "description": "Short duration displayed correctly",
            "displayFormat": "minutes",
            "executeQuery": "SELECT duration FROM meetings WHERE title = 'Standup'",
            "expectedDisplay": "15",
            "expectError": "validation error"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-DURATION-FORMAT-003",
      "given": "duration field with invalid format value",
      "when": "field configuration validation runs",
      "then": "error lists valid options: h:mm, h:mm:ss, minutes, seconds",
      "validation": {
        "setup": {
          "fieldConfig": {
            "name": "elapsed_time",
            "type": "duration",
            "format": "INVALID-FORMAT"
          }
        },
        "assertions": [
          {
            "description": "Invalid format rejected with enum error",
            "validateConfig": true,
            "expectError": "format must be one of: h:mm, h:mm:ss, minutes, seconds"
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-DURATION-FORMAT-004",
      "given": "duration field with format: 'seconds' (total seconds)",
      "when": "duration '2 minutes 30 seconds' retrieved",
      "then": "application displays as '150' (total seconds)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE api_calls (id SERIAL PRIMARY KEY, endpoint VARCHAR(255), response_time INTERVAL)",
            "INSERT INTO api_calls (endpoint, response_time) VALUES ('/api/users', INTERVAL '2 minutes 30 seconds'), ('/api/posts', INTERVAL '45 seconds')"
          ],
          "fieldConfig": {
            "name": "response_time",
            "type": "duration",
            "format": "seconds"
          }
        },
        "assertions": [
          {
            "description": "Application displays total seconds",
            "displayFormat": "seconds",
            "executeQuery": "SELECT response_time FROM api_calls WHERE endpoint = '/api/users'",
            "expectedDisplay": "150",
            "expectError": "validation error"
          },
          {
            "description": "Sub-minute duration displayed correctly",
            "displayFormat": "seconds",
            "executeQuery": "SELECT response_time FROM api_calls WHERE endpoint = '/api/posts'",
            "expectedDisplay": "45",
            "expectError": "validation error"
          }
        ]
      }
    }
  ]
}
