{
  "$id": "geolocation-field.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Geolocation Field",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "../../../common/definitions.schema.json#/definitions/id"
    },
    "name": {
      "$ref": "../../../common/definitions.schema.json#/definitions/name"
    },
    "required": {
      "$ref": "../common/required/required.schema.json"
    },
    "type": {
      "type": "string",
      "const": "geolocation"
    }
  },
  "description": "Geographic coordinates (latitude/longitude)",
  "required": ["id", "name", "type"],
  "additionalProperties": false,
  "x-specs": [
    {
      "id": "APP-GEOLOCATION-FIELD-001",
      "given": "table configuration with geolocation field 'coordinates'",
      "when": "field migration creates POINT column",
      "then": "PostgreSQL POINT type is created for latitude/longitude storage",
      "validation": {
        "setup": {
          "executeQuery": "CREATE TABLE locations (id SERIAL PRIMARY KEY, coordinates POINT)",
          "fieldConfig": {
            "id": 1,
            "name": "coordinates",
            "type": "geolocation"
          }
        },
        "assertions": [
          {
            "description": "Column created as POINT type",
            "executeQuery": "SELECT column_name, data_type FROM information_schema.columns WHERE table_name='locations' AND column_name='coordinates'",
            "expected": {
              "column_name": "coordinates",
              "data_type": "point"
            }
          },
          {
            "description": "Point (latitude, longitude) can be inserted",
            "executeQuery": "INSERT INTO locations (coordinates) VALUES (POINT(40.7128, -74.0060)) RETURNING coordinates",
            "expected": {
              "coordinates": "(40.7128,-74.006)"
            }
          },
          {
            "description": "Point coordinates can be extracted",
            "executeQuery": "INSERT INTO locations (coordinates) VALUES (POINT(51.5074, -0.1278)) RETURNING coordinates[0] as latitude, coordinates[1] as longitude",
            "expected": {
              "latitude": 51.5074,
              "longitude": -0.1278
            }
          }
        ]
      }
    },
    {
      "id": "APP-GEOLOCATION-FIELD-002",
      "given": "table 'stores' with geolocation field for distance calculations",
      "when": "calculating distance between points",
      "then": "PostgreSQL <-> operator computes Euclidean distance",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE stores (id SERIAL PRIMARY KEY, name VARCHAR(255), location POINT)",
            "INSERT INTO stores (name, location) VALUES ('Store A', POINT(40.7128, -74.0060))",
            "INSERT INTO stores (name, location) VALUES ('Store B', POINT(40.7589, -73.9851))",
            "INSERT INTO stores (name, location) VALUES ('Store C', POINT(34.0522, -118.2437))"
          ]
        },
        "assertions": [
          {
            "description": "Calculate distance from reference point",
            "executeQuery": "SELECT name, location <-> POINT(40.7128, -74.0060) as distance FROM stores ORDER BY distance LIMIT 1",
            "expected": {
              "name": "Store A",
              "distance": 0
            }
          },
          {
            "description": "Find stores within distance threshold",
            "executeQuery": "SELECT COUNT(*) as count FROM stores WHERE location <-> POINT(40.7128, -74.0060) < 1",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Order stores by proximity to point",
            "executeQuery": "SELECT name FROM stores ORDER BY location <-> POINT(40.7128, -74.0060) LIMIT 2",
            "expected": [
              {
                "name": "Store A"
              },
              {
                "name": "Store B"
              }
            ]
          }
        ]
      }
    },
    {
      "id": "APP-GEOLOCATION-FIELD-003",
      "given": "table 'places' with geolocation field and GiST index",
      "when": "GiST index is created for spatial queries",
      "then": "PostgreSQL GiST index optimizes distance calculations",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE places (id SERIAL PRIMARY KEY, position POINT)",
            "CREATE INDEX idx_places_position ON places USING GIST(position)"
          ],
          "fieldConfig": {
            "id": 1,
            "name": "position",
            "type": "geolocation",
            "indexed": true
          }
        },
        "assertions": [
          {
            "description": "Index exists in pg_indexes",
            "executeQuery": "SELECT indexname, tablename FROM pg_indexes WHERE indexname = 'idx_places_position'",
            "expected": {
              "indexname": "idx_places_position",
              "tablename": "places"
            }
          },
          {
            "description": "Index uses GiST for spatial operations",
            "executeQuery": "SELECT indexdef FROM pg_indexes WHERE indexname = 'idx_places_position'",
            "expected": {
              "indexdef": "CREATE INDEX idx_places_position ON public.places USING gist (position)"
            }
          }
        ]
      }
    },
    {
      "id": "APP-GEOLOCATION-FIELD-004",
      "given": "table 'venues' with geolocation field for bounding box queries",
      "when": "querying points within rectangular area",
      "then": "PostgreSQL box containment operator @> filters by bounding box",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE venues (id SERIAL PRIMARY KEY, name VARCHAR(255), coords POINT)",
            "INSERT INTO venues (name, coords) VALUES ('Venue 1', POINT(40.7128, -74.0060))",
            "INSERT INTO venues (name, coords) VALUES ('Venue 2', POINT(40.7589, -73.9851))",
            "INSERT INTO venues (name, coords) VALUES ('Venue 3', POINT(34.0522, -118.2437))"
          ]
        },
        "assertions": [
          {
            "description": "Define bounding box (SW and NE corners)",
            "executeQuery": "SELECT COUNT(*) as count FROM venues WHERE box(POINT(40.0, -75.0), POINT(41.0, -73.0)) @> coords",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Find venues outside bounding box",
            "executeQuery": "SELECT name FROM venues WHERE NOT box(POINT(40.0, -75.0), POINT(41.0, -73.0)) @> coords",
            "expected": {
              "name": "Venue 3"
            }
          }
        ]
      }
    },
    {
      "id": "APP-GEOLOCATION-FIELD-005",
      "given": "table 'addresses' with geolocation field and constraints",
      "when": "required and unique constraints are applied",
      "then": "PostgreSQL enforces NOT NULL and UNIQUE on POINT column",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE addresses (id SERIAL PRIMARY KEY, location POINT UNIQUE NOT NULL)",
            "INSERT INTO addresses (location) VALUES (POINT(40.7128, -74.0060))"
          ]
        },
        "assertions": [
          {
            "description": "NOT NULL constraint enforced",
            "executeQuery": "SELECT is_nullable FROM information_schema.columns WHERE table_name='addresses' AND column_name='location'",
            "expected": {
              "is_nullable": "NO"
            }
          },
          {
            "description": "UNIQUE constraint exists",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='addresses' AND constraint_type='UNIQUE' AND constraint_name LIKE '%location%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Duplicate location rejected",
            "executeQuery": "INSERT INTO addresses (location) VALUES (POINT(40.7128, -74.0060))",
            "expectError": "duplicate key value violates unique constraint"
          }
        ]
      }
    }
  ]
}
