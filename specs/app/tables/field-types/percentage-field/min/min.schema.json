{
  "$id": "min.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Percentage Field Minimum Value",
  "description": "Minimum value allowed for this percentage field",
  "type": "number",
  "x-specs": [
    {
      "id": "APP-FIELD-PERCENTAGE-MIN-001",
      "given": "percentage field with min: 0.0 (no negative percentages)",
      "when": "field migration creates CHECK constraint",
      "then": "PostgreSQL rejects percentage values below minimum",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, title VARCHAR(255), completion DECIMAL(5,2) CHECK (completion >= 0.0))",
            "INSERT INTO tasks (title, completion) VALUES ('Task 1', 0.0), ('Task 2', 50.5), ('Task 3', 100.0)"
          ],
          "fieldConfig": {
            "name": "completion",
            "type": "percentage",
            "min": 0.0
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint exists for min value",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.check_constraints WHERE constraint_name LIKE '%completion%' AND check_clause LIKE '%>= 0.0%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Zero percentage accepted",
            "executeQuery": "SELECT completion FROM tasks WHERE completion = 0.0",
            "expected": {
              "completion": 0.0
            }
          },
          {
            "description": "Negative percentage rejected",
            "executeQuery": "INSERT INTO tasks (title, completion) VALUES ('Task 4', -5.0)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Positive percentage accepted",
            "executeQuery": "INSERT INTO tasks (title, completion) VALUES ('Task 5', 75.5) RETURNING completion",
            "expected": {
              "completion": 75.5
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-PERCENTAGE-MIN-002",
      "given": "percentage field with min: 10.0 (minimum discount)",
      "when": "INSERT with value below min",
      "then": "PostgreSQL CHECK constraint rejects value",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE promotions (id SERIAL PRIMARY KEY, name VARCHAR(255), discount_rate DECIMAL(5,2) CHECK (discount_rate >= 10.0))",
            "INSERT INTO promotions (name, discount_rate) VALUES ('Summer Sale', 15.0), ('Black Friday', 50.0)"
          ],
          "fieldConfig": {
            "name": "discount_rate",
            "type": "percentage",
            "min": 10.0
          }
        },
        "assertions": [
          {
            "description": "CHECK constraint enforces min 10.0",
            "executeQuery": "SELECT check_clause FROM information_schema.check_constraints WHERE constraint_name LIKE '%discount_rate%'",
            "expected": {
              "check_clause": "(discount_rate >= 10.0)"
            }
          },
          {
            "description": "Exact minimum (10.0) accepted",
            "executeQuery": "INSERT INTO promotions (name, discount_rate) VALUES ('Spring Sale', 10.0) RETURNING discount_rate",
            "expected": {
              "discount_rate": 10.0
            }
          },
          {
            "description": "Below minimum rejected",
            "executeQuery": "INSERT INTO promotions (name, discount_rate) VALUES ('Weak Sale', 9.99)",
            "expectError": "violates check constraint"
          },
          {
            "description": "Above minimum accepted",
            "executeQuery": "INSERT INTO promotions (name, discount_rate) VALUES ('Mega Sale', 25.0) RETURNING discount_rate",
            "expected": {
              "discount_rate": 25.0
            }
          }
        ]
      }
    },
    {
      "id": "APP-FIELD-PERCENTAGE-MIN-003",
      "given": "percentage field with no min specified",
      "when": "negative values inserted (corrections, adjustments)",
      "then": "PostgreSQL accepts all DECIMAL range values",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE financial_adjustments (id SERIAL PRIMARY KEY, adjustment_rate DECIMAL(5,2))",
            "INSERT INTO financial_adjustments (adjustment_rate) VALUES (-15.0), (0.0), (25.0)"
          ],
          "fieldConfig": {
            "name": "adjustment_rate",
            "type": "percentage"
          }
        },
        "assertions": [
          {
            "description": "No CHECK constraint for min",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.check_constraints WHERE constraint_name LIKE '%adjustment_rate%'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Negative percentages accepted (adjustments)",
            "executeQuery": "SELECT adjustment_rate FROM financial_adjustments WHERE adjustment_rate = -15.0",
            "expected": {
              "adjustment_rate": -15.0
            }
          },
          {
            "description": "Large negative adjustment accepted",
            "executeQuery": "INSERT INTO financial_adjustments (adjustment_rate) VALUES (-50.0) RETURNING adjustment_rate",
            "expected": {
              "adjustment_rate": -50.0
            }
          }
        ]
      }
    }
  ]
}
