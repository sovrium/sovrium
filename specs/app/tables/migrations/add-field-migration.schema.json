{
  "$id": "add-field-migration.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Add Field Migration",
  "description": "Schema change detection and migration triggering when fields are added to existing tables",
  "type": "object",
  "properties": {
    "previousSchema": {
      "type": "object",
      "description": "Previous table schema before field addition"
    },
    "newSchema": {
      "type": "object",
      "description": "New table schema with added field"
    },
    "migrationRequired": {
      "type": "boolean",
      "description": "Whether a migration is required for this schema change"
    }
  },
  "required": ["previousSchema", "newSchema", "migrationRequired"],
  "examples": [
    {
      "previousSchema": {
        "name": "users",
        "fields": [
          {
            "name": "id",
            "type": "integer"
          },
          {
            "name": "email",
            "type": "email"
          }
        ]
      },
      "newSchema": {
        "name": "users",
        "fields": [
          {
            "name": "id",
            "type": "integer"
          },
          {
            "name": "email",
            "type": "email"
          },
          {
            "name": "name",
            "type": "single-line-text",
            "required": true
          }
        ]
      },
      "migrationRequired": true
    }
  ],
  "x-specs": [
    {
      "id": "APP-TABLES-MIGRATION-ADD-FIELD-001",
      "given": "a table schema with existing fields",
      "when": "a new required field is added to the schema",
      "then": "the system should detect schema change and trigger ALTER TABLE migration",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255) NOT NULL)",
            "INSERT INTO users (email) VALUES ('user@example.com')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "users",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "email",
                    "type": "email"
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "users",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "name": "name",
                    "type": "single-line-text",
                    "required": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Schema change should be detected",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='users' AND column_name='name'",
            "expected": {
              "column_name": "name"
            }
          },
          {
            "description": "New field should have NOT NULL constraint",
            "executeQuery": "SELECT is_nullable FROM information_schema.columns WHERE table_name='users' AND column_name='name'",
            "expected": {
              "is_nullable": "NO"
            }
          },
          {
            "description": "Existing data should be preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM users WHERE email = 'user@example.com'",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "APP-TABLES-MIGRATION-ADD-FIELD-002",
      "given": "a table schema with existing fields",
      "when": "a new optional field is added to the schema",
      "then": "the system should trigger ALTER TABLE migration without NOT NULL constraint",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, title VARCHAR(255) NOT NULL)",
            "INSERT INTO products (title) VALUES ('Product A')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "products",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "title",
                    "type": "single-line-text",
                    "required": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "products",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "title",
                    "type": "single-line-text",
                    "required": true
                  },
                  {
                    "name": "description",
                    "type": "long-text"
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "New field should be nullable",
            "executeQuery": "SELECT is_nullable FROM information_schema.columns WHERE table_name='products' AND column_name='description'",
            "expected": {
              "is_nullable": "YES"
            }
          },
          {
            "description": "Existing records should have NULL in new field",
            "executeQuery": "SELECT description FROM products WHERE title = 'Product A'",
            "expected": {
              "description": null
            }
          }
        ]
      }
    },
    {
      "id": "APP-TABLES-MIGRATION-ADD-FIELD-003",
      "given": "a table schema with existing fields",
      "when": "a new field with default value is added",
      "then": "the system should apply default value to existing records",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, amount DECIMAL(10,2) NOT NULL)",
            "INSERT INTO orders (amount) VALUES (100.00)"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "orders",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "amount",
                    "type": "decimal",
                    "required": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "orders",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "amount",
                    "type": "decimal",
                    "required": true
                  },
                  {
                    "name": "status",
                    "type": "single-line-text",
                    "default": "pending"
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Existing records should have default value",
            "executeQuery": "SELECT status FROM orders WHERE amount = 100.00",
            "expected": {
              "status": "pending"
            }
          },
          {
            "description": "Column should have DEFAULT constraint",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='orders' AND column_name='status'",
            "expected": {
              "column_default": "'pending'::character varying"
            }
          }
        ]
      }
    }
  ]
}
