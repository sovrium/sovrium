{
  "$id": "rename-field-migration.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Rename Field Migration",
  "description": "Schema change detection and migration triggering when fields are renamed in existing tables",
  "type": "object",
  "properties": {
    "previousSchema": {
      "type": "object",
      "description": "Previous table schema before field rename"
    },
    "newSchema": {
      "type": "object",
      "description": "New table schema with renamed field"
    },
    "migrationRequired": {
      "type": "boolean",
      "description": "Whether a migration is required for this schema change"
    }
  },
  "required": ["previousSchema", "newSchema", "migrationRequired"],
  "examples": [
    {
      "previousSchema": {
        "name": "users",
        "fields": [
          {
            "name": "id",
            "type": "integer"
          },
          {
            "name": "user_email",
            "type": "email"
          }
        ]
      },
      "newSchema": {
        "name": "users",
        "fields": [
          {
            "name": "id",
            "type": "integer"
          },
          {
            "name": "email",
            "type": "email"
          }
        ]
      },
      "migrationRequired": true
    }
  ],
  "x-specs": [
    {
      "id": "APP-TABLES-MIGRATION-RENAME-FIELD-001",
      "given": "a table schema with existing field",
      "when": "a field is renamed in the schema",
      "then": "the system should trigger ALTER TABLE RENAME COLUMN migration",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, user_email VARCHAR(255) NOT NULL)",
            "INSERT INTO users (user_email) VALUES ('user@example.com')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "users",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "user_email",
                    "type": "email"
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "users",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "email",
                    "type": "email"
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Old column name should no longer exist",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='users' AND column_name='user_email'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "New column name should exist",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='users' AND column_name='email'",
            "expected": {
              "column_name": "email"
            }
          },
          {
            "description": "Existing data should be preserved in renamed column",
            "executeQuery": "SELECT email FROM users WHERE id = 1",
            "expected": {
              "email": "user@example.com"
            }
          }
        ]
      }
    },
    {
      "id": "APP-TABLES-MIGRATION-RENAME-FIELD-002",
      "given": "a table with constrained field",
      "when": "the constrained field is renamed",
      "then": "the system should preserve constraints on renamed column",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, product_sku VARCHAR(50) UNIQUE NOT NULL)",
            "INSERT INTO products (product_sku) VALUES ('SKU-001')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "products",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "product_sku",
                    "type": "single-line-text",
                    "required": true,
                    "unique": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "products",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "sku",
                    "type": "single-line-text",
                    "required": true,
                    "unique": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Renamed column should preserve NOT NULL constraint",
            "executeQuery": "SELECT is_nullable FROM information_schema.columns WHERE table_name='products' AND column_name='sku'",
            "expected": {
              "is_nullable": "NO"
            }
          },
          {
            "description": "Renamed column should preserve UNIQUE constraint",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='products' AND constraint_type='UNIQUE'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Data should be preserved after rename",
            "executeQuery": "SELECT sku FROM products WHERE id = 1",
            "expected": {
              "sku": "SKU-001"
            }
          }
        ]
      }
    },
    {
      "id": "APP-TABLES-MIGRATION-RENAME-FIELD-003",
      "given": "a table with indexed field",
      "when": "the indexed field is renamed",
      "then": "the system should preserve index on renamed column",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, old_order_number VARCHAR(50))",
            "CREATE INDEX idx_old_order_number ON orders(old_order_number)",
            "INSERT INTO orders (old_order_number) VALUES ('ORD-001')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "orders",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "old_order_number",
                    "type": "single-line-text",
                    "indexed": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "orders",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "order_number",
                    "type": "single-line-text",
                    "indexed": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Column should be renamed",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='orders' AND column_name='order_number'",
            "expected": {
              "column_name": "order_number"
            }
          },
          {
            "description": "Index should still exist (possibly renamed)",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_indexes WHERE tablename='orders' AND indexdef LIKE '%order_number%'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Data should be accessible with new column name",
            "executeQuery": "SELECT order_number FROM orders WHERE id = 1",
            "expected": {
              "order_number": "ORD-001"
            }
          }
        ]
      }
    }
  ]
}
