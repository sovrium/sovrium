{
  "$id": "remove-field-migration.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Remove Field Migration",
  "description": "Schema change detection and migration triggering when fields are removed from existing tables",
  "type": "object",
  "properties": {
    "previousSchema": {
      "type": "object",
      "description": "Previous table schema before field removal"
    },
    "newSchema": {
      "type": "object",
      "description": "New table schema with field removed"
    },
    "migrationRequired": {
      "type": "boolean",
      "description": "Whether a migration is required for this schema change"
    }
  },
  "required": ["previousSchema", "newSchema", "migrationRequired"],
  "examples": [
    {
      "previousSchema": {
        "name": "users",
        "fields": [
          {
            "name": "id",
            "type": "integer"
          },
          {
            "name": "email",
            "type": "email"
          },
          {
            "name": "legacy_field",
            "type": "single-line-text"
          }
        ]
      },
      "newSchema": {
        "name": "users",
        "fields": [
          {
            "name": "id",
            "type": "integer"
          },
          {
            "name": "email",
            "type": "email"
          }
        ]
      },
      "migrationRequired": true
    }
  ],
  "x-specs": [
    {
      "id": "APP-TABLES-MIGRATION-REMOVE-FIELD-001",
      "given": "a table schema with multiple fields",
      "when": "a field is removed from the schema",
      "then": "the system should trigger ALTER TABLE DROP COLUMN migration",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255) NOT NULL, legacy_field VARCHAR(255))",
            "INSERT INTO users (email, legacy_field) VALUES ('user@example.com', 'legacy_data')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "users",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "name": "legacy_field",
                    "type": "single-line-text"
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "users",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "email",
                    "type": "email"
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Column should be removed from table",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='users' AND column_name='legacy_field'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Remaining columns should still exist",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='users' AND column_name IN ('id', 'email')",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Existing data in other columns should be preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM users WHERE email = 'user@example.com'",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "APP-TABLES-MIGRATION-REMOVE-FIELD-002",
      "given": "a table with a field that has constraints",
      "when": "the constrained field is removed",
      "then": "the system should remove column and associated constraints",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, title VARCHAR(255) NOT NULL, sku VARCHAR(50) UNIQUE NOT NULL)",
            "INSERT INTO products (title, sku) VALUES ('Product A', 'SKU-001')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "products",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "title",
                    "type": "single-line-text",
                    "required": true
                  },
                  {
                    "name": "sku",
                    "type": "single-line-text",
                    "required": true,
                    "unique": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "products",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "title",
                    "type": "single-line-text",
                    "required": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Column should be removed",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='products' AND column_name='sku'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "UNIQUE constraint should be removed",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='products' AND constraint_type='UNIQUE' AND constraint_name LIKE '%sku%'",
            "expected": {
              "count": 0
            }
          }
        ]
      }
    },
    {
      "id": "APP-TABLES-MIGRATION-REMOVE-FIELD-003",
      "given": "a table with indexed field",
      "when": "the indexed field is removed",
      "then": "the system should remove column and associated index",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, customer_email VARCHAR(255), order_number VARCHAR(50))",
            "CREATE INDEX idx_order_number ON orders(order_number)",
            "INSERT INTO orders (customer_email, order_number) VALUES ('customer@example.com', 'ORD-001')"
          ],
          "previousSchema": {
            "tables": [
              {
                "name": "orders",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "customer_email",
                    "type": "email"
                  },
                  {
                    "name": "order_number",
                    "type": "single-line-text",
                    "indexed": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "name": "orders",
                "fields": [
                  {
                    "name": "id",
                    "type": "integer"
                  },
                  {
                    "name": "customer_email",
                    "type": "email"
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Column should be removed",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='orders' AND column_name='order_number'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Index should be removed",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_indexes WHERE tablename='orders' AND indexname='idx_order_number'",
            "expected": {
              "count": 0
            }
          }
        ]
      }
    }
  ]
}
