{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "modify-field-type.schema.json",
  "title": "Modify Field Type Migration",
  "description": "Runtime SQL migration scenarios for changing column data types via ALTER TABLE ALTER COLUMN TYPE",
  "type": "object",
  "properties": {
    "previousSchema": {
      "type": "object",
      "description": "Table schema before type modification"
    },
    "newSchema": {
      "type": "object",
      "description": "Table schema after type modification"
    },
    "typeChange": {
      "type": "object",
      "properties": {
        "fieldName": {
          "type": "string"
        },
        "fromType": {
          "type": "string"
        },
        "toType": {
          "type": "string"
        }
      }
    }
  },
  "required": ["previousSchema", "newSchema"],
  "x-specs": [
    {
      "id": "MIG-MODIFY-TYPE-001",
      "given": "table 'users' with field 'bio' (VARCHAR(255))",
      "when": "field type changed to long-text (TEXT)",
      "then": "ALTER TABLE ALTER COLUMN TYPE TEXT",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              { "id": 1, "name": "email", "type": "email", "required": true },
              { "id": 2, "name": "bio", "type": "single-line-text", "required": false }
            ]
          },
          "newSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              { "id": 1, "name": "email", "type": "email", "required": true },
              { "id": 2, "name": "bio", "type": "long-text", "required": false }
            ]
          },
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255) NOT NULL, bio VARCHAR(255))",
            "INSERT INTO users (email, bio) VALUES ('alice@example.com', 'Short bio'), ('bob@example.com', 'Another short bio')"
          ]
        },
        "assertions": [
          {
            "description": "SQL migration contains ALTER COLUMN TYPE TEXT",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"users\" ALTER COLUMN \"bio\" TYPE TEXT"]
            }
          },
          {
            "description": "Column type is now TEXT",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='users' AND column_name='bio'",
            "expected": {
              "data_type": "text"
            }
          },
          {
            "description": "Existing data preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM users WHERE bio IS NOT NULL",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Long text now accepted",
            "executeQuery": "INSERT INTO users (email, bio) VALUES ('charlie@example.com', REPEAT('x', 300)) RETURNING LENGTH(bio) as length",
            "expected": {
              "length": 300
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-TYPE-002",
      "given": "table 'products' with field 'sku' (TEXT)",
      "when": "field type changed to single-line-text with maxLength=50",
      "then": "ALTER TABLE ALTER COLUMN TYPE VARCHAR(50) USING LEFT(sku, 50)",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              { "id": 2, "name": "sku", "type": "long-text", "required": true }
            ]
          },
          "newSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "sku",
                "type": "single-line-text",
                "maxLength": 50,
                "required": true
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, sku TEXT NOT NULL)",
            "INSERT INTO products (name, sku) VALUES ('Product 1', 'SKU-001'), ('Product 2', REPEAT('x', 100))"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains ALTER COLUMN TYPE VARCHAR(50) with USING",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"products\" ALTER COLUMN \"sku\" TYPE VARCHAR(50) USING LEFT(sku, 50)"
              ]
            }
          },
          {
            "description": "Column type is VARCHAR with length limit",
            "executeQuery": "SELECT character_maximum_length FROM information_schema.columns WHERE table_name='products' AND column_name='sku'",
            "expected": {
              "character_maximum_length": 50
            }
          },
          {
            "description": "Long values truncated to 50 chars",
            "executeQuery": "SELECT LENGTH(sku) as length FROM products WHERE name = 'Product 2'",
            "expected": {
              "length": 50
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-TYPE-003",
      "given": "table 'orders' with field 'total' (INTEGER)",
      "when": "field type changed to decimal",
      "then": "ALTER TABLE ALTER COLUMN TYPE NUMERIC(10,2)",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              { "id": 1, "name": "order_number", "type": "single-line-text", "required": true },
              { "id": 2, "name": "total", "type": "integer", "required": true }
            ]
          },
          "newSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              { "id": 1, "name": "order_number", "type": "single-line-text", "required": true },
              { "id": 2, "name": "total", "type": "decimal", "required": true }
            ]
          },
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_number VARCHAR(50) NOT NULL, total INTEGER NOT NULL)",
            "INSERT INTO orders (order_number, total) VALUES ('ORD-001', 100), ('ORD-002', 250)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains ALTER COLUMN TYPE NUMERIC",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"orders\" ALTER COLUMN \"total\" TYPE NUMERIC(10,2)"]
            }
          },
          {
            "description": "Column type is now numeric",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='orders' AND column_name='total'",
            "expected": {
              "data_type": "numeric"
            }
          },
          {
            "description": "Decimal values now accepted",
            "executeQuery": "INSERT INTO orders (order_number, total) VALUES ('ORD-003', 99.99) RETURNING total",
            "expected": {
              "total": 99.99
            }
          },
          {
            "description": "Existing integer values preserved as decimal",
            "executeQuery": "SELECT total FROM orders WHERE order_number = 'ORD-001'",
            "expected": {
              "total": 100.0
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-TYPE-004",
      "given": "table 'metrics' with field 'count' stored as TEXT",
      "when": "field type changed to integer",
      "then": "ALTER TABLE ALTER COLUMN TYPE INTEGER USING count::INTEGER",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_metrics",
            "name": "metrics",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              { "id": 2, "name": "count", "type": "single-line-text", "required": true }
            ]
          },
          "newSchema": {
            "id": "tbl_metrics",
            "name": "metrics",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              { "id": 2, "name": "count", "type": "integer", "required": true }
            ]
          },
          "executeQuery": [
            "CREATE TABLE metrics (id SERIAL PRIMARY KEY, name VARCHAR(100) NOT NULL, count TEXT NOT NULL)",
            "INSERT INTO metrics (name, count) VALUES ('metric1', '42'), ('metric2', '100'), ('metric3', '999')"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains USING clause for casting",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"metrics\" ALTER COLUMN \"count\" TYPE INTEGER USING count::INTEGER"
              ]
            }
          },
          {
            "description": "Column type is integer",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='metrics' AND column_name='count'",
            "expected": {
              "data_type": "integer"
            }
          },
          {
            "description": "String values converted to integers",
            "executeQuery": "SELECT count FROM metrics WHERE name = 'metric1'",
            "expected": {
              "count": 42
            }
          },
          {
            "description": "Arithmetic operations now work",
            "executeQuery": "SELECT SUM(count) as total FROM metrics",
            "expected": {
              "total": 1141
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-TYPE-005",
      "given": "table 'events' with field 'occurred_at' (TEXT) containing ISO-8601 strings",
      "when": "field type changed to timestamp",
      "then": "ALTER TABLE ALTER COLUMN TYPE TIMESTAMPTZ USING occurred_at::TIMESTAMPTZ",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_events",
            "name": "events",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              { "id": 2, "name": "occurred_at", "type": "single-line-text", "required": true }
            ]
          },
          "newSchema": {
            "id": "tbl_events",
            "name": "events",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              { "id": 2, "name": "occurred_at", "type": "datetime", "required": true }
            ]
          },
          "executeQuery": [
            "CREATE TABLE events (id SERIAL PRIMARY KEY, name VARCHAR(100) NOT NULL, occurred_at TEXT NOT NULL)",
            "INSERT INTO events (name, occurred_at) VALUES ('event1', '2025-01-01T10:00:00Z'), ('event2', '2025-01-15T15:30:00Z')"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains timestamp casting",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"events\" ALTER COLUMN \"occurred_at\" TYPE TIMESTAMPTZ USING occurred_at::TIMESTAMPTZ"
              ]
            }
          },
          {
            "description": "Column type is timestamp with time zone",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='events' AND column_name='occurred_at'",
            "expected": {
              "data_type": "timestamp with time zone"
            }
          },
          {
            "description": "Date comparisons now work",
            "executeQuery": "SELECT COUNT(*) as count FROM events WHERE occurred_at > '2025-01-10'::TIMESTAMPTZ",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-TYPE-006",
      "given": "table 'data' with field 'value' (TEXT) containing non-numeric values",
      "when": "field type changed to INTEGER",
      "then": "Migration fails with data conversion error, transaction rolled back",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_data",
            "name": "data",
            "fields": [
              { "id": 1, "name": "label", "type": "single-line-text", "required": true },
              { "id": 2, "name": "value", "type": "single-line-text", "required": true }
            ]
          },
          "newSchema": {
            "id": "tbl_data",
            "name": "data",
            "fields": [
              { "id": 1, "name": "label", "type": "single-line-text", "required": true },
              { "id": 2, "name": "value", "type": "integer", "required": true }
            ]
          },
          "executeQuery": [
            "CREATE TABLE data (id SERIAL PRIMARY KEY, label VARCHAR(100) NOT NULL, value TEXT NOT NULL)",
            "INSERT INTO data (label, value) VALUES ('item1', '123'), ('item2', 'not-a-number'), ('item3', '456')"
          ]
        },
        "assertions": [
          {
            "description": "Migration fails on invalid data",
            "migrationStatus": "failed",
            "errorPattern": "invalid input syntax for type integer|cannot cast"
          },
          {
            "description": "Column type remains TEXT",
            "executeQuery": "SELECT data_type FROM information_schema.columns WHERE table_name='data' AND column_name='value'",
            "expected": {
              "data_type": "text"
            }
          },
          {
            "description": "Invalid data still exists",
            "executeQuery": "SELECT value FROM data WHERE label = 'item2'",
            "expected": {
              "value": "not-a-number"
            }
          },
          {
            "description": "All rows preserved after failed migration",
            "executeQuery": "SELECT COUNT(*) as count FROM data",
            "expected": {
              "count": 3
            }
          }
        ]
      }
    }
  ]
}
