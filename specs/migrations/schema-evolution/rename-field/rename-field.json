{
  "title": "Rename Field Migration",
  "description": "Runtime SQL migration scenario for renaming fields in existing tables via ALTER TABLE RENAME COLUMN",
  "x-specs": [
    {
      "id": "MIG-ALTER-RENAME-001",
      "given": "table 'users' with field id=1 name='email', field name changed to 'email_address' (same id)",
      "when": "runtime migration detects rename via field ID",
      "then": "PostgreSQL generates RENAME COLUMN instead of DROP+ADD",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255) NOT NULL UNIQUE)",
            "INSERT INTO users (email) VALUES ('user@example.com')"
          ],
          "previousSchema": {
            "tables": [
              {
                "id": 1,
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email",
                    "required": true,
                    "unique": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": 1,
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email_address",
                    "type": "email",
                    "required": true,
                    "unique": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Generate RENAME COLUMN SQL",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"users\" RENAME COLUMN \"email\" TO \"email_address\""],
              "notContains": ["DROP COLUMN \"email\"", "ADD COLUMN \"email_address\""]
            }
          },
          {
            "description": "Column renamed successfully",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='users' AND column_name='email_address'",
            "expected": {
              "column_name": "email_address"
            }
          },
          {
            "description": "Old column name no longer exists",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name='users' AND column_name='email'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Data preserved after rename",
            "executeQuery": "SELECT email_address FROM users WHERE id = 1",
            "expected": {
              "email_address": "user@example.com"
            }
          },
          {
            "description": "Constraints preserved (UNIQUE still enforced)",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='users' AND constraint_type='UNIQUE'",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "MIG-ALTER-RENAME-002",
      "given": "table 'products' with indexed field 'sku' renamed to 'product_code'",
      "when": "RENAME COLUMN is executed on indexed field",
      "then": "PostgreSQL renames column and automatically updates index reference",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, sku VARCHAR(100) NOT NULL UNIQUE)",
            "CREATE INDEX idx_products_sku ON products(sku)",
            "INSERT INTO products (sku) VALUES ('PROD-001')"
          ],
          "previousSchema": {
            "tables": [
              {
                "id": 1,
                "name": "products",
                "fields": [
                  {
                    "id": 1,
                    "name": "sku",
                    "type": "single-line-text",
                    "required": true,
                    "unique": true,
                    "indexed": true
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": 1,
                "name": "products",
                "fields": [
                  {
                    "id": 1,
                    "name": "product_code",
                    "type": "single-line-text",
                    "required": true,
                    "unique": true,
                    "indexed": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "RENAME COLUMN preserves index",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"products\" RENAME COLUMN \"sku\" TO \"product_code\""]
            }
          },
          {
            "description": "Column renamed",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='products' AND column_name='product_code'",
            "expected": {
              "column_name": "product_code"
            }
          },
          {
            "description": "Index still exists and references renamed column",
            "executeQuery": "SELECT indexdef FROM pg_indexes WHERE tablename='products' AND indexname='idx_products_sku'",
            "expected": {
              "indexdef": "CREATE INDEX idx_products_sku ON public.products USING btree (product_code)"
            }
          },
          {
            "description": "Data preserved",
            "executeQuery": "SELECT product_code FROM products WHERE id = 1",
            "expected": {
              "product_code": "PROD-001"
            }
          }
        ]
      }
    },
    {
      "id": "MIG-ALTER-RENAME-003",
      "given": "table 'orders' with foreign key field 'customer_id' renamed to 'client_id'",
      "when": "RENAME COLUMN on foreign key field",
      "then": "PostgreSQL renames column and preserves foreign key constraint",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE customers (id SERIAL PRIMARY KEY, name VARCHAR(255))",
            "INSERT INTO customers (name) VALUES ('Customer A')",
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, customer_id INTEGER REFERENCES customers(id))",
            "INSERT INTO orders (customer_id) VALUES (1)"
          ],
          "previousSchema": {
            "tables": [
              {
                "id": 2,
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "customer_id",
                    "type": "relationship",
                    "relatedTable": "customers"
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": 2,
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "client_id",
                    "type": "relationship",
                    "relatedTable": "customers"
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "RENAME COLUMN on foreign key",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"orders\" RENAME COLUMN \"customer_id\" TO \"client_id\""]
            }
          },
          {
            "description": "Column renamed",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='orders' AND column_name='client_id'",
            "expected": {
              "column_name": "client_id"
            }
          },
          {
            "description": "Foreign key constraint preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='orders' AND constraint_type='FOREIGN KEY'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "Foreign key still enforced after rename",
            "executeQuery": "INSERT INTO orders (client_id) VALUES (999)",
            "expectError": "violates foreign key constraint"
          },
          {
            "description": "Data preserved",
            "executeQuery": "SELECT client_id FROM orders WHERE id = 1",
            "expected": {
              "client_id": 1
            }
          }
        ]
      }
    },
    {
      "id": "MIG-ALTER-RENAME-004",
      "given": "table 'tasks' with field 'status' (CHECK constraint) renamed to 'state'",
      "when": "RENAME COLUMN on field with CHECK constraint",
      "then": "PostgreSQL renames column but CHECK constraint references old name (constraint needs update)",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, status VARCHAR(50) CHECK (status IN ('open', 'in_progress', 'done')))",
            "INSERT INTO tasks (status) VALUES ('open')"
          ],
          "previousSchema": {
            "tables": [
              {
                "id": 1,
                "name": "tasks",
                "fields": [
                  {
                    "id": 1,
                    "name": "status",
                    "type": "single-select",
                    "options": ["open", "in_progress", "done"]
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": 1,
                "name": "tasks",
                "fields": [
                  {
                    "id": 1,
                    "name": "state",
                    "type": "single-select",
                    "options": ["open", "in_progress", "done"]
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "RENAME COLUMN and recreate CHECK constraint",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"tasks\" RENAME COLUMN \"status\" TO \"state\"",
                "ALTER TABLE \"tasks\" DROP CONSTRAINT",
                "ALTER TABLE \"tasks\" ADD CONSTRAINT"
              ]
            }
          },
          {
            "description": "Column renamed",
            "executeQuery": "SELECT column_name FROM information_schema.columns WHERE table_name='tasks' AND column_name='state'",
            "expected": {
              "column_name": "state"
            }
          },
          {
            "description": "CHECK constraint still enforced with new column name",
            "executeQuery": "INSERT INTO tasks (state) VALUES ('done') RETURNING state",
            "expected": {
              "state": "done"
            }
          },
          {
            "description": "Invalid value still rejected",
            "executeQuery": "INSERT INTO tasks (state) VALUES ('invalid')",
            "expectError": "violates check constraint"
          }
        ]
      }
    }
  ]
}
