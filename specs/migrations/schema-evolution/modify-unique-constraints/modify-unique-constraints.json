{
  "title": "Modify Unique Constraints Migration",
  "description": "Runtime SQL migration scenarios for adding and removing unique constraints via ALTER TABLE ADD/DROP CONSTRAINT",
  "x-specs": [
    {
      "id": "MIG-MODIFY-UNIQUE-001",
      "given": "table 'users' with email field (not unique)",
      "when": "unique constraint added to 'uniqueConstraints' property",
      "then": "ALTER TABLE ADD CONSTRAINT UNIQUE creates constraint",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              {
                "id": 1,
                "name": "email",
                "type": "email",
                "required": true
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text",
                "required": true
              }
            ],
            "uniqueConstraints": []
          },
          "newSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              {
                "id": 1,
                "name": "email",
                "type": "email",
                "required": true
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text",
                "required": true
              }
            ],
            "uniqueConstraints": [
              {
                "name": "uq_users_email",
                "fields": ["email"]
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255) NOT NULL, name VARCHAR(255) NOT NULL)",
            "INSERT INTO users (email, name) VALUES ('alice@example.com', 'Alice'), ('bob@example.com', 'Bob')"
          ]
        },
        "assertions": [
          {
            "description": "SQL migration contains ADD CONSTRAINT UNIQUE",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"users\" ADD CONSTRAINT uq_users_email UNIQUE (email)"]
            }
          },
          {
            "description": "Constraint exists in pg_constraint",
            "executeQuery": "SELECT conname, contype FROM pg_constraint WHERE conrelid = 'users'::regclass AND conname = 'uq_users_email'",
            "expected": {
              "conname": "uq_users_email",
              "contype": "u"
            }
          },
          {
            "description": "Duplicate email now rejected",
            "executeQuery": "INSERT INTO users (email, name) VALUES ('alice@example.com', 'Duplicate')",
            "expectError": "duplicate key value violates unique constraint \"uq_users_email\""
          },
          {
            "description": "Unique email succeeds",
            "executeQuery": "INSERT INTO users (email, name) VALUES ('charlie@example.com', 'Charlie') RETURNING email",
            "expected": {
              "email": "charlie@example.com"
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-UNIQUE-002",
      "given": "table 'accounts' with existing unique constraint on username",
      "when": "unique constraint removed from 'uniqueConstraints' property",
      "then": "ALTER TABLE DROP CONSTRAINT removes constraint",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_accounts",
            "name": "accounts",
            "fields": [
              {
                "id": 1,
                "name": "username",
                "type": "single-line-text"
              },
              {
                "id": 2,
                "name": "email",
                "type": "email"
              }
            ],
            "uniqueConstraints": [
              {
                "name": "uq_accounts_username",
                "fields": ["username"]
              }
            ]
          },
          "newSchema": {
            "id": "tbl_accounts",
            "name": "accounts",
            "fields": [
              {
                "id": 1,
                "name": "username",
                "type": "single-line-text"
              },
              {
                "id": 2,
                "name": "email",
                "type": "email"
              }
            ],
            "uniqueConstraints": []
          },
          "executeQuery": [
            "CREATE TABLE accounts (id SERIAL PRIMARY KEY, username VARCHAR(255), email VARCHAR(255))",
            "ALTER TABLE accounts ADD CONSTRAINT uq_accounts_username UNIQUE (username)",
            "INSERT INTO accounts (username, email) VALUES ('alice', 'alice@example.com')"
          ]
        },
        "assertions": [
          {
            "description": "SQL migration contains DROP CONSTRAINT",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"accounts\" DROP CONSTRAINT uq_accounts_username"]
            }
          },
          {
            "description": "Constraint no longer exists",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_constraint WHERE conrelid = 'accounts'::regclass AND conname = 'uq_accounts_username'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Duplicate username now allowed",
            "executeQuery": "INSERT INTO accounts (username, email) VALUES ('alice', 'alice2@example.com') RETURNING username",
            "expected": {
              "username": "alice"
            }
          },
          {
            "description": "Multiple duplicates allowed",
            "executeQuery": "SELECT COUNT(*) as count FROM accounts WHERE username = 'alice'",
            "expected": {
              "count": 2
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-UNIQUE-003",
      "given": "table 'tenant_users' with no unique constraints",
      "when": "composite unique constraint on (tenant_id, email) added",
      "then": "ALTER TABLE ADD CONSTRAINT UNIQUE (col1, col2) enforces multi-column uniqueness",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_tenant_users",
            "name": "tenant_users",
            "fields": [
              {
                "id": 1,
                "name": "tenant_id",
                "type": "integer",
                "required": true
              },
              {
                "id": 2,
                "name": "email",
                "type": "email",
                "required": true
              },
              {
                "id": 3,
                "name": "name",
                "type": "single-line-text",
                "required": true
              }
            ],
            "uniqueConstraints": []
          },
          "newSchema": {
            "id": "tbl_tenant_users",
            "name": "tenant_users",
            "fields": [
              {
                "id": 1,
                "name": "tenant_id",
                "type": "integer",
                "required": true
              },
              {
                "id": 2,
                "name": "email",
                "type": "email",
                "required": true
              },
              {
                "id": 3,
                "name": "name",
                "type": "single-line-text",
                "required": true
              }
            ],
            "uniqueConstraints": [
              {
                "name": "uq_tenant_users_email",
                "fields": ["tenant_id", "email"]
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE tenant_users (id SERIAL PRIMARY KEY, tenant_id INTEGER NOT NULL, email VARCHAR(255) NOT NULL, name VARCHAR(255) NOT NULL)",
            "INSERT INTO tenant_users (tenant_id, email, name) VALUES (1, 'alice@example.com', 'Alice T1'), (2, 'alice@example.com', 'Alice T2')"
          ]
        },
        "assertions": [
          {
            "description": "ADD composite UNIQUE constraint",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"tenant_users\" ADD CONSTRAINT uq_tenant_users_email UNIQUE (tenant_id, email)"
              ]
            }
          },
          {
            "description": "Composite constraint exists",
            "executeQuery": "SELECT conname FROM pg_constraint WHERE conrelid = 'tenant_users'::regclass AND conname = 'uq_tenant_users_email'",
            "expected": {
              "conname": "uq_tenant_users_email"
            }
          },
          {
            "description": "Same email allowed in different tenants",
            "executeQuery": "SELECT COUNT(*) as count FROM tenant_users WHERE email = 'alice@example.com'",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Duplicate (tenant_id, email) rejected",
            "executeQuery": "INSERT INTO tenant_users (tenant_id, email, name) VALUES (1, 'alice@example.com', 'Duplicate')",
            "expectError": "duplicate key value violates unique constraint"
          },
          {
            "description": "Same email in different tenant succeeds",
            "executeQuery": "INSERT INTO tenant_users (tenant_id, email, name) VALUES (3, 'alice@example.com', 'Alice T3') RETURNING email",
            "expected": {
              "email": "alice@example.com"
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-UNIQUE-004",
      "given": "table 'products' with duplicate data in 'sku' field",
      "when": "attempting to add unique constraint on field with duplicates",
      "then": "Migration fails with data validation error and rolls back",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              {
                "id": 1,
                "name": "sku",
                "type": "single-line-text"
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text"
              }
            ],
            "uniqueConstraints": []
          },
          "newSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              {
                "id": 1,
                "name": "sku",
                "type": "single-line-text"
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text"
              }
            ],
            "uniqueConstraints": [
              {
                "name": "uq_products_sku",
                "fields": ["sku"]
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, sku VARCHAR(100), name VARCHAR(255))",
            "INSERT INTO products (sku, name) VALUES ('SKU-001', 'Product 1'), ('SKU-001', 'Product 2'), ('SKU-002', 'Product 3')"
          ]
        },
        "assertions": [
          {
            "description": "Migration fails due to duplicate data",
            "migrationStatus": "failed",
            "errorPattern": "could not create unique index|duplicate key value"
          },
          {
            "description": "Constraint NOT created",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_constraint WHERE conrelid = 'products'::regclass AND conname = 'uq_products_sku'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Duplicate data still exists (no cleanup)",
            "executeQuery": "SELECT COUNT(*) as count FROM products WHERE sku = 'SKU-001'",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "All data preserved after failed migration",
            "executeQuery": "SELECT COUNT(*) as total FROM products",
            "expected": {
              "total": 3
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-UNIQUE-005",
      "given": "table 'orders' with existing unique constraint uq_orders_number",
      "when": "constraint fields modified from (order_number) to (order_number, tenant_id)",
      "then": "DROP old constraint and ADD new composite constraint",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              {
                "id": 1,
                "name": "tenant_id",
                "type": "integer"
              },
              {
                "id": 2,
                "name": "order_number",
                "type": "single-line-text"
              },
              {
                "id": 3,
                "name": "total",
                "type": "decimal"
              }
            ],
            "uniqueConstraints": [
              {
                "name": "uq_orders_number",
                "fields": ["order_number"]
              }
            ]
          },
          "newSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              {
                "id": 1,
                "name": "tenant_id",
                "type": "integer"
              },
              {
                "id": 2,
                "name": "order_number",
                "type": "single-line-text"
              },
              {
                "id": 3,
                "name": "total",
                "type": "decimal"
              }
            ],
            "uniqueConstraints": [
              {
                "name": "uq_orders_number",
                "fields": ["order_number", "tenant_id"]
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, tenant_id INTEGER, order_number VARCHAR(50), total NUMERIC(10,2))",
            "ALTER TABLE orders ADD CONSTRAINT uq_orders_number UNIQUE (order_number)",
            "INSERT INTO orders (tenant_id, order_number, total) VALUES (1, 'ORD-001', 99.99)"
          ]
        },
        "assertions": [
          {
            "description": "DROP old constraint and ADD new composite",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"orders\" DROP CONSTRAINT uq_orders_number",
                "ALTER TABLE \"orders\" ADD CONSTRAINT uq_orders_number UNIQUE (order_number, tenant_id)"
              ]
            }
          },
          {
            "description": "Old single-column constraint removed",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_constraint WHERE conrelid = 'orders'::regclass AND conname = 'uq_orders_number' AND array_length(conkey, 1) = 1",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "New composite constraint exists",
            "executeQuery": "SELECT conname FROM pg_constraint WHERE conrelid = 'orders'::regclass AND conname = 'uq_orders_number'",
            "expected": {
              "conname": "uq_orders_number"
            }
          },
          {
            "description": "Same order_number allowed in different tenants",
            "executeQuery": "INSERT INTO orders (tenant_id, order_number, total) VALUES (2, 'ORD-001', 150.00) RETURNING order_number",
            "expected": {
              "order_number": "ORD-001"
            }
          },
          {
            "description": "Duplicate (order_number, tenant_id) rejected",
            "executeQuery": "INSERT INTO orders (tenant_id, order_number, total) VALUES (1, 'ORD-001', 200.00)",
            "expectError": "duplicate key value violates unique constraint"
          }
        ]
      }
    }
  ]
}
