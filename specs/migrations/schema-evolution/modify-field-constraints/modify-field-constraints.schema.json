{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "modify-field-constraints.schema.json",
  "title": "Modify Field Constraints Migration",
  "description": "Runtime SQL migration scenarios for managing CHECK constraints (min/max, pattern, custom rules)",
  "type": "object",
  "properties": {
    "previousSchema": {
      "type": "object",
      "description": "Table schema before constraint modification"
    },
    "newSchema": {
      "type": "object",
      "description": "Table schema after constraint modification"
    },
    "constraintChange": {
      "type": "object",
      "properties": {
        "operation": {
          "enum": ["add", "modify", "remove"],
          "description": "Type of constraint operation"
        },
        "constraintType": {
          "enum": ["min-max", "pattern", "custom"],
          "description": "Type of CHECK constraint"
        }
      }
    }
  },
  "required": ["previousSchema", "newSchema"],
  "x-specs": [
    {
      "id": "MIG-MODIFY-CONSTRAINTS-001",
      "given": "table 'products' with price field (NUMERIC), no constraints",
      "when": "min/max constraint added (price >= 0 AND price <= 10000)",
      "then": "ALTER TABLE ADD CONSTRAINT CHECK with range validation",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              { "id": 2, "name": "price", "type": "decimal", "required": true }
            ]
          },
          "newSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "price",
                "type": "decimal",
                "required": true,
                "validation": { "min": 0, "max": 10000 }
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, price NUMERIC(10,2) NOT NULL)",
            "INSERT INTO products (name, price) VALUES ('Product 1', 99.99), ('Product 2', 500.00)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains ADD CHECK with min/max range",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"products\" ADD CONSTRAINT chk_products_price CHECK (price >= 0 AND price <= 10000)"
              ]
            }
          },
          {
            "description": "CHECK constraint exists",
            "executeQuery": "SELECT conname FROM pg_constraint WHERE conrelid = 'products'::regclass AND conname = 'chk_products_price'",
            "expected": {
              "conname": "chk_products_price"
            }
          },
          {
            "description": "Value within range accepted",
            "executeQuery": "INSERT INTO products (name, price) VALUES ('Product 3', 5000.00) RETURNING price",
            "expected": {
              "price": 5000.0
            }
          },
          {
            "description": "Negative value rejected",
            "executeQuery": "INSERT INTO products (name, price) VALUES ('Product 4', -10.00)",
            "expectError": "violates check constraint \"chk_products_price\""
          },
          {
            "description": "Value exceeding max rejected",
            "executeQuery": "INSERT INTO products (name, price) VALUES ('Product 5', 15000.00)",
            "expectError": "violates check constraint \"chk_products_price\""
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-CONSTRAINTS-002",
      "given": "table 'inventory' with quantity field, existing constraint (quantity >= 0 AND quantity <= 100)",
      "when": "max constraint increased from 100 to 1000",
      "then": "DROP old CHECK constraint, ADD new CHECK with updated max",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_inventory",
            "name": "inventory",
            "fields": [
              { "id": 1, "name": "product_name", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "quantity",
                "type": "integer",
                "required": true,
                "validation": { "min": 0, "max": 100 }
              }
            ]
          },
          "newSchema": {
            "id": "tbl_inventory",
            "name": "inventory",
            "fields": [
              { "id": 1, "name": "product_name", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "quantity",
                "type": "integer",
                "required": true,
                "validation": { "min": 0, "max": 1000 }
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE inventory (id SERIAL PRIMARY KEY, product_name VARCHAR(255) NOT NULL, quantity INTEGER NOT NULL)",
            "ALTER TABLE inventory ADD CONSTRAINT chk_inventory_quantity CHECK (quantity >= 0 AND quantity <= 100)",
            "INSERT INTO inventory (product_name, quantity) VALUES ('Item 1', 50), ('Item 2', 100)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains DROP and ADD CHECK with new max",
            "sqlGeneration": {
              "contains": [
                "ALTER TABLE \"inventory\" DROP CONSTRAINT chk_inventory_quantity",
                "ALTER TABLE \"inventory\" ADD CONSTRAINT chk_inventory_quantity CHECK (quantity >= 0 AND quantity <= 1000)"
              ]
            }
          },
          {
            "description": "Old max (100) still accepted",
            "executeQuery": "INSERT INTO inventory (product_name, quantity) VALUES ('Item 3', 100) RETURNING quantity",
            "expected": {
              "quantity": 100
            }
          },
          {
            "description": "New max (1000) now accepted",
            "executeQuery": "INSERT INTO inventory (product_name, quantity) VALUES ('Item 4', 500) RETURNING quantity",
            "expected": {
              "quantity": 500
            }
          },
          {
            "description": "Value exceeding new max rejected",
            "executeQuery": "INSERT INTO inventory (product_name, quantity) VALUES ('Item 5', 1500)",
            "expectError": "violates check constraint \"chk_inventory_quantity\""
          },
          {
            "description": "Existing data preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM inventory",
            "expected": {
              "count": 4
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-CONSTRAINTS-003",
      "given": "table 'users' with age field (INTEGER), no constraint, existing rows with age = -5",
      "when": "min constraint added (age >= 0)",
      "then": "Migration fails due to invalid existing data (negative age)",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              { "id": 2, "name": "age", "type": "integer", "required": true }
            ]
          },
          "newSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "age",
                "type": "integer",
                "required": true,
                "validation": { "min": 0 }
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, age INTEGER NOT NULL)",
            "INSERT INTO users (name, age) VALUES ('Alice', 25), ('Bob', -5), ('Charlie', 30)"
          ]
        },
        "assertions": [
          {
            "description": "Migration fails due to constraint violation on existing data",
            "migrationStatus": "failed",
            "errorPattern": "violates check constraint|constraint would be violated"
          },
          {
            "description": "Constraint NOT created",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_constraint WHERE conrelid = 'users'::regclass AND conname = 'chk_users_age'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Invalid data still exists",
            "executeQuery": "SELECT age FROM users WHERE name = 'Bob'",
            "expected": {
              "age": -5
            }
          },
          {
            "description": "All data preserved after failed migration",
            "executeQuery": "SELECT COUNT(*) as total FROM users",
            "expected": {
              "total": 3
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-CONSTRAINTS-004",
      "given": "table 'orders' with discount field, existing constraint (discount >= 0 AND discount <= 100)",
      "when": "constraint removed from schema",
      "then": "ALTER TABLE DROP CONSTRAINT removes validation",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              { "id": 1, "name": "order_number", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "discount",
                "type": "decimal",
                "required": true,
                "validation": { "min": 0, "max": 100 }
              }
            ]
          },
          "newSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              { "id": 1, "name": "order_number", "type": "single-line-text", "required": true },
              { "id": 2, "name": "discount", "type": "decimal", "required": true }
            ]
          },
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_number VARCHAR(50) NOT NULL, discount NUMERIC(5,2) NOT NULL)",
            "ALTER TABLE orders ADD CONSTRAINT chk_orders_discount CHECK (discount >= 0 AND discount <= 100)",
            "INSERT INTO orders (order_number, discount) VALUES ('ORD-001', 10.00), ('ORD-002', 25.50)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains DROP CONSTRAINT",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"orders\" DROP CONSTRAINT chk_orders_discount"]
            }
          },
          {
            "description": "Constraint no longer exists",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_constraint WHERE conrelid = 'orders'::regclass AND conname = 'chk_orders_discount'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Value exceeding old max now accepted",
            "executeQuery": "INSERT INTO orders (order_number, discount) VALUES ('ORD-003', 150.00) RETURNING discount",
            "expected": {
              "discount": 150.0
            }
          },
          {
            "description": "Negative value now accepted",
            "executeQuery": "INSERT INTO orders (order_number, discount) VALUES ('ORD-004', -20.00) RETURNING discount",
            "expected": {
              "discount": -20.0
            }
          },
          {
            "description": "Existing data preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM orders",
            "expected": {
              "count": 4
            }
          }
        ]
      }
    }
  ]
}
