{
  "title": "Database Views Migration",
  "description": "Runtime SQL migration scenarios for creating, modifying, and dropping database views (standard and materialized)",
  "x-specs": [
    {
      "id": "MIG-VIEW-001",
      "given": "table 'users' exists, no views defined",
      "when": "view 'active_users' added to schema (SELECT * FROM users WHERE active = true)",
      "then": "CREATE VIEW for read-only access",
      "validation": {
        "setup": {
          "previousSchema": {
            "tables": [
              {
                "id": "tbl_users",
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "id": 2,
                    "name": "active",
                    "type": "checkbox"
                  }
                ]
              }
            ],
            "views": []
          },
          "newSchema": {
            "tables": [
              {
                "id": "tbl_users",
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "id": 2,
                    "name": "active",
                    "type": "checkbox"
                  }
                ]
              }
            ],
            "views": [
              {
                "name": "active_users",
                "query": "SELECT * FROM users WHERE active = true"
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255), active BOOLEAN DEFAULT false)",
            "INSERT INTO users (email, active) VALUES ('alice@example.com', true), ('bob@example.com', false), ('charlie@example.com', true)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains CREATE VIEW",
            "sqlGeneration": {
              "contains": [
                "CREATE VIEW \"active_users\" AS SELECT * FROM users WHERE active = true"
              ]
            }
          },
          {
            "description": "View exists in pg_views",
            "executeQuery": "SELECT viewname FROM pg_views WHERE schemaname = 'public' AND viewname = 'active_users'",
            "expected": {
              "viewname": "active_users"
            }
          },
          {
            "description": "View returns only active users",
            "executeQuery": "SELECT COUNT(*) as count FROM active_users",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "View reflects underlying table changes",
            "executeQuery": "INSERT INTO users (email, active) VALUES ('david@example.com', true); SELECT COUNT(*) as count FROM active_users",
            "expected": {
              "count": 3
            }
          }
        ]
      }
    },
    {
      "id": "MIG-VIEW-002",
      "given": "view 'active_users' exists",
      "when": "view removed from schema",
      "then": "DROP VIEW when removed",
      "validation": {
        "setup": {
          "previousSchema": {
            "tables": [
              {
                "id": "tbl_users",
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "id": 2,
                    "name": "active",
                    "type": "checkbox"
                  }
                ]
              }
            ],
            "views": [
              {
                "name": "active_users",
                "query": "SELECT * FROM users WHERE active = true"
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": "tbl_users",
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "id": 2,
                    "name": "active",
                    "type": "checkbox"
                  }
                ]
              }
            ],
            "views": []
          },
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255), active BOOLEAN DEFAULT false)",
            "CREATE VIEW active_users AS SELECT * FROM users WHERE active = true",
            "INSERT INTO users (email, active) VALUES ('alice@example.com', true)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains DROP VIEW",
            "sqlGeneration": {
              "contains": ["DROP VIEW \"active_users\""]
            }
          },
          {
            "description": "View no longer exists",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_views WHERE schemaname = 'public' AND viewname = 'active_users'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Query to view fails (relation does not exist)",
            "executeQuery": "SELECT * FROM active_users",
            "expectError": "relation \"active_users\" does not exist"
          },
          {
            "description": "Underlying table unaffected",
            "executeQuery": "SELECT COUNT(*) as count FROM users",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "MIG-VIEW-003",
      "given": "view 'user_summary' exists with query A",
      "when": "view query modified to query B",
      "then": "ALTER VIEW via DROP and CREATE",
      "validation": {
        "setup": {
          "previousSchema": {
            "tables": [
              {
                "id": "tbl_users",
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "id": 2,
                    "name": "active",
                    "type": "checkbox"
                  },
                  {
                    "id": 3,
                    "name": "created_at",
                    "type": "datetime"
                  }
                ]
              }
            ],
            "views": [
              {
                "name": "user_summary",
                "query": "SELECT email, active FROM users"
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": "tbl_users",
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "id": 2,
                    "name": "active",
                    "type": "checkbox"
                  },
                  {
                    "id": 3,
                    "name": "created_at",
                    "type": "datetime"
                  }
                ]
              }
            ],
            "views": [
              {
                "name": "user_summary",
                "query": "SELECT email, active, created_at FROM users WHERE active = true"
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255), active BOOLEAN, created_at TIMESTAMPTZ DEFAULT NOW())",
            "CREATE VIEW user_summary AS SELECT email, active FROM users",
            "INSERT INTO users (email, active) VALUES ('alice@example.com', true), ('bob@example.com', false)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains DROP VIEW and CREATE VIEW",
            "sqlGeneration": {
              "contains": [
                "DROP VIEW \"user_summary\"",
                "CREATE VIEW \"user_summary\" AS SELECT email, active, created_at FROM users WHERE active = true"
              ]
            }
          },
          {
            "description": "View has new column (created_at)",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.columns WHERE table_name = 'user_summary' AND column_name = 'created_at'",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "View filters to active users only",
            "executeQuery": "SELECT COUNT(*) as count FROM user_summary",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "MIG-VIEW-004",
      "given": "table 'orders' exists, no materialized views",
      "when": "materialized view 'order_stats' added (aggregation query)",
      "then": "CREATE MATERIALIZED VIEW",
      "validation": {
        "setup": {
          "previousSchema": {
            "tables": [
              {
                "id": "tbl_orders",
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "customer_id",
                    "type": "integer"
                  },
                  {
                    "id": 2,
                    "name": "total",
                    "type": "decimal"
                  }
                ]
              }
            ],
            "materializedViews": []
          },
          "newSchema": {
            "tables": [
              {
                "id": "tbl_orders",
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "customer_id",
                    "type": "integer"
                  },
                  {
                    "id": 2,
                    "name": "total",
                    "type": "decimal"
                  }
                ]
              }
            ],
            "materializedViews": [
              {
                "name": "order_stats",
                "query": "SELECT customer_id, COUNT(*) as order_count, SUM(total) as total_spent FROM orders GROUP BY customer_id"
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, customer_id INTEGER, total NUMERIC(10,2))",
            "INSERT INTO orders (customer_id, total) VALUES (1, 100.00), (1, 150.00), (2, 200.00)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains CREATE MATERIALIZED VIEW",
            "sqlGeneration": {
              "contains": [
                "CREATE MATERIALIZED VIEW \"order_stats\" AS SELECT customer_id, COUNT(*) as order_count, SUM(total) as total_spent FROM orders GROUP BY customer_id"
              ]
            }
          },
          {
            "description": "Materialized view exists in pg_matviews",
            "executeQuery": "SELECT matviewname FROM pg_matviews WHERE schemaname = 'public' AND matviewname = 'order_stats'",
            "expected": {
              "matviewname": "order_stats"
            }
          },
          {
            "description": "Materialized view contains aggregated data",
            "executeQuery": "SELECT COUNT(*) as count FROM order_stats",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Data is snapshot (insert does not auto-update)",
            "executeQuery": "INSERT INTO orders (customer_id, total) VALUES (1, 50.00); SELECT COUNT(*) as count FROM order_stats",
            "expected": {
              "count": 2
            }
          }
        ]
      }
    },
    {
      "id": "MIG-VIEW-005",
      "given": "materialized view 'order_stats' exists with stale data",
      "when": "refresh triggered via schema metadata or manual command",
      "then": "REFRESH MATERIALIZED VIEW",
      "validation": {
        "setup": {
          "previousSchema": {
            "tables": [
              {
                "id": "tbl_orders",
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "customer_id",
                    "type": "integer"
                  },
                  {
                    "id": 2,
                    "name": "total",
                    "type": "decimal"
                  }
                ]
              }
            ],
            "materializedViews": [
              {
                "name": "order_stats",
                "query": "SELECT customer_id, COUNT(*) as order_count FROM orders GROUP BY customer_id"
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": "tbl_orders",
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "customer_id",
                    "type": "integer"
                  },
                  {
                    "id": 2,
                    "name": "total",
                    "type": "decimal"
                  }
                ]
              }
            ],
            "materializedViews": [
              {
                "name": "order_stats",
                "query": "SELECT customer_id, COUNT(*) as order_count FROM orders GROUP BY customer_id",
                "refresh": true
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, customer_id INTEGER, total NUMERIC(10,2))",
            "INSERT INTO orders (customer_id, total) VALUES (1, 100.00), (2, 200.00)",
            "CREATE MATERIALIZED VIEW order_stats AS SELECT customer_id, COUNT(*) as order_count FROM orders GROUP BY customer_id",
            "INSERT INTO orders (customer_id, total) VALUES (1, 50.00), (3, 300.00)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains REFRESH MATERIALIZED VIEW",
            "sqlGeneration": {
              "contains": ["REFRESH MATERIALIZED VIEW \"order_stats\""]
            }
          },
          {
            "description": "View now reflects new data (3 customers)",
            "executeQuery": "SELECT COUNT(*) as count FROM order_stats",
            "expected": {
              "count": 3
            }
          },
          {
            "description": "Customer 1 order count updated",
            "executeQuery": "SELECT order_count FROM order_stats WHERE customer_id = 1",
            "expected": {
              "order_count": 2
            }
          }
        ]
      }
    },
    {
      "id": "MIG-VIEW-006",
      "given": "view 'user_orders' exists, view 'active_orders' depends on it",
      "when": "view 'user_orders' removed from schema",
      "then": "DROP VIEW CASCADE",
      "validation": {
        "setup": {
          "previousSchema": {
            "tables": [
              {
                "id": "tbl_orders",
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "user_id",
                    "type": "integer"
                  },
                  {
                    "id": 2,
                    "name": "status",
                    "type": "single-line-text"
                  }
                ]
              }
            ],
            "views": [
              {
                "name": "user_orders",
                "query": "SELECT * FROM orders"
              },
              {
                "name": "active_orders",
                "query": "SELECT * FROM user_orders WHERE status = 'active'"
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": "tbl_orders",
                "name": "orders",
                "fields": [
                  {
                    "id": 1,
                    "name": "user_id",
                    "type": "integer"
                  },
                  {
                    "id": 2,
                    "name": "status",
                    "type": "single-line-text"
                  }
                ]
              }
            ],
            "views": []
          },
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, user_id INTEGER, status VARCHAR(50))",
            "CREATE VIEW user_orders AS SELECT * FROM orders",
            "CREATE VIEW active_orders AS SELECT * FROM user_orders WHERE status = 'active'",
            "INSERT INTO orders (user_id, status) VALUES (1, 'active'), (2, 'completed')"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains DROP VIEW CASCADE",
            "sqlGeneration": {
              "contains": ["DROP VIEW \"user_orders\" CASCADE"]
            }
          },
          {
            "description": "Primary view removed",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_views WHERE schemaname = 'public' AND viewname = 'user_orders'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Dependent view also removed",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_views WHERE schemaname = 'public' AND viewname = 'active_orders'",
            "expected": {
              "count": 0
            }
          },
          {
            "description": "Underlying table unaffected",
            "executeQuery": "SELECT COUNT(*) as count FROM orders",
            "expected": {
              "count": 2
            }
          }
        ]
      }
    }
  ]
}
