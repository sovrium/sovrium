{
  "title": "Rename Table Migration",
  "description": "Runtime SQL migration scenario for renaming tables via ALTER TABLE RENAME TO",
  "x-specs": [
    {
      "id": "MIG-RENAME-TABLE-001",
      "given": "existing table 'users' with data and indexes",
      "when": "table name property changes to 'customers'",
      "then": "ALTER TABLE RENAME preserves data, indexes, and constraints",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              {
                "id": 1,
                "name": "email",
                "type": "email",
                "required": true,
                "unique": true
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text",
                "required": true
              }
            ]
          },
          "newSchema": {
            "id": "tbl_users",
            "name": "customers",
            "fields": [
              {
                "id": 1,
                "name": "email",
                "type": "email",
                "required": true,
                "unique": true
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text",
                "required": true
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255) UNIQUE NOT NULL, name VARCHAR(255) NOT NULL)",
            "CREATE INDEX idx_users_email ON users(email)",
            "INSERT INTO users (email, name) VALUES ('alice@example.com', 'Alice'), ('bob@example.com', 'Bob')"
          ]
        },
        "assertions": [
          {
            "description": "SQL migration contains ALTER TABLE RENAME",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"users\" RENAME TO \"customers\""]
            }
          },
          {
            "description": "Old table name no longer exists",
            "executeQuery": "SELECT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'users')",
            "expected": {
              "exists": false
            }
          },
          {
            "description": "New table name exists",
            "executeQuery": "SELECT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'customers')",
            "expected": {
              "exists": true
            }
          },
          {
            "description": "All data preserved after rename",
            "executeQuery": "SELECT COUNT(*) as count FROM customers",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Index still functions on renamed table",
            "executeQuery": "SELECT indexname FROM pg_indexes WHERE tablename = 'customers' AND indexname LIKE 'idx_%'",
            "expected": {
              "indexname": "idx_users_email"
            }
          },
          {
            "description": "UNIQUE constraint preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM information_schema.table_constraints WHERE table_name='customers' AND constraint_type='UNIQUE'",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    },
    {
      "id": "MIG-RENAME-TABLE-002",
      "given": "table 'posts' referenced by foreign key from 'comments'",
      "when": "table name changes to 'articles'",
      "then": "PostgreSQL automatically updates foreign key references",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE posts (id SERIAL PRIMARY KEY, title VARCHAR(255))",
            "INSERT INTO posts (title) VALUES ('Post 1'), ('Post 2')",
            "CREATE TABLE comments (id SERIAL PRIMARY KEY, post_id INTEGER REFERENCES posts(id), content TEXT)",
            "INSERT INTO comments (post_id, content) VALUES (1, 'Comment on post 1'), (2, 'Comment on post 2')"
          ],
          "previousSchema": {
            "id": "tbl_posts",
            "name": "posts",
            "fields": [
              {
                "id": 1,
                "name": "title",
                "type": "single-line-text"
              }
            ]
          },
          "newSchema": {
            "id": "tbl_posts",
            "name": "articles",
            "fields": [
              {
                "id": 1,
                "name": "title",
                "type": "single-line-text"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Rename table with ALTER TABLE",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"posts\" RENAME TO \"articles\""]
            }
          },
          {
            "description": "Foreign key constraint still references renamed table",
            "executeQuery": "SELECT ccu.table_name as referenced_table FROM information_schema.table_constraints tc JOIN information_schema.constraint_column_usage ccu ON tc.constraint_name = ccu.constraint_name WHERE tc.table_name='comments' AND tc.constraint_type='FOREIGN KEY'",
            "expected": {
              "referenced_table": "articles"
            }
          },
          {
            "description": "Foreign key relationship still enforced",
            "executeQuery": "INSERT INTO comments (post_id, content) VALUES (999, 'Invalid reference')",
            "expectError": "violates foreign key constraint"
          },
          {
            "description": "Valid foreign key insertion succeeds",
            "executeQuery": "INSERT INTO comments (post_id, content) VALUES (1, 'New comment') RETURNING post_id",
            "expected": {
              "post_id": 1
            }
          }
        ]
      }
    },
    {
      "id": "MIG-RENAME-TABLE-003",
      "given": "table 'products' with multiple indexes and constraints",
      "when": "table renamed to 'items'",
      "then": "All indexes and constraints remain functional",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, sku VARCHAR(100) UNIQUE NOT NULL, name VARCHAR(255) NOT NULL, category VARCHAR(50))",
            "CREATE INDEX idx_products_category ON products(category)",
            "CREATE INDEX idx_products_name ON products(name)",
            "INSERT INTO products (sku, name, category) VALUES ('SKU-001', 'Product 1', 'Electronics'), ('SKU-002', 'Product 2', 'Clothing')"
          ],
          "previousSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              {
                "id": 1,
                "name": "sku",
                "type": "single-line-text",
                "required": true,
                "unique": true
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text",
                "required": true
              },
              {
                "id": 3,
                "name": "category",
                "type": "single-select"
              }
            ]
          },
          "newSchema": {
            "id": "tbl_products",
            "name": "items",
            "fields": [
              {
                "id": 1,
                "name": "sku",
                "type": "single-line-text",
                "required": true,
                "unique": true
              },
              {
                "id": 2,
                "name": "name",
                "type": "single-line-text",
                "required": true
              },
              {
                "id": 3,
                "name": "category",
                "type": "single-select"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Rename table",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"products\" RENAME TO \"items\""]
            }
          },
          {
            "description": "All indexes exist on renamed table",
            "executeQuery": "SELECT COUNT(*) as count FROM pg_indexes WHERE tablename = 'items'",
            "expected": {
              "count": 3
            }
          },
          {
            "description": "UNIQUE constraint still enforced",
            "executeQuery": "INSERT INTO items (sku, name, category) VALUES ('SKU-001', 'Duplicate', 'Food')",
            "expectError": "duplicate key value violates unique constraint"
          },
          {
            "description": "Indexes function for queries",
            "executeQuery": "SELECT name FROM items WHERE category = 'Electronics'",
            "expected": {
              "name": "Product 1"
            }
          }
        ]
      }
    },
    {
      "id": "MIG-RENAME-TABLE-004",
      "given": "table rename where new name conflicts with existing table",
      "when": "attempting to rename 'users' to 'customers' but 'customers' exists",
      "then": "Migration fails with error and transaction rolls back",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255))",
            "INSERT INTO users (email) VALUES ('user@example.com')",
            "CREATE TABLE customers (id SERIAL PRIMARY KEY, name VARCHAR(255))",
            "INSERT INTO customers (name) VALUES ('Customer 1')"
          ],
          "previousSchema": {
            "id": "tbl_users",
            "name": "users",
            "fields": [
              {
                "id": 1,
                "name": "email",
                "type": "email"
              }
            ]
          },
          "newSchema": {
            "id": "tbl_users",
            "name": "customers",
            "fields": [
              {
                "id": 1,
                "name": "email",
                "type": "email"
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Migration fails with relation exists error",
            "migrationStatus": "failed",
            "errorPattern": "relation \"customers\" already exists"
          },
          {
            "description": "Original users table still exists",
            "executeQuery": "SELECT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'users')",
            "expected": {
              "exists": true
            }
          },
          {
            "description": "Existing customers table unchanged",
            "executeQuery": "SELECT COUNT(*) as count FROM customers",
            "expected": {
              "count": 1
            }
          },
          {
            "description": "No data loss in users table",
            "executeQuery": "SELECT COUNT(*) as count FROM users",
            "expected": {
              "count": 1
            }
          }
        ]
      }
    }
  ]
}
