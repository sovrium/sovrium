{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "modify-field-default.schema.json",
  "title": "Modify Field Default Migration",
  "description": "Runtime SQL migration scenarios for managing DEFAULT values via ALTER TABLE ALTER COLUMN",
  "type": "object",
  "properties": {
    "previousSchema": {
      "type": "object",
      "description": "Table schema before default value modification"
    },
    "newSchema": {
      "type": "object",
      "description": "Table schema after default value modification"
    },
    "defaultChange": {
      "type": "object",
      "properties": {
        "operation": {
          "enum": ["add", "change", "remove"],
          "description": "Type of default value operation"
        },
        "fieldName": {
          "type": "string"
        }
      }
    }
  },
  "required": ["previousSchema", "newSchema"],
  "x-specs": [
    {
      "id": "MIG-MODIFY-DEFAULT-001",
      "given": "table 'tasks' with priority field (TEXT), no default value",
      "when": "default value 'medium' added to schema",
      "then": "ALTER TABLE ALTER COLUMN SET DEFAULT 'medium'",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_tasks",
            "name": "tasks",
            "fields": [
              { "id": 1, "name": "title", "type": "single-line-text", "required": true },
              { "id": 2, "name": "priority", "type": "single-line-text", "required": false }
            ]
          },
          "newSchema": {
            "id": "tbl_tasks",
            "name": "tasks",
            "fields": [
              { "id": 1, "name": "title", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "priority",
                "type": "single-line-text",
                "required": false,
                "default": "medium"
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE tasks (id SERIAL PRIMARY KEY, title VARCHAR(255) NOT NULL, priority VARCHAR(50))",
            "INSERT INTO tasks (title, priority) VALUES ('Task 1', 'high'), ('Task 2', NULL)"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains SET DEFAULT",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"tasks\" ALTER COLUMN \"priority\" SET DEFAULT 'medium'"]
            }
          },
          {
            "description": "Default value visible in information_schema",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='tasks' AND column_name='priority'",
            "expected": {
              "column_default": "'medium'::character varying"
            }
          },
          {
            "description": "New row without value gets default",
            "executeQuery": "INSERT INTO tasks (title) VALUES ('Task 3') RETURNING priority",
            "expected": {
              "priority": "medium"
            }
          },
          {
            "description": "Existing rows unchanged (no backfill)",
            "executeQuery": "SELECT priority FROM tasks WHERE title = 'Task 2'",
            "expected": {
              "priority": null
            }
          },
          {
            "description": "Explicit NULL still allowed (field is optional)",
            "executeQuery": "INSERT INTO tasks (title, priority) VALUES ('Task 4', NULL) RETURNING priority",
            "expected": {
              "priority": null
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-DEFAULT-002",
      "given": "table 'products' with status field, existing default 'draft'",
      "when": "default value changed from 'draft' to 'pending'",
      "then": "ALTER TABLE ALTER COLUMN SET DEFAULT 'pending' (replaces old default)",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "status",
                "type": "single-line-text",
                "required": false,
                "default": "draft"
              }
            ]
          },
          "newSchema": {
            "id": "tbl_products",
            "name": "products",
            "fields": [
              { "id": 1, "name": "name", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "status",
                "type": "single-line-text",
                "required": false,
                "default": "pending"
              }
            ]
          },
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, status VARCHAR(50) DEFAULT 'draft')",
            "INSERT INTO products (name) VALUES ('Product 1'), ('Product 2')"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains SET DEFAULT with new value",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"products\" ALTER COLUMN \"status\" SET DEFAULT 'pending'"]
            }
          },
          {
            "description": "New default visible in information_schema",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='products' AND column_name='status'",
            "expected": {
              "column_default": "'pending'::character varying"
            }
          },
          {
            "description": "New rows get new default",
            "executeQuery": "INSERT INTO products (name) VALUES ('Product 3') RETURNING status",
            "expected": {
              "status": "pending"
            }
          },
          {
            "description": "Existing rows keep old default value (no update)",
            "executeQuery": "SELECT status FROM products WHERE name = 'Product 1'",
            "expected": {
              "status": "draft"
            }
          },
          {
            "description": "All existing data preserved",
            "executeQuery": "SELECT COUNT(*) as count FROM products WHERE status = 'draft'",
            "expected": {
              "count": 2
            }
          }
        ]
      }
    },
    {
      "id": "MIG-MODIFY-DEFAULT-003",
      "given": "table 'orders' with created_at field, existing default NOW()",
      "when": "default value removed from schema",
      "then": "ALTER TABLE ALTER COLUMN DROP DEFAULT",
      "validation": {
        "setup": {
          "previousSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              { "id": 1, "name": "order_number", "type": "single-line-text", "required": true },
              {
                "id": 2,
                "name": "created_at",
                "type": "datetime",
                "required": false,
                "default": "NOW()"
              }
            ]
          },
          "newSchema": {
            "id": "tbl_orders",
            "name": "orders",
            "fields": [
              { "id": 1, "name": "order_number", "type": "single-line-text", "required": true },
              { "id": 2, "name": "created_at", "type": "datetime", "required": false }
            ]
          },
          "executeQuery": [
            "CREATE TABLE orders (id SERIAL PRIMARY KEY, order_number VARCHAR(50) NOT NULL, created_at TIMESTAMPTZ DEFAULT NOW())",
            "INSERT INTO orders (order_number) VALUES ('ORD-001'), ('ORD-002')"
          ]
        },
        "assertions": [
          {
            "description": "SQL contains DROP DEFAULT",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"orders\" ALTER COLUMN \"created_at\" DROP DEFAULT"]
            }
          },
          {
            "description": "No default in information_schema",
            "executeQuery": "SELECT column_default FROM information_schema.columns WHERE table_name='orders' AND column_name='created_at'",
            "expected": {
              "column_default": null
            }
          },
          {
            "description": "New row without value gets NULL (no default)",
            "executeQuery": "INSERT INTO orders (order_number) VALUES ('ORD-003') RETURNING created_at",
            "expected": {
              "created_at": null
            }
          },
          {
            "description": "Existing rows preserve timestamps (no update)",
            "executeQuery": "SELECT COUNT(*) as count FROM orders WHERE created_at IS NOT NULL",
            "expected": {
              "count": 2
            }
          },
          {
            "description": "Explicit value still allowed",
            "executeQuery": "INSERT INTO orders (order_number, created_at) VALUES ('ORD-004', '2025-01-15 10:00:00+00') RETURNING order_number",
            "expected": {
              "order_number": "ORD-004"
            }
          }
        ]
      }
    }
  ]
}
