{
  "title": "Checksum Optimization",
  "description": "Runtime SQL migration checksum system for skip-if-unchanged optimization (<100ms startup)",
  "x-specs": [
    {
      "id": "MIG-CHECKSUM-001",
      "given": "table schema configuration with no previous checksum",
      "when": "runtime migration executes for first time",
      "then": "PostgreSQL saves SHA-256 checksum to _sovrium_schema_checksum table",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE IF NOT EXISTS _sovrium_schema_checksum (id VARCHAR(50) PRIMARY KEY, checksum VARCHAR(64) NOT NULL, updated_at TIMESTAMPTZ DEFAULT NOW())"
          ],
          "schemaConfig": {
            "tables": [
              {
                "id": 1,
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email",
                    "required": true,
                    "unique": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Checksum table exists",
            "executeQuery": "SELECT table_name FROM information_schema.tables WHERE table_name = '_sovrium_schema_checksum'",
            "expected": {
              "table_name": "_sovrium_schema_checksum"
            }
          },
          {
            "description": "Checksum saved as singleton row",
            "executeQuery": "SELECT id, LENGTH(checksum) as checksum_length FROM _sovrium_schema_checksum WHERE id = 'singleton'",
            "expected": {
              "id": "singleton",
              "checksum_length": 64
            }
          },
          {
            "description": "Checksum is SHA-256 hex (64 characters)",
            "executeQuery": "SELECT checksum ~ '^[0-9a-f]{64}$' as valid_sha256 FROM _sovrium_schema_checksum WHERE id = 'singleton'",
            "expected": {
              "valid_sha256": true
            }
          }
        ]
      }
    },
    {
      "id": "MIG-CHECKSUM-002",
      "given": "table schema unchanged from previous run (checksum matches)",
      "when": "runtime migration compares current hash with saved checksum",
      "then": "Migration skipped, startup completes in <100ms",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE IF NOT EXISTS _sovrium_schema_checksum (id VARCHAR(50) PRIMARY KEY, checksum VARCHAR(64) NOT NULL, updated_at TIMESTAMPTZ DEFAULT NOW())",
            "INSERT INTO _sovrium_schema_checksum (id, checksum) VALUES ('singleton', 'abc123previoushash0000000000000000000000000000000000000000000000')"
          ],
          "schemaConfig": {
            "tables": [
              {
                "id": 1,
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email",
                    "required": true,
                    "unique": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Compare current checksum with saved",
            "checksumComparison": {
              "current": "compute_sha256(schemaConfig)",
              "saved": "abc123previoushash0000000000000000000000000000000000000000000000"
            }
          },
          {
            "description": "If match: migrations skipped",
            "performance": {
              "maxExecutionTime": 100,
              "note": "Skip migrations when checksum unchanged"
            }
          },
          {
            "description": "If mismatch: run full migration",
            "migrationStatus": "executed"
          }
        ]
      }
    },
    {
      "id": "MIG-CHECKSUM-003",
      "given": "table schema modified (new field added)",
      "when": "checksum differs from previous run",
      "then": "Full migration executed and new checksum saved",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE users (id SERIAL PRIMARY KEY, email VARCHAR(255))",
            "CREATE TABLE IF NOT EXISTS _sovrium_schema_checksum (id VARCHAR(50) PRIMARY KEY, checksum VARCHAR(64) NOT NULL, updated_at TIMESTAMPTZ DEFAULT NOW())",
            "INSERT INTO _sovrium_schema_checksum (id, checksum) VALUES ('singleton', 'oldchecksumbeforechange00000000000000000000000000000000000000000')"
          ],
          "previousSchema": {
            "tables": [
              {
                "id": 1,
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": 1,
                "name": "users",
                "fields": [
                  {
                    "id": 1,
                    "name": "email",
                    "type": "email"
                  },
                  {
                    "id": 2,
                    "name": "name",
                    "type": "single-line-text"
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Checksum mismatch detected",
            "checksumComparison": {
              "matched": false
            }
          },
          {
            "description": "Full migration executed (ALTER TABLE)",
            "migrationStatus": "executed",
            "sqlGeneration": {
              "contains": ["ALTER TABLE \"users\" ADD COLUMN \"name\""]
            }
          },
          {
            "description": "New checksum saved after successful migration",
            "executeQuery": "SELECT checksum != 'oldchecksumbeforechange00000000000000000000000000000000000000000' as checksum_updated FROM _sovrium_schema_checksum WHERE id = 'singleton'",
            "expected": {
              "checksum_updated": true
            }
          },
          {
            "description": "Updated timestamp reflects migration",
            "executeQuery": "SELECT updated_at > (NOW() - INTERVAL '5 seconds') as recently_updated FROM _sovrium_schema_checksum WHERE id = 'singleton'",
            "expected": {
              "recently_updated": true
            }
          }
        ]
      }
    },
    {
      "id": "MIG-CHECKSUM-004",
      "given": "checksum computation includes all schema properties (fields, types, constraints, indexes)",
      "when": "minor schema change (e.g., index added) occurs",
      "then": "Checksum changes and triggers re-migration",
      "validation": {
        "setup": {
          "executeQuery": [
            "CREATE TABLE products (id SERIAL PRIMARY KEY, sku VARCHAR(100))",
            "CREATE TABLE IF NOT EXISTS _sovrium_schema_checksum (id VARCHAR(50) PRIMARY KEY, checksum VARCHAR(64) NOT NULL)",
            "INSERT INTO _sovrium_schema_checksum (id, checksum) VALUES ('singleton', 'checksumwithoutindex000000000000000000000000000000000000000000')"
          ],
          "previousSchema": {
            "tables": [
              {
                "id": 1,
                "name": "products",
                "fields": [
                  {
                    "id": 1,
                    "name": "sku",
                    "type": "single-line-text",
                    "indexed": false
                  }
                ]
              }
            ]
          },
          "newSchema": {
            "tables": [
              {
                "id": 1,
                "name": "products",
                "fields": [
                  {
                    "id": 1,
                    "name": "sku",
                    "type": "single-line-text",
                    "indexed": true
                  }
                ]
              }
            ]
          }
        },
        "assertions": [
          {
            "description": "Checksum includes index configuration",
            "checksumComparison": {
              "matched": false,
              "reason": "indexed property changed from false to true"
            }
          },
          {
            "description": "Migration creates index",
            "sqlGeneration": {
              "contains": ["CREATE INDEX IF NOT EXISTS idx_products_sku"]
            }
          },
          {
            "description": "New checksum saved with index included",
            "executeQuery": "SELECT checksum != 'checksumwithoutindex000000000000000000000000000000000000000000' as updated FROM _sovrium_schema_checksum WHERE id = 'singleton'",
            "expected": {
              "updated": true
            }
          }
        ]
      }
    }
  ]
}
