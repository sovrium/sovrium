{
  "passed": 1,
  "failed": 0,
  "originalContent": "/**\n * Copyright (c) 2025 ESSENTIAL SERVICES\n *\n * This source code is licensed under the Business Source License 1.1\n * found in the LICENSE.md file in the root directory of this source tree.\n */\n\nimport { test, expect } from '@/specs/fixtures'\n\n/**\n * E2E Tests for Include Deleted query parameter\n *\n * Source: specs/api/paths/tables/{tableId}/records/get.json\n * Domain: api\n * Spec Count: 4\n *\n * Include Deleted Behavior:\n * - By default (includeDeleted absent or false), soft-deleted records are excluded\n * - With includeDeleted=true, soft-deleted records are included in results\n * - Pagination counts should reflect the filtered or unfiltered totals\n * - All role types (member, viewer) can use includeDeleted for read operations\n *\n * Test Organization:\n * 1. @spec tests - One per spec in schema (4 tests) - Exhaustive acceptance criteria\n * 2. @regression test - ONE optimized integration test - Efficient workflow validation\n */\n\ntest.describe('Include Deleted query parameter', () => {\n  // ============================================================================\n  // @spec tests (one per spec) - EXHAUSTIVE coverage\n  // ============================================================================\n\n  test.fixme(\n    'API-TABLES-RECORDS-INCLUDE-DELETED-001: should exclude deleted records by default',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: Table with mix of active and soft-deleted records\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 1,\n            name: 'documents',\n            fields: [\n              { id: 1, name: 'title', type: 'single-line-text', required: true },\n              { id: 2, name: 'content', type: 'long-text' },\n              { id: 3, name: 'deleted_at', type: 'deleted-at', indexed: true },\n            ],\n          },\n        ],\n      })\n      await createAuthenticatedUser()\n      await executeQuery(`\n        INSERT INTO documents (id, title, content, deleted_at) VALUES\n          (1, 'Active Doc 1', 'Content 1', NULL),\n          (2, 'Deleted Doc', 'Content 2', NOW()),\n          (3, 'Active Doc 2', 'Content 3', NULL),\n          (4, 'Another Deleted', 'Content 4', NOW()),\n          (5, 'Active Doc 3', 'Content 5', NULL)\n      `)\n\n      // WHEN: User requests records without includeDeleted parameter\n      const response = await request.get('/api/tables/1/records', {})\n\n      // THEN: Returns 200 with only active records\n      expect(response.status()).toBe(200)\n\n      const data = await response.json()\n      // THEN: Only 3 active records returned\n      expect(data.records).toHaveLength(3)\n      expect(data.pagination.total).toBe(3)\n\n      // THEN: No soft-deleted records in response\n      const ids = data.records.map((r: { id: number }) => r.id)\n      expect(ids).toEqual(expect.arrayContaining([1, 3, 5]))\n      expect(ids).not.toContain(2)\n      expect(ids).not.toContain(4)\n    }\n  )\n\n  test.fixme(\n    'API-TABLES-RECORDS-INCLUDE-DELETED-002: should include deleted with includeDeleted=true',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: Table with mix of active and soft-deleted records\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 2,\n            name: 'notes',\n            fields: [\n              { id: 1, name: 'title', type: 'single-line-text', required: true },\n              { id: 2, name: 'deleted_at', type: 'deleted-at', indexed: true },\n            ],\n          },\n        ],\n      })\n      await createAuthenticatedUser()\n      await executeQuery(`\n        INSERT INTO notes (id, title, deleted_at) VALUES\n          (1, 'Note 1', NULL),\n          (2, 'Note 2 (deleted)', NOW()),\n          (3, 'Note 3', NULL)\n      `)\n\n      // WHEN: User requests records with includeDeleted=true\n      const response = await request.get('/api/tables/2/records', {\n        params: {\n          includeDeleted: 'true',\n        },\n      })\n\n      // THEN: Returns 200 with all records (including deleted)\n      expect(response.status()).toBe(200)\n\n      const data = await response.json()\n      // THEN: All 3 records returned\n      expect(data.records).toHaveLength(3)\n      expect(data.pagination.total).toBe(3)\n\n      // THEN: Deleted records have deleted_at populated\n      const deletedRecord = data.records.find((r: { id: number }) => r.id === 2)\n      expect(deletedRecord).toBeDefined()\n      expect(deletedRecord.fields.deleted_at).toBeTruthy()\n    }\n  )\n\n  test.fixme(\n    'API-TABLES-RECORDS-INCLUDE-DELETED-003: should allow member to use includeDeleted',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedMember }) => {\n      // GIVEN: Member user accessing records with includeDeleted\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 3,\n            name: 'items',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text', required: true },\n              { id: 2, name: 'deleted_at', type: 'deleted-at', indexed: true },\n            ],\n          },\n        ],\n      })\n      await createAuthenticatedMember()\n      await executeQuery(`\n        INSERT INTO items (id, name, deleted_at) VALUES\n          (1, 'Active Item', NULL),\n          (2, 'Deleted Item', NOW())\n      `)\n\n      // WHEN: Member requests records with includeDeleted=true\n      const response = await request.get('/api/tables/3/records', {\n        params: {\n          includeDeleted: 'true',\n        },\n      })\n\n      // THEN: Returns 200 with all records (member can use includeDeleted)\n      expect(response.status()).toBe(200)\n\n      const data = await response.json()\n      expect(data.records).toHaveLength(2)\n\n      // THEN: Both active and deleted records are returned\n      const ids = data.records.map((r: { id: number }) => r.id)\n      expect(ids).toContain(1)\n      expect(ids).toContain(2)\n    }\n  )\n\n  test.fixme(\n    'API-TABLES-RECORDS-INCLUDE-DELETED-004: should correctly count deleted vs active in pagination',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: Table with large dataset including deleted records\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 4,\n            name: 'records',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'deleted_at', type: 'deleted-at', indexed: true },\n            ],\n          },\n        ],\n      })\n      await createAuthenticatedUser()\n\n      // Insert 30 active records and 20 deleted records\n      const activeInserts = Array.from(\n        { length: 30 },\n        (_, i) => `(${i + 1}, 'Active ${i + 1}', NULL)`\n      ).join(',')\n      const deletedInserts = Array.from(\n        { length: 20 },\n        (_, i) => `(${i + 31}, 'Deleted ${i + 1}', NOW())`\n      ).join(',')\n\n      await executeQuery(`INSERT INTO records (id, name, deleted_at) VALUES ${activeInserts}`)\n      await executeQuery(`INSERT INTO records (id, name, deleted_at) VALUES ${deletedInserts}`)\n\n      // WHEN: User requests records without includeDeleted (default behavior)\n      const defaultResponse = await request.get('/api/tables/4/records', {\n        params: {\n          limit: '10',\n        },\n      })\n\n      // THEN: Pagination reflects only active records\n      expect(defaultResponse.status()).toBe(200)\n      const defaultData = await defaultResponse.json()\n      expect(defaultData.records).toHaveLength(10)\n      expect(defaultData.pagination.total).toBe(30) // Only active records counted\n\n      // WHEN: User requests records with includeDeleted=true\n      const includedResponse = await request.get('/api/tables/4/records', {\n        params: {\n          limit: '10',\n          includeDeleted: 'true',\n        },\n      })\n\n      // THEN: Pagination reflects all records\n      expect(includedResponse.status()).toBe(200)\n      const includedData = await includedResponse.json()\n      expect(includedData.records).toHaveLength(10)\n      expect(includedData.pagination.total).toBe(50) // All records counted\n    }\n  )\n\n  // ============================================================================\n  // @regression test (exactly one) - OPTIMIZED integration\n  // ============================================================================\n\n  test.fixme(\n    'API-TABLES-RECORDS-INCLUDE-DELETED-REGRESSION: user can complete include-deleted workflow',\n    { tag: '@regression' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      await test.step('Setup: Start server with table and mixed records', async () => {\n        await startServerWithSchema({\n          name: 'test-app',\n          auth: { emailAndPassword: true },\n          tables: [\n            {\n              id: 1,\n              name: 'documents',\n              fields: [\n                { id: 1, name: 'title', type: 'single-line-text', required: true },\n                { id: 2, name: 'content', type: 'long-text' },\n                { id: 3, name: 'deleted_at', type: 'deleted-at', indexed: true },\n              ],\n            },\n          ],\n        })\n\n        // Insert 30 active records and 20 deleted records for comprehensive testing\n        const activeInserts = Array.from(\n          { length: 30 },\n          (_, i) => `(${i + 1}, 'Active Doc ${i + 1}', 'Content ${i + 1}', NULL)`\n        ).join(',')\n        const deletedInserts = Array.from(\n          { length: 20 },\n          (_, i) => `(${i + 31}, 'Deleted Doc ${i + 1}', 'Content ${i + 31}', NOW())`\n        ).join(',')\n\n        await executeQuery(\n          `INSERT INTO documents (id, title, content, deleted_at) VALUES ${activeInserts}`\n        )\n        await executeQuery(\n          `INSERT INTO documents (id, title, content, deleted_at) VALUES ${deletedInserts}`\n        )\n      })\n\n      await test.step('Authenticate as user for basic operations', async () => {\n        await createAuthenticatedUser()\n      })\n\n      await test.step('API-TABLES-RECORDS-INCLUDE-DELETED-001: Excludes deleted records by default', async () => {\n        // WHEN: User requests records without includeDeleted parameter\n        const response = await request.get('/api/tables/1/records', {})\n\n        // THEN: Returns 200 with only active records\n        expect(response.status()).toBe(200)\n\n        const data = await response.json()\n        // THEN: Only 30 active records returned\n        expect(data.records).toHaveLength(10) // First page of 10\n        expect(data.pagination.total).toBe(30)\n\n        // THEN: No soft-deleted records in response\n        const ids = data.records.map((r: { id: number }) => r.id)\n        ids.forEach((id: number) => {\n          expect(id).toBeLessThanOrEqual(30) // Only active IDs (1-30)\n        })\n      })\n\n      await test.step('API-TABLES-RECORDS-INCLUDE-DELETED-002: Includes deleted with includeDeleted=true', async () => {\n        // WHEN: User requests records with includeDeleted=true\n        const response = await request.get('/api/tables/1/records', {\n          params: {\n            includeDeleted: 'true',\n          },\n        })\n\n        // THEN: Returns 200 with all records (including deleted)\n        expect(response.status()).toBe(200)\n\n        const data = await response.json()\n        // THEN: All 50 records counted in total\n        expect(data.records).toHaveLength(10) // First page of 10\n        expect(data.pagination.total).toBe(50) // All records counted\n\n        // THEN: Deleted records have deleted_at populated\n        const allRecordsResponse = await request.get('/api/tables/1/records', {\n          params: {\n            includeDeleted: 'true',\n            limit: '50',\n          },\n        })\n        const allData = await allRecordsResponse.json()\n        const deletedRecords = allData.records.filter((r: { fields: { deleted_at: any } }) =>\n          Boolean(r.fields.deleted_at)\n        )\n        expect(deletedRecords.length).toBe(20)\n      })\n\n      await test.step('API-TABLES-RECORDS-INCLUDE-DELETED-003: Allows member to use includeDeleted', async () => {\n        // WHEN: Member requests records with includeDeleted=true\n        const response = await request.get('/api/tables/1/records', {\n          params: {\n            includeDeleted: 'true',\n          },\n        })\n\n        // THEN: Returns 200 with all records (member can use includeDeleted)\n        expect(response.status()).toBe(200)\n\n        const data = await response.json()\n        expect(data.pagination.total).toBe(50)\n\n        // THEN: Both active and deleted records are accessible\n        const sampleResponse = await request.get('/api/tables/1/records', {\n          params: {\n            includeDeleted: 'true',\n            limit: '5',\n          },\n        })\n        const sampleData = await sampleResponse.json()\n        expect(sampleData.records.length).toBeGreaterThan(0)\n      })\n\n      await test.step('API-TABLES-RECORDS-INCLUDE-DELETED-004: Correctly counts deleted vs active in pagination', async () => {\n        // WHEN: User requests records without includeDeleted (default behavior)\n        const defaultResponse = await request.get('/api/tables/1/records', {\n          params: {\n            limit: '10',\n          },\n        })\n\n        // THEN: Pagination reflects only active records\n        expect(defaultResponse.status()).toBe(200)\n        const defaultData = await defaultResponse.json()\n        expect(defaultData.records).toHaveLength(10)\n        expect(defaultData.pagination.total).toBe(30) // Only active records counted\n\n        // WHEN: User requests records with includeDeleted=true\n        const includedResponse = await request.get('/api/tables/1/records', {\n          params: {\n            limit: '10',\n            includeDeleted: 'true',\n          },\n        })\n\n        // THEN: Pagination reflects all records\n        expect(includedResponse.status()).toBe(200)\n        const includedData = await includedResponse.json()\n        expect(includedData.records).toHaveLength(10)\n        expect(includedData.pagination.total).toBe(50) // All records counted\n      })\n    }\n  )\n})\n"
}