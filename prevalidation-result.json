{
  "passed": 1,
  "failed": 0,
  "originalContent": "/**\n * Copyright (c) 2025 ESSENTIAL SERVICES\n *\n * This source code is licensed under the Business Source License 1.1\n * found in the LICENSE.md file in the root directory of this source tree.\n */\n\nimport { test, expect } from '@/specs/fixtures'\n\n/**\n * E2E Tests for Create new record\n *\n * Source: specs/api/paths/tables/{tableId}/records/post.json\n * Domain: api\n * Spec Count: 16\n *\n * Test Organization:\n * 1. @spec tests - One per spec in schema (16 tests) - Exhaustive acceptance criteria\n * 2. @regression test - ONE optimized integration test - Efficient workflow validation\n */\n\ntest.describe('Create new record', () => {\n  // ============================================================================\n  // @spec tests (one per spec) - EXHAUSTIVE coverage\n  // ============================================================================\n\n  test(\n    'API-TABLES-RECORDS-CREATE-001: should return 201 Created with record data',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: A running server with valid table\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 1,\n            name: 'users',\n            fields: [\n              { id: 1, name: 'email', type: 'email', required: true, unique: true },\n              { id: 2, name: 'first_name', type: 'single-line-text' },\n              { id: 3, name: 'last_name', type: 'single-line-text' },\n            ],\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // WHEN: User creates record with valid data\n      const response = await request.post('/api/tables/1/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          email: 'john.doe@example.com',\n          first_name: 'John',\n          last_name: 'Doe',\n        },\n      })\n\n      // THEN: Response should be 201 Created with record data\n      expect(response.status()).toBe(201)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data).toHaveProperty('id')\n      expect(data.fields.email).toBe('john.doe@example.com')\n      expect(data.fields.first_name).toBe('John')\n      expect(data.fields.last_name).toBe('Doe')\n\n      // Verify record exists in database\n      const result = await executeQuery(`\n        SELECT * FROM users WHERE email = 'john.doe@example.com'\n      `)\n      // THEN: assertion\n      expect(result.rows).toHaveLength(1)\n      expect(result.rows[0].first_name).toBe('John')\n      expect(result.rows[0].last_name).toBe('Doe')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-002: should return 404 Not Found',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: A running server with valid table but attempting to access non-existent table\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 1,\n            name: 'users',\n            fields: [{ id: 1, name: 'email', type: 'email', required: true }],\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // WHEN: User attempts to create record in non-existent table\n      const response = await request.post('/api/tables/9999/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          email: 'user@example.com',\n        },\n      })\n\n      // THEN: Response should be 404 Not Found\n      expect(response.status()).toBe(404)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data).toHaveProperty('error')\n      expect(data.error).toBe('Table not found')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-003: should return 400 Bad Request with validation error',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: A table with required email field\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 1,\n            name: 'users',\n            fields: [\n              { id: 1, name: 'email', type: 'email', required: true, unique: true },\n              { id: 2, name: 'first_name', type: 'single-line-text' },\n            ],\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // WHEN: User creates record without required field\n      const response = await request.post('/api/tables/1/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          first_name: 'John',\n        },\n      })\n\n      // THEN: Response should be 400 Bad Request with validation error\n      expect(response.status()).toBe(400)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data).toHaveProperty('error')\n      expect(data.error).toBe('Validation error')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-004: should return 409 Conflict',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: A table with unique email constraint and existing record\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 3,\n            name: 'users',\n            fields: [\n              { id: 1, name: 'email', type: 'email', required: true, unique: true },\n              { id: 2, name: 'first_name', type: 'single-line-text' },\n            ],\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // Seed test data\n      await executeQuery(`\n        INSERT INTO users (email, first_name)\n        VALUES ('existing@example.com', 'Jane')\n      `)\n\n      // WHEN: User attempts to create record with duplicate email\n      const response = await request.post('/api/tables/3/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          email: 'existing@example.com',\n          first_name: 'John',\n        },\n      })\n\n      // THEN: Response should be 409 Conflict\n      expect(response.status()).toBe(409)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data).toHaveProperty('error')\n      expect(data.error).toBe('Unique constraint violation')\n\n      // Verify database still contains only original record\n      const result = await executeQuery(`\n        SELECT COUNT(*) as count FROM users WHERE email = 'existing@example.com'\n      `)\n      // THEN: assertion\n      expect(result.rows[0].count).toBe('1')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-005: should return 401 Unauthorized',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema }) => {\n      // GIVEN: A valid table with auth enabled\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 4,\n            name: 'users',\n            fields: [{ id: 1, name: 'email', type: 'email', required: true }],\n          },\n        ],\n      })\n\n      // WHEN: Unauthenticated user attempts to create record\n      const response = await request.post('/api/tables/1/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          email: 'test@example.com',\n        },\n      })\n\n      // THEN: Response should be 401 Unauthorized\n      expect(response.status()).toBe(401)\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-006: should return 403 Forbidden',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: A member user without create permission for the table\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 5,\n            name: 'projects',\n            fields: [{ id: 1, name: 'name', type: 'single-line-text' }],\n            permissions: {\n              create: { type: 'roles', roles: ['admin'] }, // Only admin can create\n            },\n          },\n        ],\n      })\n\n      // Create authenticated user with default role (member)\n      await createAuthenticatedUser()\n\n      // WHEN: Member attempts to create a record\n      const response = await request.post('/api/tables/5/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'New Project',\n        },\n      })\n\n      // THEN: Returns 403 Forbidden error\n      expect(response.status()).toBe(403)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.error).toBe('Forbidden')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-007: should return 403 Forbidden',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: A viewer user without create permission\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 6,\n            name: 'tasks',\n            fields: [{ id: 1, name: 'title', type: 'single-line-text' }],\n            permissions: {\n              create: { type: 'roles', roles: ['admin'] }, // Only admin can create\n            },\n          },\n        ],\n      })\n\n      // Create authenticated user with default role (member/viewer)\n      await createAuthenticatedUser()\n\n      // WHEN: Viewer attempts to create a record\n      const response = await request.post('/api/tables/6/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          title: 'New Task',\n        },\n      })\n\n      // THEN: Returns 403 Forbidden error\n      expect(response.status()).toBe(403)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.error).toBe('Forbidden')\n      expect(data.message).toBe('You do not have permission to create records in this table')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-008: should return 201 Created with all fields',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: An admin user with write access to all fields including sensitive\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 8,\n            name: 'employees',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'email', type: 'email' },\n              { id: 3, name: 'salary', type: 'decimal' },\n            ],\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // WHEN: Admin creates record with sensitive field (salary)\n      const response = await request.post('/api/tables/8/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'John Doe',\n          email: 'john@example.com',\n          salary: 75_000,\n        },\n      })\n\n      // THEN: Returns 201 Created with all fields\n      expect(response.status()).toBe(201)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data).toHaveProperty('id')\n      expect(data.fields.name).toBe('John Doe')\n      expect(data.fields.email).toBe('john@example.com')\n      // Decimal fields are returned as strings from PostgreSQL to preserve precision\n      expect(data.fields.salary).toBe('75000')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-009: should return 403 Forbidden',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: A member user attempting to create with write-protected field\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 9,\n            name: 'employees',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'email', type: 'email' },\n              { id: 3, name: 'salary', type: 'decimal' },\n            ],\n            permissions: {\n              fields: [\n                {\n                  field: 'salary',\n                  write: { type: 'roles', roles: ['admin'] }, // Only admin can write salary\n                },\n              ],\n            },\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // WHEN: Member includes salary field in create request\n      const response = await request.post('/api/tables/9/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'Jane Smith',\n          email: 'jane@example.com',\n          salary: 85_000,\n        },\n      })\n\n      // THEN: Returns 403 Forbidden (cannot write to protected field)\n      expect(response.status()).toBe(403)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.error).toBe('Forbidden')\n      expect(data.message).toBe(\"Cannot write to field 'salary': insufficient permissions\")\n      expect(data.field).toBe('salary')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-010: should return 403 Forbidden',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: A viewer user with very limited write permissions\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 10,\n            name: 'employees',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'email', type: 'email' },\n            ],\n            permissions: {\n              fields: [\n                {\n                  field: 'email',\n                  write: { type: 'roles', roles: ['admin'] }, // Only admin can write email\n                },\n              ],\n            },\n          },\n        ],\n      })\n\n      // Create authenticated user with default role (member/user)\n      await createAuthenticatedUser()\n\n      // WHEN: Viewer attempts to create with write-protected fields\n      const response = await request.post('/api/tables/10/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'Bob Wilson',\n          email: 'bob@example.com',\n        },\n      })\n\n      // THEN: Returns 403 Forbidden\n      expect(response.status()).toBe(403)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.error).toBe('Forbidden')\n      expect(data.field).toBe('email')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-011: should return 403 Forbidden',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: User attempts to set system-managed readonly fields\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 11,\n            name: 'tasks',\n            fields: [\n              { id: 1, name: 'title', type: 'single-line-text' },\n              { id: 2, name: 'created_at', type: 'datetime', default: 'NOW()' },\n            ],\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // WHEN: Create request includes id or created_at fields\n      const response = await request.post('/api/tables/11/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          id: 999,\n          title: 'Important Task',\n          created_at: '2025-01-01T00:00:00Z',\n        },\n      })\n\n      // THEN: Returns 403 Forbidden (cannot write to readonly fields)\n      expect(response.status()).toBe(403)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.error).toBe('Forbidden')\n      expect(data.message).toBe(\"Cannot write to readonly field 'id'\")\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-012: should return 403 for first forbidden field',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: Multiple fields with different write permission levels\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 12,\n            name: 'employees',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'email', type: 'email' },\n              { id: 3, name: 'phone', type: 'phone-number' },\n              { id: 4, name: 'salary', type: 'decimal' },\n              { id: 5, name: 'ssn', type: 'single-line-text' },\n            ],\n            permissions: {\n              fields: [\n                {\n                  field: 'salary',\n                  write: { type: 'roles', roles: ['admin'] }, // Only admin can write salary\n                },\n                {\n                  field: 'ssn',\n                  write: { type: 'roles', roles: ['admin'] }, // Only admin can write ssn\n                },\n              ],\n            },\n          },\n        ],\n      })\n\n      // Create authenticated user with default role (member)\n      await createAuthenticatedUser()\n\n      // WHEN: User creates with mix of permitted and forbidden fields\n      const response = await request.post('/api/tables/12/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'Alice Cooper',\n          email: 'alice@example.com',\n          phone: '555-0100',\n          salary: 95_000,\n          ssn: '123-45-6789',\n        },\n      })\n\n      // THEN: Returns 403 for first forbidden field encountered\n      expect(response.status()).toBe(403)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.error).toBe('Forbidden')\n      expect(data).toHaveProperty('field')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-013: should auto-inject owner_id',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: User creates record in table with owner_id field\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 13,\n            name: 'projects',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              {\n                id: 2,\n                name: 'owner_id',\n                type: 'user',\n                required: true,\n              },\n            ],\n          },\n        ],\n      })\n\n      const { user } = await createAuthenticatedUser({ email: 'user@example.com' })\n\n      // WHEN: owner_id field exists in table\n      const response = await request.post('/api/tables/13/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'Alpha Project',\n        },\n      })\n\n      // THEN: owner_id is automatically injected from user's session\n      expect(response.status()).toBe(201)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.fields.name).toBe('Alpha Project')\n      expect(data.fields.owner_id).toBe(user.id)\n\n      // Verify database record has correct owner_id\n      const result = await executeQuery(`\n        SELECT owner_id FROM projects WHERE name = 'Alpha Project'\n      `)\n      // THEN: assertion\n      expect(result.rows[0].owner_id).toBe(user.id)\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-014: should return 201 with filtered fields',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, createAuthenticatedUser }) => {\n      // GIVEN: Field write restrictions and table permission all apply\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 15,\n            name: 'employees',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'email', type: 'email' },\n              { id: 3, name: 'salary', type: 'decimal' },\n            ],\n            permissions: {\n              fields: [\n                {\n                  field: 'salary',\n                  read: { type: 'roles', roles: ['admin'] }, // Only admin can read salary\n                  write: { type: 'roles', roles: ['admin'] }, // Only admin can write salary\n                },\n              ],\n            },\n          },\n        ],\n      })\n\n      // Create authenticated user\n      await createAuthenticatedUser()\n\n      // WHEN: Member creates record with only permitted fields\n      const response = await request.post('/api/tables/15/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'Carol Davis',\n          email: 'carol@example.com',\n        },\n      })\n\n      // THEN: Returns 201 Created with filtered fields (salary not included due to write restrictions)\n      expect(response.status()).toBe(201)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.fields.name).toBe('Carol Davis')\n      expect(data.fields.email).toBe('carol@example.com')\n      expect(data.fields).not.toHaveProperty('salary')\n    }\n  )\n\n  test(\n    'API-TABLES-RECORDS-CREATE-015: should use database defaults',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery }) => {\n      // GIVEN: User creates record with only permitted fields\n      await startServerWithSchema({\n        name: 'test-app',\n        tables: [\n          {\n            id: 16,\n            name: 'employees',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text', required: true },\n              { id: 2, name: 'email', type: 'email' },\n              { id: 3, name: 'salary', type: 'decimal', default: 50_000 },\n            ],\n          },\n        ],\n      })\n\n      // WHEN: Some fields are omitted due to write restrictions\n      const response = await request.post('/api/tables/16/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'David Lee',\n          email: 'david@example.com',\n        },\n      })\n\n      // THEN: Returns 201 Created with defaults/nulls for omitted fields\n      expect(response.status()).toBe(201)\n\n      const data = await response.json()\n      // THEN: assertion\n      expect(data.fields.name).toBe('David Lee')\n      expect(data.fields.email).toBe('david@example.com')\n\n      // Verify database has default salary value\n      const result = await executeQuery(`\n        SELECT salary FROM employees WHERE name = 'David Lee'\n      `)\n      // THEN: assertion\n      expect(result.rows[0].salary).toBe('50000')\n    }\n  )\n\n  // ============================================================================\n  // Activity Log Tests\n  // ============================================================================\n\n  test(\n    'API-TABLES-RECORDS-CREATE-016: should create comprehensive activity log entry',\n    { tag: '@spec' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: Application with auth and activity logging\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 17,\n            name: 'contacts',\n            fields: [\n              { id: 1, name: 'id', type: 'autonumber', required: true },\n              { id: 2, name: 'name', type: 'single-line-text', required: true },\n              { id: 3, name: 'email', type: 'email', required: true },\n              { id: 4, name: 'phone', type: 'phone-number' },\n            ],\n            primaryKey: { type: 'auto-increment', field: 'id' },\n          },\n        ],\n      })\n\n      const { user } = await createAuthenticatedUser({\n        email: 'user@example.com',\n      })\n\n      // WHEN: User creates a new record\n      const response = await request.post('/api/tables/17/records', {\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        data: {\n          name: 'John Doe',\n          email: 'john@example.com',\n          phone: '555-1234',\n        },\n      })\n\n      expect(response.status()).toBe(201)\n      const record = await response.json()\n\n      // THEN: Activity log entry is created with comprehensive data\n      const logs = await executeQuery(`\n        SELECT * FROM system.activity_logs\n        WHERE table_name = 'contacts' AND action = 'create'\n        ORDER BY created_at DESC\n        LIMIT 1\n      `)\n\n      expect(logs.rows).toHaveLength(1)\n      const log = logs.rows[0]\n\n      // THEN: Log has correct metadata\n      expect(log.action).toBe('create')\n      expect(log.user_id).toBe(user.id)\n      expect(log.table_id).toBe('1')\n      expect(log.record_id).toBe(String(record.id))\n\n      // THEN: All fields are captured in changes.after\n      const changes = JSON.parse(log.changes)\n      expect(changes.after).toBeDefined()\n      expect(changes.after.id).toBeDefined()\n      expect(changes.after.name).toBe('John Doe')\n      expect(changes.after.email).toBe('john@example.com')\n      expect(changes.after.phone).toBe('555-1234')\n    }\n  )\n\n  // ============================================================================\n  // @regression test (exactly one) - OPTIMIZED integration\n  // ============================================================================\n\n  test.fixme(\n    'API-TABLES-RECORDS-CREATE-REGRESSION: user can complete full record creation workflow',\n    { tag: '@regression' },\n    async ({ request, startServerWithSchema, executeQuery, createAuthenticatedUser }) => {\n      // GIVEN: Consolidated configuration from all @spec tests\n      await startServerWithSchema({\n        name: 'test-app',\n        auth: { emailAndPassword: true },\n        tables: [\n          {\n            id: 1,\n            name: 'users',\n            fields: [\n              { id: 1, name: 'email', type: 'email', required: true, unique: true },\n              { id: 2, name: 'first_name', type: 'single-line-text' },\n              { id: 3, name: 'last_name', type: 'single-line-text' },\n            ],\n          },\n          {\n            id: 2,\n            name: 'projects',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'owner_id', type: 'user', required: true },\n            ],\n          },\n          {\n            id: 3,\n            name: 'employees',\n            fields: [\n              { id: 1, name: 'name', type: 'single-line-text' },\n              { id: 2, name: 'email', type: 'email' },\n              { id: 3, name: 'salary', type: 'decimal', default: 50_000 },\n            ],\n          },\n          {\n            id: 4,\n            name: 'tasks',\n            fields: [\n              { id: 1, name: 'title', type: 'single-line-text' },\n              { id: 2, name: 'created_at', type: 'datetime', default: 'NOW()' },\n            ],\n          },\n          {\n            id: 5,\n            name: 'contacts',\n            fields: [\n              { id: 1, name: 'id', type: 'autonumber', required: true },\n              { id: 2, name: 'name', type: 'single-line-text', required: true },\n              { id: 3, name: 'email', type: 'email', required: true },\n              { id: 4, name: 'phone', type: 'phone-number' },\n            ],\n          },\n        ],\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-001: should return 201 Created with record data', async () => {\n        const response = await request.post('/api/tables/1/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            email: 'john.doe@example.com',\n            first_name: 'John',\n            last_name: 'Doe',\n          },\n        })\n\n        expect(response.status()).toBe(201)\n\n        const data = await response.json()\n        expect(data).toHaveProperty('id')\n        expect(data.fields.email).toBe('john.doe@example.com')\n        expect(data.fields.first_name).toBe('John')\n        expect(data.fields.last_name).toBe('Doe')\n\n        const result = await executeQuery(`\n          SELECT * FROM users WHERE email = 'john.doe@example.com'\n        `)\n        expect(result.rows).toHaveLength(1)\n        expect(result.rows[0].first_name).toBe('John')\n        expect(result.rows[0].last_name).toBe('Doe')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-002: should return 404 Not Found', async () => {\n        const response = await request.post('/api/tables/9999/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: { email: 'user@example.com' },\n        })\n\n        expect(response.status()).toBe(404)\n\n        const data = await response.json()\n        expect(data).toHaveProperty('error')\n        expect(data.error).toBe('Table not found')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-003: should return 400 Bad Request with validation error', async () => {\n        const response = await request.post('/api/tables/1/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: { first_name: 'John' },\n        })\n\n        expect(response.status()).toBe(400)\n\n        const data = await response.json()\n        expect(data).toHaveProperty('error')\n        expect(data.error).toBe('Validation error')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-004: should return 409 Conflict', async () => {\n        await executeQuery(`\n          INSERT INTO users (email, first_name)\n          VALUES ('existing@example.com', 'Jane')\n        `)\n\n        const response = await request.post('/api/tables/1/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            email: 'existing@example.com',\n            first_name: 'John',\n          },\n        })\n\n        expect(response.status()).toBe(409)\n\n        const data = await response.json()\n        expect(data).toHaveProperty('error')\n        expect(data.error).toBe('Unique constraint violation')\n\n        const result = await executeQuery(`\n          SELECT COUNT(*) as count FROM users WHERE email = 'existing@example.com'\n        `)\n        expect(result.rows[0].count).toBe('1')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-005: should return 401 Unauthorized', async () => {\n        const response = await request.post('/api/tables/1/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: { email: 'test@example.com' },\n        })\n\n        expect(response.status()).toBe(401)\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-006: should return 403 Forbidden for member without create permission', async () => {\n        const response = await request.post('/api/tables/1/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: { name: 'New Project' },\n        })\n\n        expect(response.status()).toBe(403)\n\n        const data = await response.json()\n        expect(data.error).toBe('Forbidden')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-007: should return 403 Forbidden for viewer without create permission', async () => {\n        const response = await request.post('/api/tables/1/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: { title: 'New Task' },\n        })\n\n        expect(response.status()).toBe(403)\n\n        const data = await response.json()\n        expect(data.error).toBe('Forbidden')\n        expect(data.message).toBe('You do not have permission to create records in this table')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-008: should return 201 Created with all fields for admin', async () => {\n        const response = await request.post('/api/tables/3/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            name: 'John Doe',\n            email: 'john@example.com',\n            salary: 75_000,\n          },\n        })\n\n        expect(response.status()).toBe(201)\n\n        const data = await response.json()\n        expect(data).toHaveProperty('id')\n        expect(data.fields.name).toBe('John Doe')\n        expect(data.fields.email).toBe('john@example.com')\n        expect(data.fields.salary).toBe(75_000)\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-009: should return 403 Forbidden for write-protected field', async () => {\n        const response = await request.post('/api/tables/3/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            name: 'Jane Smith',\n            email: 'jane@example.com',\n            salary: 85_000,\n          },\n        })\n\n        expect(response.status()).toBe(403)\n\n        const data = await response.json()\n        expect(data.error).toBe('Forbidden')\n        expect(data.message).toBe(\"Cannot write to field 'salary': insufficient permissions\")\n        expect(data.field).toBe('salary')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-010: should return 403 Forbidden for viewer with limited write permissions', async () => {\n        const response = await request.post('/api/tables/3/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            name: 'Bob Wilson',\n            email: 'bob@example.com',\n          },\n        })\n\n        expect(response.status()).toBe(403)\n\n        const data = await response.json()\n        expect(data.error).toBe('Forbidden')\n        expect(data.field).toBe('email')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-011: should return 403 Forbidden for readonly fields', async () => {\n        const response = await request.post('/api/tables/4/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            id: 999,\n            title: 'Important Task',\n            created_at: '2025-01-01T00:00:00Z',\n          },\n        })\n\n        expect(response.status()).toBe(403)\n\n        const data = await response.json()\n        expect(data.error).toBe('Forbidden')\n        expect(data.message).toBe(\"Cannot write to readonly field 'id'\")\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-012: should return 403 for first forbidden field', async () => {\n        const response = await request.post('/api/tables/3/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            name: 'Alice Cooper',\n            email: 'alice@example.com',\n            salary: 95_000,\n          },\n        })\n\n        expect(response.status()).toBe(403)\n\n        const data = await response.json()\n        expect(data.error).toBe('Forbidden')\n        expect(data).toHaveProperty('field')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-013: should auto-inject owner_id', async () => {\n        const { user } = await createAuthenticatedUser({ email: 'owner@example.com' })\n\n        const response = await request.post('/api/tables/2/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: { name: 'Alpha Project' },\n        })\n\n        expect(response.status()).toBe(201)\n\n        const data = await response.json()\n        expect(data.fields.name).toBe('Alpha Project')\n        expect(data.fields.owner_id).toBe(user.id)\n\n        const result = await executeQuery(`\n          SELECT owner_id FROM projects WHERE name = 'Alpha Project'\n        `)\n        expect(result.rows[0].owner_id).toBe(user.id)\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-014: should return 201 with filtered fields', async () => {\n        const response = await request.post('/api/tables/3/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            name: 'Carol Davis',\n            email: 'carol@example.com',\n          },\n        })\n\n        expect(response.status()).toBe(201)\n\n        const data = await response.json()\n        expect(data.fields.name).toBe('Carol Davis')\n        expect(data.fields.email).toBe('carol@example.com')\n        expect(data.fields).not.toHaveProperty('salary')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-015: should use database defaults', async () => {\n        const response = await request.post('/api/tables/3/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            name: 'David Lee',\n            email: 'david@example.com',\n          },\n        })\n\n        expect(response.status()).toBe(201)\n\n        const data = await response.json()\n        expect(data.fields.name).toBe('David Lee')\n        expect(data.fields.email).toBe('david@example.com')\n\n        const result = await executeQuery(`\n          SELECT salary FROM employees WHERE name = 'David Lee'\n        `)\n        expect(result.rows[0].salary).toBe('50000')\n      })\n\n      await test.step('API-TABLES-RECORDS-CREATE-016: should create comprehensive activity log entry', async () => {\n        const { user } = await createAuthenticatedUser({\n          email: 'user@example.com',\n        })\n\n        const response = await request.post('/api/tables/5/records', {\n          headers: { 'Content-Type': 'application/json' },\n          data: {\n            name: 'John Doe',\n            email: 'john.activity@example.com',\n            phone: '555-1234',\n          },\n        })\n\n        expect(response.status()).toBe(201)\n        const record = await response.json()\n\n        const logs = await executeQuery(`\n          SELECT * FROM system.activity_logs\n          WHERE table_name = 'contacts' AND action = 'create'\n          ORDER BY created_at DESC\n          LIMIT 1\n        `)\n\n        expect(logs.rows).toHaveLength(1)\n        const log = logs.rows[0]\n\n        expect(log.action).toBe('create')\n        expect(log.user_id).toBe(user.id)\n        expect(log.table_id).toBe('5')\n        expect(log.record_id).toBe(String(record.id))\n\n        const changes = JSON.parse(log.changes)\n        expect(changes.after).toBeDefined()\n        expect(changes.after.id).toBeDefined()\n        expect(changes.after.name).toBe('John Doe')\n        expect(changes.after.email).toBe('john.activity@example.com')\n        expect(changes.after.phone).toBe('555-1234')\n      })\n    }\n  )\n})\n"
}