# Scalar API Reference - Interactive API Documentation UI

> **Unified API Documentation**: Beautiful, interactive OpenAPI documentation UI for both application and authentication APIs

## Overview

Sovrium uses **Scalar API Reference** (`@scalar/hono-api-reference` v0.9.25) to provide a modern, interactive API documentation interface. It aggregates multiple OpenAPI schemas into a single, user-friendly documentation portal.

### Why Scalar?

**Scalar provides**:

- üé® Modern, themeable UI (Material Design inspired)
- üì± Responsive design (mobile + desktop)
- üîç Interactive API explorer (try endpoints directly)
- üîó Multi-source aggregation (combine multiple APIs)
- üöÄ Zero configuration setup
- ‚ö° Fast rendering (optimized for large APIs)
- üéØ Deep linking support (shareable links to specific endpoints)

**Alternatives considered**:

- **Swagger UI**: Older design, heavier bundle, less modern
- **Redoc**: Read-only (no interactive testing)
- **RapiDoc**: Less polished UI
- **Stoplight Elements**: Requires additional setup

## Integration Architecture

### Current Implementation

```typescript
// src/infrastructure/server/route-setup/openapi-routes.ts
import { Scalar } from '@scalar/hono-api-reference'

export function setupOpenApiRoutes(honoApp: Readonly<Hono>): Readonly<Hono> {
  return honoApp
    .get('/api/openapi.json', (c) => {
      // Application API schema (from Hono + Zod)
      const openApiDoc = getOpenAPIDocument()
      return c.json(openApiDoc)
    })
    .get('/api/auth/openapi.json', async (c) => {
      // Better Auth API schema (auto-generated)
      const authOpenApiDoc = await auth.api.generateOpenAPISchema()
      return c.json(authOpenApiDoc)
    })
    .get(
      '/api/scalar',
      Scalar({
        pageTitle: 'Sovrium API Documentation',
        theme: 'default',
        sources: [
          { url: '/api/openapi.json', title: 'API' },
          { url: '/api/auth/openapi.json', title: 'Auth' },
        ],
      })
    )
}
```

### Route Structure

```
/api/scalar                   ‚Üí Scalar documentation UI
/api/openapi.json             ‚Üí Application API schema (Hono + Zod)
/api/auth/openapi.json        ‚Üí Better Auth API schema (auto-generated)
```

### Multi-Source Aggregation

Scalar aggregates two independent OpenAPI schemas:

1. **Application API** (`/api/openapi.json`):
   - Custom business logic endpoints
   - Generated from Zod schemas in `src/presentation/api/schemas/`
   - See `@docs/infrastructure/api/hono-rpc-openapi.md` for details

2. **Authentication API** (`/api/auth/openapi.json`):
   - Better Auth endpoints (sign-in, sign-up, etc.)
   - Auto-generated by Better Auth
   - See `@docs/infrastructure/framework/better-auth.md` for details

**Why separate schemas?**

- Better Auth auto-generates its OpenAPI schema
- Application API uses custom Zod schemas
- Scalar combines both into unified UI without conflicts

## Configuration Options

### Available Configuration

```typescript
Scalar({
  pageTitle: string              // Browser tab title
  theme: 'default' | 'dark' | 'light' | 'purple' | 'solarized' | 'none'
  sources: Array<{
    url: string                  // OpenAPI JSON endpoint
    title: string                // Section title in sidebar
  }>
  layout?: 'modern' | 'classic'  // UI layout style
  showSidebar?: boolean          // Toggle sidebar visibility
  searchHotKey?: string          // Keyboard shortcut for search
  darkMode?: boolean             // Force dark mode
  hideModels?: boolean           // Hide schema models section
  hideDownloadButton?: boolean   // Hide download spec button
  authentication?: {             // Pre-fill auth credentials
    apiKey?: { token: string }
    http?: { bearer: string }
    oauth2?: { clientId: string }
  }
})
```

### Current Configuration

| Option      | Value                       | Rationale                                  |
| ----------- | --------------------------- | ------------------------------------------ |
| `pageTitle` | "Sovrium API Documentation" | Clear browser tab identification           |
| `theme`     | "default"                   | Neutral theme (matches Sovrium branding)   |
| `sources`   | 2 sources (API + Auth)      | Unified docs for all endpoints             |
| `layout`    | (default: modern)           | Modern layout for better UX                |
| Other       | (all defaults)              | Sensible defaults work well out-of-the-box |

### Theme Customization (Future)

To match Sovrium's branding, update theme:

```typescript
Scalar({
  theme: 'none', // Disable built-in theme
  customCss: `
    :root {
      --scalar-color-1: #your-brand-color;
      --scalar-border-radius: 8px;
      --scalar-font: 'Inter', sans-serif;
    }
  `,
})
```

## Usage in Development

### Accessing Documentation

1. **Start development server**:

   ```bash
   bun run start
   ```

2. **Open Scalar UI**:

   ```
   http://localhost:3000/api/scalar
   ```

3. **Interactive testing**:
   - Select endpoint from sidebar
   - Fill in parameters
   - Click "Send Request"
   - View response in real-time

### OpenAPI JSON Endpoints

**Application API schema**:

```bash
curl http://localhost:3000/api/openapi.json | jq
```

**Better Auth API schema**:

```bash
curl http://localhost:3000/api/auth/openapi.json | jq
```

## Development Workflow

### Adding New Endpoints

When adding new API endpoints, they automatically appear in Scalar:

1. **Create Zod schema** in `src/presentation/api/schemas/`:

   ```typescript
   // src/presentation/api/schemas/users-schemas.ts
   export const userResponseSchema = z.object({
     id: z.string(),
     name: z.string(),
     email: z.string().email(),
   })
   ```

2. **Create OpenAPI route definition** in `src/presentation/api/openapi-schema.ts`:

   ```typescript
   createRoute({
     method: 'get',
     path: '/users/{id}',
     request: { params: z.object({ id: z.string() }) },
     responses: {
       200: {
         description: 'User found',
         content: { 'application/json': { schema: userResponseSchema } },
       },
     },
   })
   ```

3. **Restart server** ‚Üí New endpoint appears in Scalar UI automatically

### Debugging OpenAPI Issues

**Endpoint not showing in Scalar**:

1. Check if route is registered in OpenAPI schema (visit `/api/openapi.json`)
2. Verify Zod schema is valid (TypeScript should catch errors)
3. Check browser console for Scalar errors

**Schema validation errors**:

1. Use OpenAPI validator: `npx @redocly/cli lint /api/openapi.json`
2. Check Zod schema matches OpenAPI 3.1 spec
3. Verify response schemas match actual responses

## Testing

### Manual Testing

**Test Scalar rendering**:

```bash
bun run start
# Open http://localhost:3000/api/scalar
# Verify both "API" and "Auth" sections appear
```

**Test multi-source aggregation**:

```bash
curl http://localhost:3000/api/openapi.json | jq '.paths | keys'
curl http://localhost:3000/api/auth/openapi.json | jq '.paths | keys'
# Both should show different endpoints
```

### E2E Testing

Scalar UI is tested via Playwright (see `specs/api/` directory).

**Example test**:

```typescript
// specs/api/scalar-ui.spec.ts
test('Scalar UI renders API documentation', async ({ page }) => {
  await page.goto('http://localhost:3000/api/scalar')

  // Verify page title
  await expect(page).toHaveTitle(/Sovrium API Documentation/)

  // Verify both sources appear
  await expect(page.getByText('API')).toBeVisible()
  await expect(page.getByText('Auth')).toBeVisible()
})
```

## Troubleshooting

### Common Issues

**Issue: Scalar UI shows 404**

- **Cause**: Route not registered in `setupOpenApiRoutes()`
- **Fix**: Ensure `openapi-routes.ts` is imported in `src/infrastructure/server/server.ts`

**Issue: Auth endpoints not showing**

- **Cause**: Better Auth OpenAPI generation failed
- **Fix**: Check Better Auth configuration, ensure all plugins are loaded

**Issue: Scalar UI is slow**

- **Cause**: Large OpenAPI schema (>1000 endpoints)
- **Fix**: Consider splitting into multiple Scalar instances or using pagination

**Issue: Theme not applying**

- **Cause**: Custom CSS conflicts
- **Fix**: Use `theme: 'none'` and apply custom CSS via `customCss` option

### Performance Optimization

For large APIs (>100 endpoints):

```typescript
Scalar({
  // ... other config
  hideModels: true, // Skip schema models section
  showSidebar: true, // Keep sidebar for navigation
  layout: 'classic', // Classic layout is faster
})
```

## Best Practices

### ‚úÖ Do

- **Keep schemas up-to-date**: Ensure OpenAPI matches actual API behavior
- **Add descriptions**: Document all endpoints with clear descriptions
- **Use examples**: Include request/response examples in schemas
- **Test interactively**: Use Scalar's "Try it" feature during development
- **Version your API**: Use OpenAPI versioning for breaking changes

### ‚ùå Don't

- **Don't expose Scalar in production** (unless behind authentication)
- **Don't add sensitive data** to schema examples (use dummy data)
- **Don't mix authentication schemes** (use consistent auth across endpoints)
- **Don't over-customize theme** (built-in themes work well)

## Related Documentation

- **OpenAPI Schema Generation**: `@docs/infrastructure/api/hono-rpc-openapi.md`
- **Better Auth Integration**: `@docs/infrastructure/framework/better-auth.md`
- **API Route Structure**: `@docs/architecture/layer-based-architecture.md`

## External Resources

- [Scalar Documentation](https://github.com/scalar/scalar)
- [Scalar API Reference (Hono)](https://github.com/scalar/scalar/tree/main/packages/hono-api-reference)
- [OpenAPI 3.1 Specification](https://spec.openapis.org/oas/v3.1.0)
- [Hono RPC](https://hono.dev/docs/guides/rpc)

## Version History

| Date       | Version | Change                                        |
| ---------- | ------- | --------------------------------------------- |
| 2025-01-25 | 0.9.25  | Initial integration with multi-source support |
